<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation SSI - SSIAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK via unpkg (autoris√© par CSP) -->
    <script src="https://unpkg.com/firebase@10.7.1/firebase-app-compat.js"></script>
    <script src="https://unpkg.com/firebase@10.7.1/firebase-database-compat.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .blink {
            animation: blink 1s infinite;
        }
        .led-light {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #333;
            display: inline-block;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .led-green { background-color: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .led-orange { background-color: #ff8800; box-shadow: 0 0 10px #ff8800; }
        .led-red { background-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        .led-off { background-color: #333; box-shadow: none; }

        .ssi-panel {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border: 3px solid #7f8c8d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .ssi-button {
            padding: 10px 20px;
            border: 2px solid #333;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-align: center;
        }

        .ssi-button:active {
            transform: scale(0.95);
        }

        .ssi-button-red {
            background-color: #c0392b;
            color: white;
        }

        .ssi-button-green {
            background-color: #27ae60;
            color: white;
        }

        .ssi-button-yellow {
            background-color: #f39c12;
            color: white;
        }

        .ssi-screen {
            background-color: #000;
            color: #00ff00;
            font-family: monospace;
            padding: 15px;
            border-radius: 5px;
            min-height: 100px;
            border: 2px solid #333;
        }

        .key-switch {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid #95a5a6;
            background: linear-gradient(135deg, #bdc3c7 0%, #ecf0f1 100%);
            cursor: pointer;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .key-switch.active {
            transform: rotate(90deg);
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .command-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #333;
            border: 1px solid #666;
        }

        .command-led.active {
            background-color: #ff0000;
            box-shadow: 0 0 8px #ff0000;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAV4UZ_j2M017lZoFdcbyuxe1oV7VxjWLs",
            authDomain: "ssi-ssiap-training.firebaseapp.com",
            databaseURL: "https://ssi-ssiap-training-default-rtdb.firebaseio.com",
            projectId: "ssi-ssiap-training",
            storageBucket: "ssi-ssiap-training.firebasestorage.app",
            messagingSenderId: "1024486187072",
            appId: "1:1024486187072:web:4e452ab8549cac24d3ffa5"
        };

        // Initialize Firebase
        let db = null;
        let firebaseInitialized = false;

        // Attendre que Firebase soit charg√©
        window.addEventListener('load', () => {
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                    firebaseInitialized = true;
                    console.log('‚úì Firebase initialized successfully');

                    // Charger les stagiaires depuis Firebase
                    loadTraineesFromFirebase();
                } else {
                    console.error('‚úó Firebase library not loaded');
                }
            } catch (error) {
                console.error('‚úó Firebase initialization error:', error);
            }
        });

        // Application State
        const STATE = {
            currentView: 'home',
            currentUser: null,
            userType: null,
            trainees: [],
            currentSession: null,
            sessionActive: false,
            sessionId: null,
            accessLevel: 1,
            smsiAccessLevel: 1,

            // SDI State - 9 DAI et 9 DM (3 par zone)
            sdi: {
                systemState: 'service',
                batteryState: 'service',
                alarms: [],
                detectors: Array(9).fill().map((_, i) => ({
                    id: i + 1,
                    type: 'DAI',
                    zone: `ZC${Math.floor(i / 3) + 1}`,
                    address: `DAI ${Math.floor(i / 3) + 1}-${(i % 3) + 1}`,
                    state: 'service',
                    triggered: false
                })),
                manualAlarms: Array(9).fill().map((_, i) => ({
                    id: i + 1,
                    type: 'DM',
                    zone: `ZC${Math.floor(i / 3) + 1}`,
                    address: `DM ${Math.floor(i / 3) + 1}-${(i % 3) + 1}`,
                    state: 'service',
                    triggered: false
                })),
                alarmSound: false,
                fireAlarmActive: false
            },

            // SMSI State - 3 zones seulement
            smsi: {
                systemState: 'service',
                batteryState: 'service',
                alarmSound: false,
                messages: [],
                compartmentZones: Array(3).fill().map((_, i) => ({
                    id: i + 1,
                    zone: `ZC${i + 1}`,
                    address: `Compartiment Zone ${i + 1}`,
                    state: 'attente',
                    ledRed: { on: false, blink: false },
                    ledOrange: { on: false, blink: false },
                    ledGreen: { on: false, blink: false },
                    commandActive: false
                })),
                smokeZones: Array(3).fill().map((_, i) => ({
                    id: i + 1,
                    zone: `ZF${i + 1}`,
                    address: `D√©senfumage Zone ${i + 1}`,
                    state: 'attente',
                    ledRed: { on: false, blink: false },
                    ledOrange: { on: false, blink: false },
                    ledGreen: { on: false, blink: false },
                    commandActive: false
                })),
                relayBoxes: Array(3).fill().map((_, i) => ({
                    id: i + 1,
                    address: `Coffret ${i + 1}`,
                    state: 'attente',
                    ledRed: { on: false, blink: false },
                    ledOrange: { on: false, blink: false },
                    ledGreen: { on: false, blink: false },
                    commandActive: false,
                    stopped: false
                }))
            },

            // UGA State
            uga: {
                alarmType: 'generale',
                temporization: 0,
                temporizationActive: false,
                temporizationRemaining: 0,
                alarmActive: false
            },

            actionLog: []
        };

        // Communication via Firebase
        function sendMessage(type, data) {
            if (!firebaseInitialized || !STATE.sessionId) return;

            const messageRef = db.ref(`sessions/${STATE.sessionId}/messages`).push();
            messageRef.set({
                type,
                data,
                sender: STATE.userType,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function listenToSession(sessionId) {
            if (!firebaseInitialized) return;

            const messagesRef = db.ref(`sessions/${sessionId}/messages`);
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();

                if (message.sender === STATE.userType) return; // Ignore own messages

                if (STATE.userType === 'trainee') {
                    handleSupervisorCommand(message.type, message.data);
                } else if (STATE.userType === 'supervisor') {
                    handleTraineeAction(message.type, message.data);
                }
            });
        }

        // Session Management
        function createSession() {
            if (!firebaseInitialized) {
                showCustomAlert('Erreur: Firebase non disponible');
                return;
            }

            const sessionId = Date.now().toString();
            const sessionData = {
                id: sessionId,
                startTime: firebase.database.ServerValue.TIMESTAMP,
                endTime: null,
                active: true,
                supervisor: STATE.currentUser || 'Superviseur',
                trainees: {}
            };

            db.ref(`active_session`).set(sessionId);
            db.ref(`sessions/${sessionId}`).set(sessionData);

            STATE.sessionActive = true;
            STATE.sessionId = sessionId;

            listenToSession(sessionId);
            render();

            showCustomAlert('Session d√©marr√©e avec succ√®s !');
        }

        function endSession() {
            if (!STATE.sessionActive || !STATE.sessionId) return;

            showCustomConfirm('√ätes-vous s√ªr de vouloir terminer la session ?', () => {
                db.ref(`sessions/${STATE.sessionId}`).update({
                    endTime: firebase.database.ServerValue.TIMESTAMP,
                    active: false
                });

                db.ref(`active_session`).remove();

                STATE.sessionActive = false;
                STATE.sessionId = null;

                render();
                showCustomAlert('Session termin√©e.');
            });
        }

        function joinActiveSession() {
            if (!firebaseInitialized) return;

            db.ref('active_session').once('value', (snapshot) => {
                const sessionId = snapshot.val();

                if (sessionId) {
                    STATE.sessionId = sessionId;
                    STATE.sessionActive = true;

                    // Register trainee in session
                    if (STATE.currentUser) {
                        db.ref(`sessions/${sessionId}/trainees/${STATE.currentUser.id}`).set({
                            nom: STATE.currentUser.nom,
                            prenom: STATE.currentUser.prenom,
                            niveau: STATE.currentUser.niveau,
                            joinedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    }

                    listenToSession(sessionId);
                    render();
                } else {
                    showCustomAlert('Aucune session active. Le superviseur doit d\'abord d√©marrer une session.');
                    navigate('home');
                }
            });
        }

        function checkSessionBeforeAction() {
            if (STATE.userType === 'supervisor' && !STATE.sessionActive) {
                showCustomConfirm('Aucune session active. Voulez-vous d√©marrer une session maintenant ?', () => {
                    createSession();
                });
                return false;
            }
            return true;
        }

        // Warning before closing page
        window.addEventListener('beforeunload', (e) => {
            if (STATE.userType === 'supervisor' && STATE.sessionActive) {
                e.preventDefault();
                e.returnValue = 'Attention: La session est toujours active. Pensez √† terminer la session avant de quitter.';
                return e.returnValue;
            }
        });

        function logAction(action, details = '') {
            const log = {
                timestamp: new Date().toISOString(),
                trainee: STATE.currentUser?.prenom + ' ' + STATE.currentUser?.nom,
                action,
                details
            };
            STATE.actionLog.push(log);

            if (STATE.userType === 'trainee') {
                sendMessage('ACTION_LOG', log);
            }
        }

        function addSmsiMessage(message) {
            STATE.smsi.messages.push({
                text: message,
                timestamp: new Date().toISOString()
            });
        }

        function handleSupervisorCommand(type, data) {
            switch(type) {
                case 'SDI_STATE_CHANGE':
                    STATE.sdi.systemState = data.state;
                    break;
                case 'SDI_BATTERY_CHANGE':
                    STATE.sdi.batteryState = data.state;
                    break;
                case 'TRIGGER_DETECTOR':
                    // C√¥t√© stagiaire: jouer le son
                    triggerDetector(data.type, data.id, true);
                    break;
                case 'RESET_DETECTOR':
                    resetDetector(data.type, data.id);
                    break;
                case 'UPDATE_DETECTOR_ADDRESS':
                    updateDetectorAddress(data.type, data.id, data.address);
                    break;
                case 'SET_TEMPORIZATION':
                    STATE.uga.temporization = data.minutes;
                    break;
                case 'SET_ALARM_TYPE':
                    STATE.uga.alarmType = data.alarmType;
                    break;
                case 'SMSI_STATE_CHANGE':
                    STATE.smsi.systemState = data.state;
                    break;
                case 'SMSI_BATTERY_CHANGE':
                    STATE.smsi.batteryState = data.state;
                    break;
                case 'SET_ZONE_STATE':
                    setZoneState(data.zoneType, data.id, data.state);
                    break;
                case 'UPDATE_ZONE_ADDRESS':
                    updateZoneAddress(data.zoneType, data.id, data.address);
                    break;
            }
            render();
        }

        function handleTraineeAction(type, data) {
            if (type === 'ACTION_LOG') {
                STATE.actionLog.push(data);
            }
            render();
        }

        function updateDetectorAddress(type, id, address) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);
            if (detector) {
                detector.address = address;
            }
        }

        function updateZoneAddress(zoneType, id, address) {
            let zone;
            if (zoneType === 'compartment') {
                zone = STATE.smsi.compartmentZones.find(z => z.id === id);
            } else if (zoneType === 'smoke') {
                zone = STATE.smsi.smokeZones.find(z => z.id === id);
            } else if (zoneType === 'relay') {
                zone = STATE.smsi.relayBoxes.find(z => z.id === id);
            }
            if (zone) {
                zone.address = address;
            }
        }

        function triggerDetector(type, id, playSound = false) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);

            if (detector) {
                detector.triggered = true;
                STATE.sdi.fireAlarmActive = true;
                STATE.sdi.alarmSound = true;

                const alarm = `Alarme feu ${detector.address}`;
                STATE.sdi.alarms.push({
                    text: alarm,
                    timestamp: new Date().toISOString()
                });

                addSmsiMessage(`Alarme d√©tect√©e: ${detector.address}`);

                // Handle temporization or immediate alarm
                if (!STATE.uga.alarmActive) {
                    if (STATE.uga.temporization > 0 && !STATE.uga.temporizationActive) {
                        // Start temporization
                        STATE.uga.temporizationActive = true;
                        STATE.uga.temporizationRemaining = STATE.uga.temporization * 60;
                        startTemporization();
                    } else if (STATE.uga.temporization === 0) {
                        // No temporization: trigger alarm immediately
                        triggerGeneralAlarm();
                    }
                }

                // Jouer le son uniquement si demand√© (c√¥t√© stagiaire)
                if (playSound) {
                    playAlarmSound();
                }
                updateAllLeds();
            }
        }

        function resetDetector(type, id) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);

            if (detector) {
                detector.triggered = false;
            }
        }

        function setZoneState(zoneType, id, state) {
            let zone;
            if (zoneType === 'compartment') {
                zone = STATE.smsi.compartmentZones.find(z => z.id === id);
                if (zone) {
                    zone.state = state;
                    updateZoneLeds(zone);
                    addSmsiMessage(`${zone.address}: ${state}`);
                }
            } else if (zoneType === 'smoke') {
                zone = STATE.smsi.smokeZones.find(z => z.id === id);
                if (zone) {
                    zone.state = state;
                    updateZoneLeds(zone);
                    addSmsiMessage(`${zone.address}: ${state}`);
                }
            } else if (zoneType === 'relay') {
                zone = STATE.smsi.relayBoxes.find(z => z.id === id);
                if (zone) {
                    zone.state = state;
                    updateRelayLeds(zone);
                    addSmsiMessage(`${zone.address}: ${state}`);
                }
            }
        }

        function updateZoneLeds(zone) {
            // Reset all LEDs
            zone.ledRed = { on: false, blink: false };
            zone.ledOrange = { on: false, blink: false };
            zone.ledGreen = { on: false, blink: false };

            if (STATE.sdi.fireAlarmActive) {
                // En cas d'alarme incendie
                if (zone.state === 'securite') {
                    // Rouge fixe: alarme incendie + position de s√©curit√©
                    zone.ledRed = { on: true, blink: false };
                } else if (zone.state === 'defaut-securite') {
                    // Rouge clignotant: alarme incendie + d√©faut de position de s√©curit√©
                    zone.ledRed = { on: true, blink: true };
                }
            } else {
                // Pas d'alarme incendie
                switch(zone.state) {
                    case 'attente':
                        // Tous √©teints par d√©faut
                        break;
                    case 'defaut-alim':
                        // Orange clignotant: d√©faut de ligne
                        zone.ledOrange = { on: true, blink: true };
                        break;
                    case 'defaut-attente':
                        // Orange fixe: d√©faut de position d'attente
                        zone.ledOrange = { on: true, blink: false };
                        break;
                    case 'securite':
                        // Zone en s√©curit√© sans alarme
                        zone.ledGreen = { on: true, blink: false };
                        break;
                    case 'defaut-securite':
                        // D√©faut de s√©curit√© sans alarme
                        zone.ledRed = { on: true, blink: false };
                        break;
                }
            }
        }

        function updateRelayLeds(relay) {
            // Reset all LEDs
            relay.ledRed = { on: false, blink: false };
            relay.ledOrange = { on: false, blink: false };
            relay.ledGreen = { on: false, blink: false };

            if (STATE.sdi.fireAlarmActive) {
                // En cas d'alarme incendie
                if (relay.state === 'securite') {
                    // Rouge fixe: alarme incendie + position de s√©curit√©
                    relay.ledRed = { on: true, blink: false };
                } else if (relay.state === 'defaut-securite') {
                    // Rouge clignotant: alarme incendie + d√©faut de position de s√©curit√©
                    relay.ledRed = { on: true, blink: true };
                }
            } else {
                // Pas d'alarme incendie
                switch(relay.state) {
                    case 'attente':
                        // Tous √©teints par d√©faut
                        break;
                    case 'defaut-alim':
                        // Orange clignotant: d√©faut de ligne
                        relay.ledOrange = { on: true, blink: true };
                        break;
                    case 'defaut-attente':
                        // Orange fixe: d√©faut de position d'attente
                        relay.ledOrange = { on: true, blink: false };
                        break;
                    case 'securite':
                        // Zone en s√©curit√© sans alarme
                        relay.ledGreen = { on: true, blink: false };
                        break;
                    case 'defaut-securite':
                        // D√©faut de s√©curit√© sans alarme
                        relay.ledRed = { on: true, blink: false };
                        break;
                }
            }
        }

        function updateAllLeds() {
            [...STATE.smsi.compartmentZones, ...STATE.smsi.smokeZones].forEach(zone => {
                updateZoneLeds(zone);
            });
            STATE.smsi.relayBoxes.forEach(relay => {
                updateRelayLeds(relay);
            });
        }

        // Audio Context for alarm sounds
        let audioContext;
        let alarmOscillator;
        let generalAlarmOscillator;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playAlarmSound() {
            initAudio();
            if (alarmOscillator) return;

            alarmOscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            alarmOscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            alarmOscillator.frequency.value = 1000;
            gainNode.gain.value = 0.3;

            alarmOscillator.start();
        }

        function stopAlarmSound() {
            if (alarmOscillator) {
                alarmOscillator.stop();
                alarmOscillator = null;
                STATE.sdi.alarmSound = false;
                STATE.smsi.alarmSound = false;
                logAction('Arr√™t signal sonore');
            }
        }

        function playGeneralAlarm(type) {
            initAudio();
            if (generalAlarmOscillator) return;

            generalAlarmOscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            generalAlarmOscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'generale') {
                generalAlarmOscillator.frequency.value = 500;
            } else {
                generalAlarmOscillator.frequency.value = 700;
            }

            gainNode.gain.value = 0.2;
            generalAlarmOscillator.start();
        }

        function stopGeneralAlarm() {
            if (generalAlarmOscillator) {
                generalAlarmOscillator.stop();
                generalAlarmOscillator = null;
            }
        }

        let temporizationTimer;
        function startTemporization() {
            if (temporizationTimer) clearInterval(temporizationTimer);

            temporizationTimer = setInterval(() => {
                STATE.uga.temporizationRemaining--;

                if (STATE.uga.temporizationRemaining <= 0) {
                    clearInterval(temporizationTimer);
                    STATE.uga.temporizationActive = false;
                    triggerGeneralAlarm();
                }

                render();
            }, 1000);
        }

        function triggerGeneralAlarm() {
            STATE.uga.alarmActive = true;
            playGeneralAlarm(STATE.uga.alarmType);
            addSmsiMessage(`Alarme ${STATE.uga.alarmType} d√©clench√©e`);
            logAction('D√©clenchement alarme g√©n√©rale', STATE.uga.alarmType);
        }

        function forceGeneralAlarm() {
            if (STATE.uga.temporizationActive) {
                clearInterval(temporizationTimer);
                STATE.uga.temporizationActive = false;
            }
            if (!STATE.uga.alarmActive) {
                triggerGeneralAlarm();
            }
        }

        function acquitProcess() {
            if (STATE.uga.temporizationActive) {
                clearInterval(temporizationTimer);
                STATE.uga.temporizationActive = false;
                addSmsiMessage('Processus alarme acquitt√©');
                logAction('Acquit processus alarme');
            } else if (STATE.uga.alarmActive) {
                STATE.uga.alarmActive = false;
                stopGeneralAlarm();
                addSmsiMessage('Alarme g√©n√©rale arr√™t√©e');
                logAction('Arr√™t alarme g√©n√©rale');
            }
            render();
        }

        // System Reset functions
        function canResetSdiSystem() {
            if (STATE.accessLevel !== 2) return false;
            const allDMReset = STATE.sdi.manualAlarms.every(d => !d.triggered);
            return allDMReset;
        }

        function canResetSmsiSystem() {
            if (STATE.smsiAccessLevel !== 2) return false;
            const allZonesReady = [
                ...STATE.smsi.compartmentZones,
                ...STATE.smsi.smokeZones
            ].every(zone => zone.state === 'attente');
            return allZonesReady;
        }

        function resetSdiSystem() {
            if (!canResetSdiSystem()) {
                showCustomAlert('Impossible de r√©armer le SDI: niveau 2 requis et tous les DM doivent √™tre r√©arm√©s');
                return;
            }

            STATE.sdi.alarms = [];
            STATE.sdi.fireAlarmActive = false;
            STATE.sdi.alarmSound = false;
            STATE.sdi.detectors.forEach(d => d.triggered = false);
            STATE.sdi.manualAlarms.forEach(d => d.triggered = false);

            STATE.uga.alarmActive = false;
            STATE.uga.temporizationActive = false;
            STATE.uga.temporizationRemaining = 0;

            stopAlarmSound();
            stopGeneralAlarm();

            logAction('R√©armement SDI complet');
            render();
        }

        function resetSmsiSystem() {
            if (!canResetSmsiSystem()) {
                showCustomAlert('Impossible de r√©armer le SMSI: niveau 2 requis et tous les DAS en position d\'attente');
                return;
            }

            STATE.smsi.messages = [];
            STATE.smsi.alarmSound = false;
            STATE.smsi.compartmentZones.forEach(z => z.commandActive = false);
            STATE.smsi.smokeZones.forEach(z => z.commandActive = false);

            logAction('R√©armement SMSI complet');
            render();
        }

        // Custom modal dialogs
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button>
                        <button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" id="confirmBtn">Confirmer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#confirmBtn').onclick = () => {
                modal.remove();
                onConfirm();
            };
        }

        function showCustomPrompt(message, onSubmit, defaultValue = '') {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <input type="text" id="promptInput" value="${defaultValue}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-4">
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button>
                        <button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" id="submitBtn">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const input = modal.querySelector('#promptInput');
            input.focus();
            input.select();

            const submit = () => {
                const value = input.value;
                modal.remove();
                if (value) onSubmit(value);
            };

            modal.querySelector('#submitBtn').onclick = submit;
            input.onkeypress = (e) => {
                if (e.key === 'Enter') submit();
            };
        }

        function requestAccessCode(type, callback) {
            showCustomPrompt('Entrez le code d\'acc√®s niveau 2:', (code) => {
                if (code === '1234') {
                    if (type === 'sdi') {
                        STATE.accessLevel = 2;
                        logAction('Acc√®s niveau 2 SDI');
                    } else {
                        STATE.smsiAccessLevel = 2;
                        logAction('Acc√®s niveau 2 SMSI');
                    }
                    callback(true);
                } else {
                    showCustomAlert('Code incorrect');
                    callback(false);
                }
            });
        }

        // Trainee Management - Auto-import on startup
        let importOffered = false;

        function saveTrainees() {
            // Save to Firebase for multi-PC access
            if (firebaseInitialized) {
                db.ref('trainees').set(STATE.trainees);
            }
        }

        function loadTraineesFromFirebase() {
            if (!firebaseInitialized) return;

            db.ref('trainees').once('value', (snapshot) => {
                const trainees = snapshot.val();
                if (trainees) {
                    STATE.trainees = trainees;
                    render();
                }
            });

            // Listen for changes
            db.ref('trainees').on('value', (snapshot) => {
                const trainees = snapshot.val();
                if (trainees) {
                    STATE.trainees = trainees;
                    if (STATE.currentView === 'trainee-management' || STATE.currentView === 'trainee-login') {
                        render();
                    }
                }
            });
        }

        function autoImportOnStartup() {
            // Si Firebase est actif, les stagiaires sont d√©j√† charg√©s automatiquement
            if (firebaseInitialized) {
                // Pas besoin de demander l'import, tout est synchronis√© via Firebase
                return;
            }

            // Fallback: import manuel si Firebase n'est pas disponible
            if (STATE.trainees.length === 0 && !importOffered) {
                importOffered = true;
                setTimeout(() => {
                    showCustomConfirm('Voulez-vous importer le fichier stagiaires.json ?', () => {
                        importTrainees();
                    });
                }, 300);
            }
        }

        function printTraineeList() {
            if (STATE.trainees.length === 0) {
                showCustomAlert('Aucun stagiaire √† imprimer');
                return;
            }

            const printWindow = window.open('', '_blank');
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Liste des Stagiaires - Formation SSI SSIAP</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        h1 {
                            text-align: center;
                            color: #5D5CDE;
                            margin-bottom: 30px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td {
                            border: 1px solid #333;
                            padding: 12px;
                            text-align: left;
                        }
                        th {
                            background-color: #5D5CDE;
                            color: white;
                            font-weight: bold;
                        }
                        tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .pin {
                            font-weight: bold;
                            font-size: 18px;
                            letter-spacing: 2px;
                            color: #5D5CDE;
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 12px;
                            color: #666;
                        }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Liste des Stagiaires - Formation SSI SSIAP</h1>
                    <p>Date d'impression : ${new Date().toLocaleDateString('fr-FR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Pr√©nom</th>
                                <th>Email</th>
                                <th>Code PIN</th>
                                <th>Niveau</th>
                                <th>Dates</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${STATE.trainees.map(t => `
                                <tr>
                                    <td>${t.nom}</td>
                                    <td>${t.prenom}</td>
                                    <td>${t.email || 'N/A'}</td>
                                    <td class="pin">${t.pin}</td>
                                    <td>SSIAP ${t.niveau}</td>
                                    <td>${new Date(t.dateDebut).toLocaleDateString('fr-FR')} - ${new Date(t.dateFin).toLocaleDateString('fr-FR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>Formation SSI - SSIAP | Total : ${STATE.trainees.length} stagiaire(s)</p>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        function exportTrainees() {
            const dataStr = JSON.stringify(STATE.trainees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'stagiaires.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importTrainees() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            STATE.trainees = imported;
                            render();
                            showCustomAlert(`${imported.length} stagiaire(s) import√©(s) avec succ√®s`);
                        } else {
                            showCustomAlert('Format de fichier invalide');
                        }
                    } catch (error) {
                        showCustomAlert('Erreur lors de la lecture du fichier');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function checkTraineeAccess(trainee) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const dateDebut = new Date(trainee.dateDebut);
            dateDebut.setHours(0, 0, 0, 0);

            const dateFin = new Date(trainee.dateFin);
            dateFin.setHours(23, 59, 59, 999);

            return today >= dateDebut && today <= dateFin;
        }

        function createTrainee(data) {
            // Generate a unique 4-digit PIN
            let pin;
            do {
                pin = String(Math.floor(1000 + Math.random() * 9000));
            } while (STATE.trainees.some(t => t.pin === pin));

            const trainee = {
                id: Date.now(),
                nom: data.nom,
                prenom: data.prenom,
                email: data.email,
                niveau: data.niveau,
                dateDebut: data.dateDebut,
                dateFin: data.dateFin,
                pin: pin
            };

            STATE.trainees.push(trainee);
            saveTrainees();
            return trainee;
        }

        // Navigation
        function navigate(view, data = {}) {
            STATE.currentView = view;
            if (data.user) STATE.currentUser = data.user;
            if (data.userType) STATE.userType = data.userType;
            render();
        }

        // Rendering
        function render() {
            const app = document.getElementById('app');

            switch(STATE.currentView) {
                case 'home':
                    app.innerHTML = renderHome();
                    break;
                case 'supervisor-login':
                    app.innerHTML = renderSupervisorLogin();
                    break;
                case 'trainee-login':
                    app.innerHTML = renderTraineeLogin();
                    break;
                case 'trainee-management':
                    app.innerHTML = renderTraineeManagement();
                    autoImportOnStartup();
                    break;
                case 'create-trainee':
                    app.innerHTML = renderCreateTrainee();
                    break;
                case 'supervisor-interface':
                    app.innerHTML = renderSupervisorInterface();
                    break;
                case 'trainee-interface':
                    app.innerHTML = renderTraineeInterface();
                    break;
            }
        }

        function renderHome() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-2xl w-full">
                        <h1 class="text-4xl font-bold text-center mb-8 text-primary">Formation SSI - SSIAP</h1>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div onclick="navigate('supervisor-login')" class="cursor-pointer bg-gradient-to-br from-primary to-blue-600 p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105">
                                <h2 class="text-2xl font-bold text-white mb-4">üë®‚Äçüè´ Superviseur</h2>
                                <p class="text-white opacity-90">Cr√©er des sc√©narios et superviser les stagiaires</p>
                            </div>
                            <div onclick="navigate('trainee-login')" class="cursor-pointer bg-gradient-to-br from-green-500 to-green-600 p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105">
                                <h2 class="text-2xl font-bold text-white mb-4">üéì Stagiaire</h2>
                                <p class="text-white opacity-90">Se connecter et r√©aliser les exercices</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSupervisorLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Connexion Superviseur</h2>
                        <form onsubmit="handleSupervisorLogin(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Code superviseur</label>
                                <input type="password" id="supervisor-code" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">
                                Se connecter
                            </button>
                            <button type="button" onclick="navigate('home')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                Retour
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderTraineeLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Connexion Stagiaire</h2>
                        <form onsubmit="handleTraineePinLogin(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Code PIN (4 chiffres)</label>
                                <input type="password" id="trainee-pin" maxlength="4" pattern="[0-9]{4}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-center text-2xl tracking-widest" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">
                                Se connecter
                            </button>
                            <button type="button" onclick="navigate('home')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                Retour
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderTraineeManagement() {
            return `
                <div class="min-h-screen p-4">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold">Gestion des Stagiaires</h2>
                            <div class="space-x-2">
                                <button onclick="importTrainees()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
                                    üì• Importer
                                </button>
                                <button onclick="exportTrainees()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                    üì§ Exporter
                                </button>
                                <button onclick="printTraineeList()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">
                                    üñ®Ô∏è Imprimer
                                </button>
                                <button onclick="navigate('create-trainee')" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition">
                                    ‚ûï Cr√©er un stagiaire
                                </button>
                                <button onclick="navigate('supervisor-interface')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                    Retour
                                </button>
                            </div>
                        </div>
                        ${STATE.trainees.length > 0 && firebaseInitialized ? `
                        <div class="bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                üí° <strong>Info :</strong> Les stagiaires sont synchronis√©s automatiquement via le cloud. Accessibles depuis tous les PC !
                            </p>
                        </div>
                        ` : STATE.trainees.length > 0 ? `
                        <div class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-6">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                ‚ö†Ô∏è <strong>Mode local :</strong> Exportez r√©guli√®rement le fichier stagiaires.json comme sauvegarde.
                            </p>
                        </div>
                        ` : ''}
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${STATE.trainees.map(trainee => {
                                const isActive = checkTraineeAccess(trainee);
                                const dateDebut = new Date(trainee.dateDebut).toLocaleDateString('fr-FR');
                                const dateFin = new Date(trainee.dateFin).toLocaleDateString('fr-FR');
                                return `
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg ${isActive ? 'border-2 border-green-500' : 'border-2 border-gray-400 opacity-75'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-xl font-bold">${trainee.prenom} ${trainee.nom}</h3>
                                        <span class="px-2 py-1 rounded text-xs font-bold ${isActive ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'}">
                                            ${isActive ? '‚úì Actif' : '‚úó Inactif'}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                                        Email: ${trainee.email || 'N/A'}<br>
                                        Niveau: SSIAP ${trainee.niveau}<br>
                                        Du ${dateDebut} au ${dateFin}
                                    </p>
                                    <div class="bg-primary text-white p-4 rounded-lg mb-4 text-center">
                                        <div class="text-xs mb-1">Code PIN</div>
                                        <div class="text-3xl font-bold tracking-widest">${trainee.pin}</div>
                                    </div>
                                    <button onclick="deleteTrainee(${trainee.id})" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
                                        Supprimer
                                    </button>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCreateTrainee() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Cr√©er un Stagiaire</h2>
                        <form onsubmit="handleCreateTrainee(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Nom</label>
                                <input type="text" id="nom" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Pr√©nom</label>
                                <input type="text" id="prenom" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="email" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Niveau SSIAP</label>
                                <select id="niveau" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                                    <option value="1">SSIAP 1</option>
                                    <option value="2">SSIAP 2</option>
                                    <option value="3">SSIAP 3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Date d√©but</label>
                                <input type="date" id="dateDebut" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Date fin</label>
                                <input type="date" id="dateFin" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">
                                Cr√©er
                            </button>
                            <button type="button" onclick="navigate('trainee-management')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                Annuler
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderSupervisorInterface() {
            return `
                <div class="min-h-screen p-4 bg-gray-100 dark:bg-gray-900">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold">Interface Superviseur</h2>
                            <div class="space-x-2">
                                ${!STATE.sessionActive ? `
                                    <button onclick="createSession()" class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition font-bold">
                                        üöÄ D√©but de session
                                    </button>
                                ` : `
                                    <button onclick="endSession()" class="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition font-bold">
                                        ‚èπÔ∏è Fin de session
                                    </button>
                                `}
                                <button onclick="navigate('trainee-management')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                    üìã Gestion stagiaires
                                </button>
                                <button onclick="navigate('home')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                    D√©connexion
                                </button>
                            </div>
                        </div>

                        ${STATE.sessionActive ? `
                        <div class="bg-green-100 dark:bg-green-900 border-l-4 border-green-500 p-4 mb-6">
                            <p class="text-sm text-green-800 dark:text-green-200">
                                ‚úÖ <strong>Session active</strong> - Les stagiaires peuvent maintenant se connecter et travailler en temps r√©el.
                            </p>
                        </div>
                        ` : `
                        <div class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-6">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                ‚ö†Ô∏è <strong>Aucune session active</strong> - Cliquez sur "üöÄ D√©but de session" pour commencer.
                            </p>
                        </div>
                        `}

                        <!-- SDI Controls -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6">
                            <h3 class="text-2xl font-bold mb-4 text-primary">üî• Contr√¥le SDI</h3>

                                <div class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">√âtat syst√®me</label>
                                            <select onchange="changeSdiState(this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="service" ${STATE.sdi.systemState === 'service' ? 'selected' : ''}>En service</option>
                                                <option value="hors-service" ${STATE.sdi.systemState === 'hors-service' ? 'selected' : ''}>Hors service</option>
                                                <option value="hors-tension" ${STATE.sdi.systemState === 'hors-tension' ? 'selected' : ''}>Hors tension</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium mb-2">Batterie</label>
                                            <select onchange="changeSdiBattery(this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="service" ${STATE.sdi.batteryState === 'service' ? 'selected' : ''}>En service</option>
                                                <option value="hors-service" ${STATE.sdi.batteryState === 'hors-service' ? 'selected' : ''}>Hors service</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium mb-2">Temporisation</label>
                                            <select onchange="setTemporization(this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                ${[0,1,2,3,4,5].map(m => `<option value="${m}" ${STATE.uga.temporization === m ? 'selected' : ''}>${m} min</option>`).join('')}
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium mb-2">Type alarme</label>
                                            <select onchange="setAlarmType(this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="generale" ${STATE.uga.alarmType === 'generale' ? 'selected' : ''}>G√©n√©rale</option>
                                                <option value="generale-restreinte" ${STATE.uga.alarmType === 'generale-restreinte' ? 'selected' : ''}>G√©n√©rale restreinte</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- DAI et DM c√¥te √† c√¥te -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <h4 class="font-bold mb-2">üîç DAI</h4>
                                            ${STATE.sdi.detectors.map(d => `
                                                <div class="flex items-center gap-2 mb-2">
                                                    <button onclick="${d.state === 'service' ? `toggleDetector('DAI', ${d.id})` : ''}" class="w-12 h-12 ${d.triggered ? 'bg-red-500' : 'bg-green-500'} rounded-lg border-3 border-black ${d.state === 'hors-service' ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-90 cursor-pointer shadow-lg'} flex-shrink-0 font-bold text-white"></button>
                                                    <span class="text-sm font-mono w-14 flex-shrink-0 font-bold">DAI${String(d.id).padStart(2, '0')}</span>
                                                    <select onchange="changeDetectorZone('DAI', ${d.id}, this.value)" class="px-2 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                        <option value="ZC1" ${d.zone === 'ZC1' ? 'selected' : ''}>ZC1</option>
                                                        <option value="ZC2" ${d.zone === 'ZC2' ? 'selected' : ''}>ZC2</option>
                                                        <option value="ZC3" ${d.zone === 'ZC3' ? 'selected' : ''}>ZC3</option>
                                                    </select>
                                                    <input type="text" value="${d.address.replace(/^(DAI|DM)\s*\d*-?\d*\s*/, '').trim()}" placeholder="Adresse" onchange="updateDetectorAddressInput('DAI', ${d.id}, this.value)" class="flex-1 px-2 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                    <select onchange="changeDetectorState('DAI', ${d.id}, this.value)" class="px-2 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                        <option value="service" ${d.state === 'service' ? 'selected' : ''}>OK</option>
                                                        <option value="hors-service" ${d.state === 'hors-service' ? 'selected' : ''}>HS</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>

                                        <div>
                                            <h4 class="font-bold mb-2">üö® DM</h4>
                                            ${STATE.sdi.manualAlarms.map(d => `
                                                <div class="flex items-center gap-2 mb-2">
                                                    <button onclick="${d.state === 'service' ? `toggleDetector('DM', ${d.id})` : ''}" class="w-12 h-12 ${d.triggered ? 'bg-red-500' : 'bg-green-500'} rounded-lg border-3 border-black ${d.state === 'hors-service' ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-90 cursor-pointer shadow-lg'} flex-shrink-0 font-bold text-white"></button>
                                                    <span class="text-sm font-mono w-12 flex-shrink-0 font-bold">DM${String(d.id).padStart(2, '0')}</span>
                                                    <select onchange="changeDetectorZone('DM', ${d.id}, this.value)" class="px-2 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                        <option value="ZC1" ${d.zone === 'ZC1' ? 'selected' : ''}>ZC1</option>
                                                        <option value="ZC2" ${d.zone === 'ZC2' ? 'selected' : ''}>ZC2</option>
                                                        <option value="ZC3" ${d.zone === 'ZC3' ? 'selected' : ''}>ZC3</option>
                                                    </select>
                                                    <input type="text" value="${d.address.replace(/^(DAI|DM)\s*\d*-?\d*\s*/, '').trim()}" placeholder="Adresse" onchange="updateDetectorAddressInput('DM', ${d.id}, this.value)" class="flex-1 px-2 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                    <select onchange="changeDetectorState('DM', ${d.id}, this.value)" class="px-2 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                        <option value="service" ${d.state === 'service' ? 'selected' : ''}>OK</option>
                                                        <option value="hors-service" ${d.state === 'hors-service' ? 'selected' : ''}>HS</option>
                                                    </select>
                                                    <button onclick="resetDM(${d.id})" class="px-3 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 flex-shrink-0 font-bold">‚Üª</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                        </div>

                        <!-- SMSI Controls -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6">
                            <h3 class="text-2xl font-bold mb-4 text-primary">üõ°Ô∏è Contr√¥le SMSI</h3>

                                <div class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">√âtat syst√®me</label>
                                            <select onchange="changeSmsiState(this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="service" ${STATE.smsi.systemState === 'service' ? 'selected' : ''}>En service</option>
                                                <option value="hors-service" ${STATE.smsi.systemState === 'hors-service' ? 'selected' : ''}>Hors service</option>
                                                <option value="hors-tension" ${STATE.smsi.systemState === 'hors-tension' ? 'selected' : ''}>Hors tension</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium mb-2">Batterie</label>
                                            <select onchange="changeSmsBattery(this.value)" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="service" ${STATE.smsi.batteryState === 'service' ? 'selected' : ''}>En service</option>
                                                <option value="hors-service" ${STATE.smsi.batteryState === 'hors-service' ? 'selected' : ''}>Hors service</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- ZC, ZF et Coffrets c√¥te √† c√¥te -->
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <h4 class="font-bold mb-2 text-xs">üö™ ZC</h4>
                                            ${STATE.smsi.compartmentZones.map(z => `
                                                <div class="flex flex-col gap-1 mb-2">
                                                    <div class="flex items-center gap-1">
                                                        <span class="text-xs font-mono font-bold">${z.zone}</span>
                                                        <select onchange="changeZoneState('compartment', ${z.id}, this.value)" class="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                            <option value="attente" ${z.state === 'attente' ? 'selected' : ''}>Attente</option>
                                                            <option value="defaut-attente" ${z.state === 'defaut-attente' ? 'selected' : ''}>D√©faut position attente</option>
                                                            <option value="securite" ${z.state === 'securite' ? 'selected' : ''}>En s√©curit√©</option>
                                                            <option value="defaut-securite" ${z.state === 'defaut-securite' ? 'selected' : ''}>D√©faut position de s√©curit√©</option>
                                                            <option value="defaut-alim" ${z.state === 'defaut-alim' ? 'selected' : ''}>D√©faut alimentation</option>
                                                        </select>
                                                    </div>
                                                    <input type="text" value="${z.address.replace(/^Compartiment Zone \d+/, '').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('compartment', ${z.id}, this.value || 'Compart. Z${z.id}')" class="w-full px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                </div>
                                            `).join('')}
                                        </div>

                                        <div>
                                            <h4 class="font-bold mb-2 text-xs">üí® ZF</h4>
                                            ${STATE.smsi.smokeZones.map(z => `
                                                <div class="flex flex-col gap-1 mb-2">
                                                    <div class="flex items-center gap-1">
                                                        <span class="text-xs font-mono font-bold">${z.zone}</span>
                                                        <select onchange="changeZoneState('smoke', ${z.id}, this.value)" class="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                            <option value="attente" ${z.state === 'attente' ? 'selected' : ''}>Attente</option>
                                                            <option value="defaut-attente" ${z.state === 'defaut-attente' ? 'selected' : ''}>D√©faut position attente</option>
                                                            <option value="securite" ${z.state === 'securite' ? 'selected' : ''}>En s√©curit√©</option>
                                                            <option value="defaut-securite" ${z.state === 'defaut-securite' ? 'selected' : ''}>D√©faut position de s√©curit√©</option>
                                                            <option value="defaut-alim" ${z.state === 'defaut-alim' ? 'selected' : ''}>D√©faut alimentation</option>
                                                        </select>
                                                    </div>
                                                    <input type="text" value="${z.address.replace(/^D√©senfumage Zone \d+/, '').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('smoke', ${z.id}, this.value || 'D√©senf. Z${z.id}')" class="w-full px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                </div>
                                            `).join('')}
                                        </div>

                                        <div>
                                            <h4 class="font-bold mb-2 text-xs">‚ö° Coffrets</h4>
                                            ${STATE.smsi.relayBoxes.map(r => `
                                                <div class="flex flex-col gap-1 mb-2">
                                                    <div class="flex items-center gap-1">
                                                        <span class="text-xs font-mono font-bold">CR${r.id}</span>
                                                        <select onchange="changeZoneState('relay', ${r.id}, this.value)" class="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                            <option value="attente" ${r.state === 'attente' ? 'selected' : ''}>Attente</option>
                                                            <option value="defaut-attente" ${r.state === 'defaut-attente' ? 'selected' : ''}>D√©faut position attente</option>
                                                            <option value="securite" ${r.state === 'securite' ? 'selected' : ''}>En s√©curit√©</option>
                                                            <option value="defaut-securite" ${r.state === 'defaut-securite' ? 'selected' : ''}>D√©faut position de s√©curit√©</option>
                                                            <option value="defaut-alim" ${r.state === 'defaut-alim' ? 'selected' : ''}>D√©faut alimentation</option>
                                                        </select>
                                                    </div>
                                                    <input type="text" value="${r.address.replace(/^Coffret \d+/, '').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('relay', ${r.id}, this.value || 'Coffret ${r.id}')" class="w-full px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Log -->
                        <div class="mt-6 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-primary">üìã Journal des actions du stagiaire</h3>
                            <div class="ssi-screen max-h-96 overflow-y-auto">
                                ${STATE.actionLog.length === 0 ?
                                    '<div class="text-center opacity-50">Aucune action enregistr√©e</div>' :
                                    STATE.actionLog.slice(-20).reverse().map(log => `
                                        <div class="mb-2 pb-2 border-b border-green-900">
                                            <div class="text-xs opacity-75">${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                                            <div>${log.trainee}: <span class="text-yellow-400">${log.action}</span></div>
                                            ${log.details ? `<div class="text-sm opacity-75">${log.details}</div>` : ''}
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTraineeInterface() {
            return `
                <div class="min-h-screen p-2 bg-gray-100 dark:bg-gray-900">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h2 class="text-2xl font-bold">SSI - Formation</h2>
                                <p class="text-xs text-gray-600 dark:text-gray-400">
                                    ${STATE.currentUser?.prenom} ${STATE.currentUser?.nom} - SSIAP ${STATE.currentUser?.niveau}
                                </p>
                            </div>
                            <button onclick="navigate('home')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition text-sm">
                                D√©connexion
                            </button>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-4">
                            <!-- SDI Panel -->
                            <div class="ssi-panel">
                                <h3 class="text-xl font-bold mb-3 text-white">üî• SDI</h3>

                                <!-- ECS Screen -->
                                <div class="mb-3">
                                    <div class="text-white text-xs font-bold mb-1">üìü ECS</div>
                                    <div class="ssi-screen max-h-32 overflow-y-auto text-xs">
                                        ${STATE.sdi.alarms.length === 0 ?
                                            '<div class="text-center">SYST√àME EN VEILLE</div>' :
                                            STATE.sdi.alarms.slice(-5).map(alarm => `
                                                <div class="mb-1">${alarm.text}</div>
                                            `).join('')
                                        }
                                    </div>
                                </div>

                                <!-- Status Indicators -->
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div class="bg-gray-800 p-2 rounded">
                                        <div class="text-white text-xs mb-1">√âtat mat√©riel</div>
                                        <span class="led-light ${STATE.sdi.systemState === 'service' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                    <div class="bg-gray-800 p-2 rounded">
                                        <div class="text-white text-xs mb-1">Batterie</div>
                                        <span class="led-light ${STATE.sdi.batteryState === 'service' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                </div>

                                <!-- Fire Alarm with Sound Control -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-white text-xs font-bold">ALARME FEU</span>
                                        <div class="flex items-center gap-2">
                                            <span class="led-light ${STATE.sdi.fireAlarmActive ? 'led-red blink' : 'led-off'}"></span>
                                            ${STATE.sdi.alarmSound ? `
                                                <button onclick="traineeStopAlarmSound()" class="px-2 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                                    üîá ARR√äT
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>

                                <!-- Access Level & Reset on same line -->
                                <div class="flex gap-2 mb-2">
                                    <button onclick="toggleAccessLevel('sdi')" class="px-3 py-1 ${STATE.accessLevel === 1 ? 'bg-green-600' : 'bg-yellow-600'} text-white rounded text-xs hover:opacity-90">
                                        Niv.${STATE.accessLevel}
                                    </button>
                                    <div class="key-switch ${STATE.accessLevel === 2 ? 'active' : ''}" onclick="toggleAccessLevel('sdi')">
                                        üîë
                                    </div>
                                    <button onclick="traineeResetSdiSystem()" class="flex-1 px-3 py-1 ${canResetSdiSystem() ? 'bg-green-600' : 'bg-gray-600 opacity-50'} text-white rounded text-xs">
                                        üîÑ R√âARMEMENT SDI
                                    </button>
                                </div>
                            </div>

                            <!-- SMSI Panel -->
                            <div class="ssi-panel">
                                <h3 class="text-xl font-bold mb-3 text-white">üõ°Ô∏è SMSI</h3>

                                <!-- SMSI Screen -->
                                <div class="mb-3">
                                    <div class="text-white text-xs font-bold mb-1">üìü Remont√©es SMSI</div>
                                    <div class="ssi-screen max-h-32 overflow-y-auto text-xs">
                                        ${STATE.smsi.messages.length === 0 ?
                                            '<div class="text-center">SYST√àME EN VEILLE</div>' :
                                            STATE.smsi.messages.slice(-5).map(msg => `
                                                <div class="mb-1">${msg.text}</div>
                                            `).join('')
                                        }
                                    </div>
                                </div>

                                <!-- Status Indicators -->
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div class="bg-gray-800 p-2 rounded">
                                        <div class="text-white text-xs mb-1">√âtat mat√©riel</div>
                                        <span class="led-light ${STATE.smsi.systemState === 'service' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                    <div class="bg-gray-800 p-2 rounded">
                                        <div class="text-white text-xs mb-1">Batterie</div>
                                        <span class="led-light ${STATE.smsi.batteryState === 'service' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                </div>

                                <!-- UGA - Simplified -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="text-white font-bold mb-2 text-xs">üîî UGA</div>

                                    ${STATE.uga.temporizationActive ? `
                                        <div class="bg-yellow-600 text-white p-2 rounded mb-2 text-center font-bold text-xs">
                                            ‚è±Ô∏è ${Math.floor(STATE.uga.temporizationRemaining / 60)}:${String(STATE.uga.temporizationRemaining % 60).padStart(2, '0')}
                                        </div>
                                    ` : ''}

                                    <div class="grid grid-cols-2 gap-1">
                                        <button id="forceAlarmBtn" onmousedown="startForceAlarm()" onmouseup="cancelForceAlarm()" ontouchstart="startForceAlarm()" ontouchend="cancelForceAlarm()" class="px-2 py-2 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                            üö® FORC√â (3s)
                                        </button>
                                        <button onclick="traineeAcquitProcess()" class="px-2 py-2 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                            ‚úã ACQUIT
                                        </button>
                                    </div>

                                    ${STATE.uga.alarmActive ? `
                                        <div class="mt-2 bg-red-600 text-white p-2 rounded text-center font-bold text-xs blink">
                                            üö® ALARME ${STATE.uga.alarmType === 'generale' ? 'G√âN√âRALE' : 'RESTREINTE'}
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- UCMC - Side by side -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="text-white font-bold mb-2 text-xs">üéõÔ∏è UCMC</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <!-- Compartimentage -->
                                        <div class="pr-2 border-r border-gray-600">
                                            <div class="text-white text-xs mb-1">üö™ ZC</div>
                                            ${STATE.smsi.compartmentZones.map(z => `
                                                <div class="flex items-center gap-1 mb-1">
                                                    <span class="text-white text-xs font-bold w-6 flex-shrink-0">${z.zone}</span>
                                                    <span class="led-light ${z.ledRed.on ? 'led-red' : 'led-off'} ${z.ledRed.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${z.ledOrange.on ? 'led-orange' : 'led-off'} ${z.ledOrange.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${z.ledGreen.on ? 'led-green' : 'led-off'} ${z.ledGreen.blink ? 'blink' : ''}"></span>
                                                    <span class="text-white text-xs opacity-75 truncate flex-1">${z.address}</span>
                                                    <button onclick="commandZone('compartment', ${z.id})" class="px-1 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 flex-shrink-0">CMD</button>
                                                    <span class="command-led ${z.commandActive ? 'active' : ''}"></span>
                                                </div>
                                            `).join('')}
                                        </div>

                                        <!-- D√©senfumage -->
                                        <div class="pl-2">
                                            <div class="text-white text-xs mb-1">üí® ZF</div>
                                            ${STATE.smsi.smokeZones.map(z => `
                                                <div class="flex items-center gap-1 mb-1">
                                                    <span class="text-white text-xs font-bold w-6 flex-shrink-0">${z.zone}</span>
                                                    <span class="led-light ${z.ledRed.on ? 'led-red' : 'led-off'} ${z.ledRed.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${z.ledOrange.on ? 'led-orange' : 'led-off'} ${z.ledOrange.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${z.ledGreen.on ? 'led-green' : 'led-off'} ${z.ledGreen.blink ? 'blink' : ''}"></span>
                                                    <span class="text-white text-xs opacity-75 truncate flex-1">${z.address}</span>
                                                    <button onclick="commandZone('smoke', ${z.id})" class="px-1 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 flex-shrink-0">CMD</button>
                                                    <span class="command-led ${z.commandActive ? 'active' : ''}"></span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- Coffrets de relayage (moved from US) -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="text-white font-bold mb-2 text-xs">‚ö° Coffrets relayage</div>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${STATE.smsi.relayBoxes.map(r => `
                                            <div class="flex flex-col gap-1">
                                                <div class="flex items-center gap-1 justify-center">
                                                    <span class="text-white text-xs font-bold">CR${r.id}</span>
                                                    <span class="led-light ${r.ledRed.on ? 'led-red' : 'led-off'} ${r.ledRed.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${r.ledOrange.on ? 'led-orange' : 'led-off'} ${r.ledOrange.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${r.ledGreen.on ? 'led-green' : 'led-off'} ${r.ledGreen.blink ? 'blink' : ''}"></span>
                                                </div>
                                                <div class="text-white text-xs opacity-75 text-center truncate w-full mb-1">${r.address}</div>
                                                <button onclick="stopRelay(${r.id})" class="w-full px-1 py-1 ${r.stopped ? 'bg-red-600' : 'bg-orange-600'} text-white rounded text-xs hover:opacity-90">
                                                    ${r.stopped ? 'ARR√äT√â' : 'ARR√äT'}
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- US - Simplified -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="text-white font-bold mb-2 text-xs">üí° US</div>
                                    <div class="grid grid-cols-2 gap-1">
                                        <button onclick="testSignalization()" class="px-2 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                            üß™ TEST
                                        </button>
                                        <button onclick="bilanSystem()" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                            üìä BILAN
                                        </button>
                                    </div>
                                </div>

                                <!-- SMSI Reset -->
                                <div class="flex gap-2">
                                    <button onclick="toggleAccessLevel('smsi')" class="px-3 py-1 ${STATE.smsiAccessLevel === 1 ? 'bg-green-600' : 'bg-yellow-600'} text-white rounded text-xs hover:opacity-90">
                                        Niv.${STATE.smsiAccessLevel}
                                    </button>
                                    <div class="key-switch ${STATE.smsiAccessLevel === 2 ? 'active' : ''}" onclick="toggleAccessLevel('smsi')">
                                        üîë
                                    </div>
                                    <button onclick="traineeResetSmsiSystem()" class="flex-1 px-3 py-1 ${canResetSmsiSystem() ? 'bg-green-600' : 'bg-gray-600 opacity-50'} text-white rounded text-xs">
                                        üîÑ R√âARMEMENT SMSI
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event Handlers
        function handleSupervisorLogin(event) {
            event.preventDefault();
            const code = document.getElementById('supervisor-code').value;

            if (code === '1234') {
                navigate('supervisor-interface', { userType: 'supervisor' });
            } else {
                showCustomAlert('Code superviseur incorrect');
            }
        }

        function handleTraineePinLogin(event) {
            event.preventDefault();
            const pin = document.getElementById('trainee-pin').value;

            const trainee = STATE.trainees.find(t => t.pin === pin);
            if (!trainee) {
                showCustomAlert('Code PIN incorrect');
                return;
            }

            // V√©rifier les dates d'autorisation
            if (!checkTraineeAccess(trainee)) {
                const dateDebut = new Date(trainee.dateDebut).toLocaleDateString('fr-FR');
                const dateFin = new Date(trainee.dateFin).toLocaleDateString('fr-FR');
                showCustomAlert(`Acc√®s refus√©. Votre formation est autoris√©e du ${dateDebut} au ${dateFin}.`);
                return;
            }

            navigate('trainee-interface', { user: trainee, userType: 'trainee' });

            // Rejoindre automatiquement la session active
            setTimeout(() => {
                joinActiveSession();
            }, 500);
        }

        function handleCreateTrainee(event) {
            event.preventDefault();

            const data = {
                nom: document.getElementById('nom').value,
                prenom: document.getElementById('prenom').value,
                email: document.getElementById('email').value,
                niveau: document.getElementById('niveau').value,
                dateDebut: document.getElementById('dateDebut').value,
                dateFin: document.getElementById('dateFin').value
            };

            createTrainee(data);
            navigate('trainee-management');

            // Auto-export uniquement si Firebase n'est pas disponible
            if (!firebaseInitialized) {
                setTimeout(() => {
                    exportTrainees();
                    showCustomAlert('Stagiaire cr√©√© ! Le fichier stagiaires.json a √©t√© t√©l√©charg√© automatiquement.');
                }, 100);
            } else {
                setTimeout(() => {
                    showCustomAlert('Stagiaire cr√©√© et synchronis√© avec le cloud !');
                }, 100);
            }
        }

        function deleteTrainee(id) {
            showCustomConfirm('√ätes-vous s√ªr de vouloir supprimer ce stagiaire ?', () => {
                STATE.trainees = STATE.trainees.filter(t => t.id !== id);
                saveTrainees();
                render();

                // Auto-export uniquement si Firebase n'est pas disponible
                if (!firebaseInitialized && STATE.trainees.length > 0) {
                    setTimeout(() => {
                        exportTrainees();
                        showCustomAlert('Stagiaire supprim√© ! Le fichier stagiaires.json a √©t√© mis √† jour.');
                    }, 100);
                } else if (firebaseInitialized) {
                    setTimeout(() => {
                        showCustomAlert('Stagiaire supprim√© et synchronis√© avec le cloud !');
                    }, 100);
                }
            });
        }

        // Supervisor Controls
        function changeSdiState(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.sdi.systemState = state;
            sendMessage('SDI_STATE_CHANGE', { state });
        }

        function changeSdiBattery(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.sdi.batteryState = state;
            sendMessage('SDI_BATTERY_CHANGE', { state });
        }

        function setTemporization(minutes) {
            if (!checkSessionBeforeAction()) return;
            STATE.uga.temporization = parseInt(minutes);
            sendMessage('SET_TEMPORIZATION', { minutes: parseInt(minutes) });
        }

        function setAlarmType(type) {
            if (!checkSessionBeforeAction()) return;
            STATE.uga.alarmType = type;
            sendMessage('SET_ALARM_TYPE', { alarmType: type });
        }

        function toggleDetector(type, id) {
            if (!checkSessionBeforeAction()) return;
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);

            if (detector.triggered) {
                resetDetector(type, id);
                sendMessage('RESET_DETECTOR', { type, id });
            } else {
                // C√¥t√© superviseur: ne pas jouer le son (playSound = false)
                triggerDetector(type, id, false);
                sendMessage('TRIGGER_DETECTOR', { type, id });
            }

            render();
        }

        function resetDM(id) {
            resetDetector('DM', id);
            sendMessage('RESET_DETECTOR', { type: 'DM', id });
            render();
        }

        function changeDetectorState(type, id, state) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);
            detector.state = state;
            render();
        }

        function changeDetectorZone(type, id, zone) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);
            detector.zone = zone;
            render();
        }

        function updateDetectorAddressInput(type, id, address) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);
            if (detector) {
                detector.address = address;
            }
            sendMessage('UPDATE_DETECTOR_ADDRESS', { type, id, address });
            render();
        }

        function changeSmsiState(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.smsi.systemState = state;
            sendMessage('SMSI_STATE_CHANGE', { state });
        }

        function changeSmsBattery(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.smsi.batteryState = state;
            sendMessage('SMSI_BATTERY_CHANGE', { state });
        }

        function changeZoneState(zoneType, id, state) {
            if (!checkSessionBeforeAction()) return;
            setZoneState(zoneType, id, state);
            sendMessage('SET_ZONE_STATE', { zoneType, id, state });
            render();
        }

        function updateZoneAddressInput(zoneType, id, address) {
            updateZoneAddress(zoneType, id, address);
            sendMessage('UPDATE_ZONE_ADDRESS', { zoneType, id, address });
        }

        // Trainee Controls
        function traineeStopAlarmSound() {
            stopAlarmSound();
            render();
        }

        function toggleAccessLevel(type) {
            if (type === 'sdi') {
                if (STATE.accessLevel === 1) {
                    requestAccessCode('sdi', (success) => {
                        if (success) render();
                    });
                } else {
                    STATE.accessLevel = 1;
                    logAction('Retour niveau 1 SDI');
                    render();
                }
            } else {
                if (STATE.smsiAccessLevel === 1) {
                    requestAccessCode('smsi', (success) => {
                        if (success) render();
                    });
                } else {
                    STATE.smsiAccessLevel = 1;
                    logAction('Retour niveau 1 SMSI');
                    render();
                }
            }
        }

        function traineeResetSdiSystem() {
            resetSdiSystem();
        }

        function traineeResetSmsiSystem() {
            resetSmsiSystem();
        }

        let forceAlarmTimeout;
        function startForceAlarm() {
            forceAlarmTimeout = setTimeout(() => {
                forceGeneralAlarm();
                render();
            }, 3000);
        }

        function cancelForceAlarm() {
            if (forceAlarmTimeout) {
                clearTimeout(forceAlarmTimeout);
                forceAlarmTimeout = null;
            }
        }

        function traineeAcquitProcess() {
            acquitProcess();
        }

        function commandZone(zoneType, id) {
            let zone;
            if (zoneType === 'compartment') {
                zone = STATE.smsi.compartmentZones.find(z => z.id === id);
                addSmsiMessage(`Commande fermeture ${zone.address}`);
                logAction(`Commande fermeture ${zone.address}`);
            } else {
                zone = STATE.smsi.smokeZones.find(z => z.id === id);
                addSmsiMessage(`Commande d√©marrage ${zone.address}`);
                logAction(`Commande d√©marrage ${zone.address}`);
            }
            zone.commandActive = true;
            render();

            setTimeout(() => {
                zone.commandActive = false;
                render();
            }, 2000);
        }

        function testSignalization() {
            logAction('Test de signalisation');

            // Sauvegarder les √©tats originaux
            const originalZones = STATE.smsi.compartmentZones.map(z => ({
                ledRed: {...z.ledRed},
                ledOrange: {...z.ledOrange},
                ledGreen: {...z.ledGreen}
            }));
            const originalSmokeZones = STATE.smsi.smokeZones.map(z => ({
                ledRed: {...z.ledRed},
                ledOrange: {...z.ledOrange},
                ledGreen: {...z.ledGreen}
            }));
            const originalRelays = STATE.smsi.relayBoxes.map(r => ({
                ledRed: {...r.ledRed},
                ledOrange: {...r.ledOrange},
                ledGreen: {...r.ledGreen}
            }));

            // Allumer tous les voyants (rouge, orange, vert pour tous)
            STATE.smsi.compartmentZones.forEach(z => {
                z.ledRed = { on: true, blink: false };
                z.ledOrange = { on: true, blink: false };
                z.ledGreen = { on: true, blink: false };
            });
            STATE.smsi.smokeZones.forEach(z => {
                z.ledRed = { on: true, blink: false };
                z.ledOrange = { on: true, blink: false };
                z.ledGreen = { on: true, blink: false };
            });
            STATE.smsi.relayBoxes.forEach(r => {
                r.ledRed = { on: true, blink: false };
                r.ledOrange = { on: true, blink: false };
                r.ledGreen = { on: true, blink: false };
            });

            render();

            // Restaurer les √©tats apr√®s 2 secondes
            setTimeout(() => {
                STATE.smsi.compartmentZones.forEach((z, i) => {
                    z.ledRed = originalZones[i].ledRed;
                    z.ledOrange = originalZones[i].ledOrange;
                    z.ledGreen = originalZones[i].ledGreen;
                });
                STATE.smsi.smokeZones.forEach((z, i) => {
                    z.ledRed = originalSmokeZones[i].ledRed;
                    z.ledOrange = originalSmokeZones[i].ledOrange;
                    z.ledGreen = originalSmokeZones[i].ledGreen;
                });
                STATE.smsi.relayBoxes.forEach((r, i) => {
                    r.ledRed = originalRelays[i].ledRed;
                    r.ledOrange = originalRelays[i].ledOrange;
                    r.ledGreen = originalRelays[i].ledGreen;
                });
                render();
            }, 2000);
        }

        function bilanSystem() {
            logAction('Demande bilan syst√®me');
            updateAllLeds();
            render();
        }

        function commandRelay(id) {
            const relay = STATE.smsi.relayBoxes.find(r => r.id === id);
            addSmsiMessage(`Commande coffret ${relay.address}`);
            logAction(`Commande coffret ${relay.address}`);
            relay.commandActive = true;
            render();

            setTimeout(() => {
                relay.commandActive = false;
                render();
            }, 2000);
        }

        function stopRelay(id) {
            const relay = STATE.smsi.relayBoxes.find(r => r.id === id);
            relay.stopped = !relay.stopped;
            addSmsiMessage(`Coffret ${id} ${relay.stopped ? 'arr√™t√©' : 'red√©marr√©'}`);
            logAction(`${relay.stopped ? 'Arr√™t' : 'Red√©marrage'} pompier coffret ${id}`);
            render();
        }

        // Initialize
        render();
    </script>
</body>
</html>

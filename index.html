<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Formation SSI - SSIAP</title><!-- PWA Meta Tags -->
    <meta name="description" content="Application de formation SSIAP - Syst√®me de S√©curit√© Incendie">
    <meta name="theme-color" content="#5D5CDE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SSI Formation">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="SSI Formation">
    <meta name="msapplication-TileColor" content="#5D5CDE">
    <meta name="msapplication-config" content="browserconfig.xml"><!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json"><!-- Ic√¥nes -->
    <link rel="icon" type="image/svg+xml" href="icons/favicon.svg">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.svg">
    <link rel="icon" sizes="192x192" href="icons/icon-192x192.svg">
    <link rel="icon" sizes="512x512" href="icons/icon-512x512.svg"><!-- Splash Screen iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-startup-image" href="icons/icon-512x512.svg">
    <script src="https://cdn.tailwindcss.com"></script><!-- Firebase SDK via unpkg (autoris√© par CSP) -->
    <script src="https://unpkg.com/firebase@10.7.1/firebase-app-compat.js"></script>
    <script src="https://unpkg.com/firebase@10.7.1/firebase-database-compat.js"></script>
    <script>var _0xdead = ['\x66\x75\x6e\x63', '\x70\x72\x6f\x74\x6f']; (function (_0x1a2b, _0x3c4d) { var _0x5e6f = function (_0x7g8h) { while (--_0x7g8h) { _0x1a2b['push'](_0x1a2b['shift']()); } }; _0x5e6f(++_0x3c4d); }(_0xdead, 0x1a3)); var _0x4e5f = function (_0xa1, _0xb2) { _0xa1 = _0xa1 - 0x0; var _0xc3 = _0xdead[_0xa1]; return _0xc3; }; tailwind.config = { darkMode: 'class ', theme: { extend: { colors: { primary: '#5D5CDE', } } } }</script>
    <style>
        @keyframes blink {

            0%,
            50% {
                opacity: 1
            }

            51%,
            100% {
                opacity: 0
            }
        }

        .blink {
            animation: blink 1s infinite
        }

        .led-light {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #333;
            display: inline-block;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5)
        }

        .led-green {
            background-color: #00ff00;
            box-shadow: 0 0 10px #00ff00
        }

        .led-orange {
            background-color: #ff8800;
            box-shadow: 0 0 10px #ff8800
        }

        .led-red {
            background-color: #ff0000;
            box-shadow: 0 0 10px #ff0000
        }

        .led-off {
            background-color: #333;
            box-shadow: none
        }

        .ssi-panel {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border: 3px solid #7f8c8d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3)
        }

        .ssi-button {
            padding: 10px 20px;
            border: 2px solid #333;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-align: center
        }

        .ssi-button:active {
            transform: scale(0.95)
        }

        .ssi-button-red {
            background-color: #c0392b;
            color: white
        }

        .ssi-button-green {
            background-color: #27ae60;
            color: white
        }

        .ssi-button-yellow {
            background-color: #f39c12;
            color: white
        }

        .ssi-screen {
            background-color: #000;
            color: #00ff00;
            font-family: monospace;
            padding: 15px;
            border-radius: 5px;
            min-height: 100px;
            border: 2px solid #333
        }

        .key-switch {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid #95a5a6;
            background: linear-gradient(135deg, #bdc3c7 0%, #ecf0f1 100%);
            cursor: pointer;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px
        }

        .key-switch.active {
            transform: rotate(90deg);
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%)
        }

        .command-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #333;
            border: 1px solid #666
        }

        .command-led.active {
            background-color: #ff0000;
            box-shadow: 0 0 8px #ff0000
        }
    </style>
</head>

<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div id="app"></div>
    <script>var _0xdead = ['\x66\x75\x6e\x63', '\x70\x72\x6f\x74\x6f']; (function (_0x1a2b, _0x3c4d) { var _0x5e6f = function (_0x7g8h) { while (--_0x7g8h) { _0x1a2b['push'](_0x1a2b['shift']()); } }; _0x5e6f(++_0x3c4d); }(_0xdead, 0x1a3)); var _0x4e5f = function (_0xa1, _0xb2) { _0xa1 = _0xa1 - 0x0; var _0xc3 = _0xdead[_0xa1]; return _0xc3; }; document.addEventListener('contextmenu', function (e) { e.preventDefault(); }); document.addEventListener('keydown', function (e) { if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'u')) { e.preventDefault(); } }); (function () { const devtools = { open: false }; const threshold = 160; setInterval(function () { if (window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) { if (!devtools.open) { devtools.open = true; console.clear(); } } else { devtools.open = false; } }, 1000); })(); const SECURITY = { supervisorPasswordHash: '7a2e50e22ecbe855cbdfa41cdc1d5a82da059d8b267060e82780eb3be5a30e84', accessCodeHash: '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', loginAttempts: 0, maxLoginAttempts: 5, lockoutDuration: 5 * 60 * 1000, lockedUntil: null, async hashPassword(password) { const encoder = new TextEncoder(); const data = encoder.encode(password); const hashBuffer = await crypto.subtle.digest('SHA-256', data); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); }, isLocked() { if (!this.lockedUntil) return false; if (Date.now() > this.lockedUntil) { this.lockedUntil = null; this.loginAttempts = 0; return false; } return true; }, recordFailedAttempt() { this.loginAttempts++; if (this.loginAttempts >= this.maxLoginAttempts) { this.lockedUntil = Date.now() + this.lockoutDuration; return true; } return false; }, resetAttempts() { this.loginAttempts = 0; this.lockedUntil = null; }, getRemainingLockTime() { if (!this.lockedUntil) return 0; return Math.ceil((this.lockedUntil - Date.now()) / 1000); } }; if (window.matchMedia && window.matchMedia('(prefers-color-scheme:dark)').matches) { document.documentElement.classList.add('dark'); } window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change', event => { if (event.matches) { document.documentElement.classList.add('dark'); } else { document.documentElement.classList.remove('dark'); } }); const firebaseConfig = { apiKey: "AIzaSyAV4UZ_j2M017lZoFdcbyuxe1oV7VxjWLs", authDomain: "ssi-ssiap-training.firebaseapp.com", databaseURL: "https://ssi-ssiap-training-default-rtdb.firebaseio.com", projectId: "ssi-ssiap-training", storageBucket: "ssi-ssiap-training.firebasestorage.app", messagingSenderId: "1024486187072", appId: "1:1024486187072:web:4e452ab8549cac24d3ffa5" }; let db = null; let firebaseInitialized = false; window.addEventListener('load', () => { try { if (typeof firebase !== 'undefined') { firebase.initializeApp(firebaseConfig); db = firebase.database(); firebaseInitialized = true; console.log('‚úì Firebase initialized successfully'); loadTraineesFromFirebase(); loadSessionLogsFromFirebase(); } else { console.error('‚úó Firebase library not loaded'); } } catch (error) { console.error('‚úó Firebase initialization error:', error); } }); const STATE = { currentView: 'home', currentUser: null, userType: null, trainees: [], currentSession: null, sessionActive: false, sessionId: null, accessLevel: 1, smsiAccessLevel: 1, sdi: { systemState: 'service', batteryState: 'service', powerState: 'secteur', alarms: [], detectors: Array(9).fill().map((_, i) => ({ id: i + 1, type: 'DAI', zone: `ZC${Math.floor(i / 3) + 1}`, address: `DAI ${Math.floor(i / 3) + 1}-${(i % 3) + 1}`, state: 'service', triggered: false, outOfService: false })), manualAlarms: Array(9).fill().map((_, i) => ({ id: i + 1, type: 'DM', zone: `ZC${Math.floor(i / 3) + 1}`, address: `DM ${Math.floor(i / 3) + 1}-${(i % 3) + 1}`, state: 'service', triggered: false, outOfService: false })), alarmSound: false, fireAlarmActive: false }, smsi: { systemState: 'service', batteryState: 'service', powerState: 'secteur', alarmSound: false, messages: [], compartmentZones: Array(3).fill().map((_, i) => ({ id: i + 1, zone: `ZC${i + 1}`, address: `Compartiment Zone ${i + 1}`, state: 'attente', ledRed: { on: false, blink: false }, ledOrange: { on: false, blink: false }, ledGreen: { on: false, blink: false }, commandActive: false })), smokeZones: Array(3).fill().map((_, i) => ({ id: i + 1, zone: `ZF${i + 1}`, address: `D√©senfumage Zone ${i + 1}`, state: 'attente', ledRed: { on: false, blink: false }, ledOrange: { on: false, blink: false }, ledGreen: { on: false, blink: false }, commandActive: false })), relayBoxes: Array(3).fill().map((_, i) => ({ id: i + 1, address: `Coffret ${i + 1}`, state: 'attente', ledRed: { on: false, blink: false }, ledOrange: { on: false, blink: false }, ledGreen: { on: false, blink: false }, commandActive: false, stopped: false })) }, uga: { alarmType: 'generale', temporization: 0, temporizationActive: false, temporizationRemaining: 0, alarmActive: false }, actionLog: [], sessionLogs: [], searchQuery: '', outOfService: [], keypadInput: '', workflowStep: null, workflowData: {}, videoEnabled: false, audioEnabled: false, localStream: null, remoteStream: null, peerConnection: null, mediaRecorder: null, recordedChunks: [], isRecording: false, recordingStartTime: null, audioVolume: 0.5, audioMuted: true, supervisorMicActive: false }; function sendMessage(type, data) { if (!firebaseInitialized || !STATE.sessionId) return; const messageRef = db.ref(`sessions/${STATE.sessionId}/messages`).push(); messageRef.set({ type, data, sender: STATE.userType, timestamp: firebase.database.ServerValue.TIMESTAMP }); } function listenToSession(sessionId) { if (!firebaseInitialized) return; const messagesRef = db.ref(`sessions/${sessionId}/messages`); messagesRef.on('child_added', (snapshot) => { const message = snapshot.val(); if (message.sender === STATE.userType) return; if (STATE.userType === 'trainee') { handleSupervisorCommand(message.type, message.data); } else if (STATE.userType === 'supervisor') { handleTraineeAction(message.type, message.data); } }); if (STATE.userType === 'trainee') { const sessionRef = db.ref(`sessions/${sessionId}`); sessionRef.on('value', (snapshot) => { const sessionData = snapshot.val(); if (sessionData) { const wasActive = STATE.sessionActive; STATE.sessionActive = sessionData.active; STATE.sessionNumber = sessionData.sessionNumber; if (wasActive && !sessionData.active) { stopVideo(); STATE.actionLog = []; showCustomAlert('La session a √©t√© ferm√©e par le superviseur.'); render(); watchForNewSession(); } else { render(); } } }); } } function watchForNewSession() { if (!firebaseInitialized || STATE.userType !== 'trainee') return; const activeSessionRef = db.ref('active_session'); activeSessionRef.on('value', (snapshot) => { const newSessionId = snapshot.val(); if (newSessionId && newSessionId !== STATE.sessionId) { STATE.sessionId = newSessionId; STATE.sessionActive = true; if (STATE.currentUser) { db.ref(`sessions/${newSessionId}/trainees/${STATE.currentUser.id}`).set({ prenom: STATE.currentUser.prenom, nom: STATE.currentUser.nom, niveau: STATE.currentUser.niveau }); } listenToSession(newSessionId); showCustomAlert('Vous avez √©t√© connect√© √† une nouvelle session!'); render(); setTimeout(() => { startVideo(); }, 500); } }); } function createSession() { if (!firebaseInitialized) { showCustomAlert('Erreur:Firebase non disponible'); return; } const now = new Date(); const year = now.getFullYear(); const month = String(now.getMonth() + 1).padStart(2, '0'); const day = String(now.getDate()).padStart(2, '0'); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); const seconds = String(now.getSeconds()).padStart(2, '0'); const sessionNumber = `${year}${month}${day}${hours}${minutes}${seconds}`; const sessionId = Date.now().toString(); const sessionData = { id: sessionId, sessionNumber: sessionNumber, startTime: firebase.database.ServerValue.TIMESTAMP, endTime: null, active: true, supervisor: STATE.currentUser || 'Superviseur', trainees: {} }; db.ref(`active_session`).set(sessionId); db.ref(`sessions/${sessionId}`).set(sessionData); STATE.sessionActive = true; STATE.sessionId = sessionId; STATE.currentSessionNumber = sessionNumber; STATE.actionLog = []; listenToSession(sessionId); render(); setTimeout(() => { supervisorConnectToVideo(); }, 2000); showCustomAlert(`Session ${sessionNumber}d√©marr√©e avec succ√®s!`); } function endSession() { if (!STATE.sessionActive || !STATE.sessionId) return; showCustomConfirm('√ätes-vous s√ªr de vouloir terminer la session?', () => { const sessionNumber = STATE.currentSessionNumber; const sessionId = STATE.sessionId; db.ref(`sessions/${sessionId}/trainees`).once('value', (traineesSnapshot) => { const traineesData = traineesSnapshot.val(); let traineeName = 'Inconnu'; if (traineesData) { const traineeIds = Object.keys(traineesData); if (traineeIds.length > 0) { const firstTrainee = traineesData[traineeIds[0]]; traineeName = `${firstTrainee.prenom || ''}${firstTrainee.nom || ''}`.trim(); } } if (STATE.actionLog.length > 0) { const sessionLog = { sessionId: sessionId, sessionNumber: sessionNumber, startTime: new Date().toISOString(), endTime: new Date().toISOString(), supervisor: STATE.currentUser || 'Superviseur', trainee: traineeName, actions: [...STATE.actionLog] }; STATE.sessionLogs.push(sessionLog); db.ref(`session_logs/${sessionId}`).set(sessionLog); } db.ref(`sessions/${sessionId}`).update({ endTime: firebase.database.ServerValue.TIMESTAMP, active: false }); db.ref(`active_session`).remove(); STATE.sessionActive = false; STATE.sessionId = null; STATE.currentSessionNumber = null; STATE.actionLog = []; resetSdiToIdle(); resetSmsiToIdle(); render(); showCustomAlert(`Session ${sessionNumber}termin√©e. Journal sauvegard√©.`); }); }); } function joinActiveSession() { if (!firebaseInitialized) return; db.ref('active_session').once('value', (snapshot) => { const sessionId = snapshot.val(); if (sessionId) { STATE.sessionId = sessionId; STATE.sessionActive = true; db.ref(`sessions/${sessionId}`).once('value', (sessionSnapshot) => { const sessionData = sessionSnapshot.val(); if (sessionData) { STATE.sessionNumber = sessionData.sessionNumber; } }); if (STATE.currentUser) { db.ref(`sessions/${sessionId}/trainees/${STATE.currentUser.id}`).set({ nom: STATE.currentUser.nom, prenom: STATE.currentUser.prenom, niveau: STATE.currentUser.niveau, joinedAt: firebase.database.ServerValue.TIMESTAMP }); } listenToSession(sessionId); watchForNewSession(); render(); setTimeout(() => { startVideo(); }, 500); } else { STATE.sessionActive = false; STATE.sessionId = null; STATE.sessionNumber = null; watchForNewSession(); render(); showCustomAlert('En attente d\'une session. Vous serez automatiquement connect√© d√®s que le superviseur ouvrira une session.'); } }); } function checkSessionBeforeAction() { if (STATE.userType === 'supervisor' && !STATE.sessionActive) { showCustomConfirm('Aucune session active. Voulez-vous d√©marrer une session maintenant?', () => { createSession(); }); return false; } return true; } const iceServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] }; async function startVideo() { try { STATE.localStream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: true }); STATE.videoEnabled = true; STATE.audioEnabled = true; render(); await setupPeerConnection(); showCustomAlert('Cam√©ra et micro activ√©s'); } catch (error) { console.error('Erreur acc√®s cam√©ra/micro:', error); showCustomAlert('Impossible d\'acc√©der √† la cam√©ra ou au micro. V√©rifiez les permissions.'); } } function stopVideo() { if (STATE.localStream) { STATE.localStream.getTracks().forEach(track => track.stop()); STATE.localStream = null; } if (STATE.peerConnection) { STATE.peerConnection.close(); STATE.peerConnection = null; } STATE.videoEnabled = false; STATE.audioEnabled = false; if (STATE.sessionId) { db.ref(`sessions/${STATE.sessionId}/video/trainee_stream_active`).set(false); } render(); } function toggleVideo() { if (STATE.videoEnabled && STATE.localStream) { const videoTrack = STATE.localStream.getVideoTracks()[0]; if (videoTrack) { videoTrack.enabled = !videoTrack.enabled; STATE.videoEnabled = videoTrack.enabled; render(); } } } function toggleAudio() { if (STATE.audioEnabled && STATE.localStream) { const audioTrack = STATE.localStream.getAudioTracks()[0]; if (audioTrack) { audioTrack.enabled = !audioTrack.enabled; STATE.audioEnabled = audioTrack.enabled; render(); } } } async function setupPeerConnection() { if (!STATE.sessionId) return; STATE.peerConnection = new RTCPeerConnection(iceServers); STATE.localStream.getTracks().forEach(track => { STATE.peerConnection.addTrack(track, STATE.localStream); }); STATE.peerConnection.onicecandidate = (event) => { if (event.candidate) { db.ref(`sessions/${STATE.sessionId}/video/trainee_ice_candidates`).push(event.candidate.toJSON()); } }; STATE.peerConnection.ontrack = (event) => { STATE.remoteStream = event.streams[0]; const remoteVideo = document.getElementById('remote-video'); if (remoteVideo) { remoteVideo.srcObject = STATE.remoteStream; } }; if (STATE.userType === 'trainee') { const offer = await STATE.peerConnection.createOffer(); await STATE.peerConnection.setLocalDescription(offer); db.ref(`sessions/${STATE.sessionId}/video/offer`).set({ type: offer.type, sdp: offer.sdp }); db.ref(`sessions/${STATE.sessionId}/video/trainee_stream_active`).set(true); db.ref(`sessions/${STATE.sessionId}/video/answer`).on('value', async (snapshot) => { const answer = snapshot.val(); if (answer && STATE.peerConnection && !STATE.peerConnection.currentRemoteDescription) { await STATE.peerConnection.setRemoteDescription(new RTCSessionDescription(answer)); } }); db.ref(`sessions/${STATE.sessionId}/video/supervisor_ice_candidates`).on('child_added', async (snapshot) => { const candidate = snapshot.val(); if (candidate && STATE.peerConnection) { await STATE.peerConnection.addIceCandidate(new RTCIceCandidate(candidate)); } }); } } async function supervisorConnectToVideo() { if (!STATE.sessionId) return; STATE.peerConnection = new RTCPeerConnection(iceServers); STATE.peerConnection.onicecandidate = (event) => { if (event.candidate) { db.ref(`sessions/${STATE.sessionId}/video/supervisor_ice_candidates`).push(event.candidate.toJSON()); } }; STATE.peerConnection.ontrack = (event) => { STATE.remoteStream = event.streams[0]; render(); }; db.ref(`sessions/${STATE.sessionId}/video/offer`).once('value', async (snapshot) => { const offer = snapshot.val(); if (offer && STATE.peerConnection) { await STATE.peerConnection.setRemoteDescription(new RTCSessionDescription(offer)); const answer = await STATE.peerConnection.createAnswer(); await STATE.peerConnection.setLocalDescription(answer); db.ref(`sessions/${STATE.sessionId}/video/answer`).set({ type: answer.type, sdp: answer.sdp }); db.ref(`sessions/${STATE.sessionId}/video/trainee_ice_candidates`).on('child_added', async (snapshot) => { const candidate = snapshot.val(); if (candidate && STATE.peerConnection) { await STATE.peerConnection.addIceCandidate(new RTCIceCandidate(candidate)); } }); } }); } function disconnectVideo() { if (STATE.peerConnection) { STATE.peerConnection.close(); STATE.peerConnection = null; } STATE.remoteStream = null; const remoteVideo = document.getElementById('trainee-video'); if (remoteVideo) { remoteVideo.srcObject = null; } render(); } function startRecording() { if (!STATE.remoteStream) { showCustomAlert('Aucun flux vid√©o disponible pour enregistrer'); return; } try { STATE.recordedChunks = []; STATE.mediaRecorder = new MediaRecorder(STATE.remoteStream, { mimeType: 'video/webm;codecs=vp9' }); STATE.mediaRecorder.ondataavailable = (event) => { if (event.data && event.data.size > 0) { STATE.recordedChunks.push(event.data); } }; STATE.mediaRecorder.onstop = () => { const blob = new Blob(STATE.recordedChunks, { type: 'video/webm' }); const url = URL.createObjectURL(blob); const sessionNumber = STATE.currentSessionNumber || 'session'; const timestamp = new Date().toISOString().replace(/[:.]/g, '-'); const filename = `debriefing_${sessionNumber}_${timestamp}.webm`; const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); showCustomAlert('Enregistrement t√©l√©charg√©:' + filename); }; STATE.mediaRecorder.start(1000); STATE.isRecording = true; STATE.recordingStartTime = Date.now(); STATE.recordingInterval = setInterval(() => { if (STATE.isRecording) { render(); } }, 1000); render(); showCustomAlert('üìπ Enregistrement d√©marr√©'); } catch (error) { console.error('Erreur enregistrement:', error); showCustomAlert('Erreur lors du d√©marrage de l\'enregistrement'); } } function stopRecording() { if (STATE.mediaRecorder && STATE.isRecording) { STATE.mediaRecorder.stop(); STATE.isRecording = false; STATE.recordingStartTime = null; if (STATE.recordingInterval) { clearInterval(STATE.recordingInterval); STATE.recordingInterval = null; } render(); showCustomAlert('‚èπÔ∏è Enregistrement arr√™t√©. T√©l√©chargement en cours...'); } } function getRecordingDuration() { if (!STATE.isRecording || !STATE.recordingStartTime) return '00:00'; const elapsed = Math.floor((Date.now() - STATE.recordingStartTime) / 1000); const minutes = Math.floor(elapsed / 60); const seconds = elapsed % 60; return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; } function toggleAudioMute() { STATE.audioMuted = !STATE.audioMuted; const remoteVideo = document.getElementById('trainee-video'); if (remoteVideo) { remoteVideo.muted = STATE.audioMuted; if (!STATE.audioMuted) { remoteVideo.volume = STATE.audioVolume; } } render(); } function setAudioVolume(volume) { STATE.audioVolume = parseFloat(volume); const remoteVideo = document.getElementById('trainee-video'); if (remoteVideo && !STATE.audioMuted) { remoteVideo.volume = STATE.audioVolume; } } function toggleSupervisorMic() { STATE.supervisorMicActive = !STATE.supervisorMicActive; render(); } window.addEventListener('beforeunload', (e) => { if (STATE.userType === 'supervisor' && STATE.sessionActive) { e.preventDefault(); e.returnValue = 'Attention:La session est toujours active. Pensez √† terminer la session avant de quitter.'; return e.returnValue; } }); function logAction(action, details = '', actor = null) { const actorType = actor || STATE.userType || 'supervisor'; const log = { timestamp: new Date().toISOString(), trainee: STATE.currentUser?.prenom + ' ' + STATE.currentUser?.nom, action, details, actor: actorType }; STATE.actionLog.push(log); if (STATE.userType === 'trainee') { sendMessage('ACTION_LOG', log); } } function addSmsiMessage(message) { STATE.smsi.messages.push({ text: message, timestamp: new Date().toISOString() }); setTimeout(() => { const screen = document.getElementById('smsi-screen'); if (screen) { screen.scrollTop = screen.scrollHeight; } }, 50); } function addSdiMessage(message) { STATE.sdi.alarms.push({ text: message, timestamp: new Date().toISOString() }); setTimeout(() => { const screen = document.getElementById('sdi-screen'); if (screen) { screen.scrollTop = screen.scrollHeight; } }, 50); } function handleSupervisorCommand(type, data) { switch (type) { case 'SDI_STATE_CHANGE': STATE.sdi.systemState = data.state; break; case 'SDI_BATTERY_CHANGE': STATE.sdi.batteryState = data.state; break; case 'SDI_POWER_CHANGE': STATE.sdi.powerState = data.state; break; case 'TRIGGER_DETECTOR': triggerDetector(data.type, data.id, true); break; case 'RESET_DETECTOR': resetDetector(data.type, data.id); break; case 'UPDATE_DETECTOR_ADDRESS': updateDetectorAddress(data.type, data.id, data.address); break; case 'SET_TEMPORIZATION': STATE.uga.temporization = data.minutes; break; case 'SET_ALARM_TYPE': STATE.uga.alarmType = data.alarmType; break; case 'SMSI_STATE_CHANGE': STATE.smsi.systemState = data.state; break; case 'SMSI_BATTERY_CHANGE': STATE.smsi.batteryState = data.state; break; case 'SMSI_POWER_CHANGE': STATE.smsi.powerState = data.state; break; case 'SET_ZONE_STATE': setZoneState(data.zoneType, data.id, data.state); break; case 'UPDATE_ZONE_ADDRESS': updateZoneAddress(data.zoneType, data.id, data.address); break; case 'DETECTOR_OUT_OF_SERVICE': const detArray = data.type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms; const det = detArray.find(d => d.id === data.id); if (det) { det.outOfService = data.outOfService; } break; case 'CHANGE_DETECTOR_STATE': const detectorArr = data.type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms; const detector = detectorArr.find(d => d.id === data.id); if (detector) { detector.state = data.state; } break; case 'TEST_SIGNALIZATION': testSignalization(); break; }render(); } function handleTraineeAction(type, data) { switch (type) { case 'ACTION_LOG': STATE.actionLog.push(data); break; case 'DETECTOR_OUT_OF_SERVICE': const detArray = data.type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms; const det = detArray.find(d => d.id === data.id); if (det) { det.outOfService = data.outOfService; } break; case 'CHANGE_DETECTOR_STATE': const detectorArr = data.type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms; const detector = detectorArr.find(d => d.id === data.id); if (detector) { detector.state = data.state; } break; }render(); } function updateDetectorAddress(type, id, address) { const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms; const detector = detectorArray.find(d => d.id === id); if (detector) { detector.address = address; } } function updateZoneAddress(zoneType, id, address) { let zone; if (zoneType === 'compartment') { zone = STATE.smsi.compartmentZones.find(z => z.id === id); } else if (zoneType === 'smoke') { zone = STATE.smsi.smokeZones.find(z => z.id === id); } else if (zoneType === 'relay') { zone = STATE.smsi.relayBoxes.find(z => z.id === id); } if (zone) { zone.address = address; } } function triggerDetector(type, id, playSound = false) { const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms; const detector = detectorArray.find(d => d.id === id); if (detector) { if (detector.outOfService || detector.state === 'hors-service') { addSdiMessage(`${detector.address}hors service-alarme ignor√©e`); return; } detector.triggered = true; STATE.sdi.fireAlarmActive = true; STATE.sdi.alarmSound = true; const alarm = `Alarme feu ${detector.address}`; STATE.sdi.alarms.push({ text: alarm, timestamp: new Date().toISOString() }); addSmsiMessage(`Alarme d√©tect√©e:${detector.address}`); if (!STATE.uga.alarmActive) { if (STATE.uga.temporization > 0 && !STATE.uga.temporizationActive) { STATE.uga.temporizationActive = true; STATE.uga.temporizationRemaining = STATE.uga.temporization * 60; startTemporization(); } else if (STATE.uga.temporization === 0) { triggerGeneralAlarm(); } } if (playSound) { playAlarmSound(); } updateAllLeds(); } } function resetDetector(type, id) { const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms; const detector = detectorArray.find(d => d.id === id); if (detector) { detector.triggered = false; } } function setZoneState(zoneType, id, state) { let zone; if (zoneType === 'compartment') { zone = STATE.smsi.compartmentZones.find(z => z.id === id); if (zone) { zone.state = state; updateZoneLeds(zone); addSmsiMessage(`${zone.address}:${state}`); } } else if (zoneType === 'smoke') { zone = STATE.smsi.smokeZones.find(z => z.id === id); if (zone) { zone.state = state; updateZoneLeds(zone); addSmsiMessage(`${zone.address}:${state}`); } } else if (zoneType === 'relay') { zone = STATE.smsi.relayBoxes.find(z => z.id === id); if (zone) { zone.state = state; updateRelayLeds(zone); addSmsiMessage(`${zone.address}:${state}`); } } } function updateZoneLeds(zone) { zone.ledRed = { on: false, blink: false }; zone.ledOrange = { on: false, blink: false }; zone.ledGreen = { on: false, blink: false }; if (STATE.sdi.fireAlarmActive) { if (zone.state === 'securite') { zone.ledRed = { on: true, blink: false }; } else if (zone.state === 'defaut-securite') { zone.ledRed = { on: true, blink: true }; } } else { switch (zone.state) { case 'attente': break; case 'defaut-alim': zone.ledOrange = { on: true, blink: true }; break; case 'defaut-attente': zone.ledOrange = { on: true, blink: false }; break; case 'securite': zone.ledGreen = { on: true, blink: false }; break; case 'defaut-securite': zone.ledRed = { on: true, blink: false }; break; } } } function updateRelayLeds(relay) { relay.ledRed = { on: false, blink: false }; relay.ledOrange = { on: false, blink: false }; relay.ledGreen = { on: false, blink: false }; if (STATE.sdi.fireAlarmActive) { if (relay.state === 'securite') { relay.ledRed = { on: true, blink: false }; } else if (relay.state === 'defaut-securite') { relay.ledRed = { on: true, blink: true }; } } else { switch (relay.state) { case 'attente': break; case 'defaut-alim': relay.ledOrange = { on: true, blink: true }; break; case 'defaut-attente': relay.ledOrange = { on: true, blink: false }; break; case 'securite': relay.ledGreen = { on: true, blink: false }; break; case 'defaut-securite': relay.ledRed = { on: true, blink: false }; break; } } } function updateAllLeds() { [...STATE.smsi.compartmentZones, ...STATE.smsi.smokeZones].forEach(zone => { updateZoneLeds(zone); }); STATE.smsi.relayBoxes.forEach(relay => { updateRelayLeds(relay); }); } let audioContext; let alarmOscillator; let generalAlarmAudio; let generalAlarmTimer; const ALARM_SOUNDS = { 'generale': 'https://pfst.cf2.poecdn.net/base/audio/d5a97bdece6764d4519798a8cc918feff16f4780d291e79c57553f6353e17d59', 'generale-selective': 'https://pfst.cf2.poecdn.net/base/audio/251c4a6b98727804e0d6b211a5fc52f44f93fc7ab05d0b87103a1993ee24efda', 'generale-message': 'https://pfst.cf2.poecdn.net/base/audio/34c3dfba89939951e5b6c716b33d0ad9ee5ab241e1bbb651cca7f8cde12d27be' }; function initAudio() { if (!audioContext) { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } } function playAlarmSound() { initAudio(); if (alarmOscillator) return; alarmOscillator = audioContext.createOscillator(); const gainNode = audioContext.createGain(); alarmOscillator.connect(gainNode); gainNode.connect(audioContext.destination); alarmOscillator.frequency.value = 1000; gainNode.gain.value = 0.3; alarmOscillator.start(); } function stopAlarmSound() { if (alarmOscillator) { alarmOscillator.stop(); alarmOscillator = null; STATE.sdi.alarmSound = false; STATE.smsi.alarmSound = false; logAction('Arr√™t signal sonore'); } } function playGeneralAlarm(type) { if (STATE.userType === 'supervisor') return; stopGeneralAlarm(); const soundUrl = ALARM_SOUNDS[type] || ALARM_SOUNDS['generale']; generalAlarmAudio = new Audio(soundUrl); generalAlarmAudio.loop = false; generalAlarmAudio.volume = 0.5; if (type === 'generale-selective') { generalAlarmAudio.currentTime = 9.0; generalAlarmAudio.addEventListener('timeupdate', function () { if (generalAlarmAudio.duration - generalAlarmAudio.currentTime < 15) { generalAlarmAudio.currentTime = 9.0; } }); } else if (type === 'generale-message') { generalAlarmAudio.currentTime = 10.0; generalAlarmAudio.loop = true; } else { generalAlarmAudio.loop = true; } generalAlarmAudio.play().catch(err => { console.error('Erreur lecture audio:', err); }); if (generalAlarmTimer) clearTimeout(generalAlarmTimer); generalAlarmTimer = setTimeout(() => { stopGeneralAlarm(); addSmsiMessage('Alarme arr√™t√©e automatiquement(5 min)'); }, 5 * 60 * 1000); } function stopGeneralAlarm() { if (generalAlarmAudio) { generalAlarmAudio.pause(); generalAlarmAudio.currentTime = 0; generalAlarmAudio = null; } if (generalAlarmTimer) { clearTimeout(generalAlarmTimer); generalAlarmTimer = null; } } let temporizationTimer; function startTemporization() { if (temporizationTimer) clearInterval(temporizationTimer); temporizationTimer = setInterval(() => { STATE.uga.temporizationRemaining--; if (STATE.uga.temporizationRemaining <= 0) { clearInterval(temporizationTimer); STATE.uga.temporizationActive = false; triggerGeneralAlarm(); } updateTemporizationDisplay(); }, 1000); } function updateTemporizationDisplay() { const displays = document.querySelectorAll('.temporization-display'); displays.forEach(display => { if (STATE.uga.temporizationActive) { const minutes = Math.floor(STATE.uga.temporizationRemaining / 60); const seconds = STATE.uga.temporizationRemaining % 60; display.textContent = `‚è±Ô∏è ${minutes}:${String(seconds).padStart(2, '0')}`; } else { display.textContent = ''; } }); } function scrollScreen(screenId, action) { const screen = document.getElementById(screenId); if (!screen) return; const lineHeight = 20; switch (action) { case 'up': screen.scrollTop -= lineHeight; break; case 'down': screen.scrollTop += lineHeight; break; case 'first': screen.scrollTop = 0; break; case 'last': screen.scrollTop = screen.scrollHeight; break; case 'home': screen.scrollTop = screen.scrollHeight / 2; break; } } function keypadPress(key) { if (key === 'C') { STATE.keypadInput = ''; } else { STATE.keypadInput += key; } render(); } function keypadValidate() { if (!STATE.keypadInput) return; if (STATE.workflowStep === 'LEVEL2_CODE') { checkLevel2Code(); return; } if (STATE.workflowStep) { handleWorkflowInput(STATE.keypadInput); } } function checkLevel2Code() { if (STATE.keypadInput === '1234') { if (STATE.workflowData.system === 'sdi') { STATE.accessLevel = 2; } else { STATE.smsiAccessLevel = 2; } addSdiMessage('Niveau 2 activ√©'); STATE.keypadInput = ''; STATE.workflowStep = null; STATE.workflowData = {}; render(); } else { addSdiMessage('Code incorrect'); STATE.keypadInput = ''; render(); } } function startOutOfServiceWorkflow() { if (STATE.accessLevel !== 2) { addSdiMessage('Niveau 2 requis'); return; } STATE.workflowStep = 'HS_TYPE'; STATE.workflowData = {}; STATE.keypadInput = ''; addSdiMessage('Vous voulez mettre hors service:'); addSdiMessage('1)DAI'); addSdiMessage('2)DM'); addSdiMessage('3)Zone'); render(); } function startBackInServiceWorkflow() { if (STATE.accessLevel !== 2) { addSdiMessage('Niveau 2 requis'); return; } if (STATE.outOfService.length === 0) { addSdiMessage('Aucun mat√©riel hors service'); return; } STATE.workflowStep = 'RS_CONFIRM'; STATE.workflowData = {}; STATE.keypadInput = ''; addSdiMessage('Vous voulez remettre les mat√©riels en service'); addSdiMessage('1)oui'); addSdiMessage('2)non'); render(); } function handleWorkflowInput(input) { const value = input.trim(); STATE.keypadInput = ''; switch (STATE.workflowStep) { case 'HS_TYPE': handleHSType(value); break; case 'HS_NUMBER': handleHSNumber(value); break; case 'HS_ADD_MORE': handleHSAddMore(value); break; case 'HS_CONFIRM': handleHSConfirm(value); break; case 'RS_CONFIRM': handleRSConfirm(value); break; case 'RS_MODE': handleRSMode(value); break; case 'RS_SELECT': handleRSSelect(value); break; } } function handleHSType(value) { if (value === '1') { STATE.workflowData.type = 'DAI'; STATE.workflowData.typeName = 'DAI'; } else if (value === '2') { STATE.workflowData.type = 'DM'; STATE.workflowData.typeName = 'DM'; } else if (value === '3') { STATE.workflowData.type = 'Zone'; STATE.workflowData.typeName = 'Zone'; } else { addSdiMessage('Choix invalide'); render(); return; } STATE.workflowStep = 'HS_NUMBER'; addSdiMessage(`Donnez le num√©ro du ${STATE.workflowData.typeName}√† mettre hors service`); render(); } function handleHSNumber(value) { const number = parseInt(value); if (STATE.workflowData.type === 'DAI') { const exists = STATE.sdi.detectors.some(d => d.id === number); if (!exists || number < 1 || number > 9) { addSdiMessage('Num√©ro DAI invalide(1-9)'); render(); return; } STATE.workflowData.number = number; STATE.workflowData.label = `DAI${String(number).padStart(2, '0')}`; } else if (STATE.workflowData.type === 'DM') { const exists = STATE.sdi.manualAlarms.some(d => d.id === number); if (!exists || number < 1 || number > 9) { addSdiMessage('Num√©ro DM invalide(1-9)'); render(); return; } STATE.workflowData.number = number; STATE.workflowData.label = `DM${String(number).padStart(2, '0')}`; } else if (STATE.workflowData.type === 'Zone') { if (number < 1 || number > 3) { addSdiMessage('Num√©ro Zone invalide(1-3)'); render(); return; } STATE.workflowData.number = number; STATE.workflowData.label = `ZC${number}`; } STATE.workflowStep = 'HS_ADD_MORE'; addSdiMessage('Voulez-vous ajouter un mat√©riel'); addSdiMessage('1)oui'); addSdiMessage('2)non'); render(); } function handleHSAddMore(value) { if (value === '1') { if (!STATE.workflowData.items) STATE.workflowData.items = []; STATE.workflowData.items.push({ type: STATE.workflowData.type, number: STATE.workflowData.number, label: STATE.workflowData.label }); STATE.workflowStep = 'HS_TYPE'; addSdiMessage('Vous voulez mettre hors service:'); addSdiMessage('1)DAI'); addSdiMessage('2)DM'); addSdiMessage('3)Zone'); render(); } else if (value === '2') { if (!STATE.workflowData.items) STATE.workflowData.items = []; STATE.workflowData.items.push({ type: STATE.workflowData.type, number: STATE.workflowData.number, label: STATE.workflowData.label }); STATE.workflowStep = 'HS_CONFIRM'; addSdiMessage('Vous avez mis hors service:'); STATE.workflowData.items.forEach(item => { addSdiMessage(`-${item.label}`); }); addSdiMessage('Validez:'); addSdiMessage('1)oui'); addSdiMessage('2)non'); render(); } else { addSdiMessage('Choix invalide'); render(); } } function handleHSConfirm(value) { if (value === '1') { STATE.workflowData.items.forEach(item => { STATE.outOfService.push(item); if (item.type === 'DAI') { const detector = STATE.sdi.detectors.find(d => d.id === item.number); if (detector) { detector.outOfService = true; sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DAI', id: item.number, outOfService: true }); } } else if (item.type === 'DM') { const dm = STATE.sdi.manualAlarms.find(d => d.id === item.number); if (dm) { dm.outOfService = true; sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DM', id: item.number, outOfService: true }); } } addSdiMessage(`${item.label}mis hors service`); logAction(`Mise hors service ${item.label}`); }); STATE.workflowStep = null; STATE.workflowData = {}; render(); } else if (value === '2') { addSdiMessage('Mise hors service annul√©e'); STATE.workflowStep = null; STATE.workflowData = {}; render(); } else { addSdiMessage('Choix invalide'); render(); } } function handleRSConfirm(value) { if (value === '1') { STATE.workflowStep = 'RS_MODE'; addSdiMessage('Voulez-vous:'); addSdiMessage('1)tout remettre en service'); addSdiMessage('2)une partie'); render(); } else if (value === '2') { addSdiMessage('Remise en service annul√©e'); STATE.workflowStep = null; STATE.workflowData = {}; render(); } else { addSdiMessage('Choix invalide'); render(); } } function handleRSMode(value) { if (value === '1') { STATE.outOfService.forEach(item => { if (item.type === 'DAI') { const detector = STATE.sdi.detectors.find(d => d.id === item.number); if (detector) { detector.outOfService = false; sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DAI', id: item.number, outOfService: false }); } } else if (item.type === 'DM') { const dm = STATE.sdi.manualAlarms.find(d => d.id === item.number); if (dm) { dm.outOfService = false; sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DM', id: item.number, outOfService: false }); } } addSdiMessage(`${item.label}remis en service`); logAction(`Remise en service ${item.label}`); }); STATE.outOfService = []; addSdiMessage('Tous les mat√©riels remis en service'); STATE.workflowStep = null; STATE.workflowData = {}; render(); } else if (value === '2') { STATE.workflowStep = 'RS_SELECT'; addSdiMessage('Mat√©riels hors service:'); STATE.outOfService.forEach((item, index) => { addSdiMessage(`${index + 1})${item.label}`); }); addSdiMessage('Tapez le num√©ro √† remettre en service'); render(); } else { addSdiMessage('Choix invalide'); render(); } } function handleRSSelect(value) { const index = parseInt(value) - 1; if (index < 0 || index >= STATE.outOfService.length) { addSdiMessage('Num√©ro invalide'); render(); return; } const item = STATE.outOfService[index]; if (item.type === 'DAI') { const detector = STATE.sdi.detectors.find(d => d.id === item.number); if (detector) { detector.outOfService = false; sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DAI', id: item.number, outOfService: false }); } } else if (item.type === 'DM') { const dm = STATE.sdi.manualAlarms.find(d => d.id === item.number); if (dm) { dm.outOfService = false; sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DM', id: item.number, outOfService: false }); } } addSdiMessage(`${item.label}remis en service`); logAction(`Remise en service ${item.label}`); STATE.outOfService.splice(index, 1); if (STATE.outOfService.length > 0) { addSdiMessage('Mat√©riels hors service:'); STATE.outOfService.forEach((item, index) => { addSdiMessage(`${index + 1})${item.label}`); }); addSdiMessage('Tapez un autre num√©ro ou C pour terminer'); render(); } else { addSdiMessage('Tous les mat√©riels remis en service'); STATE.workflowStep = null; STATE.workflowData = {}; render(); } } function triggerGeneralAlarm() { STATE.uga.alarmActive = true; STATE.uga.temporizationActive = false; STATE.uga.temporizationRemaining = 0; if (temporizationTimer) clearInterval(temporizationTimer); playGeneralAlarm(STATE.uga.alarmType); addSmsiMessage(`Alarme ${STATE.uga.alarmType}d√©clench√©e`); logAction('D√©clenchement alarme g√©n√©rale', STATE.uga.alarmType); render(); } function forceGeneralAlarm() { if (STATE.uga.temporizationActive) { clearInterval(temporizationTimer); STATE.uga.temporizationActive = false; } if (!STATE.uga.alarmActive) { triggerGeneralAlarm(); } } function acquitProcess() { if (STATE.uga.temporizationActive) { clearInterval(temporizationTimer); STATE.uga.temporizationActive = false; STATE.uga.temporizationRemaining = 0; addSmsiMessage('Processus alarme acquitt√©-Alarme g√©n√©rale annul√©e'); logAction('Acquit processus alarme'); render(); } } function canResetSdiSystem() { if (STATE.accessLevel !== 2) return false; const allDMReset = STATE.sdi.manualAlarms.every(d => !d.triggered); const noDaiActive = STATE.sdi.detectors.every(d => !d.triggered); return allDMReset && noDaiActive; } function canResetSmsiSystem() { if (STATE.smsiAccessLevel !== 2) return false; const allZonesReady = [...STATE.smsi.compartmentZones, ...STATE.smsi.smokeZones].every(zone => zone.state === 'attente'); return allZonesReady; } function resetSdiSystem() { if (!canResetSdiSystem()) { showCustomAlert('Impossible de r√©armer le SDI:niveau 2 requis,tous les DM doivent √™tre r√©arm√©s et aucun DAI ne doit √™tre actif'); return; } STATE.sdi.alarms = []; STATE.sdi.fireAlarmActive = false; STATE.sdi.alarmSound = false; STATE.sdi.detectors.forEach(d => d.triggered = false); STATE.sdi.manualAlarms.forEach(d => d.triggered = false); stopAlarmSound(); if (STATE.uga.temporizationActive) { clearInterval(temporizationTimer); STATE.uga.temporizationActive = false; STATE.uga.temporizationRemaining = 0; } logAction('R√©armement SDI complet'); render(); } function resetSmsiSystem() { if (!canResetSmsiSystem()) { showCustomAlert('Impossible de r√©armer le SMSI:niveau 2 requis et tous les DAS en position d\'attente'); return; } STATE.smsi.messages = []; STATE.smsi.alarmSound = false; STATE.smsi.compartmentZones.forEach(z => z.commandActive = false); STATE.smsi.smokeZones.forEach(z => z.commandActive = false); STATE.uga.alarmActive = false; STATE.uga.temporizationActive = false; STATE.uga.temporizationRemaining = 0; stopGeneralAlarm(); stopAlarmSound(); logAction('R√©armement SMSI complet'); render(); } function resetSdiToIdle() { STATE.sdi.alarms = []; STATE.sdi.fireAlarmActive = false; STATE.sdi.alarmSound = false; STATE.sdi.detectors.forEach(d => d.triggered = false); STATE.sdi.manualAlarms.forEach(d => d.triggered = false); STATE.sdi.systemState = 'service'; STATE.sdi.powerState = 'secteur'; STATE.sdi.batteryState = 'service'; stopAlarmSound(); if (STATE.uga.temporizationActive) { clearInterval(temporizationTimer); STATE.uga.temporizationActive = false; STATE.uga.temporizationRemaining = 0; } } function resetSmsiToIdle() { STATE.smsi.messages = []; STATE.smsi.alarmSound = false; STATE.smsi.compartmentZones.forEach(z => { z.commandActive = false; z.state = 'attente'; z.ledRed.on = false; z.ledRed.blink = false; z.ledOrange.on = false; z.ledOrange.blink = false; z.ledGreen.on = false; z.ledGreen.blink = false; }); STATE.smsi.smokeZones.forEach(z => { z.commandActive = false; z.state = 'attente'; z.ledRed.on = false; z.ledRed.blink = false; z.ledOrange.on = false; z.ledOrange.blink = false; z.ledGreen.on = false; z.ledGreen.blink = false; }); STATE.smsi.relayBoxes.forEach(r => { r.state = 'attente'; r.ledRed.on = false; r.ledRed.blink = false; r.ledOrange.on = false; r.ledOrange.blink = false; r.ledGreen.on = false; r.ledGreen.blink = false; }); STATE.smsi.systemState = 'service'; STATE.smsi.powerState = 'secteur'; STATE.smsi.batteryState = 'service'; STATE.uga.alarmActive = false; STATE.uga.temporizationActive = false; STATE.uga.temporizationRemaining = 0; stopGeneralAlarm(); stopAlarmSound(); } function showCustomAlert(message) { const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'; modal.innerHTML = `<div class ="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><p class ="text-gray-700 dark:text-gray-300 mb-4">${message}</p><div class ="flex justify-end"><button class ="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" onclick="this.closest('.fixed').remove()">OK</button></div></div>`; document.body.appendChild(modal); } function showCustomConfirm(message, onConfirm) { const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'; modal.innerHTML = `<div class ="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><p class ="text-gray-700 dark:text-gray-300 mb-4">${message}</p><div class ="flex justify-end space-x-3"><button class ="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button><button class ="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" id="confirmBtn">Confirmer</button></div></div>`; document.body.appendChild(modal); modal.querySelector('#confirmBtn').onclick = () => { modal.remove(); onConfirm(); }; } function showCustomPrompt(message, onSubmit, defaultValue = '') { const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'; modal.innerHTML = `<div class ="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><p class ="text-gray-700 dark:text-gray-300 mb-4">${message}</p><input type="text" id="promptInput" value="${defaultValue}" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-4"><div class ="flex justify-end space-x-3"><button class ="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button><button class ="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" id="submitBtn">OK</button></div></div>`; document.body.appendChild(modal); const input = modal.querySelector('#promptInput'); input.focus(); input.select(); const submit = () => { const value = input.value; modal.remove(); if (value) onSubmit(value); }; modal.querySelector('#submitBtn').onclick = submit; input.onkeypress = (e) => { if (e.key === 'Enter') submit(); }; } function requestAccessCode(type, callback) { showCustomPrompt('Entrez le code d\'acc√®s niveau 2:', async (code) => { const hashedCode = await SECURITY.hashPassword(code); if (hashedCode === SECURITY.accessCodeHash) { if (type === 'sdi') { STATE.accessLevel = 2; logAction('Acc√®s niveau 2 SDI'); } else { STATE.smsiAccessLevel = 2; logAction('Acc√®s niveau 2 SMSI'); } callback(true); } else { showCustomAlert('Code incorrect'); callback(false); } }); } let importOffered = false; function saveTrainees() { if (firebaseInitialized) { db.ref('trainees').set(STATE.trainees); } } function loadTraineesFromFirebase() { if (!firebaseInitialized) return; db.ref('trainees').once('value', (snapshot) => { const trainees = snapshot.val(); if (trainees) { STATE.trainees = trainees; render(); } }); db.ref('trainees').on('value', (snapshot) => { const trainees = snapshot.val(); if (trainees) { STATE.trainees = trainees; if (STATE.currentView === 'trainee-management' || STATE.currentView === 'trainee-login') { render(); } } }); } function loadSessionLogsFromFirebase() { if (!firebaseInitialized) return; db.ref('session_logs').once('value', (snapshot) => { const logs = snapshot.val(); if (logs) { STATE.sessionLogs = Object.values(logs); } }); db.ref('session_logs').on('child_added', (snapshot) => { const log = snapshot.val(); if (log && !STATE.sessionLogs.find(l => l.sessionId === log.sessionId)) { STATE.sessionLogs.push(log); if (STATE.currentView === 'session-logs') { render(); } } }); } function autoImportOnStartup() { if (firebaseInitialized) { return; } if (STATE.trainees.length === 0 && !importOffered) { importOffered = true; setTimeout(() => { showCustomConfirm('Voulez-vous importer le fichier stagiaires.json?', () => { importTrainees(); }); }, 300); } } function printTraineeList() { if (STATE.trainees.length === 0) { showCustomAlert('Aucun stagiaire √† imprimer'); return; } const printWindow = window.open('', '_blank'); const html = `<!DOCTYPE html><html><head><title>Liste des Stagiaires-Formation SSI SSIAP</title><style>body{font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto}h1{text-align:center;color:#5D5CDE;margin-bottom:30px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #333;padding:12px;text-align:left}th{background-color:#5D5CDE;color:white;font-weight:bold}tr:nth-child(even){background-color:#f9f9f9}.pin{font-weight:bold;font-size:18px;letter-spacing:2px;color:#5D5CDE}.footer{margin-top:30px;text-align:center;font-size:12px;color:#666}@media print{button{display:none}}</style></head><body><h1>Liste des Stagiaires-Formation SSI SSIAP</h1><p>Date d'impression:${new Date().toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p><table><thead><tr><th>Nom</th><th>Pr√©nom</th><th>Email</th><th>Code PIN</th><th>Niveau</th><th>Dates</th></tr></thead><tbody>${STATE.trainees.map(t => `<tr><td>${t.nom}</td><td>${t.prenom}</td><td>${t.email || 'N/A'}</td><td class ="pin">${t.pin}</td><td>SSIAP ${t.niveau}</td><td>${new Date(t.dateDebut).toLocaleDateString('fr-FR')}-${new Date(t.dateFin).toLocaleDateString('fr-FR')}</td></tr>`).join('')}</tbody></table><div class ="footer"><p>Formation SSI-SSIAP|Total:${STATE.trainees.length}stagiaire(s)</p></div></body></html>`; printWindow.document.write(html); printWindow.document.close(); setTimeout(() => { printWindow.print(); }, 250); } function exportTrainees() { const dataStr = JSON.stringify(STATE.trainees, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = 'stagiaires.json'; link.click(); URL.revokeObjectURL(url); } function importTrainees() { const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json'; input.onchange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const imported = JSON.parse(event.target.result); if (Array.isArray(imported)) { STATE.trainees = imported; render(); showCustomAlert(`${imported.length}stagiaire(s)import√©(s)avec succ√®s`); } else { showCustomAlert('Format de fichier invalide'); } } catch (error) { showCustomAlert('Erreur lors de la lecture du fichier'); } }; reader.readAsText(file); }; input.click(); } function checkTraineeAccess(trainee) { const today = new Date(); today.setHours(0, 0, 0, 0); const dateDebut = new Date(trainee.dateDebut); dateDebut.setHours(0, 0, 0, 0); const dateFin = new Date(trainee.dateFin); dateFin.setHours(23, 59, 59, 999); return today >= dateDebut && today <= dateFin; } function createTrainee(data) { let pin; do { pin = String(Math.floor(1000 + Math.random() * 9000)); } while (STATE.trainees.some(t => t.pin === pin)); const trainee = { id: Date.now(), nom: data.nom, prenom: data.prenom, email: data.email, niveau: data.niveau, dateDebut: data.dateDebut, dateFin: data.dateFin, pin: pin }; STATE.trainees.push(trainee); saveTrainees(); return trainee; } function navigate(view, data = {}) { STATE.currentView = view; if (data.user) STATE.currentUser = data.user; if (data.userType) STATE.userType = data.userType; render(); } function render() { const app = document.getElementById('app'); switch (STATE.currentView) { case 'home': app.innerHTML = renderHome(); break; case 'supervisor-login': app.innerHTML = renderSupervisorLogin(); break; case 'trainee-login': app.innerHTML = renderTraineeLogin(); break; case 'trainee-management': app.innerHTML = renderTraineeManagement(); autoImportOnStartup(); break; case 'create-trainee': app.innerHTML = renderCreateTrainee(); break; case 'supervisor-interface': app.innerHTML = renderSupervisorInterface(); break; case 'trainee-interface': app.innerHTML = renderTraineeInterface(); break; case 'session-logs': app.innerHTML = renderSessionLogs(); break; }restoreVideoStreams(); } function restoreVideoStreams() { setTimeout(() => { if (STATE.localStream) { const localVideo = document.getElementById('local-video'); if (localVideo && localVideo.srcObject !== STATE.localStream) { localVideo.srcObject = STATE.localStream; } } if (STATE.remoteStream) { const remoteVideo = document.getElementById('trainee-video'); if (remoteVideo && remoteVideo.srcObject !== STATE.remoteStream) { remoteVideo.srcObject = STATE.remoteStream; remoteVideo.muted = STATE.audioMuted; remoteVideo.volume = STATE.audioVolume; } } }, 50); } function renderHome() { return `<div class ="min-h-screen flex items-center justify-center p-4"><div class ="max-w-2xl w-full"><h1 class ="text-4xl font-bold text-center mb-8 text-primary">Formation SSI-SSIAP</h1><div class ="grid md:grid-cols-2 gap-6"><div onclick="navigate('supervisor-login')" class ="cursor-pointer bg-gradient-to-br from-primary to-blue-600 p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105"><h2 class ="text-2xl font-bold text-white mb-4">üë®‚Äçüè´ Superviseur</h2><p class ="text-white opacity-90">Cr√©er des sc√©narios et superviser les stagiaires</p></div><div onclick="navigate('trainee-login')" class ="cursor-pointer bg-gradient-to-br from-green-500 to-green-600 p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105"><h2 class ="text-2xl font-bold text-white mb-4">üéì Stagiaire</h2><p class ="text-white opacity-90">Se connecter et r√©aliser les exercices</p></div></div></div></div>`; } function renderSupervisorLogin() { return `<div class ="min-h-screen flex items-center justify-center p-4"><div class ="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><h2 class ="text-2xl font-bold mb-6">Connexion Superviseur</h2><form onsubmit="handleSupervisorLogin(event)" class ="space-y-4"><div><label class ="block text-sm font-medium mb-2">Code superviseur</label><input type="password" id="supervisor-code" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><button type="submit" class ="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">Se connecter</button><button type="button" onclick="navigate('home')" class ="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Retour</button></form></div></div>`; } function renderTraineeLogin() { return `<div class ="min-h-screen flex items-center justify-center p-4"><div class ="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><h2 class ="text-2xl font-bold mb-6">Connexion Stagiaire</h2><form onsubmit="handleTraineePinLogin(event)" class ="space-y-4"><div><label class ="block text-sm font-medium mb-2">Code PIN(4 chiffres)</label><input type="password" id="trainee-pin" maxlength="4" pattern="[0-9]{4}" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-center text-2xl tracking-widest" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><button type="submit" class ="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">Se connecter</button><button type="button" onclick="navigate('home')" class ="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Retour</button></form></div></div>`; } function renderTraineeManagement() { return `<div class ="min-h-screen p-4"><div class ="max-w-6xl mx-auto"><div class ="flex justify-between items-center mb-4"><h2 class ="text-3xl font-bold">Gestion des Stagiaires</h2><div class ="space-x-2"><button onclick="importTrainees()" class ="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">üì• Importer</button><button onclick="exportTrainees()" class ="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">üì§ Exporter</button><button onclick="printTraineeList()" class ="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">üñ®Ô∏è Imprimer</button><button onclick="navigate('create-trainee')" class ="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition">‚ûï Cr√©er un stagiaire</button><button onclick="navigate('supervisor-interface')" class ="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Retour</button></div></div>${STATE.trainees.length > 0 && firebaseInitialized ? `<div class ="bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500 p-4 mb-6"><p class ="text-sm text-blue-800 dark:text-blue-200">üí°<strong>Info:</strong>Les stagiaires sont synchronis√©s automatiquement via le cloud. Accessibles depuis tous les PC!</p></div>` : STATE.trainees.length > 0 ? `<div class ="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-6"><p class ="text-sm text-yellow-800 dark:text-yellow-200">‚ö†Ô∏è<strong>Mode local:</strong>Exportez r√©guli√®rement le fichier stagiaires.json comme sauvegarde.</p></div>` : ''}<div class ="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${STATE.trainees.map(trainee => { const isActive = checkTraineeAccess(trainee); const dateDebut = new Date(trainee.dateDebut).toLocaleDateString('fr-FR'); const dateFin = new Date(trainee.dateFin).toLocaleDateString('fr-FR'); return `<div class ="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg ${isActive ? 'border-2 border-green-500' : 'border-2 border-gray-400 opacity-75'}"><div class ="flex justify-between items-start mb-2"><h3 class ="text-xl font-bold">${trainee.prenom}${trainee.nom}</h3><span class ="px-2 py-1 rounded text-xs font-bold ${isActive ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'}">${isActive ? '‚úì Actif' : '‚úó Inactif'}</span></div><p class ="text-sm text-gray-600 dark:text-gray-400 mb-4">Email:${trainee.email || 'N/A'}<br>Niveau:SSIAP ${trainee.niveau}<br>Du ${dateDebut}au ${dateFin}</p><div class ="bg-primary text-white p-4 rounded-lg mb-4 text-center"><div class ="text-xs mb-1">Code PIN</div><div class ="text-3xl font-bold tracking-widest">${trainee.pin}</div></div><button onclick="deleteTrainee(${trainee.id})" class ="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">Supprimer</button></div>`; }).join('')}</div></div></div>`; } function renderCreateTrainee() { return `<div class ="min-h-screen flex items-center justify-center p-4"><div class ="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><h2 class ="text-2xl font-bold mb-6">Cr√©er un Stagiaire</h2><form onsubmit="handleCreateTrainee(event)" class ="space-y-4"><div><label class ="block text-sm font-medium mb-2">Nom</label><input type="text" id="nom" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class ="block text-sm font-medium mb-2">Pr√©nom</label><input type="text" id="prenom" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class ="block text-sm font-medium mb-2">Email</label><input type="email" id="email" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class ="block text-sm font-medium mb-2">Niveau SSIAP</label><select id="niveau" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required><option value="1">SSIAP 1</option><option value="2">SSIAP 2</option><option value="3">SSIAP 3</option></select></div><div><label class ="block text-sm font-medium mb-2">Date d√©but</label><input type="date" id="dateDebut" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class ="block text-sm font-medium mb-2">Date fin</label><input type="date" id="dateFin" class ="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><button type="submit" class ="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">Cr√©er</button><button type="button" onclick="navigate('trainee-management')" class ="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Annuler</button></form></div></div>`; } function renderSupervisorInterface() { return `<div class ="min-h-screen p-4 bg-gray-100 dark:bg-gray-900"><div class ="max-w-7xl mx-auto"><div class ="flex justify-between items-center mb-6"><h2 class ="text-3xl font-bold">Interface Superviseur</h2><div class ="space-x-2">${!STATE.sessionActive ? `<button onclick="createSession()" class ="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition font-bold">üöÄ D√©but de session</button>` : `<button onclick="endSession()" class ="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition font-bold">‚èπÔ∏è Fin de session</button>`}<button onclick="navigate('trainee-management')" class ="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">üìã Gestion stagiaires</button><button onclick="navigate('session-logs')" class ="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">üìö Journaux</button><button onclick="navigate('home')" class ="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">D√©connexion</button></div></div>${STATE.sessionActive ? `<div class ="bg-green-100 dark:bg-green-900 border-l-4 border-green-500 p-4 mb-6"><p class ="text-sm text-green-800 dark:text-green-200">‚úÖ<strong>Session active</strong>-Les stagiaires peuvent maintenant se connecter et travailler en temps r√©el.</p></div>` : `<div class ="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-6"><p class ="text-sm text-yellow-800 dark:text-yellow-200">‚ö†Ô∏è<strong>Aucune session active</strong>-Cliquez sur "üöÄ D√©but de session" pour commencer.</p></div>`}<!--Grille 2 colonnes:SDI/SMSI √† gauche,Vid√©o/Journal √† droite--><div class ="grid lg:grid-cols-2 gap-6"><!--Colonne gauche:SDI et SMSI--><div class ="space-y-6"><!--SDI Controls--><div class ="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg" style="height:600px;overflow-y:auto;"><h3 class ="text-2xl font-bold mb-4 text-primary">üî• Contr√¥le SDI</h3><div class ="space-y-4"><div class ="grid grid-cols-2 gap-2"><div><label class ="block text-xs font-medium mb-1">√âtat syst√®me</label><select onchange="changeSdiState(this.value)" class ="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="service" ${STATE.sdi.systemStat    e== ='service    ?'selecte  :'   '}   >En service</optio    ><option value="hors-service" ${STATE.sdi.systemStat e== ='hors-service    ?'selecte  :''}   >Hors service</optio    ><option value="hors-tension" ${STATE.sdi.systemStat e== ='hors-tension    ?'selecte  :''}   >Hors tension</optio   n></selec   t></di    ><div><label cl ="block text-xs font-medium mb-1">Alimentation</label><select onchange="changeSdiPower(this.value)" cl ="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="secteur" ${STATE.sdi.powerStat e== ='secteur ' ?'selected ' :''}>Secteur</option><option value="batterie" ${STATE.sdi.powerStat e== ='batterie ' ?'selected ' :''}>Batterie</option></selec   t></di    ><div><label cl ="block text-xs font-medium mb-1">Batterie</label><select onchange="changeSdiBattery(this.value)" cl ="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="service" ${STATE.sdi.batteryStat e== ='service ' ?'selected ' :''}>En service</option><option value="hors-service" ${STATE.sdi.batteryStat e== ='hors-service ' ?'selected ' :''}>Hors service</option></selec   t></di    ><div><label cl ="block text-xs font-medium mb-1">Temporisation</label><select onchange="setTemporization(this.value)" cl ="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">${           ,5].map  m=  >`<option value="${m}" ${STATE.uga.temporizatio  n== = m  ?'selected '  :''}>${m}min</option>`).join('')}</select></di   v><div><label class ="block text-xs font-medium mb-1">Type alarme</label><select onchange="setAlarmType(this.value)" class ="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="generale" ${STATE.uga.alarmTyp e== ='generale ' ?'selected ' :''}>G√©n√©rale</option><option value="generale-selective" ${STATE.uga.alarmTyp e== ='generale-selective ' ?'selected ' :''}>G√©n√©rale s√©lective</option><option value="generale-message" ${STATE.uga.alarmTyp e== ='generale-message    ?'selecte  :''}   >G√©n√©rale avec message</optio   n></selec   t></di   v></di   v>   <!--DAI et DM c√¥te √† c√¥t  e- -><div class ="grid grid-cols-2 gap-4"><div><h4 class ="font-bold mb-2">üîç DAI</h4>${STATE.sdi.detectors.map( d= >`<div class ="flex items-center gap-1 mb-1"><button onclick="${(d.stat e== ='service '& &!d.outOfService ) ?`toggleDetector('DAI',${d.id}) ` :''}" class ="w-8 h-8 ${(d.outOfServic e| |d.stat e== ='hors-service' ) ?'bg-orange-500 ' :(d.triggere d ?'bg-red-500 ' :'bg-green-500')}rounded border-2 border-black ${(d.stat e== ='hors-service '| |d.outOfService ) ?'cursor-not-allowed ' :'hover:opacity-90 cursor-pointer'}flex-shrink-0 text-white text-xs"></button><span class ="text-xs font-mono w-12 flex-shrink-0 font-bold ${(d.outOfServic e| |d.stat e== ='hors-service' ) ?'text-orange-600 dark:text-orange-400 ' :''}">DAI${String(d.id).padStart(2 ,'0')}</span><select onchange="changeDetectorZone('DAI',${d.id},this.value)" class ="px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-16"><option value="ZC1" ${d.zon e== ='ZC1 ' ?'selected ' :''}>ZC1</option><option value="ZC2" ${d.zon e== ='ZC2 ' ?'selected ' :''}>ZC2</option><option value="ZC3" ${d.zon e== ='ZC3    ?'selecte  :''}   >ZC3</optio   n></selec    ><input type="text" value="${d.address.replace(/^(DAI|DM)\s*\d*-?\d*\s*/ ,'').trim()}" placeholder="Adresse" onchange="updateDetectorAddressInput('DAI',${d.id},this.value)" cl ="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"><select onchange="changeDetectorState('DAI',${d.id},this.value)" cl ="px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-12"><option value="service" ${(d.stat e== ='service '& &!d.outOfService ) ?'selected ' :''}>OK</option><option value="hors-service" ${(d.stat e== ='hors-service '| |d.outOfService ) ?'selected ' :''}>HS</option></selec   t></di    >`).join('')}</div><div><h4 class ="font-bold mb-2">üö® DM</h4>${STATE.sdi.manualAlarms.map    d=    >`<div class ="flex items-center gap-1 mb-1"><button onclick="${(d.stat    e== ='service    '&    &!d.outOfServic )  ?`toggleDetector('DM',${d.id}) `    :''}" class =" w  -8  h  -8 $  {(d.outOfServic    e|    |d.stat    e== ='hors-service' ) ?'bg-orange-500 '    :(d.trigger   ?'bg-red-500    :'b g -gree n -500' )}rounded borde r  -2 borde r  -black $  {(d.stat   e== ='hor s -service   '|   |d.outOfService ) ?'curso r -no t -allowed '   :'hover :opacit y -90 curso r -pointer ' }fle x  -shrin k  -0 tex t  -white tex t  -xs"></button><span class ="tex t  -xs fon t  -mono  w  -12 fle x  -shrin k  -0 fon t  -bold $  {(d.outOfServic   e|   |d.stat   e== ='hor s -service' ) ?'tex t -orang e -600 dark :tex t -orang e -400 '   :' '  }">DM${String(d.id).padStart(2 ,'0')}</span><select onchange="changeDetectorZone('D  ,$   {d.i    ,this.value )" class ="p    -1 p    -1 tex    -xs border borde    -gra    -300 da :borde    -gra    -600 rounded b    -white da :b    -gra    -700 tex    -gra    -900 da :tex    -gra    -100     -16"><option value="ZC1" ${d.zon e== ='ZC1 ' ?'selected ' :''}>ZC1</option><option value="ZC2" ${d.zon e== ='ZC2 ' ?'selected ' :''}>ZC2</option><option value="ZC3" ${d.zon e== ='ZC3 ' ?'selected ' :''}>ZC3</option></select><input type="text" value="$   {d.address.replace(/^(DAI|DM)\s*\d*-?\d*\s*  ,'').trim( ) }" placeholder="Adresse" onchange="updateDetectorAddressInput('DM' ,$ {d.i d} ,this.value)" class ="fle x -1 p x -1 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100 mi n - w -0"><select onchange="changeDetectorState('DM' ,$ {d.i d} ,this.value)" class ="p x -1 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100  w -12"><option value="service" ${(d.stat e== ='service '& &!d.outOfService ) ?'selected ' :''}>OK</optio n  ><option value="hor s -service" ${(d.stat e== ='hors-service   '|   |d.outOfServi    ?'selected    :'  '}  >HS</optio  n></selec  t></di v  >`).join('')}</div></div></div></div><!--SMSI Controls--><div class ="b g -white dark :b g -gra y -800  p -6 rounde d -xl shado w -lg" style="height :500px ;overflo w -y :auto ;"><h3 class ="tex t -2xl fon t -bold m b -4 tex t -primary">üõ°Ô∏è Contr√¥le SMSI</h3><div class ="spac e - y -4"><div class ="grid gri d -col s -2 ga p -2"><div><label class ="block tex t -xs fon t -medium m b -1">√âtat syst√®me</label><select onchange="changeSmsiState(this.value)" class =" w -full p x -2 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100"><option value="service" ${STATE.smsi.systemStat   e== ='service    ?'selected    :' '}  >En service</optio n  ><option value="hor s -service" ${STATE.smsi.systemStat e== ='hors-service    ?'selected    :' '}  >Hors service</optio n  ><option value="hor s -tension" ${STATE.smsi.systemStat e== ='hors-tension    ?'selected    :''}  >Hors tension</optio  n></selec  t></di v  ><div><label cla ="block tex t -xs fon t -medium m b -1">Alimentation</label><select onchange="changeSmsiPower(this.value)" cla =" w -full p x -2 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100"><option value="secteur" ${STATE.smsi.powerStat e== ='secteur ' ?'selected ' :''}>Secteur</option><option value="batterie" ${STATE.smsi.powerStat e== ='batterie ' ?'selected ' :''}>Batterie</option></selec  t></di v  ><div><label cla ="block tex t -xs fon t -medium m b -1">Batterie</label><select onchange="changeSmsBattery(this.value)" cla =" w -full p x -2 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100"><option value="service" ${STATE.smsi.batteryStat e== ='service ' ?'selected ' :''}>En service</option><option value="hor s -service" ${STATE.smsi.batteryStat e== ='hors-service ' ?'selected ' :''}>Hors service</option></selec  t></di  v></di  v>  <!--Z  ,ZF et Coffrets c√¥te √† c√¥t e- -><div class ="grid gri d -col s -3 ga p -2"><div><h4 class ="fon t -bold m b -1 tex t -xs">üö™ ZC</h4>${STATE.smsi.compartmentZones.map( z= >`<div class ="flex fle x -col ga p -1 m b -1"><div class ="flex item s -center ga p -1"><span class ="tex t -xs fon t -mono fon t -bold">${z.zone}</span><select onchange="changeZoneState('compartment' ,$ {z.i d} ,this.value)" class ="fle x -1 p x -1 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100 mi n - w -0"><option value="attente" ${z.stat e== ='attente ' ?'selected ' :''}>Attente</option><option value="defau t -attente" ${z.stat e== ='defaut-attente ' ?'selected ' :''}>D√©f. attente</option><option value="securite" ${z.stat e== ='securite    ?'selected    :''}  >S√©curit√©</optio n  ><option value="defau t -securite" ${z.stat e== ='defaut-securite    ?'selected    :''}  >D√©f s√©curit√©</optio n  ><option value="defau t -alim" ${z.stat e== ='defaut-alim    ?'selected    :''}  >D√©f alim</optio  n></selec  t></di v  ><input type="text" value="$ {z.address.replace(/^Compartiment Zone \d+  ,'').trim( ) }" placeholder="Adresse" onchange="updateZoneAddressInput('compartment' ,$ {z.i d} ,this.valu e| |'Compart. Z${z.id}')" cla =" w -full p x -1 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100 mi n - w -0"></div>`).join('')}</div><div><h4 class ="fon t -bold m b -1 tex t -xs">üí® ZF</h4>${STATE.smsi.smokeZones.map   z=   >`<div class ="flex fle x -col ga p -1 m b -1"><div class ="flex item s -center ga p -1"><span class ="tex t -xs fon t -mono fon t -bold">${z.zone}</span><select onchange="changeZoneState('smoke' ,$ {z.i d} ,this.value)" class ="fle x -1 p x -1 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100 mi n - w -0"><option value="attente" ${z.stat   e== ='attente    ?'selected    :''}  >Attente</optio n  ><option value="defau t -attente" ${z.stat e== ='defaut-attente    ?'selected    :''}  >D√©f attente</optio n  ><option value="securite" ${z.stat e== ='securite    ?'selected    :''}  >S√©curit√©</optio n  ><option value="defau t -securite" ${z.stat e== ='defaut-securite    ?'selected    :''}  >D√©f s√©curit√©</optio n  ><option value="defau t -alim" ${z.stat e== ='defaut-alim    ?'selected    :''}  >D√©f alim</optio  n></selec  t></di v  ><input type="text" value="$ {z.address.replace(/^D√©senfumage Zone \d+  ,'').trim( ) }" placeholder="Adresse" onchange="updateZoneAddressInput('smoke' ,$ {z.i d} ,this.valu e| |'D√©senf. Z${z.id}')" cla =" w -full p x -1 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100 mi n - w -0"></div>`).join('')}</div><div><h4 class ="fon t -bold m b -1 tex t -xs">‚ö° Coffrets</h4>${STATE.smsi.relayBoxes.map   r=   >`<div class ="flex fle x -col ga p -1 m b -1"><div class ="flex item s -center ga p -1"><span class ="tex t -xs fon t -mono fon t -bold">CR${r.id}</span><select onchange="changeZoneState('relay' ,$ {r.i d} ,this.value)" class ="fle x -1 p x -1 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100 mi n - w -0"><option value="attente" ${r.stat   e== ='attente    ?'selected    :''}  >Attente</optio n  ><option value="defau t -attente" ${r.stat e== ='defaut-attente    ?'selected    :''}  >D√©f attente</optio n  ><option value="securite" ${r.stat e== ='securite    ?'selected    :''}  >S√©curit√©</optio n  ><option value="defau t -securite" ${r.stat e== ='defaut-securite    ?'selected    :''}  >D√©f s√©curit√©</optio n  ><option value="defau t -alim" ${r.stat e== ='defaut-alim    ?'selected    :''}  >D√©f alim</optio  n></selec  t></di v  ><input type="text" value="$ {r.address.replace(/^Coffret \d+  ,'').trim( ) }" placeholder="Adresse" onchange="updateZoneAddressInput('relay' ,$ {r.i d} ,this.valu e| |'Coffret ${r.id}')" cla =" w -full p x -1 p y -1 tex t -xs border borde r -gra y -300 dark :borde r -gra y -600 rounded b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100 mi n - w -0"></div>`).join('')}</div></div></div></div></div><!--Colonne droite:Vid√©o et Journal--><div class ="spac e - y -6"><!--Video Panel Superviseur-->${STATE.sessionActiv    ?`<div class ="b g -white dark :b g -gra y -800  p -6 rounde d -xl shado w -lg" style="height :600px ;overflo w -y :auto ;"><h3 class ="tex t -2xl fon t -bold m b -4">üìπ Vue Stagiaire</h3><div id="vide o -statu s -section">${!STATE.remoteStrea    ?`<div class ="tex t -center p y -8"><p class ="tex t -gra y -600 dark :tex t -gra y -400 m b -4">En attente que le stagiaire active sa cam√©ra...</p><button onclick="supervisorConnectToVideo()" class ="p x -6 p y -3 b g -blu e -500 tex t -white rounde d -lg hover :b g -blu e -600 transition fon t -bold">üîó Se connecter √† la vid√©o</button></div>    :`<div class ="spac e - y -3"><!--Vid√©o--><div class ="relative b g -black rounde d -lg overflo w -hidden" style="height :280px ;"><video id="traine e -video" autoplay playsinline class =" w -full  h -full objec t -cover"></video><div class ="absolute to p -2 lef t -2 p x -2 p y -1 b g -re d -500 tex t -white tex t -xs rounded">üî¥ STAGIAIRE EN DIRECT</div><div class ="absolute botto m -2 righ t -2"><button onclick="disconnectVideo()" class ="p x -2 p y -1 b g -gra y -600 tex t -white rounded hover :b g -gra y -700 tex t -xs">‚èπÔ∏è D√©connecter</button></div></div><!--3 boutons en ligne:Son+Micro+Enregistrer--><div class ="grid gri d -col s -3 ga p -2"><!--Bouton SON--><button onclick="toggleAudioMute()" class ="p x -4 p y -3 b g -$ {STATE.audioMute d  ?'red '  :'green ' }-500 tex t -white rounde d -lg hover :b g -$ {STATE.audioMute d  ?'red '  :'green ' }-600 transition fon t -bold flex fle x -col item s -center justif y -center ga p -1"><span class ="tex t -2xl">${STATE.audioMute    ?'üîá    :'üîä'}</spa n  ><span cla ="tex t -xs">${STATE.audioMute d ?'Son ' :'Son'}</span></butto  n>  <!--Bouton MICR O- -><button onclick="toggleSupervisorMic()" class ="p x -4 p y -3 b g -$ {STATE.supervisorMicActiv e  ?'blue '  :'gray ' }-500 tex t -white rounde d -lg hover :b g -$ {STATE.supervisorMicActiv e  ?'blue '  :'gray ' }-600 transition fon t -bold flex fle x -col item s -center justif y -center ga p -1"><span class ="tex t -2xl">üé§</span><span class ="tex t -xs">Micro</span></button><!--Bouton ENREGISTRE R- -  >$ {!STATE.isRecordin    ?`<button onclick="startRecording()" class ="p x -4 p y -3 b g -re d -500 tex t -white rounde d -lg hover :b g -re d -600 transition fon t -bold flex fle x -col item s -center justif y -center ga p -1"><span class ="tex t -2xl">üé¨</span><span class ="tex t -xs">Enregistrer</span></button>    :`<button onclick="stopRecording()" class ="p x -4 p y -3 b g -gra y -600 tex t -white rounde d -lg hover :b g -gra y -700 transition fon t -bold flex fle x -col item s -center justif y -center ga p -1 animat e -pulse"><span class ="tex t -2xl">‚èπÔ∏è</span><span class ="tex t -xs">${getRecordingDuration()}</span></button> `}</di  v>  <!--Infos compl√©mentaire s- -  ><div cla ="tex t -xs tex t -gra y -600 dark :tex t -gra y -400 spac e - y -1">${STATE.audioMute d ?'<p>‚ö†Ô∏è Son coup√©. Utilisez un CASQUE avant activation!</p> ' :'<p>‚úÖ Son activ√©. Si larsen,coupez imm√©diatement!</p>'}${STATE.supervisorMicActiv e ?'<p>üé§ Micro activ√©-Le stagiaire vous entend</p> ' :'<p>üîá Micro coup√©-Le stagiaire ne vous entend pas</p>'}${STATE.isRecordin g ?'<p>üé¨ Enregistrement en cours(vid√©o+audio)</p> ' :''}</div></di v  >`}</div></div> `   :''}  <!--Action Lo g- -  ><div cla ="b g -white dark :b g -gra y -800  p -6 rounde d -xl shado w -lg" style="height :500px ;overflo w -y :auto ;"><h3 cla ="tex t -2xl fon t -bold m b -4 tex t -primary">üìã Journal des actions du stagiaire</h3><div cla ="ss i -screen ma x - h -96 overflo w - y -auto overflo w - x -hidden" style="wor d-break  :break -word ;ma x -width :10 0% ;">${STATE.actionLog.lengt h== = 0 ?'<div cla ="tex t -center opacit y -50">Aucune action enregistr√©e</div> ' :STATE.actionLog.slice(-20).reverse().map(lo g= >`<div cla ="m b -2 p b -2 borde r -b borde r -gree n -900"><div cla ="tex t -xs opacit y -75">${new Date(log.timestamp).toLocaleString('fr-FR')}</div><div>${log.trainee}:<span cla ="tex t -yello w -400">${log.action}</span></div>${log.detail s ?`<div cla ="tex t -sm opacit y -75">${log.details}</div> ` :''}</div>`).join('')}</div></div></di  v></di  v></di  v></di v  >` ; }function renderTraineeInterface( ) {return  `  <div class  ="mi n - h -screen  p -2 b g -gra y -100 dark :b g -gra y -900  "><div class ="ma x - w -7xl m x -auto"><div class ="flex justif y -between item s -center m b -4"><div><h2 class ="tex t -2xl fon t -bold">SSI-Formation</h2><p class ="tex t -xs tex t -gra y -600 dark :tex t -gra y -400">${STATE.currentUser?.prenom}${STATE.currentUser?.nom}-SSIAP ${STATE.currentUser?.niveau}</p>${STATE.sessionActiv e& &STATE.sessionNumbe r ?`<div class ="m t -1 flex item s -center ga p -2"><span class ="p x -2 p y -1 b g -blu e -500 tex t -white rounded tex t -xs fon t -bold">üìã Session ${STATE.sessionNumber}</span><span class ="p x -2 p y -1 $ {STATE.sessionActiv e  ?'bg-green-500 '  :'bg-red-500 ' }tex t -white rounded tex t -xs fon t -bold">${STATE.sessionActiv e ?'‚úì OUVERTE ' :'‚úó FERM√âE'}</span></div> ` :STATE.sessionI d ?`<div class ="m t -1"><span class ="p x -2 p y -1 b g -yello w -500 tex t -white rounded tex t -xs fon t -bold">‚è≥ En attente de session...</span></div> ` :''}</div><button onclick="navigate('home')" class ="p x -4 p y -2 b g -gra y -500 tex t -white rounded hover :b g -gra y -600 transition tex t -sm">D√©connexion</button></div><div class ="grid lg :gri d -col s -2 ga p -4"><!--SDI Panel--><div class ="ss i -panel"><h3 class ="tex t -xl fon t -bold m b -3 tex t -white">üî• SDI</h3><!--Status Indicators-3 voyants--><div class ="grid gri d -col s -3 ga p -2 m b -2"><div class ="b g -gra y -800  p -1.5 rounded flex item s -center justif y -between"><div class ="tex t -white tex t -xs">√âtat mat.</div><span class ="le d -light $ {STATE.sdi.systemStat  e== ='service '  ?'led-green '  :'led-off ' }"></span></div><div class ="b g -gra y -800  p -1.5 rounded flex item s -center justif y -between"><div class ="tex t -white tex t -xs">Alim. sect.</div><span class ="le d -light $ {STATE.sdi.powerStat  e== ='secteur '  ?'led-green '  :'led-off ' }"></span></div><div class ="b g -gra y -800  p -1.5 rounded flex item s -center justif y -between"><div class ="tex t -white tex t -xs">Batterie</div><span class ="le d -light $ {STATE.sdi.batteryStat  e== ='service '  ?'led-green '  :'led-off ' }"></span></div></div><!--ECS Screen--><div class ="m b -2"><div class ="tex t -white tex t -xs fon t -bold m b -1"><span>üìü ECS</span></div><div id="sd i -screen" class ="ss i -screen ma x - h -48 overflo w - y -hidden overflo w - x -hidden tex t -xs scrol l -smooth">${STATE.sdi.alarms.lengt h== = 0 ?'<div class ="tex t -center">SYST√àME EN VEILLE</div> ' :STATE.sdi.alarms.map(alar m= >`<div class ="m b -1">${alarm.text}</div>`).join('')}</div><!--Navigation-Nord Sud Est Ouest--><div class ="flex justif y -center ga p -1 m t -1"><button onclick="scrollScreen('sdi-screen' ,'first')" class ="b g -blu e -600 hover :b g -blu e -700 tex t -white p x -2 p y -1 rounded tex t -xs fon t -bold" title="Ouest">‚¨ÖÔ∏è</button><button onclick="scrollScreen('sdi-screen' ,'up')" class ="b g -blu e -600 hover :b g -blu e -700 tex t -white p x -2 p y -1 rounded tex t -xs fon t -bold" title="Nord">‚¨ÜÔ∏è</button><button onclick="scrollScreen('sdi-screen' ,'down')" class ="b g -blu e -600 hover :b g -blu e -700 tex t -white p x -2 p y -1 rounded tex t -xs fon t -bold" title="Sud">‚¨áÔ∏è</button><button onclick="scrollScreen('sdi-screen' ,'last')" class ="b g -blu e -600 hover :b g -blu e -700 tex t -white p x -2 p y -1 rounded tex t -xs fon t -bold" title="Est">‚û°Ô∏è</button></div></div><!--Fire Alarm with Sound Control--><div class ="b g -gra y -800  p -2 rounded m b -3"><div class ="flex item s -center justif y -between"><span class ="tex t -white tex t -xs fon t -bold">ALARME FEU</span><div class ="flex item s -center ga p -2"><span class ="le d -light $ {STATE.sdi.fireAlarmActiv e  ?'led-red blink '  :'led-off ' }"></span>${STATE.sdi.alarmSoun d ?`<button onclick="traineeStopAlarmSound()" class ="p x -2 p y -1 b g -yello w -600 tex t -white rounded tex t -xs hover :b g -yello w -700">üîá ARR√äT</button> ` :''}</div></div></div><!--4 Boutons de commande sur une ligne--><div class ="grid gri d -col s -4 ga p -1 m b -2"><button onclick="toggleAccessLevel('sdi')" class ="p x -2 p y -2 $ {STATE.accessLeve  l== = 1  ?'bg-green-600 '  :'bg-yellow-600 ' }tex t -white rounded tex t -xs hover :opacit y -90 fon t -bold">üîë Niv.${STATE.accessLevel}</button><button onclick="traineeResetSdiSystem()" class ="p x -2 p y -2 $ {canResetSdiSystem )  ?'bg-green-600 '  :'bg-gray-600 opacity-50 ' }tex t -white rounded tex t -xs fon t -bold">üîÑ R√âARM</button><button onclick="startOutOfServiceWorkflow()" class ="p x -2 p y -2 $ {STATE.accessLeve  l== = 2  ?'bg-orange-600 hover:bg-orange-700 '  :'bg-gray-600 opacity-50 ' }tex t -white rounded tex t -xs fon t -bold" ${STATE.accessLeve l!= = 2 ?'disabled ' :''}>‚ö†Ô∏è M.H.S.</button><button onclick="startBackInServiceWorkflow()" class ="p x -2 p y -2 $ {STATE.accessLeve  l== = 2  ?'bg-blue-600 hover:bg-blue-700 '  :'bg-gray-600 opacity-50 ' }tex t -white rounded tex t -xs fon t -bold" ${STATE.accessLeve l!= = 2 ?'disabled ' :''}>‚úÖ R.S.</button></div><!--Pav√© num√©rique en dessous--><div class ="b g -gra y -800  p -1.5 rounded m b -2"><div class ="tex t -white tex t -xs fon t -bold m b -1">Pav√© num√©rique</div><div class ="b g -black tex t -gree n -400 fon t -mono  p -1 rounded m b -1 tex t -center tex t -xs mi n - h -[20px]">${STATE.keypadInpu t| |'_'}</div><div class ="grid gri d -col s -3 ga p -0.5">${[1 ,2 ,3 ,4 ,5 ,6 ,7 ,8 ,9].map( n= >`<button onclick="keypadPress('${n}')" class ="b g -gra y -700 hover :b g -gra y -600 tex t -white p y -1.5 rounded tex t -xs fon t -bold">${n}</button>`).join('')}<button onclick="keypadPress('C')" class ="b g -re d -700 hover :b g -re d -600 tex t -white p y -1.5 rounded tex t -xs fon t -bold">C</button><button onclick="keypadPress('0')" class ="b g -gra y -700 hover :b g -gra y -600 tex t -white p y -1.5 rounded tex t -xs fon t -bold">0</button><button onclick="keypadValidate()" class ="b g -gree n -700 hover :b g -gree n -600 tex t -white p y -1.5 rounded tex t -xs fon t -bold">‚úì</button></div></div></div><!--SMSI Pane l- -><div class ="ss i -panel"><h3 class ="tex t -xl fon t -bold m b -3 tex t -white">üõ°Ô∏è SMSI</h3><!--Status Indicators-3 voyants--><div class ="grid gri d -col s -3 ga p -2 m b -2"><div class ="b g -gra y -800  p -1.5 rounded flex item s -center justif y -between"><div class ="tex t -white tex t -xs">√âtat mat.</div><span class ="le d -light $ {STATE.smsi.systemStat  e== ='service '  ?'led-green '  :'led-off ' }"></span></div><div class ="b g -gra y -800  p -1.5 rounded flex item s -center justif y -between"><div class ="tex t -white tex t -xs">Alim. sect.</div><span class ="le d -light $ {STATE.smsi.powerStat  e== ='secteur '  ?'led-green '  :'led-off ' }"></span></div><div class ="b g -gra y -800  p -1.5 rounded flex item s -center justif y -between"><div class ="tex t -white tex t -xs">Batterie</div><span class ="le d -light $ {STATE.smsi.batteryStat  e== ='service '  ?'led-green '  :'led-off ' }"></span></div></div><!--SMSI Screen--><div class ="m b -2"><div class ="tex t -white tex t -xs fon t -bold m b -1"><span>üìü Remont√©es SMSI</span></div><div id="sms i -screen" class ="ss i -screen ma x - h -48 overflo w - y -hidden overflo w - x -hidden tex t -xs scrol l -smooth">${STATE.smsi.messages.lengt h== = 0 ?'<div class ="tex t -center">SYST√àME EN VEILLE</div> ' :STATE.smsi.messages.map(ms g= >`<div class ="m b -1">${msg.text}</div>`).join('')}</div><!--Navigation-Nord Sud Est Ouest--><div class ="flex justif y -center ga p -1 m t -1"><button onclick="scrollScreen('smsi-screen' ,'first')" class ="b g -blu e -600 hover :b g -blu e -700 tex t -white p x -2 p y -1 rounded tex t -xs fon t -bold" title="Ouest">‚¨ÖÔ∏è</button><button onclick="scrollScreen('smsi-screen' ,'up')" class ="b g -blu e -600 hover :b g -blu e -700 tex t -white p x -2 p y -1 rounded tex t -xs fon t -bold" title="Nord">‚¨ÜÔ∏è</button><button onclick="scrollScreen('smsi-screen' ,'down')" class ="b g -blu e -600 hover :b g -blu e -700 tex t -white p x -2 p y -1 rounded tex t -xs fon t -bold" title="Sud">‚¨áÔ∏è</button><button onclick="scrollScreen('smsi-screen' ,'last')" class ="b g -blu e -600 hover :b g -blu e -700 tex t -white p x -2 p y -1 rounded tex t -xs fon t -bold" title="Est">‚û°Ô∏è</button></div></div><!--UGA-Simplified--><div class ="b g -gra y -800  p -2 rounded m b -3"><div class ="tex t -white fon t -bold m b -2 tex t -xs">üîî UGA</div>${STATE.uga.temporizationActiv e ?`<div class ="b g -yello w -600 tex t -white  p -2 rounded m b -2 tex t -center fon t -bold tex t -xs temporizatio n -display">‚è±Ô∏è ${Math.floor(STATE.uga.temporizationRemainin g /60)}:${String(STATE.uga.temporizationRemaining % 60).padStart(2 ,'0')}</div> ` :'<div class ="temporizatio n -display"></div>'}<div class ="grid gri d -col s -2 ga p -1"><button id="forceAlarmBtn" onmousedown="startForceAlarm()" onmouseup="cancelForceAlarm()" ontouchstart="startForceAlarm()" ontouchend="cancelForceAlarm()" class ="p x -2 p y -2 b g -re d -600 tex t -white rounded tex t -xs hover :b g -re d -700">üö® FORC√â(3s)</button><button onclick="traineeAcquitProcess()" class ="p x -2 p y -2 $ {STATE.uga.temporizationActiv e  ?'bg-yellow-600 hover:bg-yellow-700 '  :'bg-gray-500 opacity-50 cursor-not-allowed ' }tex t -white rounded tex t -xs" ${STATE.uga.alarmActiv e ?'disabled ' :''}>‚úã ACQUIT ${STATE.uga.temporizationActiv e ?' ' :'(Inactif)'}</button></div>${STATE.uga.alarmActiv e ?`<div class ="m t -2 b g -re d -600 tex t -white  p -2 rounded tex t -center fon t -bold tex t -xs blink">üö® ALARME ${STATE.uga.alarmTyp e== ='generale ' ?'G√âN√âRALE ' :(STATE.uga.alarmTyp e== ='generale-selective ' ?'S√âLECTIVE ' :'AVEC MESSAGE')}</div> ` :''}</div><!--UCM C  -Side by sid e- -><div class ="b g -gra y -800  p -2 rounded m b -3"><div class ="tex t -white fon t -bold m b -2 tex t -xs">üéõÔ∏è UCMC</div><div class ="grid gri d -col s -2 ga p -2"><!--Compartimentage--><div class ="p r -2 borde r -r borde r -gra y -600"><div class ="tex t -white tex t -xs m b -1">üö™ ZC</div>${STATE.smsi.compartmentZones.map( z= >`<div class ="flex item s -center ga p -1 m b -1"><span class ="tex t -white tex t -xs fon t -bold  w -6 fle x -shrin k -0">${z.zone}</span><span class ="le d -light $ {z.ledRed.o n  ?'led-red '  :'led-off '}$ {z.ledRed.blin k  ?'blink '  :' ' }"></span><span class ="le d -light $ {z.ledOrange.o n  ?'led-orange '  :'led-off '}$ {z.ledOrange.blin k  ?'blink '  :' ' }"></span><span class ="le d -light $ {z.ledGreen.o n  ?'led-green '  :'led-off '}$ {z.ledGreen.blin k  ?'blink '  :' ' }"></span><span class ="tex t -white tex t -xs opacit y -75 truncate fle x -1">${z.address}</span><button onclick="commandZone('compartment' ,$ {z.i d})" class ="p x -1 p y -1 b g -blu e -600 tex t -white rounded tex t -xs hover :b g -blu e -700 fle x -shrin k -0">CMD</button><span class ="comman d -led $ {z.commandActiv e  ?'active '  :' ' }"></span></div>`).join('')}</div><!--D√©senfumage--><div class ="p l -2"><div class ="tex t -white tex t -xs m b -1">üí® ZF</div>${STATE.smsi.smokeZones.map( z= >`<div class ="flex item s -center ga p -1 m b -1"><span class ="tex t -white tex t -xs fon t -bold  w -6 fle x -shrin k -0">${z.zone}</span><span class ="le d -light $ {z.ledRed.o n  ?'led-red '  :'led-off '}$ {z.ledRed.blin k  ?'blink '  :' ' }"></span><span class ="le d -light $ {z.ledOrange.o n  ?'led-orange '  :'led-off '}$ {z.ledOrange.blin k  ?'blink '  :' ' }"></span><span class ="le d -light $ {z.ledGreen.o n  ?'led-green '  :'led-off '}$ {z.ledGreen.blin k  ?'blink '  :' ' }"></span><span class ="tex t -white tex t -xs opacit y -75 truncate fle x -1">${z.address}</span><button onclick="commandZone('smoke' ,$ {z.i d})" class ="p x -1 p y -1 b g -blu e -600 tex t -white rounded tex t -xs hover :b g -blu e -700 fle x -shrin k -0">CMD</button><span class ="comman d -led $ {z.commandActiv e  ?'active '  :' ' }"></span></div>`).join('')}</div></div></div><!--Coffrets de relayage(moved from US )- - ><div clas ="b g -gra y -800  p -2 rounded m b -3"><div clas ="tex t -white fon t -bold m b -2 tex t -xs">‚ö° Coffrets relayage</div><div clas ="grid gri d -col s -3 ga p -2">${STATE.smsi.relayBoxes.map  r=  >`<div class ="flex fle x -col ga p -1"><div class ="flex item s -center ga p -1 justif y -center"><span class ="tex t -white tex t -xs fon t -bold">CR${r.id}</span><span class ="le d -light $ {r.ledRed.o n  ?'led-red '  :'led-off '}$ {r.ledRed.blin k  ?'blink '  :' ' }"></span><span class ="le d -light $ {r.ledOrange.o n  ?'led-orange '  :'led-off '}$ {r.ledOrange.blin k  ?'blink '  :' ' }"></span><span class ="le d -light $ {r.ledGreen.o n  ?'led-green '  :'led-off '}$ {r.ledGreen.blin k  ?'blink '  :' ' }"></span></div><div class ="tex t -white tex t -xs opacit y -75 tex t -center truncate  w -full m b -1">${r.address}</div><button onclick="stopRelay($ {r.i d})" class =" w -full p x -1 p y -1 $ {r.stoppe d  ?'bg-red-600 '  :'bg-orange-600 ' }tex t -white rounded tex t -xs hover :opacit y -90">${r.stoppe d  ?'ARR√äT√â '  :'ARR√äT'}</button></div>`).join('')}</div></div><!--U S -Simplified- -><div class ="b g -gra y -800  p -2 rounded m b -3"><div class ="tex t -white fon t -bold m b -2 tex t -xs">üí° US</div><div class ="grid gri d -col s -2 ga p -1"><button onclick="testSignalization()" class ="p x -2 p y -1 b g -yello w -600 tex t -white rounded tex t -xs hover :b g -yello w -700">üß™ TEST</button><button onclick="bilanSystem()" class ="p x -2 p y -1 b g -gree n -600 tex t -white rounded tex t -xs hover :b g -gree n -700">üìä BILAN</button></div></div><!--SMSI Reset- - ><div clas ="flex ga p -2"><button onclick="toggleAccessLevel('smsi')" clas ="p x -3 p y -1 $ {STATE.smsiAccessLeve  l== = 1  ?'bg-green-600 '  :'bg-yellow-600 ' }tex t -white rounded tex t -xs hover :opacit y -90">Niv.${STATE.smsiAccessLevel}</button><div clas ="ke y-switch ${STATE.smsiAccessLeve   l== =    ?'active    :''}" onclick="toggleAccessLevel('smsi')">üîë</div><button onclick="traineeResetSmsiSystem()" clas ="fle x  -1 p x  -3 p y  -1 $  {canResetSmsiSystem    ?'bg-green-600    :'bg-gray-600 opacity-50  }tex t -white rounded tex t -xs">üîÑ R√âARMEMENT SMSI</button></div></di v> <!--Action Lo g -Pleine largeur sous SDI et SMSI- - ><div clas ="lg :co l -spa n -2"><div clas ="ss i -panel"><h3 clas ="tex t -xl fon t -bold m b -3 tex t -white">üìã Journal des actions du stagiaire</h3><div clas ="ss i -screen ma x - h -96 overflo w - y -auto">${STATE.actionLog.lengt  h== = 0  ?'<div clas ="tex t -center opacit y -50">Aucune action enregistr√©e</div> '  :STATE.actionLog.slice(-20).reverse().map(lo  g=  >`<div clas ="m b -2 p b -2 borde r -b borde r -gree n -900"><div clas ="tex t -xs opacit y -75">${new Date(log.timestamp).toLocaleString('fr-FR')}</div><div>${log.trainee}:<span clas ="tex t -yello w -400">${log.action}</span></div>${log.detail s  ?`<div clas ="tex t -sm opacit y -75">${log.details}</div> `  :''}</di v >`).join('')}</div></div></div></di v> <!--Video Panel Stagiair e -MASQU√â(la cam√©ra fonctionne en arri√®r e -plan automatiquement)- -> <!-- <div class ="m t -4 b g -white dark :b g -gra y -800  p -4 rounde d -xl shado w -lg " ><h3 clas ="tex t -lg fon t -bold m b -3">üìπ Partage Vid√©o/Audio</h3>$ {!STATE.localStrea    ?`<div class ="tex t -center p y -8"><p class ="tex t -gra y -600 dark :tex t -gra y -400 m b -4">Activez votre cam√©ra et micro pour partager avec le superviseur</p><button onclick="startVideo()" class ="p x -6 p y -3 b g -blu e -500 tex t -white rounde d -lg hover :b g -blu e -600 transition fon t -bold">üìπ Activer Cam√©ra et Micro</button></div>    :`<div class ="spac e - y -4"><div class ="relative b g -black rounde d -lg overflo w -hidden" style="height :240px ;"><video id="loca l -video" autoplay muted playsinline class =" w -full  h -full objec t -cover"></video><div class ="absolute to p -2 lef t -2 p x -2 p y -1 b g -gree n -500 tex t -white tex t -xs rounded">üî¥ LIVE</div><div class ="absolute botto m -2 lef t -2 righ t -2 flex justif y -center ga p -2"><button onclick="toggleVideo()" class ="p x -3 p y -2 $ {STATE.videoEnable d  ?'bg-blue-500 '  :'bg-red-500 ' }tex t -white rounded hover :opacit y -90">${STATE.videoEnable    ?'üìπ    :'üìπ‚ùå '}$  {STATE.videoEnabl   ?'ON   :'OFF '}</butto n><button onclick="toggleAudio()" class ="p x -3 p y -2 $ {STATE.audioEnable d  ?'b g -blu e -500 '  :'b g -re d -500 ' }tex t -white rounded hover :opacit y -90">${STATE.audioEnable d ?'üé§ ' :'üé§‚ùå'}${STATE.audioEnable d ?'ON ' :'OFF'}</button><button onclick="stopVideo()" class ="p x -3 p y -2 b g -gra y -600 tex t -white rounded hover :b g -gra y -700">‚èπÔ∏è Arr√™ter</button></di v></di v ><p clas ="tex t -sm tex t -gra y -600 dark :tex t -gra y -400 tex t -center">Votre vid√©o est partag√©e avec le superviseur</p></di v >`}</div>--></div></div>` ; }async function handleSupervisorLogin(even )  {event.preventDefault( ;i f(SECURITY.isLocked( )  {const remainin g  =SECURITY.getRemainingLockTime(  ;const minute s  =Math.floor(remainin g  /60  ;const second s  =remaining % 6  ;showCustomAlert(`Compte bloqu√©. R√©essayez dans ${minutes}m ${seconds}s`  ;retu ;  }const cod e  =document.getElementById('superviso r -code').valu  ;const hashedCod e  =await SECURITY.hashPassword(code ;i f(hashedCod  e== =SECURITY.supervisorPasswordHas )  {SECURITY.resetAttempts(  ;navigate('superviso r -interfac    {userTy  :'supervisor   ' ; }els e   {const locke    =SECURITY.recordFailedAttempt( ;i f(lock )   {showCustomAlert(`Trop de tentatives √©chou√©es. Compte bloqu√© pendant 5 minutes.` ; }els e   {const remainin    =SECURITY.maxLoginAttempt s -SECURITY.loginAttemp  ;showCustomAlert(`Code superviseur incorrect. ${remaining}tentative(s)restante(s).` ; } }  }function handleTraineePinLogin(eve    {event.preventDefault(   ;const pi    =document.getElementById('trainee-pin').val  ;const traine    =STATE.trainees.find   t=   >t.pi  n== =pi ;i f(!train )   {showCustomAlert('Code PIN incorrect'   ;ret ; }i f(!checkTraineeAccess(traine )   {const dateDebu t  =new Date(trainee.dateDebut).toLocaleDateString('fr-FR'   ;const dateFi n  =new Date(trainee.dateFin).toLocaleDateString('fr-FR'   ;showCustomAlert(`Acc√®s refus√©. Votre formation est autoris√©e du ${dateDebut}au $ {dateFi n}.`  ;retu ;  }navigate('trainee-interface ,  {use  :traine  ,userTyp  :'trainee  '}  ;setTimeout((  )= >  {joinActiveSession(  ;  ,500 ;  }function handleCreateTrainee(even )  {event.preventDefault(  ;const dat a =  {no  :document.getElementById('nom').valu  ,preno  :document.getElementById('prenom').valu  ,emai  :document.getElementById('email').valu  ,nivea  :document.getElementById('niveau').valu  ,dateDebu  :document.getElementById('dateDebut').valu  ,dateFi  :document.getElementById('dateFin').valu  e  ;createTrainee(data  ;navigate('trainee-management' ;i f(!firebaseInitialize )  {setTimeout((  )= >  {exportTrainees( ;showCustomAlert('Stagiaire cr√©√©!Le fichier stagiaires.json a √©t√© t√©l√©charg√© automatiquement.'  ;  ,100 ; }els e  {setTimeout((  )= >  {showCustomAlert('Stagiaire cr√©√© et synchronis√© avec le cloud!'  ;  ,100 ; }  }function deleteTrainee(i )  {showCustomConfirm('√ätes-vous s√ªr de vouloir supprimer ce stagiaire?  ,(  )= >  {STATE.trainee s =STATE.trainees.filter  t=  >t.i  d!= =id)  ;saveTrainees( ;render( ;i f(!firebaseInitialize d& &STATE.trainees.lengt h  > )  {setTimeout((  )= >  {exportTrainees( ;showCustomAlert('Stagiaire supprim√©!Le fichier stagiaires.json a √©t√© mis √† jour.'  ;  ,100 ; }else i f(firebaseInitialize )  {setTimeout((  )= >  {showCustomAlert('Stagiaire supprim√© et synchronis√© avec le cloud!'  ;  ,100 ;  }} ; }function changeSdiState(stat ) {i f(!checkSessionBeforeAction( )retu  ;STATE.sdi.systemStat e  =stat  ;sendMessage('SDI_STATE_CHANGE ,  {stat  e} ;  }function changeSdiBattery(stat ) {i f(!checkSessionBeforeAction( )retu  ;STATE.sdi.batteryStat e  =stat  ;sendMessage('SDI_BATTERY_CHANGE ,  {stat  e} ;  }function changeSdiPower(stat ) {i f(!checkSessionBeforeAction( )retu  ;STATE.sdi.powerStat e  =stat  ;sendMessage('SDI_POWER_CHANGE ,  {stat  e} ;  }function changeSmsiPower(stat ) {i f(!checkSessionBeforeAction( )retu  ;STATE.smsi.powerStat e  =stat  ;sendMessage('SMSI_POWER_CHANGE ,  {stat  e} ;  }function setTemporization(minute ) {i f(!checkSessionBeforeAction( )retu  ;STATE.uga.temporizatio n  =parseInt(minutes  ;sendMessage('SET_TEMPORIZATION ,  {minute  :parseInt(minute  )} ;  }function setAlarmType(typ ) {i f(!checkSessionBeforeAction( )retu  ;STATE.uga.alarmTyp e  =typ  ;sendMessage('SET_ALARM_TYPE ,  {alarmTyp  :typ  e} ;  }function toggleDetector(typ  ,i ) {i f(!checkSessionBeforeAction( )retu  ;const detectorArra y  =typ e== ='DAI '  ?STATE.sdi.detector   :STATE.sdi.manualAlarm  ;const detecto r  =detectorArray.find  d=  >d.i  d== =id ;i f(detector.triggere )  {resetDetector(typ  ,id  ;sendMessage('RESET_DETECTOR ,  {typ  ,i  d}  ;logAction(`R√©armement $ {typ e  ,detector.addre  ,'supervisor' ; }els e   {triggerDetector(ty  ,  ,false   ;sendMessage('TRIGGER_DETECTOR ,  {typ  ,i  d}  ;logAction(`D√©clenchement ${type}  ,detector.addres  ,'supervisor' ;  }render( ;  }function resetDM(i )  {resetDetector('D  ,id   ;sendMessage('RESET_DETECTOR ,  {typ  :'D  ,i  d  ;render( ;  }function changeDetectorState(ty  ,  ,sta   
            {const detectorArra    =typ e== ='DAI    ?STATE.sdi.detecto   :STATE.sdi.manualAlar  ;const detecto    =detectorArray.find   d=   >d.i  d== =i  ;detector.stat    =sta  ;sendMessage('CHANGE_DETECTOR_STATE ,  {typ  ,i  ,stat  e}  ;render( ;  }function changeDetectorZone(typ  ,i  ,zon )  {const detectorArra y  =typ e== ='DAI '  ?STATE.sdi.detector   :STATE.sdi.manualAlarm  ;const detecto r  =detectorArray.find  d=  >d.i  d== =id  ;detector.zon e  =zon  ;render( ;  }function renderSessionLogs )  {const sortedLog s  =[...STATE.sessionLogs].sort((  ,  )=  >new Date(b.endTim )  -new Date(a.endTime)  ;const quer y  =STATE.searchQuery.toLowerCase(  ;const filteredLog s  =quer y ?sortedLogs.filter(lo  g= >  {const dateSt r =new Date(log.startTime).toLocaleDateString('f r -FR')  ;const traine e =(log.traine e|  |'').toLowerCase(  ;const sessionNu m  =log.sessionNumber.toString(  ;return dateStr.includes(quer  )|  |trainee.includes(quer  )|  |sessionNum.includes(query  ;} )  :[  ;return `<div class ="mi n - h -screen  p -4 b g -gra y -100 dark :b g -gra y -900"><div class ="ma x - w -7xl m x -auto"><div class ="flex justif y -between item s -center m b -6"><h2 class ="tex t -3xl fon t -bold">üìö Historique des Journaux de Session</h2><button onclick="navigate('superviso r -interface')" class ="p x -4 p y -2 b g -gra y -500 tex t -white rounded hover :b g -gra y -600 transition">‚Üê Retour</button></div><!--Barre de recherche--><div class ="b g -white dark :b g -gra y -800  p -4 rounde d -xl shado w -lg m b -6"><div class ="relative"><input type="text" id="searc h -input" value="$ {STATE.searchQuer y }" oninput="updateSearchQuery(this.value)" placeholder="üîç Rechercher par date ,nom du stagiaire ou num√©ro de session..." class =" w -full p x -4 p y -3 tex t -base border borde r -gra y -300 dark :borde r -gra y -600 rounde d -lg b g -white dark :b g -gra y -700 tex t -gra y -900 dark :tex t -gra y -100" list="searc h -suggestions"/><datalist id="searc h -suggestions">${sortedLogs.map(lo  g=  >`<option value="$ {log.sessionNumbe r }">Session ${log.sessionNumber}</option><option value="$ {log.traine  e|  |' ' }"></option><option value="$ {new Date(log.startTime).toLocaleDateString('f r -FR' ) }"></option>`).join('')}</datalist>${STATE.searchQuer y  ?`<button onclick="clearSearch()" class ="absolute righ t -3 to p -3 tex t -gra y -500 hover :tex t -gra y -700">‚úï</button> `  :''}</di v >$ {STATE.searchQuer  y&  &filteredLogs.lengt h > 0  ?`<div class ="m t -2 tex t -sm tex t -gra y -600 dark :tex t -gra y -400">${filteredLogs.length}r√©sultat(s)trouv√©(s)</div> `  :' '}</di v >$ {filteredLogs.lengt  h== = 0  ?`<div class ="b g -white dark :b g -gra y -800  p -12 rounde d -xl shado w -lg tex t -center"><p class ="tex t -gra y -500 dark :tex t -gra y -400 tex t -lg">${STATE.searchQuer y  ?'Aucun r√©sultat trouv√© pour cette recherche. '  :'üîç Utilisez la barre de recherche pour afficher les journaux '}</ p></di v> ` : ` <div class ="grid ga p -6 " >$ {filteredLogs.map(lo  g=  >`<div class ="b g -white dark :b g -gra y -800  p -6 rounde d -xl shado w -lg"><div class ="flex justif y -between item s -start m b -4"><div><h3 class ="tex t -2xl fon t -bold tex t -primary">Session ${log.sessionNumber}</h3><div class ="tex t -sm tex t -gra y -600 dark :tex t -gra y -400 m t -1"><span>üë§ ${log.traine  e|  |'Inconnu'}</spa n><span class ="m x -2">‚Ä¢</span><span>üë®‚Äçüè´ ${log.superviso r| |'Superviseur'}</span></di v></di v ><div clas ="tex t -right tex t -sm"><div clas ="tex t -gra y -600 dark :tex t -gra y -400">üìÖ ${new Date(log.startTime).toLocaleDateString('f r -FR')}</div><div clas ="tex t -gra y -600 dark :tex t -gra y -400">üïê ${new Date(log.startTime).toLocaleTimeString('f r -FR')}-${new Date(log.endTime).toLocaleTimeString('f r -FR')}</div></div></di v ><div clas ="borde r -t borde r -gra y -200 dark :borde r -gra y -700 p t -4"><h4 clas ="fon t -bold m b -3">üìã Actions(${log.actions.length})</h4><div clas ="ss i -screen ma x - h -96 overflo w - y -auto">${log.actions.slice(-50).reverse().map(actio  n=  >`<div class ="m b -2 p b -2 borde r -b borde r -gree n -900"><div class ="tex t -xs opacit y -75">${new Date(action.timestamp).toLocaleString('f r -FR')}</div><div>${action.trainee}:<span class ="tex t -yello w -400">${action.action}</span></div>${action.detail s  ?`<div class ="tex t -sm opacit y -75">${action.details}</div> `  :''}</div>`).join('')}</div></di v ><div clas ="m t -4 flex justif y -end ga p -2"><button onclick="printSessionLog('$ {log.sessionI d}')" clas ="p x -4 p y -2 b g -blu e -500 tex t -white rounded hover :b g -blu e -600 transition tex t -sm">üñ®Ô∏è Imprimer PDF</button><button onclick="deleteSessionLog('$ {log.sessionI d}')" clas ="p x -4 p y -2 b g -re d -500 tex t -white rounded hover :b g -re d -600 transition tex t -sm">üóëÔ∏è Supprimer</button></div></di v >`).join('')}</div>`}</di v></di v >` ; }function updateSearchQuery(value ) {STATE.searchQuer y =value ;updateSearchResults() ; }function updateSearchResults( ) {const quer y =STATE.searchQuery.toLowerCase() ;const sortedLog s =[...STATE.sessionLogs].sort((a ,b )= >new Date(b.endTime ) -new Date(a.endTime)) ;const filteredLog s =quer y ?sortedLogs.filter(lo g= > {const dateSt r =new Date(log.startTime).toLocaleDateString('f r -FR') ;const traine e =(log.traine e| |'').toLowerCase() ;const sessionNu m =log.sessionNumber.toString() ;return dateStr.includes(query )| |trainee.includes(query )| |sessionNum.includes(query) ;} ) :sortedLogs ;const resultsContaine r =document.querySelector('.grid.ga p -6') ;i f(resultsContainer ) {i f(filteredLogs.lengt h== =0 ) {resultsContainer.innerHTM L = ' <div class  ="b g -white dark :b g -gra y -800  p -12 rounde d -xl shado w -lg tex t -center " ><p clas ="tex t -gra y -500 dark :tex t -gra y -400 tex t -lg">Aucun r√©sultat trouv√©.</p></di v >' ; }els e {resultsContainer.innerHTM L =filteredLogs.map(lo g= > ` <div class ="b g -white dark :b g -gra y -800  p -6 rounde d -xl shado w -lg "><div class ="flex justif y -between item s -start m b -4"><div><h3 class ="tex t -2xl fon t -bold tex t -primary">Session ${log.sessionNumber}</h3><div class ="tex t -sm tex t -gra y -600 dark :tex t -gra y -400 m t -1"><span>üë§ ${log.traine e| |'Inconnu'}</span><span class ="m x -2">‚Ä¢</span><span>üë®‚Äçüè´ ${log.superviso r| |'Superviseur'}</span></div></div><div class ="tex t -right tex t -sm"><div class ="tex t -gra y -600 dark :tex t -gra y -400">üìÖ ${new Date(log.startTime).toLocaleDateString('f r -FR')}</div><div class ="tex t -gra y -600 dark :tex t -gra y -400">üïê ${new Date(log.startTime).toLocaleTimeString('f r -FR')}-${new Date(log.endTime).toLocaleTimeString('f r -FR')}</div></div></div><div class ="borde r -t borde r -gra y -200 dark :borde r -gra y -700 p t -4"><h4 class ="fon t -bold m b -3">üìã Actions(${log.actions.length})</h4><div class ="ss i -screen ma x - h -96 overflo w - y -auto">${log.actions.slice(-50).reverse().map(actio n= >`<div class ="m b -2 p b -2 borde r -b borde r -gree n -900"><div class ="tex t -xs opacit y -75">${new Date(action.timestamp).toLocaleString('f r -FR')}</div><div>${action.trainee}:<span class ="tex t -yello w -400">${action.action}</span></div>${action.detail s ?`<div class ="tex t -sm opacit y -75">${action.details}</div> ` :''}</div>`).join('')}</div></di v ><div clas ="m t -4 flex justif y -end ga p -2"><button onclick="printSessionLog('$ {log.sessionI d}')" clas ="p x -4 p y -2 b g -blu e -500 tex t -white rounded hover :b g -blu e -600 transition tex t -sm">üñ®Ô∏è Imprimer PDF</button><button onclick="deleteSessionLog('$ {log.sessionI d}')" clas ="p x -4 p y -2 b g -re d -500 tex t -white rounded hover :b g -re d -600 transition tex t -sm">üóëÔ∏è Supprimer</button></div></di v >`).join('') ; } }const counterElemen t =document.querySelector('.m t -2.tex t -sm') ;i f(counterElemen t& &STATE.searchQuer y& &filteredLogs.lengt h >0 ) {counterElement.textConten t =`$ {filteredLogs.lengt h }r√©sultat(s)trouv√©(s)` ; } }function clearSearch( ) {STATE.searchQuer y ='' ;render() ; }function printSessionLog(sessionId ) {const lo g =STATE.sessionLogs.find( l= >l.sessionI d== =sessionId) ;i f(!log )retur  ;const supervisorAction s =log.actions.filter( a= >a.acto r== ='supervisor') ;const traineeAction s =log.actions.filter( a= >a.acto r== ='trainee '| |!a.actor) ;const maxLengt h =Math.max(supervisorActions.length ,traineeActions.length) ;let rowsHtm l ='' ;fo r(let  i =0 ; i <maxLength ;i++ ) {const supervisorActio n =supervisorActions[i] ;const traineeActio n =traineeActions[i] ;const supervisorCel l =supervisorActio n ? ' <div class  ="actio n -cell "> ' + ' <div class  ="timestamp "> ' +new Date(supervisorAction.timestamp).toLocaleTimeString('f r -FR' , {hour :' 2 -digit' ,minute :' 2 -digit' ,second :' 2 -digit '} ) +'</di v> ' + ' <div class  ="actio n -content "> ' +supervisorAction.actio n +'</di v> ' +(supervisorAction.detail s ? ' <div class  ="details "> ' +supervisorAction.detail s +'</di v> ' :'' ) +'</di v> ' : ' <div class  ="actio n -cell empty "></di v >' ;const traineeCel l =traineeActio n ? ' <div class  ="actio n -cell "> ' + ' <div class  ="timestamp "> ' +new Date(traineeAction.timestamp).toLocaleTimeString('f r -FR' , {hour :' 2 -digit' ,minute :' 2 -digit' ,second :' 2 -digit '} ) +'</di v> ' + ' <div class  ="actio n -content "> ' +traineeAction.actio n +'</di v> ' +(traineeAction.detail s ? ' <div class  ="details "> ' +traineeAction.detail s +'</di v> ' :'' ) +'</di v> ' : ' <div class  ="actio n -cell empty "></di v >' ;rowsHtm l+ = ' <t r> ' + ' <td class  ="scenari o -col "> ' +supervisorCel l +'</t d> ' + ' <td class  ="traine e -col "> ' +traineeCel l +'</t d> ' +'</t r >' ; }const printWindo w =window.open('' ,'' ,'widt h =1000 ,heigh t =800') ;const htm l = ' <!DOCTYPE htm l> ' + ' <htm l><head> ' +'<title>Journal Session  ' +log.sessionNumbe r +'</title> ' +'<style> ' +'body{font-family:Arial,sans-serif;padding:20px;font-size:12px} ' +'h1{color:#333;border-bottom:2px solid #5D5CDE;padding-bottom:10px;font-size:18px} ' +'h2{color:#444;font-size:14px;margin-top:20px} ' +'.meta{background:#f5f5f5;padding:15px;margin:20px 0;border-radius:5px} ' +'.meta-item{margin:5px 0} ' +'table{width:100%;border-collapse:collapse;margin-top:10px} ' +'th{background:#5D5CDE;color:white;padding:10px;text-align:left;font-weight:bold} ' +'td{border:1px solid #ddd;padding:8px;vertical-align:top} ' +'.scenario-col{background:#fff8e1} ' +'.trainee-col{background:#e3f2fd} ' +'.action-cell{min-height:40px} ' +'.action-cell.empty{background:#fafafa} ' +'.timestamp{color:#666;font-size:0.85em;font-weight:bold;margin-bottom:3px} ' +'.action-content{color:#333} ' +'.details{color:#888;font-style:italic;margin-top:3px;font-size:0.9em} ' +'@media print{body{margin:0}button{display:none}} ' +'</style></head><body> ' +'<h1>üìã Journal de Session SSI-SSIAP</h1> ' +'<div class ="meta"> ' +'<div class ="met a -item"><strong>Session  ' +log.sessionNumbe r +'</strong></div> ' +'<div class ="met a -item">üìÖ Date: ' +new Date(log.startTime).toLocaleDateString('fr-FR' ) +'</div> ' +'<div class ="met a -item">üïê Heure: ' +new Date(log.startTime).toLocaleTimeString('fr-FR' ) +'- ' +new Date(log.endTime).toLocaleTimeString('fr-FR' ) +'</div> ' +'<div class ="met a -item">üë§ Stagiaire: ' +(log.traine e| |'Inconnu' ) +'</div> ' +'<div class ="met a -item">üë®‚Äçüè´ Superviseur: ' +(log.supervisor.preno m| |'Superviseur' ) +'  ' +(log.supervisor.no m| |'' ) +'</div> ' +'<div class ="met a -item">üìä Actions: ' +supervisorActions.lengt h +'(sc√©nario)+ ' +traineeActions.lengt h +'(stagiaire)= ' +log.actions.lengt h +' total</div> ' +'</div> ' +'<h2>Actions chronologiques</h2> ' +'<table> ' +'<thead> ' +'<tr> ' +'<th style="width :5 0% ;">üé¨ SC√âNARIO(Superviseur)</th> ' +'<th style="width :5 0% ;">üë§ ACTIONS STAGIAIRE</th> ' +'</tr> ' +'</thead> ' +'<tbody> ' +rowsHtm l +'</tbody> ' +'</table> ' +'<script>window.onload=function(){window.print();};<\/script> ' +'</body></htm l >' ;printWindow.document.write(html) ;printWindow.document.close() ; }function deleteSessionLog(sessionId ) {showCustomConfirm('√äte s -vous s√ªr de vouloir supprimer ce journa l ?' ,( )= > {db.ref(`session_log s /$ {sessionI d }`).remove() ;STATE.sessionLog s =STATE.sessionLogs.filter( l= >l.sessionI d!= =sessionId) ;render() ;showCustomAlert('Journal supprim√©.') ;}) ; }function updateDetectorAddressInput(type ,id ,address ) {const detectorArra y =typ e== ='DAI ' ?STATE.sdi.detector s :STATE.sdi.manualAlarms ;const detecto r =detectorArray.find( d= >d.i d== =id) ;i f(detector ) {detector.addres s =address ; }sendMessage('UPDATE_DETECTOR_ADDRESS' , {type ,id ,addres s}) ;render() ; }function changeSmsiState(state ) {i f(!checkSessionBeforeAction() )retur  ;STATE.smsi.systemStat e =state ;sendMessage('SMSI_STATE_CHANGE' , {stat e}) ; }function changeSmsBattery(state ) {i f(!checkSessionBeforeAction() )retur  ;STATE.smsi.batteryStat e =state ;sendMessage('SMSI_BATTERY_CHANGE' , {stat e}) ; }function changeZoneState(zoneType ,id ,state ) {i f(!checkSessionBeforeAction() )retur  ;const zone s =zoneTyp e== ='compartiment ' ?STATE.smsi.compartmentZone s :STATE.smsi.smokeZones ;const zon e =zones.find( z= >z.i d== =id) ;setZoneState(zoneType ,id ,state) ;sendMessage('SET_ZONE_STATE' , {zoneType ,id ,stat e}) ;logAction(`Changement √©tat zone $ {zone.addres s }` ,state ,'supervisor') ;render() ; }function updateZoneAddressInput(zoneType ,id ,address ) {updateZoneAddress(zoneType ,id ,address) ;sendMessage('UPDATE_ZONE_ADDRESS' , {zoneType ,id ,addres s}) ; }function traineeStopAlarmSound( ) {stopAlarmSound() ;render() ; }function toggleAccessLevel(type ) {i f(typ e== ='sdi' ) {i f(STATE.accessLeve l== =1 ) {STATE.workflowSte p ='LEVEL2_CODE' ;STATE.workflowDat a = {system :'sdi '} ;STATE.keypadInpu t ='' ;addSdiMessage('Tapez le code niveau 2 et validez') ;render() ; }els e {STATE.accessLeve l =1 ;logAction('Retour niveau 1 SDI') ;render() ; } }els e {i f(STATE.smsiAccessLeve l== =1 ) {STATE.workflowSte p ='LEVEL2_CODE' ;STATE.workflowDat a = {system :'smsi '} ;STATE.keypadInpu t ='' ;addSmsiMessage('Tapez le code niveau 2 et validez') ;render() ; }els e {STATE.smsiAccessLeve l =1 ;logAction('Retour niveau 1 SMSI') ;render() ; } } }function traineeResetSdiSystem( ) {resetSdiSystem() ; }function traineeResetSmsiSystem( ) {resetSmsiSystem() ; }let forceAlarmTimeout ;function startForceAlarm( ) {forceAlarmTimeou t =setTimeout(( )= > {forceGeneralAlarm() ;render() ;} ,3000) ; }function cancelForceAlarm( ) {i f(forceAlarmTimeout ) {clearTimeout(forceAlarmTimeout) ;forceAlarmTimeou t =null ; } }function traineeAcquitProcess( ) {acquitProcess() ; }function commandZone(zoneType ,id ) {let zone ;i f(zoneTyp e== ='compartment' ) {zon e =STATE.smsi.compartmentZones.find( z= >z.i d== =id) ;addSmsiMessage(`Commande fermeture $ {zone.addres s }`) ;logAction(`Commande fermeture $ {zone.addres s }`) ; }els e {zon e =STATE.smsi.smokeZones.find( z= >z.i d== =id) ;addSmsiMessage(`Commande d√©marrage $ {zone.addres s }`) ;logAction(`Commande d√©marrage $ {zone.addres s }`) ; }zone.commandActiv e =true ;render() ; }function testSignalization( ) {logAction('Test de signalisation') ;sendMessage('TEST_SIGNALIZATION' , {timestamp :Date.now( )}) ;const originalZone s =STATE.smsi.compartmentZones.map( z= >( {ledRed : {...z.ledRe d} ,ledOrange : {...z.ledOrang e} ,ledGreen : {...z.ledGree n }})) ;const originalSmokeZone s =STATE.smsi.smokeZones.map( z= >( {ledRed : {...z.ledRe d} ,ledOrange : {...z.ledOrang e} ,ledGreen : {...z.ledGree n }})) ;const originalRelay s =STATE.smsi.relayBoxes.map( r= >( {ledRed : {...r.ledRe d} ,ledOrange : {...r.ledOrang e} ,ledGreen : {...r.ledGree n }})) ;STATE.smsi.compartmentZones.forEach( z= > {z.ledRe d = {on :true ,blink :fals e} ;z.ledOrang e = {on :true ,blink :fals e} ;z.ledGree n = {on :true ,blink :fals e} ;}) ;STATE.smsi.smokeZones.forEach( z= > {z.ledRe d = {on :true ,blink :fals e} ;z.ledOrang e = {on :true ,blink :fals e} ;z.ledGree n = {on :true ,blink :fals e} ;}) ;STATE.smsi.relayBoxes.forEach( r= > {r.ledRe d = {on :true ,blink :fals e} ;r.ledOrang e = {on :true ,blink :fals e} ;r.ledGree n = {on :true ,blink :fals e} ;}) ;render() ;setTimeout(( )= > {STATE.smsi.compartmentZones.forEach((z ,i )= > {z.ledRe d =originalZones[i].ledRed ;z.ledOrang e =originalZones[i].ledOrange ;z.ledGree n =originalZones[i].ledGreen ;}) ;STATE.smsi.smokeZones.forEach((z ,i )= > {z.ledRe d =originalSmokeZones[i].ledRed ;z.ledOrang e =originalSmokeZones[i].ledOrange ;z.ledGree n =originalSmokeZones[i].ledGreen ;}) ;STATE.smsi.relayBoxes.forEach((r ,i )= > {r.ledRe d =originalRelays[i].ledRed ;r.ledOrang e =originalRelays[i].ledOrange ;r.ledGree n =originalRelays[i].ledGreen ;}) ;render() ;} ,2000) ; }function bilanSystem( ) {logAction('Demande bilan syst√®me') ;let hasDefec t =false ;STATE.smsi.compartmentZones.forEach( z= > {i f(z.ledOrange.o n| |z.ledRed.on )hasDefec t =true ;}) ;STATE.smsi.smokeZones.forEach( z= > {i f(z.ledOrange.o n| |z.ledRed.on )hasDefec t =true ;}) ;STATE.smsi.relayBoxes.forEach( r= > {i f(r.ledOrange.o n| |r.ledRed.on )hasDefec t =true ;}) ;STATE.smsi.compartmentZones.forEach( z= > {i f(!z.ledOrange.o n& &!z.ledRed.on ) {z.ledGreen.o n =true ; }}) ;STATE.smsi.smokeZones.forEach( z= > {i f(!z.ledOrange.o n& &!z.ledRed.on ) {z.ledGreen.o n =true ; }}) ;STATE.smsi.relayBoxes.forEach( r= > {i f(!r.ledOrange.o n& &!r.ledRed.on ) {r.ledGreen.o n =true ; }}) ;i f(!hasDefect ) {addSmsiMessage('BILAN :Aucun d√©fau t -Syst√®me op√©rationnel') ; }els e {addSmsiMessage('BILAN :D√©fauts d√©tect√©s(voyants roug e /orange)') ; }render() ;setTimeout(( )= > {STATE.smsi.compartmentZones.forEach( z= >z.ledGreen.o n =false) ;STATE.smsi.smokeZones.forEach( z= >z.ledGreen.o n =false) ;STATE.smsi.relayBoxes.forEach( r= >r.ledGreen.o n =false) ;render() ;} ,3000) ; }function commandRelay(id ) {const rela y =STATE.smsi.relayBoxes.find( r= >r.i d== =id) ;addSmsiMessage(`Commande coffret $ {relay.addres s }`) ;logAction(`Commande coffret $ {relay.addres s }`) ;relay.commandActiv e =true ;render() ; }function stopRelay(id ) {const rela y =STATE.smsi.relayBoxes.find( r= >r.i d== =id) ;relay.stoppe d =!relay.stopped ;addSmsiMessage(`Coffret $ {i d}$ {relay.stoppe d  ?'arr√™t√© '  :'red√©marr√© ' }`) ;logAction(`$ {relay.stoppe d  ?'Arr√™t '  :'Red√©marrage '}pompier coffret $ {i d }`) ;render() ; }render() ;i f('serviceWorker' in navigator ) {window.addEventListener('load' ,asyn c( )= > {tr y {const registratio n =await navigator.serviceWorker.register('. /sw.js') ;console.log('‚úì Service Worker enregistr√© :' ,registration.scope) ;registration.addEventListener('updatefound' ,( )= > {const newWorke r =registration.installing ;newWorker.addEventListener('statechange' ,( )= > {i f(newWorker.stat e== ='installed '& &navigator.serviceWorker.controller ) {showUpdateNotification() ; }}) ;}) ; }catc h(error ) {console.error('‚úó Erreur Service Worker :' ,error) ; }}) ; }let deferredPromp t =null ;window.addEventListener('beforeinstallprompt' ,(e )= > {e.preventDefault() ;deferredPromp t =e ;showInstallButton() ;}) ;function showInstallButton( ) {const installBt n =document.createElement('div') ;installBtn.i d ='pw a -instal l -btn' ;installBtn.innerHTM L = ` <button onclic k ="installPWA()" class ="fixed botto m -4 righ t -4 b g -primary tex t -white p x -4 p y -3 rounde d -full shado w -lg flex item s -center ga p -2  z -50 hover :b g -opacit y -90 transition animat e -bounce " ><svg clas =" w -5  h -5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 00 3 -3 v -1 m - 4 -4 l -4 4m0 0 l - 4 -4m4 4V4 "/></svg>Installer l'app</butto n >` ;document.body.appendChild(installBtn) ; }async function installPWA( ) {i f(!deferredPrompt )retur  ;deferredPrompt.prompt() ;cons t {outcom e } =await deferredPrompt.userChoice ;i f(outcom e== ='accepted' ) {console.log('‚úì PWA install√©e') ;const bt n =document.getElementById('pw a -instal l -btn') ;i f(btn )btn.remove() ; }deferredPromp t =null ; }window.addEventListener('appinstalled' ,( )= > {console.log('‚úì Application install√©e avec succ√®s') ;const bt n =document.getElementById('pw a -instal l -btn') ;i f(btn )btn.remove() ;deferredPromp t =null ;}) ;function showUpdateNotification( ) {const notificatio n =document.createElement('div') ;notification.innerHTM L = ` <div class  ="fixed to p -4 lef t - 1 /2 transfor m -translat e - x - 1 /2 b g -gree n -600 tex t -white p x -6 p y -3 rounde d -lg shado w -lg  z -50 flex item s -center ga p -3 "><span>üîÑ Nouvelle version disponible!</span><button onclick="location.reload()" class ="b g -white tex t -gree n -600 p x -3 p y -1 rounded fon t -bold hover :b g -gra y -100">Mettre √† jour</button></di v>` ;document.body.appendChild(notification) ; }window.addEventListener('online' ,( )= > {console.log('‚úì Connexion r√©tablie') ;}) ;window.addEventListener('offline' ,( )= > {console.log('‚úó Mode hor s -ligne') ;showCustomAlert('Vous √™tes hor s -ligne Certaines fonctionnalit√©s peuvent √™tre limit√©es.') ;});</script>
</body>

</html>

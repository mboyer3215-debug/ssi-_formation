<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation SSI - SSIAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK via unpkg (autorisÃ© par CSP) -->
    <script src="https://unpkg.com/firebase@10.7.1/firebase-app-compat.js"></script>
    <script src="https://unpkg.com/firebase@10.7.1/firebase-database-compat.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .blink {
            animation: blink 1s infinite;
        }
        .led-light {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #333;
            display: inline-block;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .led-green { background-color: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .led-orange { background-color: #ff8800; box-shadow: 0 0 10px #ff8800; }
        .led-red { background-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        .led-off { background-color: #333; box-shadow: none; }

        .ssi-panel {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border: 3px solid #7f8c8d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .ssi-button {
            padding: 10px 20px;
            border: 2px solid #333;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-align: center;
        }

        .ssi-button:active {
            transform: scale(0.95);
        }

        .ssi-button-red {
            background-color: #c0392b;
            color: white;
        }

        .ssi-button-green {
            background-color: #27ae60;
            color: white;
        }

        .ssi-button-yellow {
            background-color: #f39c12;
            color: white;
        }

        .ssi-screen {
            background-color: #000;
            color: #00ff00;
            font-family: monospace;
            padding: 15px;
            border-radius: 5px;
            min-height: 100px;
            border: 2px solid #333;
        }

        .key-switch {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid #95a5a6;
            background: linear-gradient(135deg, #bdc3c7 0%, #ecf0f1 100%);
            cursor: pointer;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .key-switch.active {
            transform: rotate(90deg);
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .command-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #333;
            border: 1px solid #666;
        }

        .command-led.active {
            background-color: #ff0000;
            box-shadow: 0 0 8px #ff0000;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAV4UZ_j2M017lZoFdcbyuxe1oV7VxjWLs",
            authDomain: "ssi-ssiap-training.firebaseapp.com",
            databaseURL: "https://ssi-ssiap-training-default-rtdb.firebaseio.com",
            projectId: "ssi-ssiap-training",
            storageBucket: "ssi-ssiap-training.firebasestorage.app",
            messagingSenderId: "1024486187072",
            appId: "1:1024486187072:web:4e452ab8549cac24d3ffa5"
        };

        // Initialize Firebase
        let db = null;
        let firebaseInitialized = false;

        // Attendre que Firebase soit chargÃ©
        window.addEventListener('load', () => {
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                    firebaseInitialized = true;
                    console.log('âœ“ Firebase initialized successfully');

                    // Charger les stagiaires depuis Firebase
                    loadTraineesFromFirebase();

                    // Charger les journaux de session depuis Firebase
                    loadSessionLogsFromFirebase();
                } else {
                    console.error('âœ— Firebase library not loaded');
                }
            } catch (error) {
                console.error('âœ— Firebase initialization error:', error);
            }
        });

        // Application State
        const STATE = {
            currentView: 'home',
            currentUser: null,
            userType: null,
            trainees: [],
            currentSession: null,
            sessionActive: false,
            sessionId: null,
            accessLevel: 1,
            smsiAccessLevel: 1,

            // SDI State - 9 DAI et 9 DM (3 par zone)
            sdi: {
                systemState: 'service',
                batteryState: 'service',
                powerState: 'secteur',
                alarms: [],
                detectors: Array(9).fill().map((_, i) => ({
                    id: i + 1,
                    type: 'DAI',
                    zone: `ZC${Math.floor(i / 3) + 1}`,
                    address: `DAI ${Math.floor(i / 3) + 1}-${(i % 3) + 1}`,
                    state: 'service',
                    triggered: false,
                    outOfService: false
                })),
                manualAlarms: Array(9).fill().map((_, i) => ({
                    id: i + 1,
                    type: 'DM',
                    zone: `ZC${Math.floor(i / 3) + 1}`,
                    address: `DM ${Math.floor(i / 3) + 1}-${(i % 3) + 1}`,
                    state: 'service',
                    triggered: false,
                    outOfService: false
                })),
                alarmSound: false,
                fireAlarmActive: false
            },

            // SMSI State - 3 zones seulement
            smsi: {
                systemState: 'service',
                batteryState: 'service',
                powerState: 'secteur',
                alarmSound: false,
                messages: [],
                compartmentZones: Array(3).fill().map((_, i) => ({
                    id: i + 1,
                    zone: `ZC${i + 1}`,
                    address: `Compartiment Zone ${i + 1}`,
                    state: 'attente',
                    ledRed: { on: false, blink: false },
                    ledOrange: { on: false, blink: false },
                    ledGreen: { on: false, blink: false },
                    commandActive: false
                })),
                smokeZones: Array(3).fill().map((_, i) => ({
                    id: i + 1,
                    zone: `ZF${i + 1}`,
                    address: `DÃ©senfumage Zone ${i + 1}`,
                    state: 'attente',
                    ledRed: { on: false, blink: false },
                    ledOrange: { on: false, blink: false },
                    ledGreen: { on: false, blink: false },
                    commandActive: false
                })),
                relayBoxes: Array(3).fill().map((_, i) => ({
                    id: i + 1,
                    address: `Coffret ${i + 1}`,
                    state: 'attente',
                    ledRed: { on: false, blink: false },
                    ledOrange: { on: false, blink: false },
                    ledGreen: { on: false, blink: false },
                    commandActive: false,
                    stopped: false
                }))
            },

            // UGA State
            uga: {
                alarmType: 'generale',
                temporization: 0,
                temporizationActive: false,
                temporizationRemaining: 0,
                alarmActive: false
            },

            actionLog: [],
            sessionLogs: [], // Historique de tous les journaux de session
            sessionYear: new Date().getFullYear(), // AnnÃ©e en cours
            sessionCounter: 0, // Compteur annuel de sessions (remis Ã  0 chaque annÃ©e)
            searchQuery: '', // Recherche dans les journaux

            // SystÃ¨me de mise hors service
            outOfService: [],
            keypadInput: '',
            workflowStep: null, // null, 'HS_TYPE', 'HS_NUMBER', 'HS_ADD_MORE', 'HS_CONFIRM', 'RS_CONFIRM', 'RS_MODE', 'RS_SELECT'
            workflowData: {},

            // WebRTC Video/Audio
            videoEnabled: false,
            audioEnabled: false,
            localStream: null,
            remoteStream: null,
            peerConnection: null,

            // Enregistrement vidÃ©o
            mediaRecorder: null,
            recordedChunks: [],
            isRecording: false,
            recordingStartTime: null,

            // ContrÃ´le de volume audio
            audioVolume: 0.5, // Volume par dÃ©faut (0.0 Ã  1.0)
            audioMuted: true // Audio muet par dÃ©faut pour Ã©viter le larsen
        };

        // Communication via Firebase
        function sendMessage(type, data) {
            if (!firebaseInitialized || !STATE.sessionId) return;

            const messageRef = db.ref(`sessions/${STATE.sessionId}/messages`).push();
            messageRef.set({
                type,
                data,
                sender: STATE.userType,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function listenToSession(sessionId) {
            if (!firebaseInitialized) return;

            const messagesRef = db.ref(`sessions/${sessionId}/messages`);
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();

                if (message.sender === STATE.userType) return; // Ignore own messages

                if (STATE.userType === 'trainee') {
                    handleSupervisorCommand(message.type, message.data);
                } else if (STATE.userType === 'supervisor') {
                    handleTraineeAction(message.type, message.data);
                }
            });

            // Ã‰couter les changements de statut de la session (pour dÃ©tecter la fermeture)
            if (STATE.userType === 'trainee') {
                const sessionRef = db.ref(`sessions/${sessionId}`);
                sessionRef.on('value', (snapshot) => {
                    const sessionData = snapshot.val();
                    if (sessionData) {
                        const wasActive = STATE.sessionActive;
                        STATE.sessionActive = sessionData.active;
                        STATE.sessionNumber = sessionData.sessionNumber;

                        // Si la session vient d'Ãªtre fermÃ©e
                        if (wasActive && !sessionData.active) {
                            // ArrÃªter automatiquement la camÃ©ra
                            stopVideo();

                            // RÃ©initialiser le journal des actions
                            STATE.actionLog = [];

                            showCustomAlert('La session a Ã©tÃ© fermÃ©e par le superviseur.');
                            render();

                            // Ã‰couter l'ouverture d'une nouvelle session
                            watchForNewSession();
                        } else {
                            render();
                        }
                    }
                });
            }
        }

        function watchForNewSession() {
            if (!firebaseInitialized || STATE.userType !== 'trainee') return;

            // Surveiller l'apparition d'une nouvelle session active
            const activeSessionRef = db.ref('active_session');
            activeSessionRef.on('value', (snapshot) => {
                const newSessionId = snapshot.val();

                if (newSessionId && newSessionId !== STATE.sessionId) {
                    // Une nouvelle session a Ã©tÃ© crÃ©Ã©e
                    STATE.sessionId = newSessionId;
                    STATE.sessionActive = true;

                    // S'enregistrer dans la nouvelle session
                    if (STATE.currentUser) {
                        db.ref(`sessions/${newSessionId}/trainees/${STATE.currentUser.id}`).set({
                            prenom: STATE.currentUser.prenom,
                            nom: STATE.currentUser.nom,
                            niveau: STATE.currentUser.niveau
                        });
                    }

                    // Ã‰couter cette nouvelle session
                    listenToSession(newSessionId);

                    showCustomAlert('Vous avez Ã©tÃ© connectÃ© Ã  une nouvelle session !');
                    render();

                    // DÃ©marrer automatiquement la camÃ©ra
                    setTimeout(() => {
                        startVideo();
                    }, 500);
                }
            });
        }

        // Session Management
        function createSession() {
            if (!firebaseInitialized) {
                showCustomAlert('Erreur: Firebase non disponible');
                return;
            }

            // Charger le compteur depuis Firebase avant de crÃ©er la session
            db.ref('session_counter').once('value', (counterSnapshot) => {
                const counterData = counterSnapshot.val();
                const currentYear = new Date().getFullYear();

                if (counterData) {
                    // Si on a des donnÃ©es sauvegardÃ©es
                    if (counterData.year === currentYear) {
                        // MÃªme annÃ©e, continuer le compteur
                        STATE.sessionYear = counterData.year;
                        STATE.sessionCounter = counterData.counter;
                    } else {
                        // Nouvelle annÃ©e, rÃ©initialiser
                        STATE.sessionYear = currentYear;
                        STATE.sessionCounter = 0;
                    }
                } else {
                    // PremiÃ¨re session jamais crÃ©Ã©e, initialiser
                    STATE.sessionYear = currentYear;
                    STATE.sessionCounter = 0;
                }

                // IncrÃ©menter le compteur
                STATE.sessionCounter++;

                // Sauvegarder le nouveau compteur dans Firebase
                db.ref('session_counter').set({
                    year: STATE.sessionYear,
                    counter: STATE.sessionCounter
                });

                // GÃ©nÃ©rer le numÃ©ro de session au format AANNN
                const yearSuffix = STATE.sessionYear % 100; // 2025 â†’ 25, 2026 â†’ 26
                const sessionNumber = `${yearSuffix}${String(STATE.sessionCounter).padStart(3, '0')}`; // Ex: 25001

                const sessionId = Date.now().toString();
                const sessionData = {
                    id: sessionId,
                    sessionNumber: sessionNumber,
                    sessionYear: STATE.sessionYear,
                    sessionCounter: STATE.sessionCounter,
                    startTime: firebase.database.ServerValue.TIMESTAMP,
                    endTime: null,
                    active: true,
                    supervisor: STATE.currentUser || 'Superviseur',
                    trainees: {}
                };

                db.ref(`active_session`).set(sessionId);
                db.ref(`sessions/${sessionId}`).set(sessionData);

                STATE.sessionActive = true;
                STATE.sessionId = sessionId;
                STATE.currentSessionNumber = sessionNumber; // Stocker pour endSession
                STATE.actionLog = []; // RÃ©initialiser le journal pour la nouvelle session

                listenToSession(sessionId);
                render();

                // Attendre un peu que le stagiaire se connecte et dÃ©marre sa camÃ©ra, puis se connecter
                setTimeout(() => {
                    supervisorConnectToVideo();
                }, 2000);

                showCustomAlert(`Session ${sessionNumber} dÃ©marrÃ©e avec succÃ¨s !`);
            });
        }

        function endSession() {
            if (!STATE.sessionActive || !STATE.sessionId) return;

            showCustomConfirm('ÃŠtes-vous sÃ»r de vouloir terminer la session ?', () => {
                const sessionNumber = STATE.currentSessionNumber;
                const sessionId = STATE.sessionId;

                // Sauvegarder une derniÃ¨re fois le journal avant de terminer
                saveSessionLogToFirebase();

                // Marquer la session comme terminÃ©e dans Firebase
                db.ref(`sessions/${sessionId}`).update({
                    endTime: firebase.database.ServerValue.TIMESTAMP,
                    active: false
                });

                db.ref(`active_session`).remove();

                STATE.sessionActive = false;
                STATE.sessionId = null;
                STATE.currentSessionNumber = null;
                STATE.actionLog = []; // Effacer le journal actuel

                // Remettre SDI et SMSI en veille automatiquement
                resetSdiToIdle();
                resetSmsiToIdle();

                render();
                showCustomAlert(`Session ${sessionNumber} terminÃ©e. Journal sauvegardÃ©.`);
            });
        }

        function joinActiveSession() {
            if (!firebaseInitialized) return;

            db.ref('active_session').once('value', (snapshot) => {
                const sessionId = snapshot.val();

                if (sessionId) {
                    STATE.sessionId = sessionId;
                    STATE.sessionActive = true;

                    // RÃ©cupÃ©rer les infos de session incluant sessionNumber
                    db.ref(`sessions/${sessionId}`).once('value', (sessionSnapshot) => {
                        const sessionData = sessionSnapshot.val();
                        if (sessionData) {
                            STATE.sessionNumber = sessionData.sessionNumber;
                        }
                    });

                    // Register trainee in session
                    if (STATE.currentUser) {
                        db.ref(`sessions/${sessionId}/trainees/${STATE.currentUser.id}`).set({
                            nom: STATE.currentUser.nom,
                            prenom: STATE.currentUser.prenom,
                            niveau: STATE.currentUser.niveau,
                            joinedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    }

                    listenToSession(sessionId);
                    watchForNewSession();
                    render();

                    // DÃ©marrer automatiquement la camÃ©ra pour le stagiaire
                    setTimeout(() => {
                        startVideo();
                    }, 500);
                } else {
                    // Aucune session active, mais permettre l'accÃ¨s Ã  l'interface
                    STATE.sessionActive = false;
                    STATE.sessionId = null;
                    STATE.sessionNumber = null;

                    // Surveiller l'apparition d'une nouvelle session
                    watchForNewSession();

                    render();
                    // Informer le stagiaire sans le bloquer
                    showCustomAlert('En attente d\'une session. Vous serez automatiquement connectÃ© dÃ¨s que le superviseur ouvrira une session.');
                }
            });
        }

        function checkSessionBeforeAction() {
            if (STATE.userType === 'supervisor' && !STATE.sessionActive) {
                showCustomConfirm('Aucune session active. Voulez-vous dÃ©marrer une session maintenant ?', () => {
                    createSession();
                });
                return false;
            }
            return true;
        }

        // ============ WebRTC Video/Audio Functions ============
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        async function startVideo() {
            try {
                STATE.localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });

                STATE.videoEnabled = true;
                STATE.audioEnabled = true;

                // Render va automatiquement restaurer le flux vidÃ©o via restoreVideoStreams()
                render();

                // CrÃ©er la connexion WebRTC
                await setupPeerConnection();

                showCustomAlert('CamÃ©ra et micro activÃ©s');
            } catch (error) {
                console.error('Erreur accÃ¨s camÃ©ra/micro:', error);
                showCustomAlert('Impossible d\'accÃ©der Ã  la camÃ©ra ou au micro. VÃ©rifiez les permissions.');
            }
        }

        function stopVideo() {
            if (STATE.localStream) {
                STATE.localStream.getTracks().forEach(track => track.stop());
                STATE.localStream = null;
            }

            if (STATE.peerConnection) {
                STATE.peerConnection.close();
                STATE.peerConnection = null;
            }

            STATE.videoEnabled = false;
            STATE.audioEnabled = false;

            // Notifier le superviseur
            if (STATE.sessionId) {
                db.ref(`sessions/${STATE.sessionId}/video/trainee_stream_active`).set(false);
            }

            render();
        }

        function toggleVideo() {
            if (STATE.videoEnabled && STATE.localStream) {
                const videoTrack = STATE.localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    STATE.videoEnabled = videoTrack.enabled;
                    render();
                }
            }
        }

        function toggleAudio() {
            if (STATE.audioEnabled && STATE.localStream) {
                const audioTrack = STATE.localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    STATE.audioEnabled = audioTrack.enabled;
                    render();
                }
            }
        }

        async function setupPeerConnection() {
            if (!STATE.sessionId) return;

            STATE.peerConnection = new RTCPeerConnection(iceServers);

            // Ajouter les tracks locaux Ã  la connexion
            STATE.localStream.getTracks().forEach(track => {
                STATE.peerConnection.addTrack(track, STATE.localStream);
            });

            // GÃ©rer les ICE candidates
            STATE.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    db.ref(`sessions/${STATE.sessionId}/video/trainee_ice_candidates`).push(event.candidate.toJSON());
                }
            };

            // GÃ©rer le flux distant (du superviseur)
            STATE.peerConnection.ontrack = (event) => {
                STATE.remoteStream = event.streams[0];
                const remoteVideo = document.getElementById('remote-video');
                if (remoteVideo) {
                    remoteVideo.srcObject = STATE.remoteStream;
                }
            };

            // CrÃ©er et envoyer l'offre si on est stagiaire
            if (STATE.userType === 'trainee') {
                const offer = await STATE.peerConnection.createOffer();
                await STATE.peerConnection.setLocalDescription(offer);

                db.ref(`sessions/${STATE.sessionId}/video/offer`).set({
                    type: offer.type,
                    sdp: offer.sdp
                });

                // Marquer le stream comme actif
                db.ref(`sessions/${STATE.sessionId}/video/trainee_stream_active`).set(true);

                // Ã‰couter la rÃ©ponse du superviseur
                db.ref(`sessions/${STATE.sessionId}/video/answer`).on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && STATE.peerConnection && !STATE.peerConnection.currentRemoteDescription) {
                        await STATE.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    }
                });

                // Ã‰couter les ICE candidates du superviseur
                db.ref(`sessions/${STATE.sessionId}/video/supervisor_ice_candidates`).on('child_added', async (snapshot) => {
                    const candidate = snapshot.val();
                    if (candidate && STATE.peerConnection) {
                        await STATE.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                });
            }
        }

        async function supervisorConnectToVideo() {
            if (!STATE.sessionId) return;

            STATE.peerConnection = new RTCPeerConnection(iceServers);

            // GÃ©rer les ICE candidates
            STATE.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    db.ref(`sessions/${STATE.sessionId}/video/supervisor_ice_candidates`).push(event.candidate.toJSON());
                }
            };

            // GÃ©rer le flux distant (du stagiaire)
            STATE.peerConnection.ontrack = (event) => {
                STATE.remoteStream = event.streams[0];

                // Render va automatiquement restaurer le flux vidÃ©o via restoreVideoStreams()
                render();
            };

            // Ã‰couter l'offre du stagiaire
            db.ref(`sessions/${STATE.sessionId}/video/offer`).once('value', async (snapshot) => {
                const offer = snapshot.val();
                if (offer && STATE.peerConnection) {
                    await STATE.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

                    const answer = await STATE.peerConnection.createAnswer();
                    await STATE.peerConnection.setLocalDescription(answer);

                    db.ref(`sessions/${STATE.sessionId}/video/answer`).set({
                        type: answer.type,
                        sdp: answer.sdp
                    });

                    // Ã‰couter les ICE candidates du stagiaire
                    db.ref(`sessions/${STATE.sessionId}/video/trainee_ice_candidates`).on('child_added', async (snapshot) => {
                        const candidate = snapshot.val();
                        if (candidate && STATE.peerConnection) {
                            await STATE.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        }
                    });
                }
            });
        }

        function disconnectVideo() {
            if (STATE.peerConnection) {
                STATE.peerConnection.close();
                STATE.peerConnection = null;
            }

            STATE.remoteStream = null;

            const remoteVideo = document.getElementById('trainee-video');
            if (remoteVideo) {
                remoteVideo.srcObject = null;
            }

            render();
        }

        // ============ Enregistrement VidÃ©o Functions ============
        function startRecording() {
            if (!STATE.remoteStream) {
                showCustomAlert('Aucun flux vidÃ©o disponible pour enregistrer');
                return;
            }

            try {
                STATE.recordedChunks = [];
                STATE.mediaRecorder = new MediaRecorder(STATE.remoteStream, {
                    mimeType: 'video/webm;codecs=vp9'
                });

                STATE.mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        STATE.recordedChunks.push(event.data);
                    }
                };

                STATE.mediaRecorder.onstop = () => {
                    // L'enregistrement est terminÃ©, les chunks sont prÃªts
                    const blob = new Blob(STATE.recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);

                    // Proposer le tÃ©lÃ©chargement
                    const sessionNumber = STATE.currentSessionNumber || 'session';
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `debriefing_${sessionNumber}_${timestamp}.webm`;

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();

                    URL.revokeObjectURL(url);
                    showCustomAlert('Enregistrement tÃ©lÃ©chargÃ© : ' + filename);
                };

                STATE.mediaRecorder.start(1000); // Capture toutes les secondes
                STATE.isRecording = true;
                STATE.recordingStartTime = Date.now();

                // Mettre Ã  jour l'affichage toutes les secondes
                STATE.recordingInterval = setInterval(() => {
                    if (STATE.isRecording) {
                        render();
                    }
                }, 1000);

                render();
                showCustomAlert('ðŸ“¹ Enregistrement dÃ©marrÃ©');
            } catch (error) {
                console.error('Erreur enregistrement:', error);
                showCustomAlert('Erreur lors du dÃ©marrage de l\'enregistrement');
            }
        }

        function stopRecording() {
            if (STATE.mediaRecorder && STATE.isRecording) {
                STATE.mediaRecorder.stop();
                STATE.isRecording = false;
                STATE.recordingStartTime = null;

                // ArrÃªter l'intervalle de mise Ã  jour
                if (STATE.recordingInterval) {
                    clearInterval(STATE.recordingInterval);
                    STATE.recordingInterval = null;
                }

                render();
                showCustomAlert('â¹ï¸ Enregistrement arrÃªtÃ©. TÃ©lÃ©chargement en cours...');
            }
        }

        function getRecordingDuration() {
            if (!STATE.isRecording || !STATE.recordingStartTime) return '00:00';

            const elapsed = Math.floor((Date.now() - STATE.recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;

            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Fonction pour activer/couper le son
        function toggleAudioMute() {
            STATE.audioMuted = !STATE.audioMuted;
            const remoteVideo = document.getElementById('trainee-video');
            if (remoteVideo) {
                remoteVideo.muted = STATE.audioMuted;
                if (!STATE.audioMuted) {
                    remoteVideo.volume = STATE.audioVolume;
                }
            }
            render();
        }

        // Fonction pour ajuster le volume audio
        function setAudioVolume(volume) {
            STATE.audioVolume = parseFloat(volume);
            const remoteVideo = document.getElementById('trainee-video');
            if (remoteVideo && !STATE.audioMuted) {
                remoteVideo.volume = STATE.audioVolume;
            }
        }

        // Warning before closing page
        window.addEventListener('beforeunload', (e) => {
            if (STATE.userType === 'supervisor' && STATE.sessionActive) {
                e.preventDefault();
                e.returnValue = 'Attention: La session est toujours active. Pensez Ã  terminer la session avant de quitter.';
                return e.returnValue;
            }
        });

        function logAction(action, details = '', actor = null) {
            // DÃ©terminer qui fait l'action: si actor est spÃ©cifiÃ©, on l'utilise
            // Sinon, c'est l'utilisateur actuel (stagiaire ou superviseur)
            const actorType = actor || STATE.userType || 'supervisor';

            const log = {
                timestamp: new Date().toISOString(),
                trainee: STATE.currentUser?.prenom + ' ' + STATE.currentUser?.nom,
                action,
                details,
                actor: actorType // 'trainee' ou 'supervisor'
            };
            STATE.actionLog.push(log);

            if (STATE.userType === 'trainee') {
                sendMessage('ACTION_LOG', log);
            }

            // Sauvegarder automatiquement le journal en temps rÃ©el dans Firebase
            if (STATE.sessionActive && STATE.sessionId && firebaseInitialized) {
                saveSessionLogToFirebase();
            }
        }

        function saveSessionLogToFirebase() {
            if (!STATE.sessionActive || !STATE.sessionId || STATE.actionLog.length === 0) return;

            // RÃ©cupÃ©rer les infos du stagiaire depuis Firebase
            db.ref(`sessions/${STATE.sessionId}/trainees`).once('value', (traineesSnapshot) => {
                const traineesData = traineesSnapshot.val();
                let traineeName = 'Inconnu';

                if (traineesData) {
                    const traineeIds = Object.keys(traineesData);
                    if (traineeIds.length > 0) {
                        const firstTrainee = traineesData[traineeIds[0]];
                        traineeName = `${firstTrainee.prenom || ''} ${firstTrainee.nom || ''}`.trim();
                    }
                }

                const sessionLog = {
                    sessionId: STATE.sessionId,
                    sessionNumber: STATE.currentSessionNumber,
                    sessionYear: STATE.sessionYear,
                    sessionCounter: STATE.sessionCounter,
                    startTime: new Date().toISOString(),
                    endTime: new Date().toISOString(),
                    supervisor: STATE.currentUser || 'Superviseur',
                    trainee: traineeName,
                    actions: [...STATE.actionLog]
                };

                // Sauvegarder dans Firebase (Ã©crase le log existant avec les nouvelles actions)
                db.ref(`session_logs/${STATE.sessionId}`).set(sessionLog);
            });
        }

        function addSmsiMessage(message) {
            STATE.smsi.messages.push({
                text: message,
                timestamp: new Date().toISOString()
            });
            // Auto-scroll vers la derniÃ¨re ligne aprÃ¨s le render
            setTimeout(() => {
                const screen = document.getElementById('smsi-screen');
                if (screen) {
                    screen.scrollTop = screen.scrollHeight;
                }
            }, 50);
        }

        function addSdiMessage(message) {
            STATE.sdi.alarms.push({
                text: message,
                timestamp: new Date().toISOString()
            });
            // Auto-scroll vers la derniÃ¨re ligne aprÃ¨s le render
            setTimeout(() => {
                const screen = document.getElementById('sdi-screen');
                if (screen) {
                    screen.scrollTop = screen.scrollHeight;
                }
            }, 50);
        }

        function handleSupervisorCommand(type, data) {
            switch(type) {
                case 'SDI_STATE_CHANGE':
                    STATE.sdi.systemState = data.state;
                    break;
                case 'SDI_BATTERY_CHANGE':
                    STATE.sdi.batteryState = data.state;
                    break;
                case 'SDI_POWER_CHANGE':
                    STATE.sdi.powerState = data.state;
                    break;
                case 'TRIGGER_DETECTOR':
                    // CÃ´tÃ© stagiaire: jouer le son
                    triggerDetector(data.type, data.id, true);
                    break;
                case 'RESET_DETECTOR':
                    resetDetector(data.type, data.id);
                    break;
                case 'UPDATE_DETECTOR_ADDRESS':
                    updateDetectorAddress(data.type, data.id, data.address);
                    break;
                case 'SET_TEMPORIZATION':
                    STATE.uga.temporization = data.minutes;
                    break;
                case 'SET_ALARM_TYPE':
                    STATE.uga.alarmType = data.alarmType;
                    break;
                case 'SMSI_STATE_CHANGE':
                    STATE.smsi.systemState = data.state;
                    break;
                case 'SMSI_BATTERY_CHANGE':
                    STATE.smsi.batteryState = data.state;
                    break;
                case 'SMSI_POWER_CHANGE':
                    STATE.smsi.powerState = data.state;
                    break;
                case 'SET_ZONE_STATE':
                    setZoneState(data.zoneType, data.id, data.state);
                    break;
                case 'UPDATE_ZONE_ADDRESS':
                    updateZoneAddress(data.zoneType, data.id, data.address);
                    break;
                case 'DETECTOR_OUT_OF_SERVICE':
                    // Mettre Ã  jour l'Ã©tat hors service du dÃ©tecteur
                    const detArray = data.type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
                    const det = detArray.find(d => d.id === data.id);
                    if (det) {
                        det.outOfService = data.outOfService;
                    }
                    break;
                case 'CHANGE_DETECTOR_STATE':
                    // Mettre Ã  jour l'Ã©tat du dÃ©tecteur (service/hors-service)
                    const detectorArr = data.type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
                    const detector = detectorArr.find(d => d.id === data.id);
                    if (detector) {
                        detector.state = data.state;
                    }
                    break;
                case 'TEST_SIGNALIZATION':
                    // ExÃ©cuter le test de signalisation cÃ´tÃ© stagiaire
                    testSignalization();
                    break;
            }
            render();
        }

        function handleTraineeAction(type, data) {
            switch(type) {
                case 'ACTION_LOG':
                    STATE.actionLog.push(data);
                    break;
                case 'DETECTOR_OUT_OF_SERVICE':
                    // Mettre Ã  jour l'Ã©tat hors service du dÃ©tecteur cÃ´tÃ© superviseur
                    const detArray = data.type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
                    const det = detArray.find(d => d.id === data.id);
                    if (det) {
                        det.outOfService = data.outOfService;
                    }
                    break;
                case 'CHANGE_DETECTOR_STATE':
                    // Mettre Ã  jour l'Ã©tat du dÃ©tecteur cÃ´tÃ© superviseur
                    const detectorArr = data.type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
                    const detector = detectorArr.find(d => d.id === data.id);
                    if (detector) {
                        detector.state = data.state;
                    }
                    break;
            }
            render();
        }

        function updateDetectorAddress(type, id, address) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);
            if (detector) {
                detector.address = address;
            }
        }

        function updateZoneAddress(zoneType, id, address) {
            let zone;
            if (zoneType === 'compartment') {
                zone = STATE.smsi.compartmentZones.find(z => z.id === id);
            } else if (zoneType === 'smoke') {
                zone = STATE.smsi.smokeZones.find(z => z.id === id);
            } else if (zoneType === 'relay') {
                zone = STATE.smsi.relayBoxes.find(z => z.id === id);
            }
            if (zone) {
                zone.address = address;
            }
        }

        function triggerDetector(type, id, playSound = false) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);

            if (detector) {
                // Ne pas dÃ©clencher si le dÃ©tecteur est hors service
                if (detector.outOfService || detector.state === 'hors-service') {
                    addSdiMessage(`${detector.address} hors service - alarme ignorÃ©e`);
                    return;
                }

                detector.triggered = true;
                STATE.sdi.fireAlarmActive = true;
                STATE.sdi.alarmSound = true;

                const alarm = `Alarme feu ${detector.address}`;
                STATE.sdi.alarms.push({
                    text: alarm,
                    timestamp: new Date().toISOString()
                });

                addSmsiMessage(`Alarme dÃ©tectÃ©e: ${detector.address}`);

                // Handle temporization or immediate alarm
                if (!STATE.uga.alarmActive) {
                    if (STATE.uga.temporization > 0 && !STATE.uga.temporizationActive) {
                        // Start temporization
                        STATE.uga.temporizationActive = true;
                        STATE.uga.temporizationRemaining = STATE.uga.temporization * 60;
                        startTemporization();
                    } else if (STATE.uga.temporization === 0) {
                        // No temporization: trigger alarm immediately
                        triggerGeneralAlarm();
                    }
                }

                // Jouer le BIP SDI uniquement si demandÃ© (cÃ´tÃ© stagiaire)
                // Ce bip est DIFFÃ‰RENT de l'alarme UGA
                if (playSound) {
                    playAlarmSound();
                }

                updateAllLeds();
            }
        }

        function resetDetector(type, id) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);

            if (detector) {
                detector.triggered = false;
            }
        }

        function setZoneState(zoneType, id, state) {
            let zone;
            if (zoneType === 'compartment') {
                zone = STATE.smsi.compartmentZones.find(z => z.id === id);
                if (zone) {
                    zone.state = state;
                    updateZoneLeds(zone);
                    addSmsiMessage(`${zone.address}: ${state}`);
                }
            } else if (zoneType === 'smoke') {
                zone = STATE.smsi.smokeZones.find(z => z.id === id);
                if (zone) {
                    zone.state = state;
                    updateZoneLeds(zone);
                    addSmsiMessage(`${zone.address}: ${state}`);
                }
            } else if (zoneType === 'relay') {
                zone = STATE.smsi.relayBoxes.find(z => z.id === id);
                if (zone) {
                    zone.state = state;
                    updateRelayLeds(zone);
                    addSmsiMessage(`${zone.address}: ${state}`);
                }
            }
        }

        function updateZoneLeds(zone) {
            // Reset all LEDs
            zone.ledRed = { on: false, blink: false };
            zone.ledOrange = { on: false, blink: false };
            zone.ledGreen = { on: false, blink: false };

            if (STATE.sdi.fireAlarmActive) {
                // En cas d'alarme incendie
                if (zone.state === 'securite') {
                    // Rouge fixe: alarme incendie + position de sÃ©curitÃ©
                    zone.ledRed = { on: true, blink: false };
                } else if (zone.state === 'defaut-securite') {
                    // Rouge clignotant: alarme incendie + dÃ©faut de position de sÃ©curitÃ©
                    zone.ledRed = { on: true, blink: true };
                }
            } else {
                // Pas d'alarme incendie
                switch(zone.state) {
                    case 'attente':
                        // Tous Ã©teints par dÃ©faut
                        break;
                    case 'defaut-alim':
                        // Orange clignotant: dÃ©faut de ligne
                        zone.ledOrange = { on: true, blink: true };
                        break;
                    case 'defaut-attente':
                        // Orange fixe: dÃ©faut de position d'attente
                        zone.ledOrange = { on: true, blink: false };
                        break;
                    case 'securite':
                        // Zone en sÃ©curitÃ© sans alarme
                        zone.ledGreen = { on: true, blink: false };
                        break;
                    case 'defaut-securite':
                        // DÃ©faut de sÃ©curitÃ© sans alarme
                        zone.ledRed = { on: true, blink: false };
                        break;
                }
            }
        }

        function updateRelayLeds(relay) {
            // Reset all LEDs
            relay.ledRed = { on: false, blink: false };
            relay.ledOrange = { on: false, blink: false };
            relay.ledGreen = { on: false, blink: false };

            if (STATE.sdi.fireAlarmActive) {
                // En cas d'alarme incendie
                if (relay.state === 'securite') {
                    // Rouge fixe: alarme incendie + position de sÃ©curitÃ©
                    relay.ledRed = { on: true, blink: false };
                } else if (relay.state === 'defaut-securite') {
                    // Rouge clignotant: alarme incendie + dÃ©faut de position de sÃ©curitÃ©
                    relay.ledRed = { on: true, blink: true };
                }
            } else {
                // Pas d'alarme incendie
                switch(relay.state) {
                    case 'attente':
                        // Tous Ã©teints par dÃ©faut
                        break;
                    case 'defaut-alim':
                        // Orange clignotant: dÃ©faut de ligne
                        relay.ledOrange = { on: true, blink: true };
                        break;
                    case 'defaut-attente':
                        // Orange fixe: dÃ©faut de position d'attente
                        relay.ledOrange = { on: true, blink: false };
                        break;
                    case 'securite':
                        // Zone en sÃ©curitÃ© sans alarme
                        relay.ledGreen = { on: true, blink: false };
                        break;
                    case 'defaut-securite':
                        // DÃ©faut de sÃ©curitÃ© sans alarme
                        relay.ledRed = { on: true, blink: false };
                        break;
                }
            }
        }

        function updateAllLeds() {
            [...STATE.smsi.compartmentZones, ...STATE.smsi.smokeZones].forEach(zone => {
                updateZoneLeds(zone);
            });
            STATE.smsi.relayBoxes.forEach(relay => {
                updateRelayLeds(relay);
            });
        }

        // Audio Context for alarm sounds
        let audioContext;
        let alarmOscillator; // Pour le bip SDI
        let generalAlarmAudio; // Pour l'alarme UGA (fichiers audio rÃ©els)
        let generalAlarmTimer; // Timer pour arrÃªter l'alarme UGA aprÃ¨s 5 minutes

        // Fichiers audio des alarmes
        const ALARM_SOUNDS = {
            'generale': 'https://pfst.cf2.poecdn.net/base/audio/d5a97bdece6764d4519798a8cc918feff16f4780d291e79c57553f6353e17d59',
            'generale-selective': 'https://pfst.cf2.poecdn.net/base/audio/251c4a6b98727804e0d6b211a5fc52f44f93fc7ab05d0b87103a1993ee24efda',
            'generale-message': 'https://pfst.cf2.poecdn.net/base/audio/34c3dfba89939951e5b6c716b33d0ad9ee5ab241e1bbb651cca7f8cde12d27be'
        };

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playAlarmSound() {
            initAudio();
            if (alarmOscillator) return;

            alarmOscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            alarmOscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            alarmOscillator.frequency.value = 1000;
            gainNode.gain.value = 0.3;

            alarmOscillator.start();
        }

        function stopAlarmSound() {
            if (alarmOscillator) {
                alarmOscillator.stop();
                alarmOscillator = null;
                STATE.sdi.alarmSound = false;
                STATE.smsi.alarmSound = false;
                logAction('ArrÃªt signal sonore');
            }
        }

        function playGeneralAlarm(type) {
            // Le son ne joue QUE cÃ´tÃ© stagiaire (pas cÃ´tÃ© superviseur)
            if (STATE.userType === 'supervisor') return;

            // ArrÃªter l'alarme prÃ©cÃ©dente si elle existe
            stopGeneralAlarm();

            // Jouer le fichier audio correspondant au type d'alarme
            const soundUrl = ALARM_SOUNDS[type] || ALARM_SOUNDS['generale'];
            generalAlarmAudio = new Audio(soundUrl);
            generalAlarmAudio.loop = false; // On gÃ¨re la boucle manuellement pour Ã©viter les silences
            generalAlarmAudio.volume = 0.5;

            // Sauter le silence au dÃ©but des fichiers audio
            if (type === 'generale-selective') {
                generalAlarmAudio.currentTime = 9.0; // Sauter 9 secondes de silence au dÃ©but

                // GÃ©rer la boucle pour Ã©viter le silence de 15s Ã  la fin
                generalAlarmAudio.addEventListener('timeupdate', function() {
                    // Quand on arrive Ã  15 secondes avant la fin, on recommence
                    if (generalAlarmAudio.duration - generalAlarmAudio.currentTime < 15) {
                        generalAlarmAudio.currentTime = 9.0; // Revenir au dÃ©but du vrai son
                    }
                });
            } else if (type === 'generale-message') {
                generalAlarmAudio.currentTime = 10.0; // Sauter 10 secondes de silence
                generalAlarmAudio.loop = true; // Boucle normale pour celui-ci
            } else {
                generalAlarmAudio.loop = true; // Boucle normale pour alarme gÃ©nÃ©rale
            }

            generalAlarmAudio.play().catch(err => {
                console.error('Erreur lecture audio:', err);
            });

            // Timer de 5 minutes pour arrÃªter l'alarme automatiquement
            if (generalAlarmTimer) clearTimeout(generalAlarmTimer);
            generalAlarmTimer = setTimeout(() => {
                stopGeneralAlarm();
                addSmsiMessage('Alarme arrÃªtÃ©e automatiquement (5 min)');
            }, 5 * 60 * 1000); // 5 minutes
        }

        function stopGeneralAlarm() {
            if (generalAlarmAudio) {
                generalAlarmAudio.pause();
                generalAlarmAudio.currentTime = 0;
                generalAlarmAudio = null;
            }
            if (generalAlarmTimer) {
                clearTimeout(generalAlarmTimer);
                generalAlarmTimer = null;
            }
        }

        let temporizationTimer;
        function startTemporization() {
            if (temporizationTimer) clearInterval(temporizationTimer);

            temporizationTimer = setInterval(() => {
                STATE.uga.temporizationRemaining--;

                if (STATE.uga.temporizationRemaining <= 0) {
                    clearInterval(temporizationTimer);
                    STATE.uga.temporizationActive = false;
                    triggerGeneralAlarm();
                }

                // Mise Ã  jour uniquement de l'affichage du compteur sans re-render complet
                updateTemporizationDisplay();
            }, 1000);
        }

        function updateTemporizationDisplay() {
            // Mise Ã  jour du compteur de temporisation sans re-render complet
            const displays = document.querySelectorAll('.temporization-display');
            displays.forEach(display => {
                if (STATE.uga.temporizationActive) {
                    const minutes = Math.floor(STATE.uga.temporizationRemaining / 60);
                    const seconds = STATE.uga.temporizationRemaining % 60;
                    display.textContent = `â±ï¸ ${minutes}:${String(seconds).padStart(2, '0')}`;
                } else {
                    display.textContent = '';
                }
            });
        }

        function scrollScreen(screenId, action) {
            const screen = document.getElementById(screenId);
            if (!screen) return;

            const lineHeight = 20; // hauteur approximative d'une ligne en pixels

            switch(action) {
                case 'up':
                    // Monter d'une ligne
                    screen.scrollTop -= lineHeight;
                    break;
                case 'down':
                    // Descendre d'une ligne
                    screen.scrollTop += lineHeight;
                    break;
                case 'first':
                    // Aller Ã  la premiÃ¨re ligne
                    screen.scrollTop = 0;
                    break;
                case 'last':
                    // Aller Ã  la derniÃ¨re ligne
                    screen.scrollTop = screen.scrollHeight;
                    break;
                case 'home':
                    // Retour Ã  la position centrale
                    screen.scrollTop = screen.scrollHeight / 2;
                    break;
            }
        }

        // PavÃ© numÃ©rique
        function keypadPress(key) {
            if (key === 'C') {
                STATE.keypadInput = '';
            } else {
                STATE.keypadInput += key;
            }
            render();
        }

        function keypadValidate() {
            if (!STATE.keypadInput) return;

            // Si en mode niveau 2, vÃ©rifier le code
            if (STATE.workflowStep === 'LEVEL2_CODE') {
                checkLevel2Code();
                return;
            }

            // Sinon, gÃ©rer selon le workflow actif
            if (STATE.workflowStep) {
                handleWorkflowInput(STATE.keypadInput);
            }
        }

        function checkLevel2Code() {
            if (STATE.keypadInput === '1234') {
                if (STATE.workflowData.system === 'sdi') {
                    STATE.accessLevel = 2;
                } else {
                    STATE.smsiAccessLevel = 2;
                }
                addSdiMessage('Niveau 2 activÃ©');
                STATE.keypadInput = '';
                STATE.workflowStep = null;
                STATE.workflowData = {};
                render();
            } else {
                addSdiMessage('Code incorrect');
                STATE.keypadInput = '';
                render();
            }
        }

        // Workflow Mise Hors Service
        function startOutOfServiceWorkflow() {
            if (STATE.accessLevel !== 2) {
                addSdiMessage('Niveau 2 requis');
                return;
            }

            STATE.workflowStep = 'HS_TYPE';
            STATE.workflowData = {};
            STATE.keypadInput = '';
            addSdiMessage('Vous voulez mettre hors service:');
            addSdiMessage('1) DAI');
            addSdiMessage('2) DM');
            addSdiMessage('3) Zone');
            render();
        }

        // Workflow Remise en Service
        function startBackInServiceWorkflow() {
            if (STATE.accessLevel !== 2) {
                addSdiMessage('Niveau 2 requis');
                return;
            }

            if (STATE.outOfService.length === 0) {
                addSdiMessage('Aucun matÃ©riel hors service');
                return;
            }

            STATE.workflowStep = 'RS_CONFIRM';
            STATE.workflowData = {};
            STATE.keypadInput = '';
            addSdiMessage('Vous voulez remettre les matÃ©riels en service');
            addSdiMessage('1) oui');
            addSdiMessage('2) non');
            render();
        }

        // Gestion des entrÃ©es du workflow
        function handleWorkflowInput(input) {
            const value = input.trim();
            STATE.keypadInput = '';

            switch(STATE.workflowStep) {
                case 'HS_TYPE':
                    handleHSType(value);
                    break;
                case 'HS_NUMBER':
                    handleHSNumber(value);
                    break;
                case 'HS_ADD_MORE':
                    handleHSAddMore(value);
                    break;
                case 'HS_CONFIRM':
                    handleHSConfirm(value);
                    break;
                case 'RS_CONFIRM':
                    handleRSConfirm(value);
                    break;
                case 'RS_MODE':
                    handleRSMode(value);
                    break;
                case 'RS_SELECT':
                    handleRSSelect(value);
                    break;
            }
        }

        function handleHSType(value) {
            if (value === '1') {
                STATE.workflowData.type = 'DAI';
                STATE.workflowData.typeName = 'DAI';
            } else if (value === '2') {
                STATE.workflowData.type = 'DM';
                STATE.workflowData.typeName = 'DM';
            } else if (value === '3') {
                STATE.workflowData.type = 'Zone';
                STATE.workflowData.typeName = 'Zone';
            } else {
                addSdiMessage('Choix invalide');
                render();
                return;
            }

            STATE.workflowStep = 'HS_NUMBER';
            addSdiMessage(`Donnez le numÃ©ro du ${STATE.workflowData.typeName} Ã  mettre hors service`);
            render();
        }

        function handleHSNumber(value) {
            const number = parseInt(value);

            if (STATE.workflowData.type === 'DAI') {
                const exists = STATE.sdi.detectors.some(d => d.id === number);
                if (!exists || number < 1 || number > 9) {
                    addSdiMessage('NumÃ©ro DAI invalide (1-9)');
                    render();
                    return;
                }
                STATE.workflowData.number = number;
                STATE.workflowData.label = `DAI${String(number).padStart(2, '0')}`;
            } else if (STATE.workflowData.type === 'DM') {
                const exists = STATE.sdi.manualAlarms.some(d => d.id === number);
                if (!exists || number < 1 || number > 9) {
                    addSdiMessage('NumÃ©ro DM invalide (1-9)');
                    render();
                    return;
                }
                STATE.workflowData.number = number;
                STATE.workflowData.label = `DM${String(number).padStart(2, '0')}`;
            } else if (STATE.workflowData.type === 'Zone') {
                if (number < 1 || number > 3) {
                    addSdiMessage('NumÃ©ro Zone invalide (1-3)');
                    render();
                    return;
                }
                STATE.workflowData.number = number;
                STATE.workflowData.label = `ZC${number}`;
            }

            STATE.workflowStep = 'HS_ADD_MORE';
            addSdiMessage('Voulez-vous ajouter un matÃ©riel');
            addSdiMessage('1) oui');
            addSdiMessage('2) non');
            render();
        }

        function handleHSAddMore(value) {
            if (value === '1') {
                if (!STATE.workflowData.items) STATE.workflowData.items = [];
                STATE.workflowData.items.push({
                    type: STATE.workflowData.type,
                    number: STATE.workflowData.number,
                    label: STATE.workflowData.label
                });
                STATE.workflowStep = 'HS_TYPE';
                addSdiMessage('Vous voulez mettre hors service:');
                addSdiMessage('1) DAI');
                addSdiMessage('2) DM');
                addSdiMessage('3) Zone');
                render();
            } else if (value === '2') {
                if (!STATE.workflowData.items) STATE.workflowData.items = [];
                STATE.workflowData.items.push({
                    type: STATE.workflowData.type,
                    number: STATE.workflowData.number,
                    label: STATE.workflowData.label
                });
                STATE.workflowStep = 'HS_CONFIRM';
                addSdiMessage('Vous avez mis hors service:');
                STATE.workflowData.items.forEach(item => {
                    addSdiMessage(`- ${item.label}`);
                });
                addSdiMessage('Validez:');
                addSdiMessage('1) oui');
                addSdiMessage('2) non');
                render();
            } else {
                addSdiMessage('Choix invalide');
                render();
            }
        }

        function handleHSConfirm(value) {
            if (value === '1') {
                STATE.workflowData.items.forEach(item => {
                    STATE.outOfService.push(item);
                    if (item.type === 'DAI') {
                        const detector = STATE.sdi.detectors.find(d => d.id === item.number);
                        if (detector) {
                            detector.outOfService = true;
                            // Synchroniser avec Firebase
                            sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DAI', id: item.number, outOfService: true });
                        }
                    } else if (item.type === 'DM') {
                        const dm = STATE.sdi.manualAlarms.find(d => d.id === item.number);
                        if (dm) {
                            dm.outOfService = true;
                            // Synchroniser avec Firebase
                            sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DM', id: item.number, outOfService: true });
                        }
                    }
                    addSdiMessage(`${item.label} mis hors service`);
                    logAction(`Mise hors service ${item.label}`);
                });
                STATE.workflowStep = null;
                STATE.workflowData = {};
                render();
            } else if (value === '2') {
                addSdiMessage('Mise hors service annulÃ©e');
                STATE.workflowStep = null;
                STATE.workflowData = {};
                render();
            } else {
                addSdiMessage('Choix invalide');
                render();
            }
        }

        function handleRSConfirm(value) {
            if (value === '1') {
                STATE.workflowStep = 'RS_MODE';
                addSdiMessage('Voulez-vous:');
                addSdiMessage('1) tout remettre en service');
                addSdiMessage('2) une partie');
                render();
            } else if (value === '2') {
                addSdiMessage('Remise en service annulÃ©e');
                STATE.workflowStep = null;
                STATE.workflowData = {};
                render();
            } else {
                addSdiMessage('Choix invalide');
                render();
            }
        }

        function handleRSMode(value) {
            if (value === '1') {
                STATE.outOfService.forEach(item => {
                    if (item.type === 'DAI') {
                        const detector = STATE.sdi.detectors.find(d => d.id === item.number);
                        if (detector) {
                            detector.outOfService = false;
                            // Synchroniser avec Firebase
                            sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DAI', id: item.number, outOfService: false });
                        }
                    } else if (item.type === 'DM') {
                        const dm = STATE.sdi.manualAlarms.find(d => d.id === item.number);
                        if (dm) {
                            dm.outOfService = false;
                            // Synchroniser avec Firebase
                            sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DM', id: item.number, outOfService: false });
                        }
                    }
                    addSdiMessage(`${item.label} remis en service`);
                    logAction(`Remise en service ${item.label}`);
                });
                STATE.outOfService = [];
                addSdiMessage('Tous les matÃ©riels remis en service');
                STATE.workflowStep = null;
                STATE.workflowData = {};
                render();
            } else if (value === '2') {
                STATE.workflowStep = 'RS_SELECT';
                addSdiMessage('MatÃ©riels hors service:');
                STATE.outOfService.forEach((item, index) => {
                    addSdiMessage(`${index + 1}) ${item.label}`);
                });
                addSdiMessage('Tapez le numÃ©ro Ã  remettre en service');
                render();
            } else {
                addSdiMessage('Choix invalide');
                render();
            }
        }

        function handleRSSelect(value) {
            const index = parseInt(value) - 1;
            if (index < 0 || index >= STATE.outOfService.length) {
                addSdiMessage('NumÃ©ro invalide');
                render();
                return;
            }
            const item = STATE.outOfService[index];
            if (item.type === 'DAI') {
                const detector = STATE.sdi.detectors.find(d => d.id === item.number);
                if (detector) {
                    detector.outOfService = false;
                    // Synchroniser avec Firebase
                    sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DAI', id: item.number, outOfService: false });
                }
            } else if (item.type === 'DM') {
                const dm = STATE.sdi.manualAlarms.find(d => d.id === item.number);
                if (dm) {
                    dm.outOfService = false;
                    // Synchroniser avec Firebase
                    sendMessage('DETECTOR_OUT_OF_SERVICE', { type: 'DM', id: item.number, outOfService: false });
                }
            }
            addSdiMessage(`${item.label} remis en service`);
            logAction(`Remise en service ${item.label}`);
            STATE.outOfService.splice(index, 1);
            if (STATE.outOfService.length > 0) {
                addSdiMessage('MatÃ©riels hors service:');
                STATE.outOfService.forEach((item, index) => {
                    addSdiMessage(`${index + 1}) ${item.label}`);
                });
                addSdiMessage('Tapez un autre numÃ©ro ou C pour terminer');
                render();
            } else {
                addSdiMessage('Tous les matÃ©riels remis en service');
                STATE.workflowStep = null;
                STATE.workflowData = {};
                render();
            }
        }

        function triggerGeneralAlarm() {
            STATE.uga.alarmActive = true;
            STATE.uga.temporizationActive = false; // DÃ©sactiver la temporisation
            STATE.uga.temporizationRemaining = 0;
            if (temporizationTimer) clearInterval(temporizationTimer);

            playGeneralAlarm(STATE.uga.alarmType);
            addSmsiMessage(`Alarme ${STATE.uga.alarmType} dÃ©clenchÃ©e`);
            logAction('DÃ©clenchement alarme gÃ©nÃ©rale', STATE.uga.alarmType);
            render(); // Re-render pour mettre Ã  jour l'affichage
        }

        function forceGeneralAlarm() {
            if (STATE.uga.temporizationActive) {
                clearInterval(temporizationTimer);
                STATE.uga.temporizationActive = false;
            }
            if (!STATE.uga.alarmActive) {
                triggerGeneralAlarm();
            }
        }

        function acquitProcess() {
            // L'acquit fonctionne UNIQUEMENT pendant la temporisation
            if (STATE.uga.temporizationActive) {
                clearInterval(temporizationTimer);
                STATE.uga.temporizationActive = false;
                STATE.uga.temporizationRemaining = 0;
                addSmsiMessage('Processus alarme acquittÃ© - Alarme gÃ©nÃ©rale annulÃ©e');
                logAction('Acquit processus alarme');
                render();
            }
            // Une fois l'alarme gÃ©nÃ©rale dÃ©clenchÃ©e, on ne peut plus l'arrÃªter via acquit
        }

        // System Reset functions
        function canResetSdiSystem() {
            if (STATE.accessLevel !== 2) return false;
            const allDMReset = STATE.sdi.manualAlarms.every(d => !d.triggered);
            const noDaiActive = STATE.sdi.detectors.every(d => !d.triggered);
            return allDMReset && noDaiActive;
        }

        function canResetSmsiSystem() {
            if (STATE.smsiAccessLevel !== 2) return false;
            const allZonesReady = [
                ...STATE.smsi.compartmentZones,
                ...STATE.smsi.smokeZones
            ].every(zone => zone.state === 'attente');
            return allZonesReady;
        }

        function resetSdiSystem() {
            if (!canResetSdiSystem()) {
                showCustomAlert('Impossible de rÃ©armer le SDI: niveau 2 requis, tous les DM doivent Ãªtre rÃ©armÃ©s et aucun DAI ne doit Ãªtre actif');
                return;
            }

            // RÃ©armement SDI uniquement - ne touche PAS au SMSI
            STATE.sdi.alarms = [];
            STATE.sdi.fireAlarmActive = false;
            STATE.sdi.alarmSound = false;
            STATE.sdi.detectors.forEach(d => d.triggered = false);
            STATE.sdi.manualAlarms.forEach(d => d.triggered = false);

            // ArrÃªt de TOUS les sons d'alarme (SDI)
            stopAlarmSound();

            // Si une temporisation est en cours, l'arrÃªter
            if (STATE.uga.temporizationActive) {
                clearInterval(temporizationTimer);
                STATE.uga.temporizationActive = false;
                STATE.uga.temporizationRemaining = 0;
            }

            // NE PAS toucher Ã  l'alarme gÃ©nÃ©rale et la temporisation (c'est le SMSI)
            // L'alarme gÃ©nÃ©rale continue de sonner mÃªme aprÃ¨s rÃ©armement SDI

            logAction('RÃ©armement SDI complet');
            render();
        }

        function resetSmsiSystem() {
            if (!canResetSmsiSystem()) {
                showCustomAlert('Impossible de rÃ©armer le SMSI: niveau 2 requis et tous les DAS en position d\'attente');
                return;
            }

            // RÃ©armement SMSI - arrÃªte l'alarme gÃ©nÃ©rale et la temporisation
            STATE.smsi.messages = [];
            STATE.smsi.alarmSound = false;
            STATE.smsi.compartmentZones.forEach(z => z.commandActive = false);
            STATE.smsi.smokeZones.forEach(z => z.commandActive = false);

            // ArrÃªter TOUS les sons d'alarme
            STATE.uga.alarmActive = false;
            STATE.uga.temporizationActive = false;
            STATE.uga.temporizationRemaining = 0;
            stopGeneralAlarm();
            stopAlarmSound(); // ArrÃªter aussi le son d'alarme SDI si actif

            logAction('RÃ©armement SMSI complet');
            render();
        }

        // Fonctions pour remettre SDI et SMSI en veille (sans log, pour fermeture de session)
        function resetSdiToIdle() {
            STATE.sdi.alarms = [];
            STATE.sdi.fireAlarmActive = false;
            STATE.sdi.alarmSound = false;
            STATE.sdi.detectors.forEach(d => d.triggered = false);
            STATE.sdi.manualAlarms.forEach(d => d.triggered = false);
            STATE.sdi.systemState = 'service';
            STATE.sdi.powerState = 'secteur';
            STATE.sdi.batteryState = 'service';
            stopAlarmSound();

            // Si une temporisation est en cours, l'arrÃªter
            if (STATE.uga.temporizationActive) {
                clearInterval(temporizationTimer);
                STATE.uga.temporizationActive = false;
                STATE.uga.temporizationRemaining = 0;
            }
        }

        function resetSmsiToIdle() {
            STATE.smsi.messages = [];
            STATE.smsi.alarmSound = false;
            STATE.smsi.compartmentZones.forEach(z => {
                z.commandActive = false;
                z.state = 'attente';
                z.ledRed.on = false;
                z.ledRed.blink = false;
                z.ledOrange.on = false;
                z.ledOrange.blink = false;
                z.ledGreen.on = false;
                z.ledGreen.blink = false;
            });
            STATE.smsi.smokeZones.forEach(z => {
                z.commandActive = false;
                z.state = 'attente';
                z.ledRed.on = false;
                z.ledRed.blink = false;
                z.ledOrange.on = false;
                z.ledOrange.blink = false;
                z.ledGreen.on = false;
                z.ledGreen.blink = false;
            });
            STATE.smsi.relayBoxes.forEach(r => {
                r.state = 'attente';
                r.ledRed.on = false;
                r.ledRed.blink = false;
                r.ledOrange.on = false;
                r.ledOrange.blink = false;
                r.ledGreen.on = false;
                r.ledGreen.blink = false;
            });
            STATE.smsi.systemState = 'service';
            STATE.smsi.powerState = 'secteur';
            STATE.smsi.batteryState = 'service';

            // ArrÃªter TOUS les sons d'alarme
            STATE.uga.alarmActive = false;
            STATE.uga.temporizationActive = false;
            STATE.uga.temporizationRemaining = 0;
            stopGeneralAlarm();
            stopAlarmSound();
        }

        // Custom modal dialogs
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button>
                        <button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" id="confirmBtn">Confirmer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#confirmBtn').onclick = () => {
                modal.remove();
                onConfirm();
            };
        }

        function showCustomPrompt(message, onSubmit, defaultValue = '') {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <input type="text" id="promptInput" value="${defaultValue}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-4">
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button>
                        <button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" id="submitBtn">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const input = modal.querySelector('#promptInput');
            input.focus();
            input.select();

            const submit = () => {
                const value = input.value;
                modal.remove();
                if (value) onSubmit(value);
            };

            modal.querySelector('#submitBtn').onclick = submit;
            input.onkeypress = (e) => {
                if (e.key === 'Enter') submit();
            };
        }

        function requestAccessCode(type, callback) {
            showCustomPrompt('Entrez le code d\'accÃ¨s niveau 2:', (code) => {
                if (code === '1234') {
                    if (type === 'sdi') {
                        STATE.accessLevel = 2;
                        logAction('AccÃ¨s niveau 2 SDI');
                    } else {
                        STATE.smsiAccessLevel = 2;
                        logAction('AccÃ¨s niveau 2 SMSI');
                    }
                    callback(true);
                } else {
                    showCustomAlert('Code incorrect');
                    callback(false);
                }
            });
        }

        // Trainee Management - Auto-import on startup
        let importOffered = false;

        function saveTrainees() {
            // Save to Firebase for multi-PC access
            if (firebaseInitialized) {
                db.ref('trainees').set(STATE.trainees);
            }
        }

        function loadTraineesFromFirebase() {
            if (!firebaseInitialized) return;

            db.ref('trainees').once('value', (snapshot) => {
                const trainees = snapshot.val();
                if (trainees) {
                    STATE.trainees = trainees;
                    render();
                }
            });

            // Listen for changes
            db.ref('trainees').on('value', (snapshot) => {
                const trainees = snapshot.val();
                if (trainees) {
                    STATE.trainees = trainees;
                    if (STATE.currentView === 'trainee-management' || STATE.currentView === 'trainee-login') {
                        render();
                    }
                }
            });
        }

        function loadSessionLogsFromFirebase() {
            if (!firebaseInitialized) return;

            db.ref('session_logs').once('value', (snapshot) => {
                const logs = snapshot.val();
                if (logs) {
                    STATE.sessionLogs = Object.values(logs);

                    // Trouver le compteur le plus Ã©levÃ© pour l'annÃ©e en cours
                    const currentYear = new Date().getFullYear();
                    const currentYearLogs = STATE.sessionLogs.filter(log => log.sessionYear === currentYear);

                    if (currentYearLogs.length > 0) {
                        const maxCounter = Math.max(...currentYearLogs.map(log => log.sessionCounter || 0));
                        STATE.sessionCounter = maxCounter;
                        STATE.sessionYear = currentYear;
                    }
                }
            });

            // Listen for new logs
            db.ref('session_logs').on('child_added', (snapshot) => {
                const log = snapshot.val();
                if (log && !STATE.sessionLogs.find(l => l.sessionId === log.sessionId)) {
                    STATE.sessionLogs.push(log);
                    if (STATE.currentView === 'session-logs') {
                        render();
                    }
                }
            });
        }

        function autoImportOnStartup() {
            // Si Firebase est actif, les stagiaires sont dÃ©jÃ  chargÃ©s automatiquement
            if (firebaseInitialized) {
                // Pas besoin de demander l'import, tout est synchronisÃ© via Firebase
                return;
            }

            // Fallback: import manuel si Firebase n'est pas disponible
            if (STATE.trainees.length === 0 && !importOffered) {
                importOffered = true;
                setTimeout(() => {
                    showCustomConfirm('Voulez-vous importer le fichier stagiaires.json ?', () => {
                        importTrainees();
                    });
                }, 300);
            }
        }

        function printTraineeList() {
            if (STATE.trainees.length === 0) {
                showCustomAlert('Aucun stagiaire Ã  imprimer');
                return;
            }

            const printWindow = window.open('', '_blank');
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Liste des Stagiaires - Formation SSI SSIAP</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        h1 {
                            text-align: center;
                            color: #5D5CDE;
                            margin-bottom: 30px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td {
                            border: 1px solid #333;
                            padding: 12px;
                            text-align: left;
                        }
                        th {
                            background-color: #5D5CDE;
                            color: white;
                            font-weight: bold;
                        }
                        tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .pin {
                            font-weight: bold;
                            font-size: 18px;
                            letter-spacing: 2px;
                            color: #5D5CDE;
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 12px;
                            color: #666;
                        }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Liste des Stagiaires - Formation SSI SSIAP</h1>
                    <p>Date d'impression : ${new Date().toLocaleDateString('fr-FR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>PrÃ©nom</th>
                                <th>Email</th>
                                <th>Code PIN</th>
                                <th>Niveau</th>
                                <th>Dates</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${STATE.trainees.map(t => `
                                <tr>
                                    <td>${t.nom}</td>
                                    <td>${t.prenom}</td>
                                    <td>${t.email || 'N/A'}</td>
                                    <td class="pin">${t.pin}</td>
                                    <td>SSIAP ${t.niveau}</td>
                                    <td>${new Date(t.dateDebut).toLocaleDateString('fr-FR')} - ${new Date(t.dateFin).toLocaleDateString('fr-FR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>Formation SSI - SSIAP | Total : ${STATE.trainees.length} stagiaire(s)</p>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        function exportTrainees() {
            const dataStr = JSON.stringify(STATE.trainees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'stagiaires.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importTrainees() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            STATE.trainees = imported;
                            render();
                            showCustomAlert(`${imported.length} stagiaire(s) importÃ©(s) avec succÃ¨s`);
                        } else {
                            showCustomAlert('Format de fichier invalide');
                        }
                    } catch (error) {
                        showCustomAlert('Erreur lors de la lecture du fichier');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function checkTraineeAccess(trainee) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const dateDebut = new Date(trainee.dateDebut);
            dateDebut.setHours(0, 0, 0, 0);

            const dateFin = new Date(trainee.dateFin);
            dateFin.setHours(23, 59, 59, 999);

            return today >= dateDebut && today <= dateFin;
        }

        function createTrainee(data) {
            // Generate a unique 4-digit PIN
            let pin;
            do {
                pin = String(Math.floor(1000 + Math.random() * 9000));
            } while (STATE.trainees.some(t => t.pin === pin));

            const trainee = {
                id: Date.now(),
                nom: data.nom,
                prenom: data.prenom,
                email: data.email,
                niveau: data.niveau,
                dateDebut: data.dateDebut,
                dateFin: data.dateFin,
                pin: pin
            };

            STATE.trainees.push(trainee);
            saveTrainees();
            return trainee;
        }

        // Navigation
        function navigate(view, data = {}) {
            STATE.currentView = view;
            if (data.user) STATE.currentUser = data.user;
            if (data.userType) STATE.userType = data.userType;
            render();
        }

        // Rendering
        function render() {
            const app = document.getElementById('app');

            switch(STATE.currentView) {
                case 'home':
                    app.innerHTML = renderHome();
                    break;
                case 'supervisor-login':
                    app.innerHTML = renderSupervisorLogin();
                    break;
                case 'trainee-login':
                    app.innerHTML = renderTraineeLogin();
                    break;
                case 'trainee-management':
                    app.innerHTML = renderTraineeManagement();
                    autoImportOnStartup();
                    break;
                case 'create-trainee':
                    app.innerHTML = renderCreateTrainee();
                    break;
                case 'supervisor-interface':
                    app.innerHTML = renderSupervisorInterface();
                    break;
                case 'trainee-interface':
                    app.innerHTML = renderTraineeInterface();
                    break;
                case 'session-logs':
                    app.innerHTML = renderSessionLogs();
                    break;
            }

            // Restaurer les flux vidÃ©o aprÃ¨s le rendu
            restoreVideoStreams();
        }

        // Fonction pour restaurer les flux vidÃ©o aprÃ¨s chaque render()
        function restoreVideoStreams() {
            // Attendre un court instant que le DOM soit complÃ¨tement mis Ã  jour
            setTimeout(() => {
                // Restaurer le flux local (stagiaire)
                if (STATE.localStream) {
                    const localVideo = document.getElementById('local-video');
                    if (localVideo && localVideo.srcObject !== STATE.localStream) {
                        localVideo.srcObject = STATE.localStream;
                    }
                }

                // Restaurer le flux distant (superviseur visualise le stagiaire)
                if (STATE.remoteStream) {
                    const remoteVideo = document.getElementById('trainee-video');
                    if (remoteVideo && remoteVideo.srcObject !== STATE.remoteStream) {
                        remoteVideo.srcObject = STATE.remoteStream;
                        // Appliquer le mute et le volume configurÃ©s
                        remoteVideo.muted = STATE.audioMuted;
                        remoteVideo.volume = STATE.audioVolume;
                    }
                }
            }, 50);
        }

        function renderHome() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-2xl w-full">
                        <h1 class="text-4xl font-bold text-center mb-8 text-primary">Formation SSI - SSIAP</h1>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div onclick="navigate('supervisor-login')" class="cursor-pointer bg-gradient-to-br from-primary to-blue-600 p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105">
                                <h2 class="text-2xl font-bold text-white mb-4">ðŸ‘¨â€ðŸ« Superviseur</h2>
                                <p class="text-white opacity-90">CrÃ©er des scÃ©narios et superviser les stagiaires</p>
                            </div>
                            <div onclick="navigate('trainee-login')" class="cursor-pointer bg-gradient-to-br from-green-500 to-green-600 p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105">
                                <h2 class="text-2xl font-bold text-white mb-4">ðŸŽ“ Stagiaire</h2>
                                <p class="text-white opacity-90">Se connecter et rÃ©aliser les exercices</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSupervisorLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Connexion Superviseur</h2>
                        <form onsubmit="handleSupervisorLogin(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Code superviseur</label>
                                <input type="password" id="supervisor-code" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">
                                Se connecter
                            </button>
                            <button type="button" onclick="navigate('home')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                Retour
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderTraineeLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Connexion Stagiaire</h2>
                        <form onsubmit="handleTraineePinLogin(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Code PIN (4 chiffres)</label>
                                <input type="password" id="trainee-pin" maxlength="4" pattern="[0-9]{4}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-center text-2xl tracking-widest" required placeholder="â€¢â€¢â€¢â€¢">
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">
                                Se connecter
                            </button>
                            <button type="button" onclick="navigate('home')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                Retour
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderTraineeManagement() {
            return `
                <div class="min-h-screen p-4">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold">Gestion des Stagiaires</h2>
                            <div class="space-x-2">
                                <button onclick="importTrainees()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
                                    ðŸ“¥ Importer
                                </button>
                                <button onclick="exportTrainees()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                    ðŸ“¤ Exporter
                                </button>
                                <button onclick="printTraineeList()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">
                                    ðŸ–¨ï¸ Imprimer
                                </button>
                                <button onclick="navigate('create-trainee')" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition">
                                    âž• CrÃ©er un stagiaire
                                </button>
                                <button onclick="navigate('supervisor-interface')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                    Retour
                                </button>
                            </div>
                        </div>
                        ${STATE.trainees.length > 0 && firebaseInitialized ? `
                        <div class="bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                ðŸ’¡ <strong>Info :</strong> Les stagiaires sont synchronisÃ©s automatiquement via le cloud. Accessibles depuis tous les PC !
                            </p>
                        </div>
                        ` : STATE.trainees.length > 0 ? `
                        <div class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-6">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                âš ï¸ <strong>Mode local :</strong> Exportez rÃ©guliÃ¨rement le fichier stagiaires.json comme sauvegarde.
                            </p>
                        </div>
                        ` : ''}
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${STATE.trainees.map(trainee => {
                                const isActive = checkTraineeAccess(trainee);
                                const dateDebut = new Date(trainee.dateDebut).toLocaleDateString('fr-FR');
                                const dateFin = new Date(trainee.dateFin).toLocaleDateString('fr-FR');
                                return `
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg ${isActive ? 'border-2 border-green-500' : 'border-2 border-gray-400 opacity-75'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-xl font-bold">${trainee.prenom} ${trainee.nom}</h3>
                                        <span class="px-2 py-1 rounded text-xs font-bold ${isActive ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'}">
                                            ${isActive ? 'âœ“ Actif' : 'âœ— Inactif'}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                                        Email: ${trainee.email || 'N/A'}<br>
                                        Niveau: SSIAP ${trainee.niveau}<br>
                                        Du ${dateDebut} au ${dateFin}
                                    </p>
                                    <div class="bg-primary text-white p-4 rounded-lg mb-4 text-center">
                                        <div class="text-xs mb-1">Code PIN</div>
                                        <div class="text-3xl font-bold tracking-widest">${trainee.pin}</div>
                                    </div>
                                    <button onclick="deleteTrainee(${trainee.id})" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
                                        Supprimer
                                    </button>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCreateTrainee() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">CrÃ©er un Stagiaire</h2>
                        <form onsubmit="handleCreateTrainee(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Nom</label>
                                <input type="text" id="nom" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">PrÃ©nom</label>
                                <input type="text" id="prenom" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="email" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Niveau SSIAP</label>
                                <select id="niveau" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                                    <option value="1">SSIAP 1</option>
                                    <option value="2">SSIAP 2</option>
                                    <option value="3">SSIAP 3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Date dÃ©but</label>
                                <input type="date" id="dateDebut" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Date fin</label>
                                <input type="date" id="dateFin" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">
                                CrÃ©er
                            </button>
                            <button type="button" onclick="navigate('trainee-management')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                Annuler
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderSupervisorInterface() {
            return `
                <div class="min-h-screen p-4 bg-gray-100 dark:bg-gray-900">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold">Interface Superviseur</h2>
                            <div class="space-x-2">
                                ${!STATE.sessionActive ? `
                                    <button onclick="createSession()" class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition font-bold">
                                        ðŸš€ DÃ©but de session
                                    </button>
                                ` : `
                                    <button onclick="endSession()" class="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition font-bold">
                                        â¹ï¸ Fin de session
                                    </button>
                                `}
                                <button onclick="navigate('trainee-management')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                    ðŸ“‹ Gestion stagiaires
                                </button>
                                <button onclick="navigate('session-logs')" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">
                                    ðŸ“š Journaux
                                </button>
                                <button onclick="navigate('home')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                    DÃ©connexion
                                </button>
                            </div>
                        </div>

                        ${STATE.sessionActive ? `
                        <div class="bg-green-100 dark:bg-green-900 border-l-4 border-green-500 p-4 mb-6">
                            <p class="text-sm text-green-800 dark:text-green-200">
                                âœ… <strong>Session active</strong> - Les stagiaires peuvent maintenant se connecter et travailler en temps rÃ©el.
                            </p>
                        </div>
                        ` : `
                        <div class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-6">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                âš ï¸ <strong>Aucune session active</strong> - Cliquez sur "ðŸš€ DÃ©but de session" pour commencer.
                            </p>
                        </div>
                        `}

                        <!-- Grille 2 colonnes : SDI/SMSI Ã  gauche, VidÃ©o/Journal Ã  droite -->
                        <div class="grid lg:grid-cols-2 gap-6">
                            <!-- Colonne gauche : SDI et SMSI -->
                            <div class="space-y-6">
                                <!-- SDI Controls -->
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                    <h3 class="text-2xl font-bold mb-4 text-primary">ðŸ”¥ ContrÃ´le SDI</h3>

                                <div class="space-y-4">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Ã‰tat systÃ¨me</label>
                                            <select onchange="changeSdiState(this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="service" ${STATE.sdi.systemState === 'service' ? 'selected' : ''}>En service</option>
                                                <option value="hors-service" ${STATE.sdi.systemState === 'hors-service' ? 'selected' : ''}>Hors service</option>
                                                <option value="hors-tension" ${STATE.sdi.systemState === 'hors-tension' ? 'selected' : ''}>Hors tension</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-xs font-medium mb-1">Alimentation</label>
                                            <select onchange="changeSdiPower(this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="secteur" ${STATE.sdi.powerState === 'secteur' ? 'selected' : ''}>Secteur</option>
                                                <option value="batterie" ${STATE.sdi.powerState === 'batterie' ? 'selected' : ''}>Batterie</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-xs font-medium mb-1">Batterie</label>
                                            <select onchange="changeSdiBattery(this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="service" ${STATE.sdi.batteryState === 'service' ? 'selected' : ''}>En service</option>
                                                <option value="hors-service" ${STATE.sdi.batteryState === 'hors-service' ? 'selected' : ''}>Hors service</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-xs font-medium mb-1">Temporisation</label>
                                            <select onchange="setTemporization(this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                ${[0,1,2,3,4,5].map(m => `<option value="${m}" ${STATE.uga.temporization === m ? 'selected' : ''}>${m} min</option>`).join('')}
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-xs font-medium mb-1">Type alarme</label>
                                            <select onchange="setAlarmType(this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="generale" ${STATE.uga.alarmType === 'generale' ? 'selected' : ''}>GÃ©nÃ©rale</option>
                                                <option value="generale-selective" ${STATE.uga.alarmType === 'generale-selective' ? 'selected' : ''}>GÃ©nÃ©rale sÃ©lective</option>
                                                <option value="generale-message" ${STATE.uga.alarmType === 'generale-message' ? 'selected' : ''}>GÃ©nÃ©rale avec message</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- DAI et DM cÃ´te Ã  cÃ´te -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <h4 class="font-bold mb-2">ðŸ” DAI</h4>
                                            ${STATE.sdi.detectors.map(d => `
                                                <div class="flex items-center gap-1 mb-1">
                                                    <button onclick="${(d.state === 'service' && !d.outOfService) ? `toggleDetector('DAI', ${d.id})` : ''}" class="w-8 h-8 ${(d.outOfService || d.state === 'hors-service') ? 'bg-orange-500' : (d.triggered ? 'bg-red-500' : 'bg-green-500')} rounded border-2 border-black ${(d.state === 'hors-service' || d.outOfService) ? 'cursor-not-allowed' : 'hover:opacity-90 cursor-pointer'} flex-shrink-0 text-white text-xs"></button>
                                                    <span class="text-xs font-mono w-12 flex-shrink-0 font-bold ${(d.outOfService || d.state === 'hors-service') ? 'text-orange-600 dark:text-orange-400' : ''}">DAI${String(d.id).padStart(2, '0')}</span>
                                                    <select onchange="changeDetectorZone('DAI', ${d.id}, this.value)" class="px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-16">
                                                        <option value="ZC1" ${d.zone === 'ZC1' ? 'selected' : ''}>ZC1</option>
                                                        <option value="ZC2" ${d.zone === 'ZC2' ? 'selected' : ''}>ZC2</option>
                                                        <option value="ZC3" ${d.zone === 'ZC3' ? 'selected' : ''}>ZC3</option>
                                                    </select>
                                                    <input type="text" value="${d.address.replace(/^(DAI|DM)\s*\d*-?\d*\s*/, '').trim()}" placeholder="Adresse" onchange="updateDetectorAddressInput('DAI', ${d.id}, this.value)" class="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0">
                                                    <select onchange="changeDetectorState('DAI', ${d.id}, this.value)" class="px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-12">
                                                        <option value="service" ${(d.state === 'service' && !d.outOfService) ? 'selected' : ''}>OK</option>
                                                        <option value="hors-service" ${(d.state === 'hors-service' || d.outOfService) ? 'selected' : ''}>HS</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>

                                        <div>
                                            <h4 class="font-bold mb-2">ðŸš¨ DM</h4>
                                            ${STATE.sdi.manualAlarms.map(d => `
                                                <div class="flex items-center gap-1 mb-1">
                                                    <button onclick="${(d.state === 'service' && !d.outOfService) ? `toggleDetector('DM', ${d.id})` : ''}" class="w-8 h-8 ${(d.outOfService || d.state === 'hors-service') ? 'bg-orange-500' : (d.triggered ? 'bg-red-500' : 'bg-green-500')} rounded border-2 border-black ${(d.state === 'hors-service' || d.outOfService) ? 'cursor-not-allowed' : 'hover:opacity-90 cursor-pointer'} flex-shrink-0 text-white text-xs"></button>
                                                    <span class="text-xs font-mono w-12 flex-shrink-0 font-bold ${(d.outOfService || d.state === 'hors-service') ? 'text-orange-600 dark:text-orange-400' : ''}">DM${String(d.id).padStart(2, '0')}</span>
                                                    <select onchange="changeDetectorZone('DM', ${d.id}, this.value)" class="px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-16">
                                                        <option value="ZC1" ${d.zone === 'ZC1' ? 'selected' : ''}>ZC1</option>
                                                        <option value="ZC2" ${d.zone === 'ZC2' ? 'selected' : ''}>ZC2</option>
                                                        <option value="ZC3" ${d.zone === 'ZC3' ? 'selected' : ''}>ZC3</option>
                                                    </select>
                                                    <input type="text" value="${d.address.replace(/^(DAI|DM)\s*\d*-?\d*\s*/, '').trim()}" placeholder="Adresse" onchange="updateDetectorAddressInput('DM', ${d.id}, this.value)" class="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0">
                                                    <select onchange="changeDetectorState('DM', ${d.id}, this.value)" class="px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-12">
                                                        <option value="service" ${(d.state === 'service' && !d.outOfService) ? 'selected' : ''}>OK</option>
                                                        <option value="hors-service" ${(d.state === 'hors-service' || d.outOfService) ? 'selected' : ''}>HS</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    </div>
                                </div>

                                <!-- SMSI Controls -->
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                    <h3 class="text-2xl font-bold mb-4 text-primary">ðŸ›¡ï¸ ContrÃ´le SMSI</h3>

                                    <div class="space-y-4">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium mb-1">Ã‰tat systÃ¨me</label>
                                            <select onchange="changeSmsiState(this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="service" ${STATE.smsi.systemState === 'service' ? 'selected' : ''}>En service</option>
                                                <option value="hors-service" ${STATE.smsi.systemState === 'hors-service' ? 'selected' : ''}>Hors service</option>
                                                <option value="hors-tension" ${STATE.smsi.systemState === 'hors-tension' ? 'selected' : ''}>Hors tension</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-xs font-medium mb-1">Alimentation</label>
                                            <select onchange="changeSmsiPower(this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="secteur" ${STATE.smsi.powerState === 'secteur' ? 'selected' : ''}>Secteur</option>
                                                <option value="batterie" ${STATE.smsi.powerState === 'batterie' ? 'selected' : ''}>Batterie</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-xs font-medium mb-1">Batterie</label>
                                            <select onchange="changeSmsBattery(this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                                <option value="service" ${STATE.smsi.batteryState === 'service' ? 'selected' : ''}>En service</option>
                                                <option value="hors-service" ${STATE.smsi.batteryState === 'hors-service' ? 'selected' : ''}>Hors service</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- ZC, ZF et Coffrets cÃ´te Ã  cÃ´te -->
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <h4 class="font-bold mb-1 text-xs">ðŸšª ZC</h4>
                                            ${STATE.smsi.compartmentZones.map(z => `
                                                <div class="flex flex-col gap-1 mb-1">
                                                    <div class="flex items-center gap-1">
                                                        <span class="text-xs font-mono font-bold">${z.zone}</span>
                                                        <select onchange="changeZoneState('compartment', ${z.id}, this.value)" class="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0">
                                                            <option value="attente" ${z.state === 'attente' ? 'selected' : ''}>Attente</option>
                                                            <option value="defaut-attente" ${z.state === 'defaut-attente' ? 'selected' : ''}>DÃ©f. attente</option>
                                                            <option value="securite" ${z.state === 'securite' ? 'selected' : ''}>SÃ©curitÃ©</option>
                                                            <option value="defaut-securite" ${z.state === 'defaut-securite' ? 'selected' : ''}>DÃ©f. sÃ©curitÃ©</option>
                                                            <option value="defaut-alim" ${z.state === 'defaut-alim' ? 'selected' : ''}>DÃ©f. alim</option>
                                                        </select>
                                                    </div>
                                                    <input type="text" value="${z.address.replace(/^Compartiment Zone \d+/, '').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('compartment', ${z.id}, this.value || 'Compart. Z${z.id}')" class="w-full px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0">
                                                </div>
                                            `).join('')}
                                        </div>

                                        <div>
                                            <h4 class="font-bold mb-1 text-xs">ðŸ’¨ ZF</h4>
                                            ${STATE.smsi.smokeZones.map(z => `
                                                <div class="flex flex-col gap-1 mb-1">
                                                    <div class="flex items-center gap-1">
                                                        <span class="text-xs font-mono font-bold">${z.zone}</span>
                                                        <select onchange="changeZoneState('smoke', ${z.id}, this.value)" class="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0">
                                                            <option value="attente" ${z.state === 'attente' ? 'selected' : ''}>Attente</option>
                                                            <option value="defaut-attente" ${z.state === 'defaut-attente' ? 'selected' : ''}>DÃ©f. attente</option>
                                                            <option value="securite" ${z.state === 'securite' ? 'selected' : ''}>SÃ©curitÃ©</option>
                                                            <option value="defaut-securite" ${z.state === 'defaut-securite' ? 'selected' : ''}>DÃ©f. sÃ©curitÃ©</option>
                                                            <option value="defaut-alim" ${z.state === 'defaut-alim' ? 'selected' : ''}>DÃ©f. alim</option>
                                                        </select>
                                                    </div>
                                                    <input type="text" value="${z.address.replace(/^DÃ©senfumage Zone \d+/, '').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('smoke', ${z.id}, this.value || 'DÃ©senf. Z${z.id}')" class="w-full px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0">
                                                </div>
                                            `).join('')}
                                        </div>

                                        <div>
                                            <h4 class="font-bold mb-1 text-xs">âš¡ Coffrets</h4>
                                            ${STATE.smsi.relayBoxes.map(r => `
                                                <div class="flex flex-col gap-1 mb-1">
                                                    <div class="flex items-center gap-1">
                                                        <span class="text-xs font-mono font-bold">CR${r.id}</span>
                                                        <select onchange="changeZoneState('relay', ${r.id}, this.value)" class="flex-1 px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0">
                                                            <option value="attente" ${r.state === 'attente' ? 'selected' : ''}>Attente</option>
                                                            <option value="defaut-attente" ${r.state === 'defaut-attente' ? 'selected' : ''}>DÃ©f. attente</option>
                                                            <option value="securite" ${r.state === 'securite' ? 'selected' : ''}>SÃ©curitÃ©</option>
                                                            <option value="defaut-securite" ${r.state === 'defaut-securite' ? 'selected' : ''}>DÃ©f. sÃ©curitÃ©</option>
                                                            <option value="defaut-alim" ${r.state === 'defaut-alim' ? 'selected' : ''}>DÃ©f. alim</option>
                                                        </select>
                                                    </div>
                                                    <input type="text" value="${r.address.replace(/^Coffret \d+/, '').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('relay', ${r.id}, this.value || 'Coffret ${r.id}')" class="w-full px-1 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0">
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Colonne droite : VidÃ©o et Journal -->
                            <div class="space-y-6">
                                <!-- Video Panel Superviseur -->
                                ${STATE.sessionActive ? `
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                    <h3 class="text-2xl font-bold mb-4">ðŸ“¹ Vue Stagiaire</h3>

                                    <div id="video-status-section">
                                        ${!STATE.remoteStream ? `
                                            <div class="text-center py-8">
                                                <p class="text-gray-600 dark:text-gray-400 mb-4">
                                                    En attente que le stagiaire active sa camÃ©ra...
                                                </p>
                                                <button onclick="supervisorConnectToVideo()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-bold">
                                                    ðŸ”— Se connecter Ã  la vidÃ©o
                                                </button>
                                            </div>
                                        ` : `
                                            <div class="space-y-4">
                                                <div class="relative bg-black rounded-lg overflow-hidden" style="height: 360px;">
                                                    <video id="trainee-video" autoplay playsinline class="w-full h-full object-cover"></video>
                                                    <div class="absolute top-2 left-2 px-2 py-1 bg-red-500 text-white text-xs rounded">
                                                        ðŸ”´ STAGIAIRE EN DIRECT
                                                    </div>
                                                    <div class="absolute bottom-2 right-2">
                                                        <button onclick="disconnectVideo()" class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                                            â¹ï¸ DÃ©connecter
                                                        </button>
                                                    </div>
                                                </div>
                                                <p class="text-sm text-gray-600 dark:text-gray-400 text-center">
                                                    ðŸ’¡ Vous pouvez voir et entendre le stagiaire pour dÃ©briefing
                                                </p>

                                                <!-- Bouton Mute/Unmute Audio -->
                                                <div class="bg-${STATE.audioMuted ? 'red' : 'green'}-50 dark:bg-${STATE.audioMuted ? 'red' : 'green'}-900 p-4 rounded-lg border-2 border-${STATE.audioMuted ? 'red' : 'green'}-500">
                                                    <button
                                                        onclick="toggleAudioMute()"
                                                        class="w-full px-6 py-3 bg-${STATE.audioMuted ? 'red' : 'green'}-500 text-white rounded-lg hover:bg-${STATE.audioMuted ? 'red' : 'green'}-600 transition font-bold text-lg flex items-center justify-center gap-3"
                                                    >
                                                        <span class="text-2xl">${STATE.audioMuted ? 'ðŸ”‡' : 'ðŸ”Š'}</span>
                                                        <span>${STATE.audioMuted ? 'SON COUPÃ‰ - Cliquez pour activer' : 'SON ACTIVÃ‰ - Cliquez pour couper'}</span>
                                                    </button>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-2 text-center">
                                                        ${STATE.audioMuted ?
                                                            'âš ï¸ Audio dÃ©sactivÃ© par dÃ©faut pour Ã©viter le larsen. Utilisez un CASQUE avant d\'activer !' :
                                                            'âœ… Audio activÃ©. Si vous entendez du larsen, COUPEZ immÃ©diatement ou utilisez un casque.'
                                                        }
                                                    </p>
                                                </div>

                                                <!-- ContrÃ´le de volume audio -->
                                                ${!STATE.audioMuted ? `
                                                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                                                    <h4 class="font-bold mb-3 flex items-center gap-2">
                                                        ðŸ”Š RÃ©glage du Volume
                                                    </h4>
                                                    <div class="flex items-center gap-4">
                                                        <span class="text-sm">ðŸ”‡</span>
                                                        <input
                                                            type="range"
                                                            min="0"
                                                            max="1"
                                                            step="0.05"
                                                            value="${STATE.audioVolume}"
                                                            oninput="setAudioVolume(this.value); this.nextElementSibling.textContent = Math.round(this.value * 100) + '%'"
                                                            class="flex-1 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer"
                                                            style="accent-color: #3b82f6;"
                                                        >
                                                        <span class="text-sm font-bold min-w-[50px] text-right">${Math.round(STATE.audioVolume * 100)}%</span>
                                                        <span class="text-sm">ðŸ”Š</span>
                                                    </div>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">
                                                        ðŸ’¡ Ajustez le volume pour mieux entendre le stagiaire. âš ï¸ Volume faible recommandÃ© pour Ã©viter le larsen !
                                                    </p>
                                                </div>
                                                ` : ''}

                                                <!-- ContrÃ´les d'enregistrement -->
                                                <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                                                    <h4 class="font-bold mb-3 flex items-center gap-2">
                                                        ðŸŽ¬ Enregistrement pour dÃ©briefing
                                                        ${STATE.isRecording ? `<span class="px-2 py-1 bg-red-500 text-white text-xs rounded animate-pulse">âº REC ${getRecordingDuration()}</span>` : ''}
                                                    </h4>
                                                    <div class="flex gap-2">
                                                        ${!STATE.isRecording ? `
                                                            <button onclick="startRecording()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition font-bold">
                                                                âº DÃ©marrer l'enregistrement
                                                            </button>
                                                        ` : `
                                                            <button onclick="stopRecording()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition font-bold">
                                                                â¹ï¸ ArrÃªter et TÃ©lÃ©charger
                                                            </button>
                                                        `}
                                                    </div>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">
                                                        ${STATE.isRecording ?
                                                            'ðŸ“¹ Enregistrement VIDÃ‰O + AUDIO en cours... Le fichier sera tÃ©lÃ©chargÃ© automatiquement Ã  l\'arrÃªt.' :
                                                            'ðŸ’¾ L\'enregistrement capture la VIDÃ‰O + AUDIO du stagiaire (mÃªme si le son est coupÃ© pour vous).'
                                                        }
                                                    </p>
                                                    ${STATE.audioMuted ? `
                                                    <div class="mt-2 p-2 bg-green-100 dark:bg-green-800 rounded border border-green-500">
                                                        <p class="text-xs text-green-800 dark:text-green-200">
                                                            âœ… <strong>Audio enregistrÃ© :</strong> Le son du stagiaire est capturÃ© dans l'enregistrement mÃªme si vous ne l'entendez pas en direct.
                                                        </p>
                                                    </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `}
                                    </div>
                                </div>
                                ` : ''}

                                <!-- Action Log -->
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                    <h3 class="text-2xl font-bold mb-4 text-primary">ðŸ“‹ Journal des actions du stagiaire</h3>
                                    <div class="ssi-screen max-h-96 overflow-y-auto overflow-x-hidden" style="word-break: break-word; max-width: 100%;">
                                ${STATE.actionLog.length === 0 ?
                                    '<div class="text-center opacity-50">Aucune action enregistrÃ©e</div>' :
                                    STATE.actionLog.slice(-20).reverse().map(log => `
                                        <div class="mb-2 pb-2 border-b border-green-900">
                                            <div class="text-xs opacity-75">${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                                            <div>${log.trainee}: <span class="text-yellow-400">${log.action}</span></div>
                                            ${log.details ? `<div class="text-sm opacity-75">${log.details}</div>` : ''}
                                        </div>
                                    `).join('')
                                }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTraineeInterface() {
            return `
                <div class="min-h-screen p-2 bg-gray-100 dark:bg-gray-900">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h2 class="text-2xl font-bold">SSI - Formation</h2>
                                <p class="text-xs text-gray-600 dark:text-gray-400">
                                    ${STATE.currentUser?.prenom} ${STATE.currentUser?.nom} - SSIAP ${STATE.currentUser?.niveau}
                                </p>
                                ${STATE.sessionActive && STATE.sessionNumber ? `
                                    <div class="mt-1 flex items-center gap-2">
                                        <span class="px-2 py-1 bg-blue-500 text-white rounded text-xs font-bold">
                                            ðŸ“‹ Session ${STATE.sessionNumber}
                                        </span>
                                        <span class="px-2 py-1 ${STATE.sessionActive ? 'bg-green-500' : 'bg-red-500'} text-white rounded text-xs font-bold">
                                            ${STATE.sessionActive ? 'âœ“ OUVERTE' : 'âœ— FERMÃ‰E'}
                                        </span>
                                    </div>
                                ` : STATE.sessionId ? `
                                    <div class="mt-1">
                                        <span class="px-2 py-1 bg-yellow-500 text-white rounded text-xs font-bold">
                                            â³ En attente de session...
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="navigate('home')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition text-sm">
                                DÃ©connexion
                            </button>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-4">
                            <!-- SDI Panel -->
                            <div class="ssi-panel">
                                <h3 class="text-xl font-bold mb-3 text-white">ðŸ”¥ SDI</h3>

                                <!-- Status Indicators - 3 voyants -->
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <div class="bg-gray-800 p-1.5 rounded flex items-center justify-between">
                                        <div class="text-white text-xs">Ã‰tat mat.</div>
                                        <span class="led-light ${STATE.sdi.systemState === 'service' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                    <div class="bg-gray-800 p-1.5 rounded flex items-center justify-between">
                                        <div class="text-white text-xs">Alim. sect.</div>
                                        <span class="led-light ${STATE.sdi.powerState === 'secteur' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                    <div class="bg-gray-800 p-1.5 rounded flex items-center justify-between">
                                        <div class="text-white text-xs">Batterie</div>
                                        <span class="led-light ${STATE.sdi.batteryState === 'service' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                </div>

                                <!-- ECS Screen -->
                                <div class="mb-2">
                                    <div class="text-white text-xs font-bold mb-1">
                                        <span>ðŸ“Ÿ ECS</span>
                                    </div>
                                    <div id="sdi-screen" class="ssi-screen max-h-48 overflow-y-hidden overflow-x-hidden text-xs scroll-smooth">
                                        ${STATE.sdi.alarms.length === 0 ?
                                            '<div class="text-center">SYSTÃˆME EN VEILLE</div>' :
                                            STATE.sdi.alarms.map(alarm => `
                                                <div class="mb-1">${alarm.text}</div>
                                            `).join('')
                                        }
                                    </div>
                                    <!-- Navigation - Nord Sud Est Ouest -->
                                    <div class="flex justify-center gap-1 mt-1">
                                        <button onclick="scrollScreen('sdi-screen', 'first')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold" title="Ouest">â¬…ï¸</button>
                                        <button onclick="scrollScreen('sdi-screen', 'up')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold" title="Nord">â¬†ï¸</button>
                                        <button onclick="scrollScreen('sdi-screen', 'down')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold" title="Sud">â¬‡ï¸</button>
                                        <button onclick="scrollScreen('sdi-screen', 'last')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold" title="Est">âž¡ï¸</button>
                                    </div>
                                </div>

                                <!-- Fire Alarm with Sound Control -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-white text-xs font-bold">ALARME FEU</span>
                                        <div class="flex items-center gap-2">
                                            <span class="led-light ${STATE.sdi.fireAlarmActive ? 'led-red blink' : 'led-off'}"></span>
                                            ${STATE.sdi.alarmSound ? `
                                                <button onclick="traineeStopAlarmSound()" class="px-2 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                                    ðŸ”‡ ARRÃŠT
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>

                                <!-- 4 Boutons de commande sur une ligne -->
                                <div class="grid grid-cols-4 gap-1 mb-2">
                                    <button onclick="toggleAccessLevel('sdi')" class="px-2 py-2 ${STATE.accessLevel === 1 ? 'bg-green-600' : 'bg-yellow-600'} text-white rounded text-xs hover:opacity-90 font-bold">
                                        ðŸ”‘ Niv.${STATE.accessLevel}
                                    </button>
                                    <button onclick="traineeResetSdiSystem()" class="px-2 py-2 ${canResetSdiSystem() ? 'bg-green-600' : 'bg-gray-600 opacity-50'} text-white rounded text-xs font-bold">
                                        ðŸ”„ RÃ‰ARM
                                    </button>
                                    <button onclick="startOutOfServiceWorkflow()" class="px-2 py-2 ${STATE.accessLevel === 2 ? 'bg-orange-600 hover:bg-orange-700' : 'bg-gray-600 opacity-50'} text-white rounded text-xs font-bold" ${STATE.accessLevel !== 2 ? 'disabled' : ''}>
                                        âš ï¸ M.H.S.
                                    </button>
                                    <button onclick="startBackInServiceWorkflow()" class="px-2 py-2 ${STATE.accessLevel === 2 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 opacity-50'} text-white rounded text-xs font-bold" ${STATE.accessLevel !== 2 ? 'disabled' : ''}>
                                        âœ… R.S.
                                    </button>
                                </div>

                                <!-- PavÃ© numÃ©rique en dessous -->
                                <div class="bg-gray-800 p-1.5 rounded mb-2">
                                    <div class="text-white text-xs font-bold mb-1">PavÃ© numÃ©rique</div>
                                    <div class="bg-black text-green-400 font-mono p-1 rounded mb-1 text-center text-xs min-h-[20px]">
                                        ${STATE.keypadInput || '_'}
                                    </div>
                                    <div class="grid grid-cols-3 gap-0.5">
                                        ${[1,2,3,4,5,6,7,8,9].map(n => `
                                            <button onclick="keypadPress('${n}')" class="bg-gray-700 hover:bg-gray-600 text-white py-1.5 rounded text-xs font-bold">
                                                ${n}
                                            </button>
                                        `).join('')}
                                        <button onclick="keypadPress('C')" class="bg-red-700 hover:bg-red-600 text-white py-1.5 rounded text-xs font-bold">
                                            C
                                        </button>
                                        <button onclick="keypadPress('0')" class="bg-gray-700 hover:bg-gray-600 text-white py-1.5 rounded text-xs font-bold">
                                            0
                                        </button>
                                        <button onclick="keypadValidate()" class="bg-green-700 hover:bg-green-600 text-white py-1.5 rounded text-xs font-bold">
                                            âœ“
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- SMSI Panel -->
                            <div class="ssi-panel">
                                <h3 class="text-xl font-bold mb-3 text-white">ðŸ›¡ï¸ SMSI</h3>

                                <!-- Status Indicators - 3 voyants -->
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <div class="bg-gray-800 p-1.5 rounded flex items-center justify-between">
                                        <div class="text-white text-xs">Ã‰tat mat.</div>
                                        <span class="led-light ${STATE.smsi.systemState === 'service' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                    <div class="bg-gray-800 p-1.5 rounded flex items-center justify-between">
                                        <div class="text-white text-xs">Alim. sect.</div>
                                        <span class="led-light ${STATE.smsi.powerState === 'secteur' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                    <div class="bg-gray-800 p-1.5 rounded flex items-center justify-between">
                                        <div class="text-white text-xs">Batterie</div>
                                        <span class="led-light ${STATE.smsi.batteryState === 'service' ? 'led-green' : 'led-off'}"></span>
                                    </div>
                                </div>

                                <!-- SMSI Screen -->
                                <div class="mb-2">
                                    <div class="text-white text-xs font-bold mb-1">
                                        <span>ðŸ“Ÿ RemontÃ©es SMSI</span>
                                    </div>
                                    <div id="smsi-screen" class="ssi-screen max-h-48 overflow-y-hidden overflow-x-hidden text-xs scroll-smooth">
                                        ${STATE.smsi.messages.length === 0 ?
                                            '<div class="text-center">SYSTÃˆME EN VEILLE</div>' :
                                            STATE.smsi.messages.map(msg => `
                                                <div class="mb-1">${msg.text}</div>
                                            `).join('')
                                        }
                                    </div>
                                    <!-- Navigation - Nord Sud Est Ouest -->
                                    <div class="flex justify-center gap-1 mt-1">
                                        <button onclick="scrollScreen('smsi-screen', 'first')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold" title="Ouest">â¬…ï¸</button>
                                        <button onclick="scrollScreen('smsi-screen', 'up')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold" title="Nord">â¬†ï¸</button>
                                        <button onclick="scrollScreen('smsi-screen', 'down')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold" title="Sud">â¬‡ï¸</button>
                                        <button onclick="scrollScreen('smsi-screen', 'last')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold" title="Est">âž¡ï¸</button>
                                    </div>
                                </div>

                                <!-- UGA - Simplified -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="text-white font-bold mb-2 text-xs">ðŸ”” UGA</div>

                                    ${STATE.uga.temporizationActive ? `
                                        <div class="bg-yellow-600 text-white p-2 rounded mb-2 text-center font-bold text-xs temporization-display">
                                            â±ï¸ ${Math.floor(STATE.uga.temporizationRemaining / 60)}:${String(STATE.uga.temporizationRemaining % 60).padStart(2, '0')}
                                        </div>
                                    ` : '<div class="temporization-display"></div>'}

                                    <div class="grid grid-cols-2 gap-1">
                                        <button id="forceAlarmBtn" onmousedown="startForceAlarm()" onmouseup="cancelForceAlarm()" ontouchstart="startForceAlarm()" ontouchend="cancelForceAlarm()" class="px-2 py-2 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                            ðŸš¨ FORCÃ‰ (3s)
                                        </button>
                                        <button onclick="traineeAcquitProcess()" class="px-2 py-2 ${STATE.uga.temporizationActive ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-500 opacity-50 cursor-not-allowed'} text-white rounded text-xs" ${STATE.uga.alarmActive ? 'disabled' : ''}>
                                            âœ‹ ACQUIT ${STATE.uga.temporizationActive ? '' : '(Inactif)'}
                                        </button>
                                    </div>

                                    ${STATE.uga.alarmActive ? `
                                        <div class="mt-2 bg-red-600 text-white p-2 rounded text-center font-bold text-xs blink">
                                            ðŸš¨ ALARME ${STATE.uga.alarmType === 'generale' ? 'GÃ‰NÃ‰RALE' : (STATE.uga.alarmType === 'generale-selective' ? 'SÃ‰LECTIVE' : 'AVEC MESSAGE')}
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- UCMC - Side by side -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="text-white font-bold mb-2 text-xs">ðŸŽ›ï¸ UCMC</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <!-- Compartimentage -->
                                        <div class="pr-2 border-r border-gray-600">
                                            <div class="text-white text-xs mb-1">ðŸšª ZC</div>
                                            ${STATE.smsi.compartmentZones.map(z => `
                                                <div class="flex items-center gap-1 mb-1">
                                                    <span class="text-white text-xs font-bold w-6 flex-shrink-0">${z.zone}</span>
                                                    <span class="led-light ${z.ledRed.on ? 'led-red' : 'led-off'} ${z.ledRed.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${z.ledOrange.on ? 'led-orange' : 'led-off'} ${z.ledOrange.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${z.ledGreen.on ? 'led-green' : 'led-off'} ${z.ledGreen.blink ? 'blink' : ''}"></span>
                                                    <span class="text-white text-xs opacity-75 truncate flex-1">${z.address}</span>
                                                    <button onclick="commandZone('compartment', ${z.id})" class="px-1 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 flex-shrink-0">CMD</button>
                                                    <span class="command-led ${z.commandActive ? 'active' : ''}"></span>
                                                </div>
                                            `).join('')}
                                        </div>

                                        <!-- DÃ©senfumage -->
                                        <div class="pl-2">
                                            <div class="text-white text-xs mb-1">ðŸ’¨ ZF</div>
                                            ${STATE.smsi.smokeZones.map(z => `
                                                <div class="flex items-center gap-1 mb-1">
                                                    <span class="text-white text-xs font-bold w-6 flex-shrink-0">${z.zone}</span>
                                                    <span class="led-light ${z.ledRed.on ? 'led-red' : 'led-off'} ${z.ledRed.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${z.ledOrange.on ? 'led-orange' : 'led-off'} ${z.ledOrange.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${z.ledGreen.on ? 'led-green' : 'led-off'} ${z.ledGreen.blink ? 'blink' : ''}"></span>
                                                    <span class="text-white text-xs opacity-75 truncate flex-1">${z.address}</span>
                                                    <button onclick="commandZone('smoke', ${z.id})" class="px-1 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 flex-shrink-0">CMD</button>
                                                    <span class="command-led ${z.commandActive ? 'active' : ''}"></span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- Coffrets de relayage (moved from US) -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="text-white font-bold mb-2 text-xs">âš¡ Coffrets relayage</div>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${STATE.smsi.relayBoxes.map(r => `
                                            <div class="flex flex-col gap-1">
                                                <div class="flex items-center gap-1 justify-center">
                                                    <span class="text-white text-xs font-bold">CR${r.id}</span>
                                                    <span class="led-light ${r.ledRed.on ? 'led-red' : 'led-off'} ${r.ledRed.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${r.ledOrange.on ? 'led-orange' : 'led-off'} ${r.ledOrange.blink ? 'blink' : ''}"></span>
                                                    <span class="led-light ${r.ledGreen.on ? 'led-green' : 'led-off'} ${r.ledGreen.blink ? 'blink' : ''}"></span>
                                                </div>
                                                <div class="text-white text-xs opacity-75 text-center truncate w-full mb-1">${r.address}</div>
                                                <button onclick="stopRelay(${r.id})" class="w-full px-1 py-1 ${r.stopped ? 'bg-red-600' : 'bg-orange-600'} text-white rounded text-xs hover:opacity-90">
                                                    ${r.stopped ? 'ARRÃŠTÃ‰' : 'ARRÃŠT'}
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- US - Simplified -->
                                <div class="bg-gray-800 p-2 rounded mb-3">
                                    <div class="text-white font-bold mb-2 text-xs">ðŸ’¡ US</div>
                                    <div class="grid grid-cols-2 gap-1">
                                        <button onclick="testSignalization()" class="px-2 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">
                                            ðŸ§ª TEST
                                        </button>
                                        <button onclick="bilanSystem()" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                            ðŸ“Š BILAN
                                        </button>
                                    </div>
                                </div>

                                <!-- SMSI Reset -->
                                <div class="flex gap-2">
                                    <button onclick="toggleAccessLevel('smsi')" class="px-3 py-1 ${STATE.smsiAccessLevel === 1 ? 'bg-green-600' : 'bg-yellow-600'} text-white rounded text-xs hover:opacity-90">
                                        Niv.${STATE.smsiAccessLevel}
                                    </button>
                                    <div class="key-switch ${STATE.smsiAccessLevel === 2 ? 'active' : ''}" onclick="toggleAccessLevel('smsi')">
                                        ðŸ”‘
                                    </div>
                                    <button onclick="traineeResetSmsiSystem()" class="flex-1 px-3 py-1 ${canResetSmsiSystem() ? 'bg-green-600' : 'bg-gray-600 opacity-50'} text-white rounded text-xs">
                                        ðŸ”„ RÃ‰ARMEMENT SMSI
                                    </button>
                                </div>
                            </div>

                            <!-- Action Log - Pleine largeur sous SDI et SMSI -->
                            <div class="lg:col-span-2">
                                <div class="ssi-panel">
                                    <h3 class="text-xl font-bold mb-3 text-white">ðŸ“‹ Journal des actions du stagiaire</h3>
                                    <div class="ssi-screen max-h-96 overflow-y-auto">
                                        ${STATE.actionLog.length === 0 ?
                                            '<div class="text-center opacity-50">Aucune action enregistrÃ©e</div>' :
                                            STATE.actionLog.slice(-20).reverse().map(log => `
                                                <div class="mb-2 pb-2 border-b border-green-900">
                                                    <div class="text-xs opacity-75">${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                                                    <div>${log.trainee}: <span class="text-yellow-400">${log.action}</span></div>
                                                    ${log.details ? `<div class="text-sm opacity-75">${log.details}</div>` : ''}
                                                </div>
                                            `).join('')
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Video Panel Stagiaire - MASQUÃ‰ (la camÃ©ra fonctionne en arriÃ¨re-plan automatiquement) -->
                        <!--
                        <div class="mt-4 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                            <h3 class="text-lg font-bold mb-3">ðŸ“¹ Partage VidÃ©o / Audio</h3>

                            ${!STATE.localStream ? `
                                <div class="text-center py-8">
                                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                                        Activez votre camÃ©ra et micro pour partager avec le superviseur
                                    </p>
                                    <button onclick="startVideo()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-bold">
                                        ðŸ“¹ Activer CamÃ©ra et Micro
                                    </button>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    <div class="relative bg-black rounded-lg overflow-hidden" style="height: 240px;">
                                        <video id="local-video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                                        <div class="absolute top-2 left-2 px-2 py-1 bg-green-500 text-white text-xs rounded">
                                            ðŸ”´ LIVE
                                        </div>
                                        <div class="absolute bottom-2 left-2 right-2 flex justify-center gap-2">
                                            <button onclick="toggleVideo()" class="px-3 py-2 ${STATE.videoEnabled ? 'bg-blue-500' : 'bg-red-500'} text-white rounded hover:opacity-90">
                                                ${STATE.videoEnabled ? 'ðŸ“¹' : 'ðŸ“¹âŒ'} ${STATE.videoEnabled ? 'ON' : 'OFF'}
                                            </button>
                                            <button onclick="toggleAudio()" class="px-3 py-2 ${STATE.audioEnabled ? 'bg-blue-500' : 'bg-red-500'} text-white rounded hover:opacity-90">
                                                ${STATE.audioEnabled ? 'ðŸŽ¤' : 'ðŸŽ¤âŒ'} ${STATE.audioEnabled ? 'ON' : 'OFF'}
                                            </button>
                                            <button onclick="stopVideo()" class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                                â¹ï¸ ArrÃªter
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 text-center">
                                        Votre vidÃ©o est partagÃ©e avec le superviseur
                                    </p>
                                </div>
                            `}
                        </div>
                        -->
                    </div>
                </div>
            `;
        }

        // Event Handlers
        function handleSupervisorLogin(event) {
            event.preventDefault();
            const code = document.getElementById('supervisor-code').value;

            if (code === '1234') {
                navigate('supervisor-interface', { userType: 'supervisor' });
            } else {
                showCustomAlert('Code superviseur incorrect');
            }
        }

        function handleTraineePinLogin(event) {
            event.preventDefault();
            const pin = document.getElementById('trainee-pin').value;

            const trainee = STATE.trainees.find(t => t.pin === pin);
            if (!trainee) {
                showCustomAlert('Code PIN incorrect');
                return;
            }

            // VÃ©rifier les dates d'autorisation
            if (!checkTraineeAccess(trainee)) {
                const dateDebut = new Date(trainee.dateDebut).toLocaleDateString('fr-FR');
                const dateFin = new Date(trainee.dateFin).toLocaleDateString('fr-FR');
                showCustomAlert(`AccÃ¨s refusÃ©. Votre formation est autorisÃ©e du ${dateDebut} au ${dateFin}.`);
                return;
            }

            navigate('trainee-interface', { user: trainee, userType: 'trainee' });

            // Rejoindre automatiquement la session active
            setTimeout(() => {
                joinActiveSession();
            }, 500);
        }

        function handleCreateTrainee(event) {
            event.preventDefault();

            const data = {
                nom: document.getElementById('nom').value,
                prenom: document.getElementById('prenom').value,
                email: document.getElementById('email').value,
                niveau: document.getElementById('niveau').value,
                dateDebut: document.getElementById('dateDebut').value,
                dateFin: document.getElementById('dateFin').value
            };

            createTrainee(data);
            navigate('trainee-management');

            // Auto-export uniquement si Firebase n'est pas disponible
            if (!firebaseInitialized) {
                setTimeout(() => {
                    exportTrainees();
                    showCustomAlert('Stagiaire crÃ©Ã© ! Le fichier stagiaires.json a Ã©tÃ© tÃ©lÃ©chargÃ© automatiquement.');
                }, 100);
            } else {
                setTimeout(() => {
                    showCustomAlert('Stagiaire crÃ©Ã© et synchronisÃ© avec le cloud !');
                }, 100);
            }
        }

        function deleteTrainee(id) {
            showCustomConfirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce stagiaire ?', () => {
                STATE.trainees = STATE.trainees.filter(t => t.id !== id);
                saveTrainees();
                render();

                // Auto-export uniquement si Firebase n'est pas disponible
                if (!firebaseInitialized && STATE.trainees.length > 0) {
                    setTimeout(() => {
                        exportTrainees();
                        showCustomAlert('Stagiaire supprimÃ© ! Le fichier stagiaires.json a Ã©tÃ© mis Ã  jour.');
                    }, 100);
                } else if (firebaseInitialized) {
                    setTimeout(() => {
                        showCustomAlert('Stagiaire supprimÃ© et synchronisÃ© avec le cloud !');
                    }, 100);
                }
            });
        }

        // Supervisor Controls
        function changeSdiState(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.sdi.systemState = state;
            sendMessage('SDI_STATE_CHANGE', { state });
        }

        function changeSdiBattery(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.sdi.batteryState = state;
            sendMessage('SDI_BATTERY_CHANGE', { state });
        }

        function changeSdiPower(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.sdi.powerState = state;
            sendMessage('SDI_POWER_CHANGE', { state });
        }

        function changeSmsiPower(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.smsi.powerState = state;
            sendMessage('SMSI_POWER_CHANGE', { state });
        }

        function setTemporization(minutes) {
            if (!checkSessionBeforeAction()) return;
            STATE.uga.temporization = parseInt(minutes);
            sendMessage('SET_TEMPORIZATION', { minutes: parseInt(minutes) });
        }

        function setAlarmType(type) {
            if (!checkSessionBeforeAction()) return;
            STATE.uga.alarmType = type;
            sendMessage('SET_ALARM_TYPE', { alarmType: type });
        }

        function toggleDetector(type, id) {
            if (!checkSessionBeforeAction()) return;
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);

            if (detector.triggered) {
                resetDetector(type, id);
                sendMessage('RESET_DETECTOR', { type, id });
                logAction(`RÃ©armement ${type}`, detector.address, 'supervisor');
            } else {
                // CÃ´tÃ© superviseur: ne pas jouer le son (playSound = false)
                triggerDetector(type, id, false);
                sendMessage('TRIGGER_DETECTOR', { type, id });
                logAction(`DÃ©clenchement ${type}`, detector.address, 'supervisor');
            }

            render();
        }

        function resetDM(id) {
            resetDetector('DM', id);
            sendMessage('RESET_DETECTOR', { type: 'DM', id });
            render();
        }

        function changeDetectorState(type, id, state) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);
            detector.state = state;
            // Synchroniser avec Firebase
            sendMessage('CHANGE_DETECTOR_STATE', { type, id, state });
            render();
        }

        function changeDetectorZone(type, id, zone) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);
            detector.zone = zone;
            render();
        }

        function renderSessionLogs() {
            // Trier les journaux par date (plus rÃ©cent en premier)
            const sortedLogs = [...STATE.sessionLogs].sort((a, b) =>
                new Date(b.endTime) - new Date(a.endTime)
            );

            // Filtrer selon la recherche
            const query = STATE.searchQuery.toLowerCase();
            // N'afficher les journaux que si une recherche est effectuÃ©e
            const filteredLogs = query ? sortedLogs.filter(log => {
                const dateStr = new Date(log.startTime).toLocaleDateString('fr-FR');
                const trainee = (log.trainee || '').toLowerCase();
                const sessionNum = log.sessionNumber.toString();
                return dateStr.includes(query) || trainee.includes(query) || sessionNum.includes(query);
            }) : [];

            return `
                <div class="min-h-screen p-4 bg-gray-100 dark:bg-gray-900">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold">ðŸ“š Historique des Journaux de Session</h2>
                            <button onclick="navigate('supervisor-interface')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                â† Retour
                            </button>
                        </div>

                        <!-- Barre de recherche -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg mb-6">
                            <div class="relative">
                                <input
                                    type="text"
                                    id="search-input"
                                    value="${STATE.searchQuery}"
                                    oninput="updateSearchQuery(this.value)"
                                    placeholder="ðŸ” Rechercher par date, nom du stagiaire ou numÃ©ro de session..."
                                    class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                                    list="search-suggestions"
                                />
                                <datalist id="search-suggestions">
                                    ${sortedLogs.map(log => `
                                        <option value="${log.sessionNumber}">Session ${log.sessionNumber}</option>
                                        <option value="${log.trainee || ''}"></option>
                                        <option value="${new Date(log.startTime).toLocaleDateString('fr-FR')}"></option>
                                    `).join('')}
                                </datalist>
                                ${STATE.searchQuery ? `
                                    <button onclick="clearSearch()" class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">
                                        âœ•
                                    </button>
                                ` : ''}
                            </div>
                            ${STATE.searchQuery && filteredLogs.length > 0 ? `
                                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                    ${filteredLogs.length} rÃ©sultat(s) trouvÃ©(s)
                                </div>
                            ` : ''}
                        </div>

                        ${filteredLogs.length === 0 ? `
                            <div class="bg-white dark:bg-gray-800 p-12 rounded-xl shadow-lg text-center">
                                <p class="text-gray-500 dark:text-gray-400 text-lg">
                                    ${STATE.searchQuery ? 'Aucun rÃ©sultat trouvÃ© pour cette recherche.' : 'ðŸ” Utilisez la barre de recherche pour afficher les journaux'}
                                </p>
                            </div>
                        ` : `
                            <div class="grid gap-6">
                                ${filteredLogs.map(log => `
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                        <div class="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 class="text-2xl font-bold text-primary">Session ${log.sessionNumber}</h3>
                                                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                                    <span>ðŸ‘¤ ${log.trainee || 'Inconnu'}</span>
                                                    <span class="mx-2">â€¢</span>
                                                    <span>ðŸ‘¨â€ðŸ« ${log.supervisor || 'Superviseur'}</span>
                                                </div>
                                            </div>
                                            <div class="text-right text-sm">
                                                <div class="text-gray-600 dark:text-gray-400">
                                                    ðŸ“… ${new Date(log.startTime).toLocaleDateString('fr-FR')}
                                                </div>
                                                <div class="text-gray-600 dark:text-gray-400">
                                                    ðŸ• ${new Date(log.startTime).toLocaleTimeString('fr-FR')} - ${new Date(log.endTime).toLocaleTimeString('fr-FR')}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                                            <h4 class="font-bold mb-3">ðŸ“‹ Actions (${log.actions.length})</h4>
                                            <div class="ssi-screen max-h-96 overflow-y-auto">
                                                ${log.actions.slice(-50).reverse().map(action => `
                                                    <div class="mb-2 pb-2 border-b border-green-900">
                                                        <div class="text-xs opacity-75">${new Date(action.timestamp).toLocaleString('fr-FR')}</div>
                                                        <div>${action.trainee}: <span class="text-yellow-400">${action.action}</span></div>
                                                        ${action.details ? `<div class="text-sm opacity-75">${action.details}</div>` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <div class="mt-4 flex justify-end gap-2">
                                            <button onclick="printSessionLog('${log.sessionId}')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm">
                                                ðŸ–¨ï¸ Imprimer PDF
                                            </button>
                                            <button onclick="deleteSessionLog('${log.sessionId}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">
                                                ðŸ—‘ï¸ Supprimer
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function updateSearchQuery(value) {
            STATE.searchQuery = value;
            // Ne pas faire de render complet, juste mettre Ã  jour les rÃ©sultats
            updateSearchResults();
        }

        function updateSearchResults() {
            // Filtrer et afficher les rÃ©sultats sans re-render complet
            const query = STATE.searchQuery.toLowerCase();
            const sortedLogs = [...STATE.sessionLogs].sort((a, b) => new Date(b.endTime) - new Date(a.endTime));
            const filteredLogs = query ? sortedLogs.filter(log => {
                const dateStr = new Date(log.startTime).toLocaleDateString('fr-FR');
                const trainee = (log.trainee || '').toLowerCase();
                const sessionNum = log.sessionNumber.toString();
                return dateStr.includes(query) || trainee.includes(query) || sessionNum.includes(query);
            }) : sortedLogs;

            // Mettre Ã  jour uniquement la section des rÃ©sultats
            const resultsContainer = document.querySelector('.grid.gap-6');
            if (resultsContainer) {
                if (filteredLogs.length === 0) {
                    resultsContainer.innerHTML = '<div class="bg-white dark:bg-gray-800 p-12 rounded-xl shadow-lg text-center"><p class="text-gray-500 dark:text-gray-400 text-lg">Aucun rÃ©sultat trouvÃ©.</p></div>';
                } else {
                    resultsContainer.innerHTML = filteredLogs.map(log => `
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-2xl font-bold text-primary">Session ${log.sessionNumber}</h3>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                        <span>ðŸ‘¤ ${log.trainee || 'Inconnu'}</span>
                                        <span class="mx-2">â€¢</span>
                                        <span>ðŸ‘¨â€ðŸ« ${log.supervisor || 'Superviseur'}</span>
                                    </div>
                                </div>
                                <div class="text-right text-sm">
                                    <div class="text-gray-600 dark:text-gray-400">
                                        ðŸ“… ${new Date(log.startTime).toLocaleDateString('fr-FR')}
                                    </div>
                                    <div class="text-gray-600 dark:text-gray-400">
                                        ðŸ• ${new Date(log.startTime).toLocaleTimeString('fr-FR')} - ${new Date(log.endTime).toLocaleTimeString('fr-FR')}
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                                <h4 class="font-bold mb-3">ðŸ“‹ Actions (${log.actions.length})</h4>
                                <div class="ssi-screen max-h-96 overflow-y-auto">
                                    ${log.actions.slice(-50).reverse().map(action => `
                                        <div class="mb-2 pb-2 border-b border-green-900">
                                            <div class="text-xs opacity-75">${new Date(action.timestamp).toLocaleString('fr-FR')}</div>
                                            <div>${action.trainee}: <span class="text-yellow-400">${action.action}</span></div>
                                            ${action.details ? `<div class="text-sm opacity-75">${action.details}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end gap-2">
                                <button onclick="printSessionLog('${log.sessionId}')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm">
                                    ðŸ–¨ï¸ Imprimer PDF
                                </button>
                                <button onclick="deleteSessionLog('${log.sessionId}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">
                                    ðŸ—‘ï¸ Supprimer
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // Mettre Ã  jour le compteur de rÃ©sultats
            const counterElement = document.querySelector('.mt-2.text-sm');
            if (counterElement && STATE.searchQuery && filteredLogs.length > 0) {
                counterElement.textContent = `${filteredLogs.length} rÃ©sultat(s) trouvÃ©(s)`;
            }
        }

        function clearSearch() {
            STATE.searchQuery = '';
            render();
        }

        function printSessionLog(sessionId) {
            const log = STATE.sessionLogs.find(l => l.sessionId === sessionId);
            if (!log) return;

            // SÃ©parer les actions par acteur (superviseur vs stagiaire)
            const supervisorActions = log.actions.filter(a => a.actor === 'supervisor');
            const traineeActions = log.actions.filter(a => a.actor === 'trainee' || !a.actor); // !a.actor pour rÃ©tro-compatibilitÃ©

            // Construire le HTML en deux colonnes
            const maxLength = Math.max(supervisorActions.length, traineeActions.length);
            let rowsHtml = '';

            for (let i = 0; i < maxLength; i++) {
                const supervisorAction = supervisorActions[i];
                const traineeAction = traineeActions[i];

                const supervisorCell = supervisorAction ?
                    '<div class="action-cell">' +
                    '<div class="timestamp">' + new Date(supervisorAction.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit', second:'2-digit'}) + '</div>' +
                    '<div class="action-content">' + supervisorAction.action + '</div>' +
                    (supervisorAction.details ? '<div class="details">' + supervisorAction.details + '</div>' : '') +
                    '</div>' : '<div class="action-cell empty"></div>';

                const traineeCell = traineeAction ?
                    '<div class="action-cell">' +
                    '<div class="timestamp">' + new Date(traineeAction.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit', second:'2-digit'}) + '</div>' +
                    '<div class="action-content">' + traineeAction.action + '</div>' +
                    (traineeAction.details ? '<div class="details">' + traineeAction.details + '</div>' : '') +
                    '</div>' : '<div class="action-cell empty"></div>';

                rowsHtml += '<tr>' +
                    '<td class="scenario-col">' + supervisorCell + '</td>' +
                    '<td class="trainee-col">' + traineeCell + '</td>' +
                    '</tr>';
            }

            // CrÃ©er une fenÃªtre d'impression avec le contenu formatÃ©
            const printWindow = window.open('', '', 'width=1000,height=800');
            const html = '<!DOCTYPE html>' +
                '<html><head>' +
                '<title>Journal Session ' + log.sessionNumber + '</title>' +
                '<style>' +
                'body { font-family: Arial, sans-serif; padding: 20px; font-size: 12px; }' +
                'h1 { color: #333; border-bottom: 2px solid #5D5CDE; padding-bottom: 10px; font-size: 18px; }' +
                'h2 { color: #444; font-size: 14px; margin-top: 20px; }' +
                '.meta { background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; }' +
                '.meta-item { margin: 5px 0; }' +
                'table { width: 100%; border-collapse: collapse; margin-top: 10px; }' +
                'th { background: #5D5CDE; color: white; padding: 10px; text-align: left; font-weight: bold; }' +
                'td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }' +
                '.scenario-col { background: #fff8e1; }' +
                '.trainee-col { background: #e3f2fd; }' +
                '.action-cell { min-height: 40px; }' +
                '.action-cell.empty { background: #fafafa; }' +
                '.timestamp { color: #666; font-size: 0.85em; font-weight: bold; margin-bottom: 3px; }' +
                '.action-content { color: #333; }' +
                '.details { color: #888; font-style: italic; margin-top: 3px; font-size: 0.9em; }' +
                '@media print { body { margin: 0; } button { display: none; } }' +
                '</style></head><body>' +
                '<h1>ðŸ“‹ Journal de Session SSI-SSIAP</h1>' +
                '<div class="meta">' +
                '<div class="meta-item"><strong>Session ' + log.sessionNumber + '</strong></div>' +
                '<div class="meta-item">ðŸ“… Date: ' + new Date(log.startTime).toLocaleDateString('fr-FR') + '</div>' +
                '<div class="meta-item">ðŸ• Heure: ' + new Date(log.startTime).toLocaleTimeString('fr-FR') + ' - ' + new Date(log.endTime).toLocaleTimeString('fr-FR') + '</div>' +
                '<div class="meta-item">ðŸ‘¤ Stagiaire: ' + (log.trainee || 'Inconnu') + '</div>' +
                '<div class="meta-item">ðŸ‘¨â€ðŸ« Superviseur: ' + (log.supervisor.prenom || 'Superviseur') + ' ' + (log.supervisor.nom || '') + '</div>' +
                '<div class="meta-item">ðŸ“Š Actions: ' + supervisorActions.length + ' (scÃ©nario) + ' + traineeActions.length + ' (stagiaire) = ' + log.actions.length + ' total</div>' +
                '</div>' +
                '<h2>Actions chronologiques</h2>' +
                '<table>' +
                '<thead>' +
                '<tr>' +
                '<th style="width: 50%;">ðŸŽ¬ SCÃ‰NARIO (Superviseur)</th>' +
                '<th style="width: 50%;">ðŸ‘¤ ACTIONS STAGIAIRE</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>' +
                rowsHtml +
                '</tbody>' +
                '</table>' +
                '<script>window.onload = function() { window.print(); };<\/script>' +
                '</body></html>';

            printWindow.document.write(html);
            printWindow.document.close();
        }

        function deleteSessionLog(sessionId) {
            showCustomConfirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce journal ?', () => {
                // Supprimer de Firebase
                db.ref(`session_logs/${sessionId}`).remove();

                // Supprimer du STATE local
                STATE.sessionLogs = STATE.sessionLogs.filter(l => l.sessionId !== sessionId);

                render();
                showCustomAlert('Journal supprimÃ©.');
            });
        }

        function updateDetectorAddressInput(type, id, address) {
            const detectorArray = type === 'DAI' ? STATE.sdi.detectors : STATE.sdi.manualAlarms;
            const detector = detectorArray.find(d => d.id === id);
            if (detector) {
                detector.address = address;
            }
            sendMessage('UPDATE_DETECTOR_ADDRESS', { type, id, address });
            render();
        }

        function changeSmsiState(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.smsi.systemState = state;
            sendMessage('SMSI_STATE_CHANGE', { state });
        }

        function changeSmsBattery(state) {
            if (!checkSessionBeforeAction()) return;
            STATE.smsi.batteryState = state;
            sendMessage('SMSI_BATTERY_CHANGE', { state });
        }

        function changeZoneState(zoneType, id, state) {
            if (!checkSessionBeforeAction()) return;
            const zones = zoneType === 'compartiment' ? STATE.smsi.compartmentZones : STATE.smsi.smokeZones;
            const zone = zones.find(z => z.id === id);
            setZoneState(zoneType, id, state);
            sendMessage('SET_ZONE_STATE', { zoneType, id, state });
            logAction(`Changement Ã©tat zone ${zone.address}`, state, 'supervisor');
            render();
        }

        function updateZoneAddressInput(zoneType, id, address) {
            updateZoneAddress(zoneType, id, address);
            sendMessage('UPDATE_ZONE_ADDRESS', { zoneType, id, address });
        }

        // Trainee Controls
        function traineeStopAlarmSound() {
            stopAlarmSound();
            render();
        }

        function toggleAccessLevel(type) {
            if (type === 'sdi') {
                if (STATE.accessLevel === 1) {
                    // Demander le code via le pavÃ© numÃ©rique
                    STATE.workflowStep = 'LEVEL2_CODE';
                    STATE.workflowData = { system: 'sdi' };
                    STATE.keypadInput = '';
                    addSdiMessage('Tapez le code niveau 2 et validez');
                    render();
                } else {
                    STATE.accessLevel = 1;
                    logAction('Retour niveau 1 SDI');
                    render();
                }
            } else {
                if (STATE.smsiAccessLevel === 1) {
                    // Demander le code via le pavÃ© numÃ©rique
                    STATE.workflowStep = 'LEVEL2_CODE';
                    STATE.workflowData = { system: 'smsi' };
                    STATE.keypadInput = '';
                    addSmsiMessage('Tapez le code niveau 2 et validez');
                    render();
                } else {
                    STATE.smsiAccessLevel = 1;
                    logAction('Retour niveau 1 SMSI');
                    render();
                }
            }
        }

        function traineeResetSdiSystem() {
            resetSdiSystem();
        }

        function traineeResetSmsiSystem() {
            resetSmsiSystem();
        }

        let forceAlarmTimeout;
        function startForceAlarm() {
            forceAlarmTimeout = setTimeout(() => {
                forceGeneralAlarm();
                render();
            }, 3000);
        }

        function cancelForceAlarm() {
            if (forceAlarmTimeout) {
                clearTimeout(forceAlarmTimeout);
                forceAlarmTimeout = null;
            }
        }

        function traineeAcquitProcess() {
            acquitProcess();
        }

        function commandZone(zoneType, id) {
            let zone;
            if (zoneType === 'compartment') {
                zone = STATE.smsi.compartmentZones.find(z => z.id === id);
                addSmsiMessage(`Commande fermeture ${zone.address}`);
                logAction(`Commande fermeture ${zone.address}`);
            } else {
                zone = STATE.smsi.smokeZones.find(z => z.id === id);
                addSmsiMessage(`Commande dÃ©marrage ${zone.address}`);
                logAction(`Commande dÃ©marrage ${zone.address}`);
            }
            zone.commandActive = true;
            render();

            // Le voyant reste allumÃ© jusqu'au rÃ©armement SMSI
        }

        function testSignalization() {
            logAction('Test de signalisation');
            sendMessage('TEST_SIGNALIZATION', { timestamp: Date.now() });

            // Sauvegarder les Ã©tats originaux
            const originalZones = STATE.smsi.compartmentZones.map(z => ({
                ledRed: {...z.ledRed},
                ledOrange: {...z.ledOrange},
                ledGreen: {...z.ledGreen}
            }));
            const originalSmokeZones = STATE.smsi.smokeZones.map(z => ({
                ledRed: {...z.ledRed},
                ledOrange: {...z.ledOrange},
                ledGreen: {...z.ledGreen}
            }));
            const originalRelays = STATE.smsi.relayBoxes.map(r => ({
                ledRed: {...r.ledRed},
                ledOrange: {...r.ledOrange},
                ledGreen: {...r.ledGreen}
            }));

            // Allumer tous les voyants (rouge, orange, vert pour tous)
            STATE.smsi.compartmentZones.forEach(z => {
                z.ledRed = { on: true, blink: false };
                z.ledOrange = { on: true, blink: false };
                z.ledGreen = { on: true, blink: false };
            });
            STATE.smsi.smokeZones.forEach(z => {
                z.ledRed = { on: true, blink: false };
                z.ledOrange = { on: true, blink: false };
                z.ledGreen = { on: true, blink: false };
            });
            STATE.smsi.relayBoxes.forEach(r => {
                r.ledRed = { on: true, blink: false };
                r.ledOrange = { on: true, blink: false };
                r.ledGreen = { on: true, blink: false };
            });

            render();

            // Restaurer les Ã©tats aprÃ¨s 2 secondes
            setTimeout(() => {
                STATE.smsi.compartmentZones.forEach((z, i) => {
                    z.ledRed = originalZones[i].ledRed;
                    z.ledOrange = originalZones[i].ledOrange;
                    z.ledGreen = originalZones[i].ledGreen;
                });
                STATE.smsi.smokeZones.forEach((z, i) => {
                    z.ledRed = originalSmokeZones[i].ledRed;
                    z.ledOrange = originalSmokeZones[i].ledOrange;
                    z.ledGreen = originalSmokeZones[i].ledGreen;
                });
                STATE.smsi.relayBoxes.forEach((r, i) => {
                    r.ledRed = originalRelays[i].ledRed;
                    r.ledOrange = originalRelays[i].ledOrange;
                    r.ledGreen = originalRelays[i].ledGreen;
                });
                render();
            }, 2000);
        }

        function bilanSystem() {
            logAction('Demande bilan systÃ¨me');

            // VÃ©rifier s'il y a des dÃ©fauts (voyants orange ou rouge allumÃ©s)
            let hasDefect = false;

            // VÃ©rifier les zones de compartimentage
            STATE.smsi.compartmentZones.forEach(z => {
                if (z.ledOrange.on || z.ledRed.on) hasDefect = true;
            });

            // VÃ©rifier les zones de dÃ©senfumage
            STATE.smsi.smokeZones.forEach(z => {
                if (z.ledOrange.on || z.ledRed.on) hasDefect = true;
            });

            // VÃ©rifier les coffrets de relayage
            STATE.smsi.relayBoxes.forEach(r => {
                if (r.ledOrange.on || r.ledRed.on) hasDefect = true;
            });

            // Allumer les voyants verts SAUF pour le matÃ©riel en dÃ©faut ou hors service
            STATE.smsi.compartmentZones.forEach(z => {
                // Voyant vert si pas de dÃ©faut (pas de rouge/orange)
                if (!z.ledOrange.on && !z.ledRed.on) {
                    z.ledGreen.on = true;
                }
            });
            STATE.smsi.smokeZones.forEach(z => {
                // Voyant vert si pas de dÃ©faut (pas de rouge/orange)
                if (!z.ledOrange.on && !z.ledRed.on) {
                    z.ledGreen.on = true;
                }
            });
            STATE.smsi.relayBoxes.forEach(r => {
                // Voyant vert si pas de dÃ©faut (pas de rouge/orange)
                if (!r.ledOrange.on && !r.ledRed.on) {
                    r.ledGreen.on = true;
                }
            });

            if (!hasDefect) {
                addSmsiMessage('BILAN: Aucun dÃ©faut - SystÃ¨me opÃ©rationnel');
            } else {
                addSmsiMessage('BILAN: DÃ©fauts dÃ©tectÃ©s (voyants rouge/orange)');
            }

            render();

            // Ã‰teindre les voyants verts aprÃ¨s 3 secondes
            setTimeout(() => {
                STATE.smsi.compartmentZones.forEach(z => z.ledGreen.on = false);
                STATE.smsi.smokeZones.forEach(z => z.ledGreen.on = false);
                STATE.smsi.relayBoxes.forEach(r => r.ledGreen.on = false);
                render();
            }, 3000);
        }

        function commandRelay(id) {
            const relay = STATE.smsi.relayBoxes.find(r => r.id === id);
            addSmsiMessage(`Commande coffret ${relay.address}`);
            logAction(`Commande coffret ${relay.address}`);
            relay.commandActive = true;
            render();

            // Le voyant reste allumÃ© jusqu'au rÃ©armement SMSI
        }

        function stopRelay(id) {
            const relay = STATE.smsi.relayBoxes.find(r => r.id === id);
            relay.stopped = !relay.stopped;
            addSmsiMessage(`Coffret ${id} ${relay.stopped ? 'arrÃªtÃ©' : 'redÃ©marrÃ©'}`);
            logAction(`${relay.stopped ? 'ArrÃªt' : 'RedÃ©marrage'} pompier coffret ${id}`);
            render();
        }

        // Initialize
        render();
    </script>
</body>
</html>

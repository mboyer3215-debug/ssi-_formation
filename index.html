<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Formation SSI - SSIAP</title><!-- PWA Meta Tags --><meta name="description" content="Application de formation SSIAP - Syst√®me de S√©curit√© Incendie"><meta name="theme-color" content="#5D5CDE"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="SSI Formation"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="SSI Formation"><meta name="msapplication-TileColor" content="#5D5CDE"><meta name="msapplication-config" content="browserconfig.xml"><!-- PWA Manifest --><link rel="manifest" href="manifest.json"><!-- Ic√¥nes --><link rel="icon" type="image/svg+xml" href="icons/favicon.svg"><link rel="apple-touch-icon" href="icons/apple-touch-icon.svg"><link rel="icon" sizes="192x192" href="icons/icon-192x192.svg"><link rel="icon" sizes="512x512" href="icons/icon-512x512.svg"><!-- Splash Screen iOS --><meta name="apple-mobile-web-app-capable" content="yes"><link rel="apple-touch-startup-image" href="icons/icon-512x512.svg"><script src="https://cdn.tailwindcss.com"></script><!-- Firebase SDK via unpkg (autoris√© par CSP) --><script src="https://unpkg.com/firebase@10.7.1/firebase-app-compat.js"></script><script src="https://unpkg.com/firebase@10.7.1/firebase-database-compat.js"></script><script>tailwind.config={darkMode:'class',theme:{extend:{colors:{primary:'#5D5CDE',}}}}</script><style>@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}.blink{animation:blink 1s infinite}.led-light{width:16px;height:16px;border-radius:50%;border:2px solid #333;display:inline-block;box-shadow:inset 0 0 5px rgba(0,0,0,0.5)}.led-green{background-color:#00ff00;box-shadow:0 0 10px #00ff00}.led-orange{background-color:#ff8800;box-shadow:0 0 10px #ff8800}.led-red{background-color:#ff0000;box-shadow:0 0 10px #ff0000}.led-off{background-color:#333;box-shadow:none}.ssi-panel{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);border:3px solid #7f8c8d;border-radius:8px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,0.3)}.ssi-button{padding:10px 20px;border:2px solid #333;border-radius:5px;cursor:pointer;font-weight:bold;transition:all 0.2s;text-align:center}.ssi-button:active{transform:scale(0.95)}.ssi-button-red{background-color:#c0392b;color:white}.ssi-button-green{background-color:#27ae60;color:white}.ssi-button-yellow{background-color:#f39c12;color:white}.ssi-screen{background-color:#000;color:#00ff00;font-family:monospace;padding:15px;border-radius:5px;min-height:100px;border:2px solid #333}.key-switch{width:35px;height:35px;border-radius:50%;border:3px solid #95a5a6;background:linear-gradient(135deg,#bdc3c7 0%,#ecf0f1 100%);cursor:pointer;transition:transform 0.3s;display:flex;align-items:center;justify-content:center;font-size:16px}.key-switch.active{transform:rotate(90deg);background:linear-gradient(135deg,#3498db 0%,#2980b9 100%)}.command-led{width:12px;height:12px;border-radius:50%;background-color:#333;border:1px solid #666}.command-led.active{background-color:#ff0000;box-shadow:0 0 8px #ff0000}</style></head><body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen"><div id="app"></div><script>
document.addEventListener('contextmenu',function(e){e.preventDefault();});
document.addEventListener('keydown',function(e){if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&e.key==='I')||(e.ctrlKey&&e.key==='u')){e.preventDefault();}});

const SECURITY={
supervisorPasswordHash:'7a2e50e22ecbe855cbdfa41cdc1d5a82da059d8b267060e82780eb3be5a30e84',
accessCodeHash:'03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4',
loginAttempts:0,maxLoginAttempts:5,lockoutDuration:5*60*1000,lockedUntil:null,
async hashPassword(password){const encoder=new TextEncoder();const data=encoder.encode(password);const hashBuffer=await crypto.subtle.digest('SHA-256',data);const hashArray=Array.from(new Uint8Array(hashBuffer));return hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');},
isLocked(){if(!this.lockedUntil)return false;if(Date.now()>this.lockedUntil){this.lockedUntil=null;this.loginAttempts=0;return false;}return true;},
recordFailedAttempt(){this.loginAttempts++;if(this.loginAttempts>=this.maxLoginAttempts){this.lockedUntil=Date.now()+this.lockoutDuration;return true;}return false;},
resetAttempts(){this.loginAttempts=0;this.lockedUntil=null;},
getRemainingLockTime(){if(!this.lockedUntil)return 0;return Math.ceil((this.lockedUntil-Date.now())/1000);}
};

if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches){document.documentElement.classList.add('dark');}
window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',event=>{if(event.matches){document.documentElement.classList.add('dark');}else{document.documentElement.classList.remove('dark');}});

const firebaseConfig={apiKey:"AIzaSyAV4UZ_j2M017lZoFdcbyuxe1oV7VxjWLs",authDomain:"ssi-ssiap-training.firebaseapp.com",databaseURL:"https://ssi-ssiap-training-default-rtdb.firebaseio.com",projectId:"ssi-ssiap-training",storageBucket:"ssi-ssiap-training.firebasestorage.app",messagingSenderId:"1024486187072",appId:"1:1024486187072:web:4e452ab8549cac24d3ffa5"};

let db=null;
let firebaseInitialized=false;
// FIX: Track Firebase listeners for cleanup
let activeFirebaseListeners=[];

window.addEventListener('load',()=>{
try{
if(typeof firebase!=='undefined'){firebase.initializeApp(firebaseConfig);db=firebase.database();firebaseInitialized=true;console.log('‚úì Firebase initialized successfully');loadTraineesFromFirebase();loadSessionLogsFromFirebase();}
else{console.error('‚úó Firebase library not loaded');}
}catch(error){console.error('‚úó Firebase initialization error:',error);}
});

const STATE={currentView:'home',currentUser:null,userType:null,trainees:[],currentSession:null,sessionActive:false,sessionId:null,accessLevel:1,smsiAccessLevel:1,
sdi:{systemState:'service',batteryState:'service',powerState:'secteur',alarms:[],
detectors:Array(9).fill().map((_,i)=>({id:i+1,type:'DAI',zone:`ZC${Math.floor(i/3)+1}`,address:`DAI ${Math.floor(i/3)+1}-${(i%3)+1}`,state:'service',triggered:false,outOfService:false})),
manualAlarms:Array(9).fill().map((_,i)=>({id:i+1,type:'DM',zone:`ZC${Math.floor(i/3)+1}`,address:`DM ${Math.floor(i/3)+1}-${(i%3)+1}`,state:'service',triggered:false,outOfService:false})),
alarmSound:false,fireAlarmActive:false},
smsi:{systemState:'service',batteryState:'service',powerState:'secteur',alarmSound:false,messages:[],
compartmentZones:Array(3).fill().map((_,i)=>({id:i+1,zone:`ZC${i+1}`,address:`Compartiment Zone ${i+1}`,state:'attente',ledRed:{on:false,blink:false},ledOrange:{on:false,blink:false},ledGreen:{on:false,blink:false},commandActive:false})),
smokeZones:Array(3).fill().map((_,i)=>({id:i+1,zone:`ZF${i+1}`,address:`D√©senfumage Zone ${i+1}`,state:'attente',ledRed:{on:false,blink:false},ledOrange:{on:false,blink:false},ledGreen:{on:false,blink:false},commandActive:false})),
relayBoxes:Array(3).fill().map((_,i)=>({id:i+1,address:`Coffret ${i+1}`,state:'attente',ledRed:{on:false,blink:false},ledOrange:{on:false,blink:false},ledGreen:{on:false,blink:false},commandActive:false,stopped:false}))},
uga:{alarmType:'generale',temporization:0,temporizationActive:false,temporizationRemaining:0,alarmActive:false},
actionLog:[],sessionLogs:[],searchQuery:'',outOfService:[],keypadInput:'',workflowStep:null,workflowData:{},
videoEnabled:false,audioEnabled:false,localStream:null,remoteStream:null,peerConnection:null,
mediaRecorder:null,recordedChunks:[],isRecording:false,recordingStartTime:null,
audioVolume:0.5,audioMuted:true,supervisorMicActive:false,
// FIX: Store session start time
sessionStartTime:null,
// FIX: Track edit state
editingTrainee:null
};

// FIX: Proper cleanup of Firebase listeners
function cleanupFirebaseListeners(){
activeFirebaseListeners.forEach(ref=>{
try{ref.off();}catch(e){console.log('Listener cleanup:',e);}
});
activeFirebaseListeners=[];
}

// FIX: Full session cleanup for trainee logout
function cleanupSession(){
cleanupFirebaseListeners();
stopVideo();
stopAlarmSound();
stopGeneralAlarm();
STATE.sessionActive=false;
STATE.sessionId=null;
STATE.sessionNumber=null;
STATE.currentSessionNumber=null;
STATE.sessionStartTime=null;
STATE.actionLog=[];
STATE.currentUser=null;
STATE.userType=null;
STATE.accessLevel=1;
STATE.smsiAccessLevel=1;
STATE.keypadInput='';
STATE.workflowStep=null;
STATE.workflowData={};
resetSdiToIdle();
resetSmsiToIdle();
}

function sendMessage(type,data){if(!firebaseInitialized||!STATE.sessionId)return;const messageRef=db.ref(`sessions/${STATE.sessionId}/messages`).push();messageRef.set({type,data,sender:STATE.userType,timestamp:firebase.database.ServerValue.TIMESTAMP});}

function listenToSession(sessionId){
if(!firebaseInitialized)return;

// FIX: Clean previous listeners before setting up new ones
cleanupFirebaseListeners();

const messagesRef=db.ref(`sessions/${sessionId}/messages`);
messagesRef.on('child_added',(snapshot)=>{
const message=snapshot.val();
if(message.sender===STATE.userType)return;
if(STATE.userType==='trainee'){handleSupervisorCommand(message.type,message.data);}
else if(STATE.userType==='supervisor'){handleTraineeAction(message.type,message.data);}
});
activeFirebaseListeners.push(messagesRef);

if(STATE.userType==='trainee'){
const sessionRef=db.ref(`sessions/${sessionId}`);
sessionRef.on('value',(snapshot)=>{
const sessionData=snapshot.val();
if(sessionData){
const wasActive=STATE.sessionActive;
STATE.sessionActive=sessionData.active;
STATE.sessionNumber=sessionData.sessionNumber;
// FIX: When session is closed by supervisor, fully clean up trainee side
if(wasActive&&!sessionData.active){
stopVideo();
stopAlarmSound();
stopGeneralAlarm();
STATE.actionLog=[];
STATE.sessionId=null;
STATE.sessionNumber=null;
STATE.accessLevel=1;
STATE.smsiAccessLevel=1;
resetSdiToIdle();
resetSmsiToIdle();
showCustomAlert('La session a √©t√© ferm√©e par le superviseur.');
render();
watchForNewSession();
}else{
render();
}
}
});
activeFirebaseListeners.push(sessionRef);
}
}

function watchForNewSession(){
if(!firebaseInitialized||STATE.userType!=='trainee')return;
const activeSessionRef=db.ref('active_session');
activeSessionRef.on('value',(snapshot)=>{
const newSessionId=snapshot.val();
if(newSessionId&&newSessionId!==STATE.sessionId){
STATE.sessionId=newSessionId;
STATE.sessionActive=true;
STATE.actionLog=[];
resetSdiToIdle();
resetSmsiToIdle();
if(STATE.currentUser){
db.ref(`sessions/${newSessionId}/trainees/${STATE.currentUser.id}`).set({prenom:STATE.currentUser.prenom,nom:STATE.currentUser.nom,niveau:STATE.currentUser.niveau});
}
listenToSession(newSessionId);
showCustomAlert('Vous avez √©t√© connect√© √† une nouvelle session!');
render();
// FIX: Only start video after a delay and with user confirmation
setTimeout(()=>{startVideo();},1000);
}
});
activeFirebaseListeners.push(activeSessionRef);
}

function createSession(){
if(!firebaseInitialized){showCustomAlert('Erreur: Firebase non disponible');return;}
const now=new Date();
const year=now.getFullYear();const month=String(now.getMonth()+1).padStart(2,'0');const day=String(now.getDate()).padStart(2,'0');
const hours=String(now.getHours()).padStart(2,'0');const minutes=String(now.getMinutes()).padStart(2,'0');const seconds=String(now.getSeconds()).padStart(2,'0');
const sessionNumber=`${year}${month}${day}${hours}${minutes}${seconds}`;
const sessionId=Date.now().toString();
// FIX: Store actual start time
const startTimeISO=now.toISOString();
const sessionData={id:sessionId,sessionNumber:sessionNumber,startTime:firebase.database.ServerValue.TIMESTAMP,startTimeISO:startTimeISO,endTime:null,active:true,supervisor:STATE.currentUser||'Superviseur',trainees:{}};
db.ref(`active_session`).set(sessionId);
db.ref(`sessions/${sessionId}`).set(sessionData);
STATE.sessionActive=true;
STATE.sessionId=sessionId;
STATE.currentSessionNumber=sessionNumber;
STATE.sessionStartTime=startTimeISO;
STATE.actionLog=[];
resetSdiToIdle();
resetSmsiToIdle();
listenToSession(sessionId);
render();
setTimeout(()=>{supervisorConnectToVideo();},2000);
showCustomAlert(`Session ${sessionNumber} d√©marr√©e avec succ√®s!`);
}

function endSession(){
if(!STATE.sessionActive||!STATE.sessionId)return;
showCustomConfirm('√ätes-vous s√ªr de vouloir terminer la session?',()=>{
const sessionNumber=STATE.currentSessionNumber;
const sessionId=STATE.sessionId;
const endTimeISO=new Date().toISOString();

// FIX: Get session data including start time from Firebase
db.ref(`sessions/${sessionId}`).once('value',(sessionSnapshot)=>{
const sessionData=sessionSnapshot.val();
const startTimeISO=sessionData?.startTimeISO||STATE.sessionStartTime||new Date().toISOString();

db.ref(`sessions/${sessionId}/trainees`).once('value',(traineesSnapshot)=>{
const traineesData=traineesSnapshot.val();
let traineeName='Inconnu';
if(traineesData){
const traineeIds=Object.keys(traineesData);
if(traineeIds.length>0){const firstTrainee=traineesData[traineeIds[0]];traineeName=`${firstTrainee.prenom||''} ${firstTrainee.nom||''}`.trim();}
}

// FIX: Always save session log, even with 0 actions (for record keeping)
const sessionLog={
sessionId:sessionId,
sessionNumber:sessionNumber,
startTime:startTimeISO,
endTime:endTimeISO,
supervisor:STATE.currentUser||'Superviseur',
trainee:traineeName,
actions:[...STATE.actionLog]
};
STATE.sessionLogs.push(sessionLog);
db.ref(`session_logs/${sessionId}`).set(sessionLog);

db.ref(`sessions/${sessionId}`).update({endTime:firebase.database.ServerValue.TIMESTAMP,endTimeISO:endTimeISO,active:false});
db.ref(`active_session`).remove();
STATE.sessionActive=false;
STATE.sessionId=null;
STATE.currentSessionNumber=null;
STATE.sessionStartTime=null;
STATE.actionLog=[];
resetSdiToIdle();
resetSmsiToIdle();
disconnectVideo();
render();
showCustomAlert(`Session ${sessionNumber} termin√©e. Journal sauvegard√© (${sessionLog.actions.length} actions).`);
});
});
});
}

function joinActiveSession(){
if(!firebaseInitialized)return;
db.ref('active_session').once('value',(snapshot)=>{
const sessionId=snapshot.val();
if(sessionId){
// FIX: Verify the session is actually active before joining
db.ref(`sessions/${sessionId}`).once('value',(sessionSnapshot)=>{
const sessionData=sessionSnapshot.val();
if(sessionData&&sessionData.active===true){
STATE.sessionId=sessionId;
STATE.sessionActive=true;
STATE.sessionNumber=sessionData.sessionNumber;
STATE.actionLog=[];
if(STATE.currentUser){
db.ref(`sessions/${sessionId}/trainees/${STATE.currentUser.id}`).set({nom:STATE.currentUser.nom,prenom:STATE.currentUser.prenom,niveau:STATE.currentUser.niveau,joinedAt:firebase.database.ServerValue.TIMESTAMP});
}
listenToSession(sessionId);
render();
// FIX: Start video with small delay
setTimeout(()=>{startVideo();},1000);
}else{
// Session exists but is not active - clean up and wait
db.ref('active_session').remove();
STATE.sessionActive=false;
STATE.sessionId=null;
STATE.sessionNumber=null;
watchForNewSession();
render();
showCustomAlert('En attente d\'une session. Vous serez automatiquement connect√© d√®s que le superviseur ouvrira une session.');
}
});
}else{
STATE.sessionActive=false;
STATE.sessionId=null;
STATE.sessionNumber=null;
watchForNewSession();
render();
showCustomAlert('En attente d\'une session. Vous serez automatiquement connect√© d√®s que le superviseur ouvrira une session.');
}
});
}

function checkSessionBeforeAction(){
if(STATE.userType==='supervisor'&&!STATE.sessionActive){
showCustomConfirm('Aucune session active. Voulez-vous d√©marrer une session maintenant?',()=>{createSession();});
return false;
}
return true;
}

const iceServers={iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]};

async function startVideo(){
try{
// FIX: Check if session is active before starting video
if(!STATE.sessionActive||!STATE.sessionId){
console.log('Pas de session active, vid√©o non d√©marr√©e');
return;
}
STATE.localStream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480},audio:true});
STATE.videoEnabled=true;
STATE.audioEnabled=true;
render();
await setupPeerConnection();
showCustomAlert('Cam√©ra et micro activ√©s');
}catch(error){
console.error('Erreur acc√®s cam√©ra/micro:',error);
// FIX: More specific error messages
let msg='Impossible d\'acc√©der √† la cam√©ra ou au micro.';
if(error.name==='NotAllowedError'){msg+=' Autorisez l\'acc√®s dans les param√®tres de votre navigateur.';}
else if(error.name==='NotFoundError'){msg+=' Aucune cam√©ra/micro d√©tect√©.';}
else if(error.name==='NotReadableError'){msg+=' La cam√©ra est peut-√™tre utilis√©e par une autre application.';}
else{msg+=' V√©rifiez les permissions.';}
showCustomAlert(msg);
// FIX: Continue without video - don't block the session
STATE.videoEnabled=false;
STATE.audioEnabled=false;
}
}

function stopVideo(){
if(STATE.localStream){STATE.localStream.getTracks().forEach(track=>track.stop());STATE.localStream=null;}
if(STATE.peerConnection){STATE.peerConnection.close();STATE.peerConnection=null;}
STATE.videoEnabled=false;
STATE.audioEnabled=false;
if(STATE.sessionId&&firebaseInitialized){
try{db.ref(`sessions/${STATE.sessionId}/video/trainee_stream_active`).set(false);}catch(e){}
}
}

function toggleVideo(){if(STATE.videoEnabled&&STATE.localStream){const videoTrack=STATE.localStream.getVideoTracks()[0];if(videoTrack){videoTrack.enabled=!videoTrack.enabled;STATE.videoEnabled=videoTrack.enabled;render();}}}
function toggleAudio(){if(STATE.audioEnabled&&STATE.localStream){const audioTrack=STATE.localStream.getAudioTracks()[0];if(audioTrack){audioTrack.enabled=!audioTrack.enabled;STATE.audioEnabled=audioTrack.enabled;render();}}}

async function setupPeerConnection(){
if(!STATE.sessionId)return;
STATE.peerConnection=new RTCPeerConnection(iceServers);
STATE.localStream.getTracks().forEach(track=>{STATE.peerConnection.addTrack(track,STATE.localStream);});
STATE.peerConnection.onicecandidate=(event)=>{if(event.candidate){db.ref(`sessions/${STATE.sessionId}/video/trainee_ice_candidates`).push(event.candidate.toJSON());}};
STATE.peerConnection.ontrack=(event)=>{STATE.remoteStream=event.streams[0];const remoteVideo=document.getElementById('remote-video');if(remoteVideo){remoteVideo.srcObject=STATE.remoteStream;}};
if(STATE.userType==='trainee'){
const offer=await STATE.peerConnection.createOffer();
await STATE.peerConnection.setLocalDescription(offer);
db.ref(`sessions/${STATE.sessionId}/video/offer`).set({type:offer.type,sdp:offer.sdp});
db.ref(`sessions/${STATE.sessionId}/video/trainee_stream_active`).set(true);
const answerRef=db.ref(`sessions/${STATE.sessionId}/video/answer`);
answerRef.on('value',async(snapshot)=>{const answer=snapshot.val();if(answer&&STATE.peerConnection&&!STATE.peerConnection.currentRemoteDescription){await STATE.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));}});
activeFirebaseListeners.push(answerRef);
const supIceRef=db.ref(`sessions/${STATE.sessionId}/video/supervisor_ice_candidates`);
supIceRef.on('child_added',async(snapshot)=>{const candidate=snapshot.val();if(candidate&&STATE.peerConnection){await STATE.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));}});
activeFirebaseListeners.push(supIceRef);
}
}

async function supervisorConnectToVideo(){
if(!STATE.sessionId)return;
if(STATE.peerConnection){STATE.peerConnection.close();}
STATE.peerConnection=new RTCPeerConnection(iceServers);
STATE.peerConnection.onicecandidate=(event)=>{if(event.candidate){db.ref(`sessions/${STATE.sessionId}/video/supervisor_ice_candidates`).push(event.candidate.toJSON());}};
STATE.peerConnection.ontrack=(event)=>{STATE.remoteStream=event.streams[0];render();};
db.ref(`sessions/${STATE.sessionId}/video/offer`).once('value',async(snapshot)=>{
const offer=snapshot.val();
if(offer&&STATE.peerConnection){
await STATE.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
const answer=await STATE.peerConnection.createAnswer();
await STATE.peerConnection.setLocalDescription(answer);
db.ref(`sessions/${STATE.sessionId}/video/answer`).set({type:answer.type,sdp:answer.sdp});
const traineeIceRef=db.ref(`sessions/${STATE.sessionId}/video/trainee_ice_candidates`);
traineeIceRef.on('child_added',async(snapshot)=>{const candidate=snapshot.val();if(candidate&&STATE.peerConnection){await STATE.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));}});
activeFirebaseListeners.push(traineeIceRef);
}
});
}

function disconnectVideo(){
if(STATE.peerConnection){STATE.peerConnection.close();STATE.peerConnection=null;}
STATE.remoteStream=null;
const remoteVideo=document.getElementById('trainee-video');
if(remoteVideo){remoteVideo.srcObject=null;}
render();
}

function startRecording(){
if(!STATE.remoteStream){showCustomAlert('Aucun flux vid√©o disponible pour enregistrer');return;}
try{
STATE.recordedChunks=[];
STATE.mediaRecorder=new MediaRecorder(STATE.remoteStream,{mimeType:'video/webm;codecs=vp9'});
STATE.mediaRecorder.ondataavailable=(event)=>{if(event.data&&event.data.size>0){STATE.recordedChunks.push(event.data);}};
STATE.mediaRecorder.onstop=()=>{const blob=new Blob(STATE.recordedChunks,{type:'video/webm'});const url=URL.createObjectURL(blob);const sessionNumber=STATE.currentSessionNumber||'session';const timestamp=new Date().toISOString().replace(/[:.]/g,'-');const filename=`debriefing_${sessionNumber}_${timestamp}.webm`;const a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);showCustomAlert('Enregistrement t√©l√©charg√©: '+filename);};
STATE.mediaRecorder.start(1000);
STATE.isRecording=true;STATE.recordingStartTime=Date.now();
STATE.recordingInterval=setInterval(()=>{if(STATE.isRecording){render();}},1000);
render();showCustomAlert('üìπ Enregistrement d√©marr√©');
}catch(error){console.error('Erreur enregistrement:',error);showCustomAlert('Erreur lors du d√©marrage de l\'enregistrement');}
}

function stopRecording(){
if(STATE.mediaRecorder&&STATE.isRecording){
STATE.mediaRecorder.stop();STATE.isRecording=false;STATE.recordingStartTime=null;
if(STATE.recordingInterval){clearInterval(STATE.recordingInterval);STATE.recordingInterval=null;}
render();showCustomAlert('‚èπÔ∏è Enregistrement arr√™t√©. T√©l√©chargement en cours...');
}
}

function getRecordingDuration(){if(!STATE.isRecording||!STATE.recordingStartTime)return '00:00';const elapsed=Math.floor((Date.now()-STATE.recordingStartTime)/1000);const minutes=Math.floor(elapsed/60);const seconds=elapsed%60;return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;}
function toggleAudioMute(){STATE.audioMuted=!STATE.audioMuted;const remoteVideo=document.getElementById('trainee-video');if(remoteVideo){remoteVideo.muted=STATE.audioMuted;if(!STATE.audioMuted){remoteVideo.volume=STATE.audioVolume;}}render();}
function setAudioVolume(volume){STATE.audioVolume=parseFloat(volume);const remoteVideo=document.getElementById('trainee-video');if(remoteVideo&&!STATE.audioMuted){remoteVideo.volume=STATE.audioVolume;}}
function toggleSupervisorMic(){STATE.supervisorMicActive=!STATE.supervisorMicActive;render();}

window.addEventListener('beforeunload',(e)=>{
if(STATE.userType==='supervisor'&&STATE.sessionActive){e.preventDefault();e.returnValue='Attention: La session est toujours active.';return e.returnValue;}
});

function logAction(action,details='',actor=null){
const actorType=actor||STATE.userType||'supervisor';
const log={timestamp:new Date().toISOString(),trainee:STATE.currentUser?.prenom+' '+STATE.currentUser?.nom,action,details,actor:actorType};
STATE.actionLog.push(log);
if(STATE.userType==='trainee'){sendMessage('ACTION_LOG',log);}
}

function addSmsiMessage(message){STATE.smsi.messages.push({text:message,timestamp:new Date().toISOString()});setTimeout(()=>{const screen=document.getElementById('smsi-screen');if(screen){screen.scrollTop=screen.scrollHeight;}},50);}
function addSdiMessage(message){STATE.sdi.alarms.push({text:message,timestamp:new Date().toISOString()});setTimeout(()=>{const screen=document.getElementById('sdi-screen');if(screen){screen.scrollTop=screen.scrollHeight;}},50);}

function handleSupervisorCommand(type,data){
switch(type){
case 'SDI_STATE_CHANGE':STATE.sdi.systemState=data.state;break;
case 'SDI_BATTERY_CHANGE':STATE.sdi.batteryState=data.state;break;
case 'SDI_POWER_CHANGE':STATE.sdi.powerState=data.state;break;
case 'TRIGGER_DETECTOR':triggerDetector(data.type,data.id,true);break;
case 'RESET_DETECTOR':resetDetector(data.type,data.id);break;
case 'UPDATE_DETECTOR_ADDRESS':updateDetectorAddress(data.type,data.id,data.address);break;
case 'SET_TEMPORIZATION':STATE.uga.temporization=data.minutes;break;
case 'SET_ALARM_TYPE':STATE.uga.alarmType=data.alarmType;break;
case 'SMSI_STATE_CHANGE':STATE.smsi.systemState=data.state;break;
case 'SMSI_BATTERY_CHANGE':STATE.smsi.batteryState=data.state;break;
case 'SMSI_POWER_CHANGE':STATE.smsi.powerState=data.state;break;
case 'SET_ZONE_STATE':setZoneState(data.zoneType,data.id,data.state);break;
case 'UPDATE_ZONE_ADDRESS':updateZoneAddress(data.zoneType,data.id,data.address);break;
case 'DETECTOR_OUT_OF_SERVICE':
{const detArray=data.type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const det=detArray.find(d=>d.id===data.id);if(det){det.outOfService=data.outOfService;}}break;
case 'CHANGE_DETECTOR_STATE':
{const detectorArr=data.type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const detector=detectorArr.find(d=>d.id===data.id);if(detector){detector.state=data.state;}}break;
case 'TEST_SIGNALIZATION':testSignalization();break;
}
render();
}

function handleTraineeAction(type,data){
switch(type){
case 'ACTION_LOG':STATE.actionLog.push(data);break;
case 'DETECTOR_OUT_OF_SERVICE':
{const detArray=data.type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const det=detArray.find(d=>d.id===data.id);if(det){det.outOfService=data.outOfService;}}break;
case 'CHANGE_DETECTOR_STATE':
{const detectorArr=data.type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const detector=detectorArr.find(d=>d.id===data.id);if(detector){detector.state=data.state;}}break;
}
render();
}

function updateDetectorAddress(type,id,address){const detectorArray=type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const detector=detectorArray.find(d=>d.id===id);if(detector){detector.address=address;}}
function updateZoneAddress(zoneType,id,address){let zone;if(zoneType==='compartment'){zone=STATE.smsi.compartmentZones.find(z=>z.id===id);}else if(zoneType==='smoke'){zone=STATE.smsi.smokeZones.find(z=>z.id===id);}else if(zoneType==='relay'){zone=STATE.smsi.relayBoxes.find(z=>z.id===id);}if(zone){zone.address=address;}}

function triggerDetector(type,id,playSound=false){
const detectorArray=type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;
const detector=detectorArray.find(d=>d.id===id);
if(detector){
if(detector.outOfService||detector.state==='hors-service'){addSdiMessage(`${detector.address} hors service - alarme ignor√©e`);return;}
detector.triggered=true;STATE.sdi.fireAlarmActive=true;STATE.sdi.alarmSound=true;
const alarm=`Alarme feu ${detector.address}`;
STATE.sdi.alarms.push({text:alarm,timestamp:new Date().toISOString()});
addSmsiMessage(`Alarme d√©tect√©e: ${detector.address}`);
if(!STATE.uga.alarmActive){
if(STATE.uga.temporization>0&&!STATE.uga.temporizationActive){STATE.uga.temporizationActive=true;STATE.uga.temporizationRemaining=STATE.uga.temporization*60;startTemporization();}
else if(STATE.uga.temporization===0){triggerGeneralAlarm();}
}
if(playSound){playAlarmSound();}
updateAllLeds();
}
}

function resetDetector(type,id){const detectorArray=type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const detector=detectorArray.find(d=>d.id===id);if(detector){detector.triggered=false;}}

function setZoneState(zoneType,id,state){
let zone;
if(zoneType==='compartment'){zone=STATE.smsi.compartmentZones.find(z=>z.id===id);if(zone){zone.state=state;updateZoneLeds(zone);addSmsiMessage(`${zone.address}: ${state}`);}}
else if(zoneType==='smoke'){zone=STATE.smsi.smokeZones.find(z=>z.id===id);if(zone){zone.state=state;updateZoneLeds(zone);addSmsiMessage(`${zone.address}: ${state}`);}}
else if(zoneType==='relay'){zone=STATE.smsi.relayBoxes.find(z=>z.id===id);if(zone){zone.state=state;updateRelayLeds(zone);addSmsiMessage(`${zone.address}: ${state}`);}}
}

function updateZoneLeds(zone){
zone.ledRed={on:false,blink:false};zone.ledOrange={on:false,blink:false};zone.ledGreen={on:false,blink:false};
if(STATE.sdi.fireAlarmActive){
if(zone.state==='securite'){zone.ledRed={on:true,blink:false};}else if(zone.state==='defaut-securite'){zone.ledRed={on:true,blink:true};}
}else{
switch(zone.state){case 'attente':break;case 'defaut-alim':zone.ledOrange={on:true,blink:true};break;case 'defaut-attente':zone.ledOrange={on:true,blink:false};break;case 'securite':zone.ledGreen={on:true,blink:false};break;case 'defaut-securite':zone.ledRed={on:true,blink:false};break;}
}
}

function updateRelayLeds(relay){
relay.ledRed={on:false,blink:false};relay.ledOrange={on:false,blink:false};relay.ledGreen={on:false,blink:false};
if(STATE.sdi.fireAlarmActive){
if(relay.state==='securite'){relay.ledRed={on:true,blink:false};}else if(relay.state==='defaut-securite'){relay.ledRed={on:true,blink:true};}
}else{
switch(relay.state){case 'attente':break;case 'defaut-alim':relay.ledOrange={on:true,blink:true};break;case 'defaut-attente':relay.ledOrange={on:true,blink:false};break;case 'securite':relay.ledGreen={on:true,blink:false};break;case 'defaut-securite':relay.ledRed={on:true,blink:false};break;}
}
}

function updateAllLeds(){
[...STATE.smsi.compartmentZones,...STATE.smsi.smokeZones].forEach(zone=>{updateZoneLeds(zone);});
STATE.smsi.relayBoxes.forEach(relay=>{updateRelayLeds(relay);});
}

// FIX: Complete alarm sound system using Web Audio API (no external URLs needed)
let audioContext;
let alarmOscillator;
let generalAlarmAudio;
let generalAlarmTimer;
let generalAlarmOscillators=[];

function initAudio(){if(!audioContext){audioContext=new(window.AudioContext||window.webkitAudioContext)();}}

function playAlarmSound(){
initAudio();
if(alarmOscillator)return;
alarmOscillator=audioContext.createOscillator();
const gainNode=audioContext.createGain();
alarmOscillator.connect(gainNode);
gainNode.connect(audioContext.destination);
alarmOscillator.frequency.value=1000;
gainNode.gain.value=0.3;
alarmOscillator.start();
}

function stopAlarmSound(){
if(alarmOscillator){try{alarmOscillator.stop();}catch(e){}alarmOscillator=null;}
STATE.sdi.alarmSound=false;STATE.smsi.alarmSound=false;
logAction('Arr√™t signal sonore');
}

// FIX: Generate alarm sounds with Web Audio API instead of external URLs
function playGeneralAlarm(type){
if(STATE.userType==='supervisor')return;
stopGeneralAlarm();
initAudio();

try{
if(type==='generale'){
// Alarm g√©n√©rale: Two-tone siren alternating
createTwoToneSiren(800,1200,0.5,0.4);
}else if(type==='generale-selective'){
// Alarm s√©lective: Pulsing tone
createPulsingAlarm(1000,0.3,0.15);
}else if(type==='generale-message'){
// Alarm with message: Three ascending tones then pause
createMessageAlarm();
}else{
createTwoToneSiren(800,1200,0.5,0.4);
}
}catch(err){
console.error('Erreur cr√©ation son alarme:',err);
}

if(generalAlarmTimer)clearTimeout(generalAlarmTimer);
generalAlarmTimer=setTimeout(()=>{
stopGeneralAlarm();
addSmsiMessage('Alarme arr√™t√©e automatiquement (5 min)');
},5*60*1000);
}

function createTwoToneSiren(freq1,freq2,interval,volume){
const osc=audioContext.createOscillator();
const gain=audioContext.createGain();
osc.connect(gain);
gain.connect(audioContext.destination);
osc.frequency.value=freq1;
gain.gain.value=volume;
osc.start();
generalAlarmOscillators.push({osc,gain});

// Alternate between two frequencies
const sirenInterval=setInterval(()=>{
if(osc.frequency.value===freq1){osc.frequency.value=freq2;}
else{osc.frequency.value=freq1;}
},interval*1000);
generalAlarmOscillators.push({interval:sirenInterval});
}

function createPulsingAlarm(freq,onTime,volume){
const osc=audioContext.createOscillator();
const gain=audioContext.createGain();
osc.connect(gain);
gain.connect(audioContext.destination);
osc.frequency.value=freq;
gain.gain.value=0;
osc.start();
generalAlarmOscillators.push({osc,gain});

let on=true;
const pulseInterval=setInterval(()=>{
gain.gain.value=on?volume:0;
on=!on;
},onTime*1000);
generalAlarmOscillators.push({interval:pulseInterval});
}

function createMessageAlarm(){
// Three ascending tones, then pause, repeat
const gain=audioContext.createGain();
gain.connect(audioContext.destination);
gain.gain.value=0.3;

function playSequence(){
const freqs=[523,659,784]; // C5, E5, G5
let i=0;
const osc=audioContext.createOscillator();
osc.connect(gain);
osc.frequency.value=freqs[0];
osc.start();
generalAlarmOscillators.push({osc,gain});

const seqInterval=setInterval(()=>{
i++;
if(i<freqs.length){
osc.frequency.value=freqs[i];
}else if(i===freqs.length){
gain.gain.value=0;
}else if(i>freqs.length+2){
i=0;
osc.frequency.value=freqs[0];
gain.gain.value=0.3;
}
},400);
generalAlarmOscillators.push({interval:seqInterval});
}
playSequence();
}

function stopGeneralAlarm(){
generalAlarmOscillators.forEach(item=>{
if(item.osc){try{item.osc.stop();}catch(e){}}
if(item.interval){clearInterval(item.interval);}
});
generalAlarmOscillators=[];
if(generalAlarmTimer){clearTimeout(generalAlarmTimer);generalAlarmTimer=null;}
}

let temporizationTimer;
function startTemporization(){
if(temporizationTimer)clearInterval(temporizationTimer);
temporizationTimer=setInterval(()=>{STATE.uga.temporizationRemaining--;if(STATE.uga.temporizationRemaining<=0){clearInterval(temporizationTimer);STATE.uga.temporizationActive=false;triggerGeneralAlarm();}updateTemporizationDisplay();},1000);
}

function updateTemporizationDisplay(){
const displays=document.querySelectorAll('.temporization-display');
displays.forEach(display=>{
if(STATE.uga.temporizationActive){const minutes=Math.floor(STATE.uga.temporizationRemaining/60);const seconds=STATE.uga.temporizationRemaining%60;display.textContent=`‚è±Ô∏è ${minutes}:${String(seconds).padStart(2,'0')}`;}
else{display.textContent='';}
});
}

function scrollScreen(screenId,action){const screen=document.getElementById(screenId);if(!screen)return;const lineHeight=20;switch(action){case 'up':screen.scrollTop-=lineHeight;break;case 'down':screen.scrollTop+=lineHeight;break;case 'first':screen.scrollTop=0;break;case 'last':screen.scrollTop=screen.scrollHeight;break;case 'home':screen.scrollTop=screen.scrollHeight/2;break;}}
function keypadPress(key){if(key==='C'){STATE.keypadInput='';}else{STATE.keypadInput+=key;}render();}
function keypadValidate(){if(!STATE.keypadInput)return;if(STATE.workflowStep==='LEVEL2_CODE'){checkLevel2Code();return;}if(STATE.workflowStep){handleWorkflowInput(STATE.keypadInput);}}

function checkLevel2Code(){
if(STATE.keypadInput==='1234'){
if(STATE.workflowData.system==='sdi'){STATE.accessLevel=2;}else{STATE.smsiAccessLevel=2;}
addSdiMessage('Niveau 2 activ√©');STATE.keypadInput='';STATE.workflowStep=null;STATE.workflowData={};render();
}else{addSdiMessage('Code incorrect');STATE.keypadInput='';render();}
}

function startOutOfServiceWorkflow(){if(STATE.accessLevel!==2){addSdiMessage('Niveau 2 requis');return;}STATE.workflowStep='HS_TYPE';STATE.workflowData={};STATE.keypadInput='';addSdiMessage('Vous voulez mettre hors service:');addSdiMessage('1) DAI');addSdiMessage('2) DM');addSdiMessage('3) Zone');render();}
function startBackInServiceWorkflow(){if(STATE.accessLevel!==2){addSdiMessage('Niveau 2 requis');return;}if(STATE.outOfService.length===0){addSdiMessage('Aucun mat√©riel hors service');return;}STATE.workflowStep='RS_CONFIRM';STATE.workflowData={};STATE.keypadInput='';addSdiMessage('Vous voulez remettre les mat√©riels en service');addSdiMessage('1) oui');addSdiMessage('2) non');render();}

function handleWorkflowInput(input){const value=input.trim();STATE.keypadInput='';switch(STATE.workflowStep){case 'HS_TYPE':handleHSType(value);break;case 'HS_NUMBER':handleHSNumber(value);break;case 'HS_ADD_MORE':handleHSAddMore(value);break;case 'HS_CONFIRM':handleHSConfirm(value);break;case 'RS_CONFIRM':handleRSConfirm(value);break;case 'RS_MODE':handleRSMode(value);break;case 'RS_SELECT':handleRSSelect(value);break;}}

function handleHSType(value){if(value==='1'){STATE.workflowData.type='DAI';STATE.workflowData.typeName='DAI';}else if(value==='2'){STATE.workflowData.type='DM';STATE.workflowData.typeName='DM';}else if(value==='3'){STATE.workflowData.type='Zone';STATE.workflowData.typeName='Zone';}else{addSdiMessage('Choix invalide');render();return;}STATE.workflowStep='HS_NUMBER';addSdiMessage(`Donnez le num√©ro du ${STATE.workflowData.typeName} √† mettre hors service`);render();}
function handleHSNumber(value){const number=parseInt(value);if(STATE.workflowData.type==='DAI'){const exists=STATE.sdi.detectors.some(d=>d.id===number);if(!exists||number<1||number>9){addSdiMessage('Num√©ro DAI invalide (1-9)');render();return;}STATE.workflowData.number=number;STATE.workflowData.label=`DAI${String(number).padStart(2,'0')}`;}else if(STATE.workflowData.type==='DM'){const exists=STATE.sdi.manualAlarms.some(d=>d.id===number);if(!exists||number<1||number>9){addSdiMessage('Num√©ro DM invalide (1-9)');render();return;}STATE.workflowData.number=number;STATE.workflowData.label=`DM${String(number).padStart(2,'0')}`;}else if(STATE.workflowData.type==='Zone'){if(number<1||number>3){addSdiMessage('Num√©ro Zone invalide (1-3)');render();return;}STATE.workflowData.number=number;STATE.workflowData.label=`ZC${number}`;}STATE.workflowStep='HS_ADD_MORE';addSdiMessage('Voulez-vous ajouter un mat√©riel');addSdiMessage('1) oui');addSdiMessage('2) non');render();}
function handleHSAddMore(value){if(value==='1'){if(!STATE.workflowData.items)STATE.workflowData.items=[];STATE.workflowData.items.push({type:STATE.workflowData.type,number:STATE.workflowData.number,label:STATE.workflowData.label});STATE.workflowStep='HS_TYPE';addSdiMessage('Vous voulez mettre hors service:');addSdiMessage('1) DAI');addSdiMessage('2) DM');addSdiMessage('3) Zone');render();}else if(value==='2'){if(!STATE.workflowData.items)STATE.workflowData.items=[];STATE.workflowData.items.push({type:STATE.workflowData.type,number:STATE.workflowData.number,label:STATE.workflowData.label});STATE.workflowStep='HS_CONFIRM';addSdiMessage('Vous avez mis hors service:');STATE.workflowData.items.forEach(item=>{addSdiMessage(`- ${item.label}`);});addSdiMessage('Validez:');addSdiMessage('1) oui');addSdiMessage('2) non');render();}else{addSdiMessage('Choix invalide');render();}}
function handleHSConfirm(value){if(value==='1'){STATE.workflowData.items.forEach(item=>{STATE.outOfService.push(item);if(item.type==='DAI'){const detector=STATE.sdi.detectors.find(d=>d.id===item.number);if(detector){detector.outOfService=true;sendMessage('DETECTOR_OUT_OF_SERVICE',{type:'DAI',id:item.number,outOfService:true});}}else if(item.type==='DM'){const dm=STATE.sdi.manualAlarms.find(d=>d.id===item.number);if(dm){dm.outOfService=true;sendMessage('DETECTOR_OUT_OF_SERVICE',{type:'DM',id:item.number,outOfService:true});}}addSdiMessage(`${item.label} mis hors service`);logAction(`Mise hors service ${item.label}`);});STATE.workflowStep=null;STATE.workflowData={};render();}else if(value==='2'){addSdiMessage('Mise hors service annul√©e');STATE.workflowStep=null;STATE.workflowData={};render();}else{addSdiMessage('Choix invalide');render();}}
function handleRSConfirm(value){if(value==='1'){STATE.workflowStep='RS_MODE';addSdiMessage('Voulez-vous:');addSdiMessage('1) tout remettre en service');addSdiMessage('2) une partie');render();}else if(value==='2'){addSdiMessage('Remise en service annul√©e');STATE.workflowStep=null;STATE.workflowData={};render();}else{addSdiMessage('Choix invalide');render();}}
function handleRSMode(value){if(value==='1'){STATE.outOfService.forEach(item=>{if(item.type==='DAI'){const detector=STATE.sdi.detectors.find(d=>d.id===item.number);if(detector){detector.outOfService=false;sendMessage('DETECTOR_OUT_OF_SERVICE',{type:'DAI',id:item.number,outOfService:false});}}else if(item.type==='DM'){const dm=STATE.sdi.manualAlarms.find(d=>d.id===item.number);if(dm){dm.outOfService=false;sendMessage('DETECTOR_OUT_OF_SERVICE',{type:'DM',id:item.number,outOfService:false});}}addSdiMessage(`${item.label} remis en service`);logAction(`Remise en service ${item.label}`);});STATE.outOfService=[];addSdiMessage('Tous les mat√©riels remis en service');STATE.workflowStep=null;STATE.workflowData={};render();}else if(value==='2'){STATE.workflowStep='RS_SELECT';addSdiMessage('Mat√©riels hors service:');STATE.outOfService.forEach((item,index)=>{addSdiMessage(`${index+1}) ${item.label}`);});addSdiMessage('Tapez le num√©ro √† remettre en service');render();}else{addSdiMessage('Choix invalide');render();}}
function handleRSSelect(value){const index=parseInt(value)-1;if(index<0||index>=STATE.outOfService.length){addSdiMessage('Num√©ro invalide');render();return;}const item=STATE.outOfService[index];if(item.type==='DAI'){const detector=STATE.sdi.detectors.find(d=>d.id===item.number);if(detector){detector.outOfService=false;sendMessage('DETECTOR_OUT_OF_SERVICE',{type:'DAI',id:item.number,outOfService:false});}}else if(item.type==='DM'){const dm=STATE.sdi.manualAlarms.find(d=>d.id===item.number);if(dm){dm.outOfService=false;sendMessage('DETECTOR_OUT_OF_SERVICE',{type:'DM',id:item.number,outOfService:false});}}addSdiMessage(`${item.label} remis en service`);logAction(`Remise en service ${item.label}`);STATE.outOfService.splice(index,1);if(STATE.outOfService.length>0){addSdiMessage('Mat√©riels hors service:');STATE.outOfService.forEach((item,index)=>{addSdiMessage(`${index+1}) ${item.label}`);});addSdiMessage('Tapez un autre num√©ro ou C pour terminer');render();}else{addSdiMessage('Tous les mat√©riels remis en service');STATE.workflowStep=null;STATE.workflowData={};render();}}

function triggerGeneralAlarm(){STATE.uga.alarmActive=true;STATE.uga.temporizationActive=false;STATE.uga.temporizationRemaining=0;if(temporizationTimer)clearInterval(temporizationTimer);playGeneralAlarm(STATE.uga.alarmType);addSmsiMessage(`Alarme ${STATE.uga.alarmType} d√©clench√©e`);logAction('D√©clenchement alarme g√©n√©rale',STATE.uga.alarmType);render();}
function forceGeneralAlarm(){if(STATE.uga.temporizationActive){clearInterval(temporizationTimer);STATE.uga.temporizationActive=false;}if(!STATE.uga.alarmActive){triggerGeneralAlarm();}}
function acquitProcess(){if(STATE.uga.temporizationActive){clearInterval(temporizationTimer);STATE.uga.temporizationActive=false;STATE.uga.temporizationRemaining=0;addSmsiMessage('Processus alarme acquitt√© - Alarme g√©n√©rale annul√©e');logAction('Acquit processus alarme');render();}}
function canResetSdiSystem(){if(STATE.accessLevel!==2)return false;const allDMReset=STATE.sdi.manualAlarms.every(d=>!d.triggered);const noDaiActive=STATE.sdi.detectors.every(d=>!d.triggered);return allDMReset&&noDaiActive;}
function canResetSmsiSystem(){if(STATE.smsiAccessLevel!==2)return false;const allZonesReady=[...STATE.smsi.compartmentZones,...STATE.smsi.smokeZones].every(zone=>zone.state==='attente');return allZonesReady;}

function resetSdiSystem(){if(!canResetSdiSystem()){showCustomAlert('Impossible de r√©armer le SDI: niveau 2 requis, tous les DM doivent √™tre r√©arm√©s et aucun DAI ne doit √™tre actif');return;}STATE.sdi.alarms=[];STATE.sdi.fireAlarmActive=false;STATE.sdi.alarmSound=false;STATE.sdi.detectors.forEach(d=>d.triggered=false);STATE.sdi.manualAlarms.forEach(d=>d.triggered=false);stopAlarmSound();if(STATE.uga.temporizationActive){clearInterval(temporizationTimer);STATE.uga.temporizationActive=false;STATE.uga.temporizationRemaining=0;}logAction('R√©armement SDI complet');render();}
function resetSmsiSystem(){if(!canResetSmsiSystem()){showCustomAlert('Impossible de r√©armer le SMSI: niveau 2 requis et tous les DAS en position d\'attente');return;}STATE.smsi.messages=[];STATE.smsi.alarmSound=false;STATE.smsi.compartmentZones.forEach(z=>z.commandActive=false);STATE.smsi.smokeZones.forEach(z=>z.commandActive=false);STATE.uga.alarmActive=false;STATE.uga.temporizationActive=false;STATE.uga.temporizationRemaining=0;stopGeneralAlarm();stopAlarmSound();logAction('R√©armement SMSI complet');render();}

function resetSdiToIdle(){STATE.sdi.alarms=[];STATE.sdi.fireAlarmActive=false;STATE.sdi.alarmSound=false;STATE.sdi.detectors.forEach(d=>{d.triggered=false;});STATE.sdi.manualAlarms.forEach(d=>{d.triggered=false;});STATE.sdi.systemState='service';STATE.sdi.powerState='secteur';STATE.sdi.batteryState='service';try{stopAlarmSound();}catch(e){}if(STATE.uga.temporizationActive){clearInterval(temporizationTimer);STATE.uga.temporizationActive=false;STATE.uga.temporizationRemaining=0;}}
function resetSmsiToIdle(){STATE.smsi.messages=[];STATE.smsi.alarmSound=false;STATE.smsi.compartmentZones.forEach(z=>{z.commandActive=false;z.state='attente';z.ledRed={on:false,blink:false};z.ledOrange={on:false,blink:false};z.ledGreen={on:false,blink:false};});STATE.smsi.smokeZones.forEach(z=>{z.commandActive=false;z.state='attente';z.ledRed={on:false,blink:false};z.ledOrange={on:false,blink:false};z.ledGreen={on:false,blink:false};});STATE.smsi.relayBoxes.forEach(r=>{r.state='attente';r.ledRed={on:false,blink:false};r.ledOrange={on:false,blink:false};r.ledGreen={on:false,blink:false};});STATE.smsi.systemState='service';STATE.smsi.powerState='secteur';STATE.smsi.batteryState='service';STATE.uga.alarmActive=false;STATE.uga.temporizationActive=false;STATE.uga.temporizationRemaining=0;try{stopGeneralAlarm();stopAlarmSound();}catch(e){}}

function showCustomAlert(message){const modal=document.createElement('div');modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';modal.innerHTML=`<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p><div class="flex justify-end"><button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" onclick="this.closest('.fixed').remove()">OK</button></div></div>`;document.body.appendChild(modal);}
function showCustomConfirm(message,onConfirm){const modal=document.createElement('div');modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';modal.innerHTML=`<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p><div class="flex justify-end space-x-3"><button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button><button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" id="confirmBtn">Confirmer</button></div></div>`;document.body.appendChild(modal);modal.querySelector('#confirmBtn').onclick=()=>{modal.remove();onConfirm();};}
function showCustomPrompt(message,onSubmit,defaultValue=''){const modal=document.createElement('div');modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';modal.innerHTML=`<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p><input type="text" id="promptInput" value="${defaultValue}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 mb-4"><div class="flex justify-end space-x-3"><button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button><button class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" id="submitBtn">OK</button></div></div>`;document.body.appendChild(modal);const input=modal.querySelector('#promptInput');input.focus();input.select();const submit=()=>{const value=input.value;modal.remove();if(value)onSubmit(value);};modal.querySelector('#submitBtn').onclick=submit;input.onkeypress=(e)=>{if(e.key==='Enter')submit();};}

let importOffered=false;
function saveTrainees(){if(firebaseInitialized){db.ref('trainees').set(STATE.trainees);}}
function loadTraineesFromFirebase(){if(!firebaseInitialized)return;db.ref('trainees').once('value',(snapshot)=>{const trainees=snapshot.val();if(trainees){STATE.trainees=trainees;render();}});db.ref('trainees').on('value',(snapshot)=>{const trainees=snapshot.val();if(trainees){STATE.trainees=trainees;if(STATE.currentView==='trainee-management'||STATE.currentView==='trainee-login'){render();}}});}
function loadSessionLogsFromFirebase(){if(!firebaseInitialized)return;db.ref('session_logs').once('value',(snapshot)=>{const logs=snapshot.val();if(logs){STATE.sessionLogs=Object.values(logs);}});db.ref('session_logs').on('child_added',(snapshot)=>{const log=snapshot.val();if(log&&!STATE.sessionLogs.find(l=>l.sessionId===log.sessionId)){STATE.sessionLogs.push(log);if(STATE.currentView==='session-logs'){render();}}});}
function printTraineeList(){if(STATE.trainees.length===0){showCustomAlert('Aucun stagiaire √† imprimer');return;}const printWindow=window.open('','_blank');const html=`<!DOCTYPE html><html><head><title>Liste des Stagiaires</title><style>body{font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto}h1{text-align:center;color:#5D5CDE}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #333;padding:12px;text-align:left}th{background-color:#5D5CDE;color:white}.pin{font-weight:bold;font-size:18px;letter-spacing:2px;color:#5D5CDE}@media print{button{display:none}}</style></head><body><h1>Liste des Stagiaires - Formation SSI SSIAP</h1><p>Date: ${new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</p><table><thead><tr><th>Nom</th><th>Pr√©nom</th><th>Email</th><th>Code PIN</th><th>Niveau</th><th>Dates</th></tr></thead><tbody>${STATE.trainees.map(t=>`<tr><td>${t.nom}</td><td>${t.prenom}</td><td>${t.email||'N/A'}</td><td class="pin">${t.pin}</td><td>SSIAP ${t.niveau}</td><td>${new Date(t.dateDebut).toLocaleDateString('fr-FR')} - ${new Date(t.dateFin).toLocaleDateString('fr-FR')}</td></tr>`).join('')}</tbody></table><p>Total: ${STATE.trainees.length} stagiaire(s)</p></body></html>`;printWindow.document.write(html);printWindow.document.close();setTimeout(()=>{printWindow.print();},250);}
function exportTrainees(){const dataStr=JSON.stringify(STATE.trainees,null,2);const dataBlob=new Blob([dataStr],{type:'application/json'});const url=URL.createObjectURL(dataBlob);const link=document.createElement('a');link.href=url;link.download='stagiaires.json';link.click();URL.revokeObjectURL(url);}
function importTrainees(){const input=document.createElement('input');input.type='file';input.accept='application/json';input.onchange=(e)=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=(event)=>{try{const imported=JSON.parse(event.target.result);if(Array.isArray(imported)){STATE.trainees=imported;saveTrainees();render();showCustomAlert(`${imported.length} stagiaire(s) import√©(s) avec succ√®s`);}else{showCustomAlert('Format de fichier invalide');}}catch(error){showCustomAlert('Erreur lors de la lecture du fichier');}};reader.readAsText(file);};input.click();}
function checkTraineeAccess(trainee){const today=new Date();today.setHours(0,0,0,0);const dateDebut=new Date(trainee.dateDebut);dateDebut.setHours(0,0,0,0);const dateFin=new Date(trainee.dateFin);dateFin.setHours(23,59,59,999);return today>=dateDebut&&today<=dateFin;}

function createTrainee(data){
let pin;do{pin=String(Math.floor(1000+Math.random()*9000));}while(STATE.trainees.some(t=>t.pin===pin));
const trainee={id:Date.now(),nom:data.nom,prenom:data.prenom,email:data.email,niveau:data.niveau,dateDebut:data.dateDebut,dateFin:data.dateFin,pin:pin};
STATE.trainees.push(trainee);saveTrainees();return trainee;
}

// FIX: Add trainee update function
function updateTrainee(id,data){
const index=STATE.trainees.findIndex(t=>t.id===id);
if(index===-1)return;
STATE.trainees[index]={...STATE.trainees[index],...data};
saveTrainees();
}

function navigate(view,data={}){
// FIX: Clean up when leaving trainee or supervisor interface
if(view==='home'&&(STATE.currentView==='trainee-interface'||STATE.currentView==='supervisor-interface')){
cleanupSession();
}
STATE.currentView=view;
if(data.user)STATE.currentUser=data.user;
if(data.userType)STATE.userType=data.userType;
STATE.editingTrainee=null;
render();
}

function render(){
const app=document.getElementById('app');
switch(STATE.currentView){
case 'home':app.innerHTML=renderHome();break;
case 'supervisor-login':app.innerHTML=renderSupervisorLogin();break;
case 'trainee-login':app.innerHTML=renderTraineeLogin();break;
case 'trainee-management':app.innerHTML=renderTraineeManagement();break;
case 'create-trainee':app.innerHTML=renderCreateTrainee();break;
case 'edit-trainee':app.innerHTML=renderEditTrainee();break;
case 'supervisor-interface':app.innerHTML=renderSupervisorInterface();break;
case 'trainee-interface':app.innerHTML=renderTraineeInterface();break;
case 'session-logs':app.innerHTML=renderSessionLogs();break;
}
restoreVideoStreams();
}

function restoreVideoStreams(){setTimeout(()=>{if(STATE.localStream){const localVideo=document.getElementById('local-video');if(localVideo&&localVideo.srcObject!==STATE.localStream){localVideo.srcObject=STATE.localStream;}}if(STATE.remoteStream){const remoteVideo=document.getElementById('trainee-video');if(remoteVideo&&remoteVideo.srcObject!==STATE.remoteStream){remoteVideo.srcObject=STATE.remoteStream;remoteVideo.muted=STATE.audioMuted;remoteVideo.volume=STATE.audioVolume;}}},50);}

function renderHome(){return `<div class="min-h-screen flex items-center justify-center p-4"><div class="max-w-2xl w-full"><h1 class="text-4xl font-bold text-center mb-8 text-primary">Formation SSI - SSIAP</h1><div class="grid md:grid-cols-2 gap-6"><div onclick="navigate('supervisor-login')" class="cursor-pointer bg-gradient-to-br from-primary to-blue-600 p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105"><h2 class="text-2xl font-bold text-white mb-4">üë®‚Äçüè´ Superviseur</h2><p class="text-white opacity-90">Cr√©er des sc√©narios et superviser les stagiaires</p></div><div onclick="navigate('trainee-login')" class="cursor-pointer bg-gradient-to-br from-green-500 to-green-600 p-8 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105"><h2 class="text-2xl font-bold text-white mb-4">üéì Stagiaire</h2><p class="text-white opacity-90">Se connecter et r√©aliser les exercices</p></div></div></div></div>`;}
function renderSupervisorLogin(){return `<div class="min-h-screen flex items-center justify-center p-4"><div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-6">Connexion Superviseur</h2><form onsubmit="handleSupervisorLogin(event)" class="space-y-4"><div><label class="block text-sm font-medium mb-2">Code superviseur</label><input type="password" id="supervisor-code" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">Se connecter</button><button type="button" onclick="navigate('home')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Retour</button></form></div></div>`;}
function renderTraineeLogin(){return `<div class="min-h-screen flex items-center justify-center p-4"><div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-6">Connexion Stagiaire</h2><form onsubmit="handleTraineePinLogin(event)" class="space-y-4"><div><label class="block text-sm font-medium mb-2">Code PIN (4 chiffres)</label><input type="password" id="trainee-pin" maxlength="4" pattern="[0-9]{4}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-center text-2xl tracking-widest" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">Se connecter</button><button type="button" onclick="navigate('home')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Retour</button></form></div></div>`;}

function renderTraineeManagement(){return `<div class="min-h-screen p-4"><div class="max-w-6xl mx-auto"><div class="flex flex-wrap justify-between items-center mb-4 gap-2"><h2 class="text-3xl font-bold">Gestion des Stagiaires</h2><div class="flex flex-wrap gap-2"><button onclick="importTrainees()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">üì• Importer</button><button onclick="exportTrainees()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">üì§ Exporter</button><button onclick="printTraineeList()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">üñ®Ô∏è Imprimer</button><button onclick="navigate('create-trainee')" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition">‚ûï Cr√©er</button><button onclick="navigate('supervisor-interface')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Retour</button></div></div>${STATE.trainees.length>0&&firebaseInitialized?`<div class="bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500 p-4 mb-6"><p class="text-sm text-blue-800 dark:text-blue-200">üí° <strong>Info:</strong> Les stagiaires sont synchronis√©s automatiquement via le cloud.</p></div>`:''}<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${STATE.trainees.map(trainee=>{const isActive=checkTraineeAccess(trainee);const dateDebut=new Date(trainee.dateDebut).toLocaleDateString('fr-FR');const dateFin=new Date(trainee.dateFin).toLocaleDateString('fr-FR');return `<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg ${isActive?'border-2 border-green-500':'border-2 border-gray-400 opacity-75'}"><div class="flex justify-between items-start mb-2"><h3 class="text-xl font-bold">${trainee.prenom} ${trainee.nom}</h3><span class="px-2 py-1 rounded text-xs font-bold ${isActive?'bg-green-500 text-white':'bg-gray-500 text-white'}">${isActive?'‚úì Actif':'‚úó Inactif'}</span></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Email: ${trainee.email||'N/A'}<br>Niveau: SSIAP ${trainee.niveau}<br>Du ${dateDebut} au ${dateFin}</p><div class="bg-primary text-white p-4 rounded-lg mb-4 text-center"><div class="text-xs mb-1">Code PIN</div><div class="text-3xl font-bold tracking-widest">${trainee.pin}</div></div><div class="flex gap-2"><button onclick="editTrainee(${trainee.id})" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">‚úèÔ∏è Modifier</button><button onclick="deleteTrainee(${trainee.id})" class="flex-1 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">üóëÔ∏è Supprimer</button></div></div>`;}).join('')}</div></div></div>`;}

function renderCreateTrainee(){return `<div class="min-h-screen flex items-center justify-center p-4"><div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-6">Cr√©er un Stagiaire</h2><form onsubmit="handleCreateTrainee(event)" class="space-y-4"><div><label class="block text-sm font-medium mb-2">Nom</label><input type="text" id="nom" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class="block text-sm font-medium mb-2">Pr√©nom</label><input type="text" id="prenom" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class="block text-sm font-medium mb-2">Email</label><input type="email" id="email" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class="block text-sm font-medium mb-2">Niveau SSIAP</label><select id="niveau" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required><option value="1">SSIAP 1</option><option value="2">SSIAP 2</option><option value="3">SSIAP 3</option></select></div><div><label class="block text-sm font-medium mb-2">Date d√©but</label><input type="date" id="dateDebut" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class="block text-sm font-medium mb-2">Date fin</label><input type="date" id="dateFin" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><button type="submit" class="w-full px-4 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">Cr√©er</button><button type="button" onclick="navigate('trainee-management')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Annuler</button></form></div></div>`;}

// FIX: New edit trainee view
function renderEditTrainee(){
const t=STATE.editingTrainee;
if(!t)return '<div class="p-4">Erreur: aucun stagiaire s√©lectionn√©</div>';
return `<div class="min-h-screen flex items-center justify-center p-4"><div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-6">‚úèÔ∏è Modifier le Stagiaire</h2><div class="bg-primary text-white p-3 rounded-lg mb-4 text-center"><div class="text-xs mb-1">Code PIN (inchang√©)</div><div class="text-2xl font-bold tracking-widest">${t.pin}</div></div><form onsubmit="handleEditTrainee(event)" class="space-y-4"><div><label class="block text-sm font-medium mb-2">Nom</label><input type="text" id="edit-nom" value="${t.nom}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class="block text-sm font-medium mb-2">Pr√©nom</label><input type="text" id="edit-prenom" value="${t.prenom}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class="block text-sm font-medium mb-2">Email</label><input type="email" id="edit-email" value="${t.email||''}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class="block text-sm font-medium mb-2">Niveau SSIAP</label><select id="edit-niveau" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required><option value="1" ${t.niveau==='1'||t.niveau===1?'selected':''}>SSIAP 1</option><option value="2" ${t.niveau==='2'||t.niveau===2?'selected':''}>SSIAP 2</option><option value="3" ${t.niveau==='3'||t.niveau===3?'selected':''}>SSIAP 3</option></select></div><div><label class="block text-sm font-medium mb-2">Date d√©but</label><input type="date" id="edit-dateDebut" value="${t.dateDebut}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><div><label class="block text-sm font-medium mb-2">Date fin</label><input type="date" id="edit-dateFin" value="${t.dateFin}" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required></div><button type="submit" class="w-full px-4 py-3 bg-green-500 text-white rounded hover:bg-green-600 transition">üíæ Enregistrer les modifications</button><button type="button" onclick="navigate('trainee-management')" class="w-full px-4 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition">Annuler</button></form></div></div>`;
}

// FIX: Edit trainee function
function editTrainee(id){
const trainee=STATE.trainees.find(t=>t.id===id);
if(!trainee){showCustomAlert('Stagiaire non trouv√©');return;}
STATE.editingTrainee={...trainee};
STATE.currentView='edit-trainee';
render();
}

// FIX: Handle edit trainee form submission
function handleEditTrainee(event){
event.preventDefault();
const data={
nom:document.getElementById('edit-nom').value,
prenom:document.getElementById('edit-prenom').value,
email:document.getElementById('edit-email').value,
niveau:document.getElementById('edit-niveau').value,
dateDebut:document.getElementById('edit-dateDebut').value,
dateFin:document.getElementById('edit-dateFin').value
};
updateTrainee(STATE.editingTrainee.id,data);
STATE.editingTrainee=null;
navigate('trainee-management');
showCustomAlert('Stagiaire modifi√© avec succ√®s!');
}

function renderSupervisorInterface(){return `<div class="min-h-screen p-4 bg-gray-100 dark:bg-gray-900"><div class="max-w-7xl mx-auto"><div class="flex flex-wrap justify-between items-center mb-6 gap-2"><h2 class="text-3xl font-bold">Interface Superviseur</h2><div class="flex flex-wrap gap-2">${!STATE.sessionActive?`<button onclick="createSession()" class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition font-bold">üöÄ D√©but de session</button>`:`<button onclick="endSession()" class="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition font-bold">‚èπÔ∏è Fin de session</button>`}<button onclick="navigate('trainee-management')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">üìã Gestion stagiaires</button><button onclick="navigate('session-logs')" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition">üìö Journaux</button><button onclick="navigate('home')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">D√©connexion</button></div></div>${STATE.sessionActive?`<div class="bg-green-100 dark:bg-green-900 border-l-4 border-green-500 p-4 mb-6"><p class="text-sm text-green-800 dark:text-green-200">‚úÖ <strong>Session ${STATE.currentSessionNumber} active</strong> - Les stagiaires peuvent maintenant se connecter.</p></div>`:`<div class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-6"><p class="text-sm text-yellow-800 dark:text-yellow-200">‚ö†Ô∏è <strong>Aucune session active</strong> - Cliquez sur "üöÄ D√©but de session" pour commencer.</p></div>`}<div class="grid lg:grid-cols-2 gap-6"><div class="space-y-6"><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg" style="height:600px;overflow-y:auto;"><h3 class="text-2xl font-bold mb-4 text-primary">üî• Contr√¥le SDI</h3><div class="space-y-4"><div class="grid grid-cols-2 gap-2"><div><label class="block text-xs font-medium mb-1">√âtat syst√®me</label><select onchange="changeSdiState(this.value)" class="w-full px-2 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="service" ${STATE.sdi.systemState==='service'?'selected':''}>En service</option><option value="hors-service" ${STATE.sdi.systemState==='hors-service'?'selected':''}>Hors service</option><option value="hors-tension" ${STATE.sdi.systemState==='hors-tension'?'selected':''}>Hors tension</option></select></div><div><label class="block text-xs font-medium mb-1">Alimentation</label><select onchange="changeSdiPower(this.value)" class="w-full px-2 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="secteur" ${STATE.sdi.powerState==='secteur'?'selected':''}>Secteur</option><option value="batterie" ${STATE.sdi.powerState==='batterie'?'selected':''}>Batterie</option></select></div><div><label class="block text-xs font-medium mb-1">Batterie</label><select onchange="changeSdiBattery(this.value)" class="w-full px-2 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="service" ${STATE.sdi.batteryState==='service'?'selected':''}>En service</option><option value="hors-service" ${STATE.sdi.batteryState==='hors-service'?'selected':''}>Hors service</option></select></div><div><label class="block text-xs font-medium mb-1">Temporisation</label><select onchange="setTemporization(this.value)" class="w-full px-2 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">${[0,1,2,3,4,5].map(m=>`<option value="${m}" ${STATE.uga.temporization===m?'selected':''}>${m} min</option>`).join('')}</select></div><div><label class="block text-xs font-medium mb-1">Type alarme</label><select onchange="setAlarmType(this.value)" class="w-full px-2 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="generale" ${STATE.uga.alarmType==='generale'?'selected':''}>G√©n√©rale</option><option value="generale-selective" ${STATE.uga.alarmType==='generale-selective'?'selected':''}>G√©n√©rale s√©lective</option><option value="generale-message" ${STATE.uga.alarmType==='generale-message'?'selected':''}>G√©n√©rale avec message</option></select></div></div><div class="grid grid-cols-2 gap-4"><div><h4 class="font-bold mb-2">üîç DAI</h4>${STATE.sdi.detectors.map(d=>`<div class="flex items-center gap-1 mb-1"><button onclick="${(d.state==='service'&&!d.outOfService)?`toggleDetector('DAI',${d.id})`:''}" class="w-8 h-8 ${(d.outOfService||d.state==='hors-service')?'bg-orange-500':(d.triggered?'bg-red-500':'bg-green-500')} rounded border-2 border-black ${(d.state==='hors-service'||d.outOfService)?'cursor-not-allowed':'hover:opacity-90 cursor-pointer'} flex-shrink-0 text-white text-xs"></button><span class="text-xs font-mono w-12 flex-shrink-0 font-bold ${(d.outOfService||d.state==='hors-service')?'text-orange-600 dark:text-orange-400':''}">DAI${String(d.id).padStart(2,'0')}</span><select onchange="changeDetectorZone('DAI',${d.id},this.value)" class="px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-16"><option value="ZC1" ${d.zone==='ZC1'?'selected':''}>ZC1</option><option value="ZC2" ${d.zone==='ZC2'?'selected':''}>ZC2</option><option value="ZC3" ${d.zone==='ZC3'?'selected':''}>ZC3</option></select><input type="text" value="${d.address.replace(/^(DAI|DM)\s*\d*-?\d*\s*/,'').trim()}" placeholder="Adresse" onchange="updateDetectorAddressInput('DAI',${d.id},this.value)" class="flex-1 px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"><select onchange="changeDetectorState('DAI',${d.id},this.value)" class="px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-12"><option value="service" ${(d.state==='service'&&!d.outOfService)?'selected':''}>OK</option><option value="hors-service" ${(d.state==='hors-service'||d.outOfService)?'selected':''}>HS</option></select></div>`).join('')}</div><div><h4 class="font-bold mb-2">üö® DM</h4>${STATE.sdi.manualAlarms.map(d=>`<div class="flex items-center gap-1 mb-1"><button onclick="${(d.state==='service'&&!d.outOfService)?`toggleDetector('DM',${d.id})`:''}" class="w-8 h-8 ${(d.outOfService||d.state==='hors-service')?'bg-orange-500':(d.triggered?'bg-red-500':'bg-green-500')} rounded border-2 border-black ${(d.state==='hors-service'||d.outOfService)?'cursor-not-allowed':'hover:opacity-90 cursor-pointer'} flex-shrink-0 text-white text-xs"></button><span class="text-xs font-mono w-12 flex-shrink-0 font-bold ${(d.outOfService||d.state==='hors-service')?'text-orange-600 dark:text-orange-400':''}">DM${String(d.id).padStart(2,'0')}</span><select onchange="changeDetectorZone('DM',${d.id},this.value)" class="px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-16"><option value="ZC1" ${d.zone==='ZC1'?'selected':''}>ZC1</option><option value="ZC2" ${d.zone==='ZC2'?'selected':''}>ZC2</option><option value="ZC3" ${d.zone==='ZC3'?'selected':''}>ZC3</option></select><input type="text" value="${d.address.replace(/^(DAI|DM)\s*\d*-?\d*\s*/,'').trim()}" placeholder="Adresse" onchange="updateDetectorAddressInput('DM',${d.id},this.value)" class="flex-1 px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"><select onchange="changeDetectorState('DM',${d.id},this.value)" class="px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-12"><option value="service" ${(d.state==='service'&&!d.outOfService)?'selected':''}>OK</option><option value="hors-service" ${(d.state==='hors-service'||d.outOfService)?'selected':''}>HS</option></select></div>`).join('')}</div></div></div></div><div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg" style="height:500px;overflow-y:auto;"><h3 class="text-2xl font-bold mb-4 text-primary">üõ°Ô∏è Contr√¥le SMSI</h3><div class="space-y-4"><div class="grid grid-cols-2 gap-2"><div><label class="block text-xs font-medium mb-1">√âtat syst√®me</label><select onchange="changeSmsiState(this.value)" class="w-full px-2 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="service" ${STATE.smsi.systemState==='service'?'selected':''}>En service</option><option value="hors-service" ${STATE.smsi.systemState==='hors-service'?'selected':''}>Hors service</option><option value="hors-tension" ${STATE.smsi.systemState==='hors-tension'?'selected':''}>Hors tension</option></select></div><div><label class="block text-xs font-medium mb-1">Alimentation</label><select onchange="changeSmsiPower(this.value)" class="w-full px-2 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="secteur" ${STATE.smsi.powerState==='secteur'?'selected':''}>Secteur</option><option value="batterie" ${STATE.smsi.powerState==='batterie'?'selected':''}>Batterie</option></select></div><div><label class="block text-xs font-medium mb-1">Batterie</label><select onchange="changeSmsBattery(this.value)" class="w-full px-2 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"><option value="service" ${STATE.smsi.batteryState==='service'?'selected':''}>En service</option><option value="hors-service" ${STATE.smsi.batteryState==='hors-service'?'selected':''}>Hors service</option></select></div></div><div class="grid grid-cols-3 gap-2"><div><h4 class="font-bold mb-1 text-xs">üö™ ZC</h4>${STATE.smsi.compartmentZones.map(z=>`<div class="flex flex-col gap-1 mb-1"><div class="flex items-center gap-1"><span class="text-xs font-mono font-bold">${z.zone}</span><select onchange="changeZoneState('compartment',${z.id},this.value)" class="flex-1 px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"><option value="attente" ${z.state==='attente'?'selected':''}>Attente</option><option value="defaut-attente" ${z.state==='defaut-attente'?'selected':''}>D√©f. attente</option><option value="securite" ${z.state==='securite'?'selected':''}>S√©curit√©</option><option value="defaut-securite" ${z.state==='defaut-securite'?'selected':''}>D√©f. s√©curit√©</option><option value="defaut-alim" ${z.state==='defaut-alim'?'selected':''}>D√©f. alim</option></select></div><input type="text" value="${z.address.replace(/^Compartiment Zone \d+/,'').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('compartment',${z.id},this.value||'Compart. Z${z.id}')" class="w-full px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"></div>`).join('')}</div><div><h4 class="font-bold mb-1 text-xs">üí® ZF</h4>${STATE.smsi.smokeZones.map(z=>`<div class="flex flex-col gap-1 mb-1"><div class="flex items-center gap-1"><span class="text-xs font-mono font-bold">${z.zone}</span><select onchange="changeZoneState('smoke',${z.id},this.value)" class="flex-1 px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"><option value="attente" ${z.state==='attente'?'selected':''}>Attente</option><option value="defaut-attente" ${z.state==='defaut-attente'?'selected':''}>D√©f. attente</option><option value="securite" ${z.state==='securite'?'selected':''}>S√©curit√©</option><option value="defaut-securite" ${z.state==='defaut-securite'?'selected':''}>D√©f. s√©curit√©</option><option value="defaut-alim" ${z.state==='defaut-alim'?'selected':''}>D√©f. alim</option></select></div><input type="text" value="${z.address.replace(/^D√©senfumage Zone \d+/,'').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('smoke',${z.id},this.value||'D√©senf. Z${z.id}')" class="w-full px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"></div>`).join('')}</div><div><h4 class="font-bold mb-1 text-xs">‚ö° Coffrets</h4>${STATE.smsi.relayBoxes.map(r=>`<div class="flex flex-col gap-1 mb-1"><div class="flex items-center gap-1"><span class="text-xs font-mono font-bold">CR${r.id}</span><select onchange="changeZoneState('relay',${r.id},this.value)" class="flex-1 px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"><option value="attente" ${r.state==='attente'?'selected':''}>Attente</option><option value="defaut-attente" ${r.state==='defaut-attente'?'selected':''}>D√©f. attente</option><option value="securite" ${r.state==='securite'?'selected':''}>S√©curit√©</option><option value="defaut-securite" ${r.state==='defaut-securite'?'selected':''}>D√©f. s√©curit√©</option><option value="defaut-alim" ${r.state==='defaut-alim'?'selected':''}>D√©f. alim</option></select></div><input type="text" value="${r.address.replace(/^Coffret \d+/,'').trim()}" placeholder="Adresse" onchange="updateZoneAddressInput('relay',${r.id},this.value||'Coffret ${r.id}')" class="w-full px-1 py-1 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 min-w-0"></div>`).join('')}</div></div></div></div></div><div class="space-y-6">${STATE.sessionActive?`<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg" style="height:600px;overflow-y:auto;"><h3 class="text-2xl font-bold mb-4">üìπ Vue Stagiaire</h3><div id="video-status-section">${!STATE.remoteStream?`<div class="text-center py-8"><p class="text-gray-600 dark:text-gray-400 mb-4">En attente que le stagiaire active sa cam√©ra...</p><button onclick="supervisorConnectToVideo()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-bold">üîó Se connecter √† la vid√©o</button></div>`:`<div class="space-y-3"><div class="relative bg-black rounded-lg overflow-hidden" style="height:280px;"><video id="trainee-video" autoplay playsinline class="w-full h-full object-cover"></video><div class="absolute top-2 left-2 px-2 py-1 bg-red-500 text-white text-xs rounded">üî¥ STAGIAIRE EN DIRECT</div><div class="absolute bottom-2 right-2"><button onclick="disconnectVideo()" class="px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-xs">‚èπÔ∏è D√©connecter</button></div></div><div class="grid grid-cols-3 gap-2"><button onclick="toggleAudioMute()" class="px-4 py-3 bg-${STATE.audioMuted?'red':'green'}-500 text-white rounded-lg hover:bg-${STATE.audioMuted?'red':'green'}-600 transition font-bold flex flex-col items-center justify-center gap-1"><span class="text-2xl">${STATE.audioMuted?'üîá':'üîä'}</span><span class="text-xs">${STATE.audioMuted?'Son':'Son'}</span></button><button onclick="toggleSupervisorMic()" class="px-4 py-3 bg-${STATE.supervisorMicActive?'blue':'gray'}-500 text-white rounded-lg hover:bg-${STATE.supervisorMicActive?'blue':'gray'}-600 transition font-bold flex flex-col items-center justify-center gap-1"><span class="text-2xl">üé§</span><span class="text-xs">Micro</span></button>${!STATE.isRecording?`<button onclick="startRecording()" class="px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-bold flex flex-col items-center justify-center gap-1"><span class="text-2xl">üé¨</span><span class="text-xs">Enregistrer</span></button>`:`<button onclick="stopRecording()" class="px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-bold flex flex-col items-center justify-center gap-1 animate-pulse"><span class="text-2xl">‚èπÔ∏è</span><span class="text-xs">${getRecordingDuration()}</span></button>`}</div></div>`}</div></div>`:''}<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg" style="height:500px;overflow-y:auto;"><h3 class="text-2xl font-bold mb-4 text-primary">üìã Journal des actions</h3><div class="ssi-screen max-h-96 overflow-y-auto overflow-x-hidden" style="word-break:break-word;max-width:100%;">${STATE.actionLog.length===0?'<div class="text-center opacity-50">Aucune action enregistr√©e</div>':STATE.actionLog.slice(-20).reverse().map(log=>`<div class="mb-2 pb-2 border-b border-green-900"><div class="text-xs opacity-75">${new Date(log.timestamp).toLocaleString('fr-FR')}</div><div>${log.trainee}: <span class="text-yellow-400">${log.action}</span></div>${log.details?`<div class="text-sm opacity-75">${log.details}</div>`:''}</div>`).join('')}</div></div></div></div></div></div>`;}

function renderTraineeInterface(){return `<div class="min-h-screen p-2 bg-gray-100 dark:bg-gray-900"><div class="max-w-7xl mx-auto"><div class="flex justify-between items-center mb-4"><div><h2 class="text-2xl font-bold">SSI - Formation</h2><p class="text-xs text-gray-600 dark:text-gray-400">${STATE.currentUser?.prenom} ${STATE.currentUser?.nom} - SSIAP ${STATE.currentUser?.niveau}</p>${STATE.sessionActive&&STATE.sessionNumber?`<div class="mt-1 flex items-center gap-2"><span class="px-2 py-1 bg-blue-500 text-white rounded text-xs font-bold">üìã Session ${STATE.sessionNumber}</span><span class="px-2 py-1 bg-green-500 text-white rounded text-xs font-bold">‚úì OUVERTE</span></div>`:`<div class="mt-1"><span class="px-2 py-1 bg-yellow-500 text-white rounded text-xs font-bold">‚è≥ En attente de session...</span></div>`}</div><button onclick="navigate('home')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition text-sm">D√©connexion</button></div><div class="grid lg:grid-cols-2 gap-4"><div class="ssi-panel"><h3 class="text-xl font-bold mb-3 text-white">üî• SDI</h3><div class="grid grid-cols-3 gap-2 mb-2"><div class="bg-gray-800 p-1.5 rounded flex items-center justify-between"><div class="text-white text-xs">√âtat mat.</div><span class="led-light ${STATE.sdi.systemState==='service'?'led-green':'led-off'}"></span></div><div class="bg-gray-800 p-1.5 rounded flex items-center justify-between"><div class="text-white text-xs">Alim. sect.</div><span class="led-light ${STATE.sdi.powerState==='secteur'?'led-green':'led-off'}"></span></div><div class="bg-gray-800 p-1.5 rounded flex items-center justify-between"><div class="text-white text-xs">Batterie</div><span class="led-light ${STATE.sdi.batteryState==='service'?'led-green':'led-off'}"></span></div></div><div class="mb-2"><div class="text-white text-xs font-bold mb-1"><span>üìü ECS</span></div><div id="sdi-screen" class="ssi-screen max-h-48 overflow-y-hidden overflow-x-hidden text-xs scroll-smooth">${STATE.sdi.alarms.length===0?'<div class="text-center">SYST√àME EN VEILLE</div>':STATE.sdi.alarms.map(alarm=>`<div class="mb-1">${alarm.text}</div>`).join('')}</div><div class="flex justify-center gap-1 mt-1"><button onclick="scrollScreen('sdi-screen','first')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold">‚¨ÖÔ∏è</button><button onclick="scrollScreen('sdi-screen','up')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold">‚¨ÜÔ∏è</button><button onclick="scrollScreen('sdi-screen','down')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold">‚¨áÔ∏è</button><button onclick="scrollScreen('sdi-screen','last')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold">‚û°Ô∏è</button></div></div><div class="bg-gray-800 p-2 rounded mb-3"><div class="flex items-center justify-between"><span class="text-white text-xs font-bold">ALARME FEU</span><div class="flex items-center gap-2"><span class="led-light ${STATE.sdi.fireAlarmActive?'led-red blink':'led-off'}"></span>${STATE.sdi.alarmSound?`<button onclick="traineeStopAlarmSound()" class="px-2 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">üîá ARR√äT</button>`:''}</div></div></div><div class="grid grid-cols-4 gap-1 mb-2"><button onclick="toggleAccessLevel('sdi')" class="px-2 py-2 ${STATE.accessLevel===1?'bg-green-600':'bg-yellow-600'} text-white rounded text-xs hover:opacity-90 font-bold">üîë Niv.${STATE.accessLevel}</button><button onclick="traineeResetSdiSystem()" class="px-2 py-2 ${canResetSdiSystem()?'bg-green-600':'bg-gray-600 opacity-50'} text-white rounded text-xs font-bold">üîÑ R√âARM</button><button onclick="startOutOfServiceWorkflow()" class="px-2 py-2 ${STATE.accessLevel===2?'bg-orange-600 hover:bg-orange-700':'bg-gray-600 opacity-50'} text-white rounded text-xs font-bold" ${STATE.accessLevel!==2?'disabled':''}>‚ö†Ô∏è M.H.S.</button><button onclick="startBackInServiceWorkflow()" class="px-2 py-2 ${STATE.accessLevel===2?'bg-blue-600 hover:bg-blue-700':'bg-gray-600 opacity-50'} text-white rounded text-xs font-bold" ${STATE.accessLevel!==2?'disabled':''}>‚úÖ R.S.</button></div><div class="bg-gray-800 p-1.5 rounded mb-2"><div class="text-white text-xs font-bold mb-1">Pav√© num√©rique</div><div class="bg-black text-green-400 font-mono p-1 rounded mb-1 text-center text-xs min-h-[20px]">${STATE.keypadInput||'_'}</div><div class="grid grid-cols-3 gap-0.5">${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="keypadPress('${n}')" class="bg-gray-700 hover:bg-gray-600 text-white py-1.5 rounded text-xs font-bold">${n}</button>`).join('')}<button onclick="keypadPress('C')" class="bg-red-700 hover:bg-red-600 text-white py-1.5 rounded text-xs font-bold">C</button><button onclick="keypadPress('0')" class="bg-gray-700 hover:bg-gray-600 text-white py-1.5 rounded text-xs font-bold">0</button><button onclick="keypadValidate()" class="bg-green-700 hover:bg-green-600 text-white py-1.5 rounded text-xs font-bold">‚úì</button></div></div></div><div class="ssi-panel"><h3 class="text-xl font-bold mb-3 text-white">üõ°Ô∏è SMSI</h3><div class="grid grid-cols-3 gap-2 mb-2"><div class="bg-gray-800 p-1.5 rounded flex items-center justify-between"><div class="text-white text-xs">√âtat mat.</div><span class="led-light ${STATE.smsi.systemState==='service'?'led-green':'led-off'}"></span></div><div class="bg-gray-800 p-1.5 rounded flex items-center justify-between"><div class="text-white text-xs">Alim. sect.</div><span class="led-light ${STATE.smsi.powerState==='secteur'?'led-green':'led-off'}"></span></div><div class="bg-gray-800 p-1.5 rounded flex items-center justify-between"><div class="text-white text-xs">Batterie</div><span class="led-light ${STATE.smsi.batteryState==='service'?'led-green':'led-off'}"></span></div></div><div class="mb-2"><div class="text-white text-xs font-bold mb-1"><span>üìü Remont√©es SMSI</span></div><div id="smsi-screen" class="ssi-screen max-h-48 overflow-y-hidden overflow-x-hidden text-xs scroll-smooth">${STATE.smsi.messages.length===0?'<div class="text-center">SYST√àME EN VEILLE</div>':STATE.smsi.messages.map(msg=>`<div class="mb-1">${msg.text}</div>`).join('')}</div><div class="flex justify-center gap-1 mt-1"><button onclick="scrollScreen('smsi-screen','first')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold">‚¨ÖÔ∏è</button><button onclick="scrollScreen('smsi-screen','up')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold">‚¨ÜÔ∏è</button><button onclick="scrollScreen('smsi-screen','down')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold">‚¨áÔ∏è</button><button onclick="scrollScreen('smsi-screen','last')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold">‚û°Ô∏è</button></div></div><div class="bg-gray-800 p-2 rounded mb-3"><div class="text-white font-bold mb-2 text-xs">üîî UGA</div>${STATE.uga.temporizationActive?`<div class="bg-yellow-600 text-white p-2 rounded mb-2 text-center font-bold text-xs temporization-display">‚è±Ô∏è ${Math.floor(STATE.uga.temporizationRemaining/60)}:${String(STATE.uga.temporizationRemaining%60).padStart(2,'0')}</div>`:'<div class="temporization-display"></div>'}<div class="grid grid-cols-2 gap-1"><button id="forceAlarmBtn" onmousedown="startForceAlarm()" onmouseup="cancelForceAlarm()" ontouchstart="startForceAlarm()" ontouchend="cancelForceAlarm()" class="px-2 py-2 bg-red-600 text-white rounded text-xs hover:bg-red-700">üö® FORC√â (3s)</button><button onclick="traineeAcquitProcess()" class="px-2 py-2 ${STATE.uga.temporizationActive?'bg-yellow-600 hover:bg-yellow-700':'bg-gray-500 opacity-50 cursor-not-allowed'} text-white rounded text-xs" ${STATE.uga.alarmActive?'disabled':''}>‚úã ACQUIT ${STATE.uga.temporizationActive?'':'(Inactif)'}</button></div>${STATE.uga.alarmActive?`<div class="mt-2 bg-red-600 text-white p-2 rounded text-center font-bold text-xs blink">üö® ALARME ${STATE.uga.alarmType==='generale'?'G√âN√âRALE':(STATE.uga.alarmType==='generale-selective'?'S√âLECTIVE':'AVEC MESSAGE')}</div>`:''}</div><div class="bg-gray-800 p-2 rounded mb-3"><div class="text-white font-bold mb-2 text-xs">üéõÔ∏è UCMC</div><div class="grid grid-cols-2 gap-2"><div class="pr-2 border-r border-gray-600"><div class="text-white text-xs mb-1">üö™ ZC</div>${STATE.smsi.compartmentZones.map(z=>`<div class="flex items-center gap-1 mb-1"><span class="text-white text-xs font-bold w-6 flex-shrink-0">${z.zone}</span><span class="led-light ${z.ledRed.on?'led-red':'led-off'} ${z.ledRed.blink?'blink':''}"></span><span class="led-light ${z.ledOrange.on?'led-orange':'led-off'} ${z.ledOrange.blink?'blink':''}"></span><span class="led-light ${z.ledGreen.on?'led-green':'led-off'} ${z.ledGreen.blink?'blink':''}"></span><span class="text-white text-xs opacity-75 truncate flex-1">${z.address}</span><button onclick="commandZone('compartment',${z.id})" class="px-1 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 flex-shrink-0">CMD</button><span class="command-led ${z.commandActive?'active':''}"></span></div>`).join('')}</div><div class="pl-2"><div class="text-white text-xs mb-1">üí® ZF</div>${STATE.smsi.smokeZones.map(z=>`<div class="flex items-center gap-1 mb-1"><span class="text-white text-xs font-bold w-6 flex-shrink-0">${z.zone}</span><span class="led-light ${z.ledRed.on?'led-red':'led-off'} ${z.ledRed.blink?'blink':''}"></span><span class="led-light ${z.ledOrange.on?'led-orange':'led-off'} ${z.ledOrange.blink?'blink':''}"></span><span class="led-light ${z.ledGreen.on?'led-green':'led-off'} ${z.ledGreen.blink?'blink':''}"></span><span class="text-white text-xs opacity-75 truncate flex-1">${z.address}</span><button onclick="commandZone('smoke',${z.id})" class="px-1 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 flex-shrink-0">CMD</button><span class="command-led ${z.commandActive?'active':''}"></span></div>`).join('')}</div></div></div><div class="bg-gray-800 p-2 rounded mb-3"><div class="text-white font-bold mb-2 text-xs">‚ö° Coffrets relayage</div><div class="grid grid-cols-3 gap-2">${STATE.smsi.relayBoxes.map(r=>`<div class="flex flex-col gap-1"><div class="flex items-center gap-1 justify-center"><span class="text-white text-xs font-bold">CR${r.id}</span><span class="led-light ${r.ledRed.on?'led-red':'led-off'} ${r.ledRed.blink?'blink':''}"></span><span class="led-light ${r.ledOrange.on?'led-orange':'led-off'} ${r.ledOrange.blink?'blink':''}"></span><span class="led-light ${r.ledGreen.on?'led-green':'led-off'} ${r.ledGreen.blink?'blink':''}"></span></div><div class="text-white text-xs opacity-75 text-center truncate w-full mb-1">${r.address}</div><button onclick="stopRelay(${r.id})" class="w-full px-1 py-1 ${r.stopped?'bg-red-600':'bg-orange-600'} text-white rounded text-xs hover:opacity-90">${r.stopped?'ARR√äT√â':'ARR√äT'}</button></div>`).join('')}</div></div><div class="bg-gray-800 p-2 rounded mb-3"><div class="text-white font-bold mb-2 text-xs">üí° US</div><div class="grid grid-cols-2 gap-1"><button onclick="testSignalization()" class="px-2 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">üß™ TEST</button><button onclick="bilanSystem()" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">üìä BILAN</button></div></div><div class="flex gap-2"><button onclick="toggleAccessLevel('smsi')" class="px-3 py-1 ${STATE.smsiAccessLevel===1?'bg-green-600':'bg-yellow-600'} text-white rounded text-xs hover:opacity-90">Niv.${STATE.smsiAccessLevel}</button><div class="key-switch ${STATE.smsiAccessLevel===2?'active':''}" onclick="toggleAccessLevel('smsi')">üîë</div><button onclick="traineeResetSmsiSystem()" class="flex-1 px-3 py-1 ${canResetSmsiSystem()?'bg-green-600':'bg-gray-600 opacity-50'} text-white rounded text-xs">üîÑ R√âARMEMENT SMSI</button></div></div><div class="lg:col-span-2"><div class="ssi-panel"><h3 class="text-xl font-bold mb-3 text-white">üìã Journal des actions</h3><div class="ssi-screen max-h-96 overflow-y-auto">${STATE.actionLog.length===0?'<div class="text-center opacity-50">Aucune action enregistr√©e</div>':STATE.actionLog.slice(-20).reverse().map(log=>`<div class="mb-2 pb-2 border-b border-green-900"><div class="text-xs opacity-75">${new Date(log.timestamp).toLocaleString('fr-FR')}</div><div>${log.trainee}: <span class="text-yellow-400">${log.action}</span></div>${log.details?`<div class="text-sm opacity-75">${log.details}</div>`:''}</div>`).join('')}</div></div></div></div></div></div>`;}

async function handleSupervisorLogin(event){event.preventDefault();if(SECURITY.isLocked()){const remaining=SECURITY.getRemainingLockTime();const minutes=Math.floor(remaining/60);const seconds=remaining%60;showCustomAlert(`Compte bloqu√©. R√©essayez dans ${minutes}m ${seconds}s`);return;}const code=document.getElementById('supervisor-code').value;const hashedCode=await SECURITY.hashPassword(code);if(hashedCode===SECURITY.supervisorPasswordHash){SECURITY.resetAttempts();navigate('supervisor-interface',{userType:'supervisor'});}else{const locked=SECURITY.recordFailedAttempt();if(locked){showCustomAlert(`Trop de tentatives. Compte bloqu√© 5 minutes.`);}else{const remaining=SECURITY.maxLoginAttempts-SECURITY.loginAttempts;showCustomAlert(`Code incorrect. ${remaining} tentative(s) restante(s).`);}}}

function handleTraineePinLogin(event){event.preventDefault();const pin=document.getElementById('trainee-pin').value;const trainee=STATE.trainees.find(t=>t.pin===pin);if(!trainee){showCustomAlert('Code PIN incorrect');return;}if(!checkTraineeAccess(trainee)){const dateDebut=new Date(trainee.dateDebut).toLocaleDateString('fr-FR');const dateFin=new Date(trainee.dateFin).toLocaleDateString('fr-FR');showCustomAlert(`Acc√®s refus√©. Formation autoris√©e du ${dateDebut} au ${dateFin}.`);return;}navigate('trainee-interface',{user:trainee,userType:'trainee'});setTimeout(()=>{joinActiveSession();},500);}

function handleCreateTrainee(event){event.preventDefault();const data={nom:document.getElementById('nom').value,prenom:document.getElementById('prenom').value,email:document.getElementById('email').value,niveau:document.getElementById('niveau').value,dateDebut:document.getElementById('dateDebut').value,dateFin:document.getElementById('dateFin').value};createTrainee(data);navigate('trainee-management');showCustomAlert('Stagiaire cr√©√© et synchronis√©!');}

function deleteTrainee(id){showCustomConfirm('√ätes-vous s√ªr de vouloir supprimer ce stagiaire?',()=>{STATE.trainees=STATE.trainees.filter(t=>t.id!==id);saveTrainees();render();showCustomAlert('Stagiaire supprim√©.');});}

function changeSdiState(state){if(!checkSessionBeforeAction())return;STATE.sdi.systemState=state;sendMessage('SDI_STATE_CHANGE',{state});}
function changeSdiBattery(state){if(!checkSessionBeforeAction())return;STATE.sdi.batteryState=state;sendMessage('SDI_BATTERY_CHANGE',{state});}
function changeSdiPower(state){if(!checkSessionBeforeAction())return;STATE.sdi.powerState=state;sendMessage('SDI_POWER_CHANGE',{state});}
function changeSmsiPower(state){if(!checkSessionBeforeAction())return;STATE.smsi.powerState=state;sendMessage('SMSI_POWER_CHANGE',{state});}
function setTemporization(minutes){if(!checkSessionBeforeAction())return;STATE.uga.temporization=parseInt(minutes);sendMessage('SET_TEMPORIZATION',{minutes:parseInt(minutes)});}
function setAlarmType(type){if(!checkSessionBeforeAction())return;STATE.uga.alarmType=type;sendMessage('SET_ALARM_TYPE',{alarmType:type});}

function toggleDetector(type,id){if(!checkSessionBeforeAction())return;const detectorArray=type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const detector=detectorArray.find(d=>d.id===id);if(detector.triggered){resetDetector(type,id);sendMessage('RESET_DETECTOR',{type,id});logAction(`R√©armement ${type}`,detector.address,'supervisor');}else{triggerDetector(type,id,false);sendMessage('TRIGGER_DETECTOR',{type,id});logAction(`D√©clenchement ${type}`,detector.address,'supervisor');}render();}
function changeDetectorState(type,id,state){const detectorArray=type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const detector=detectorArray.find(d=>d.id===id);detector.state=state;sendMessage('CHANGE_DETECTOR_STATE',{type,id,state});render();}
function changeDetectorZone(type,id,zone){const detectorArray=type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const detector=detectorArray.find(d=>d.id===id);detector.zone=zone;render();}

function renderSessionLogs(){
const sortedLogs=[...STATE.sessionLogs].sort((a,b)=>new Date(b.endTime)-new Date(a.endTime));
const query=STATE.searchQuery.toLowerCase();
const filteredLogs=query?sortedLogs.filter(log=>{const dateStr=new Date(log.startTime).toLocaleDateString('fr-FR');const trainee=(log.trainee||'').toLowerCase();const sessionNum=log.sessionNumber.toString();return dateStr.includes(query)||trainee.includes(query)||sessionNum.includes(query);}):sortedLogs;
return `<div class="min-h-screen p-4 bg-gray-100 dark:bg-gray-900"><div class="max-w-7xl mx-auto"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">üìö Historique des Sessions</h2><button onclick="navigate('supervisor-interface')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">‚Üê Retour</button></div><div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg mb-6"><div class="relative"><input type="text" id="search-input" value="${STATE.searchQuery}" oninput="updateSearchQuery(this.value)" placeholder="üîç Rechercher par date, nom ou num√©ro de session..." class="w-full px-4 py-3 text-base border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">${STATE.searchQuery?`<button onclick="clearSearch()" class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">‚úï</button>`:''}</div><div class="mt-2 text-sm text-gray-600 dark:text-gray-400">${filteredLogs.length} session(s) trouv√©e(s)</div></div>${filteredLogs.length===0?`<div class="bg-white dark:bg-gray-800 p-12 rounded-xl shadow-lg text-center"><p class="text-gray-500 text-lg">Aucune session enregistr√©e</p></div>`:`<div class="grid gap-6">${filteredLogs.map(log=>`<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg"><div class="flex justify-between items-start mb-4"><div><h3 class="text-2xl font-bold text-primary">Session ${log.sessionNumber}</h3><div class="text-sm text-gray-600 dark:text-gray-400 mt-1"><span>üë§ ${log.trainee||'Inconnu'}</span><span class="mx-2">‚Ä¢</span><span>üë®‚Äçüè´ ${typeof log.supervisor==='object'?(log.supervisor.prenom||''):'Superviseur'}</span></div></div><div class="text-right text-sm"><div class="text-gray-600 dark:text-gray-400">üìÖ ${new Date(log.startTime).toLocaleDateString('fr-FR')}</div><div class="text-gray-600 dark:text-gray-400">üïê ${new Date(log.startTime).toLocaleTimeString('fr-FR')} - ${new Date(log.endTime).toLocaleTimeString('fr-FR')}</div></div></div><div class="border-t pt-4"><h4 class="font-bold mb-3">üìã Actions (${log.actions.length})</h4><div class="ssi-screen max-h-96 overflow-y-auto">${log.actions.length===0?'<div class="text-center opacity-50">Aucune action dans cette session</div>':log.actions.slice(-50).reverse().map(action=>`<div class="mb-2 pb-2 border-b border-green-900"><div class="text-xs opacity-75">${new Date(action.timestamp).toLocaleString('fr-FR')}</div><div>${action.trainee}: <span class="text-yellow-400">${action.action}</span></div>${action.details?`<div class="text-sm opacity-75">${action.details}</div>`:''}</div>`).join('')}</div></div><div class="mt-4 flex justify-end gap-2"><button onclick="printSessionLog('${log.sessionId}')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm">üñ®Ô∏è Imprimer</button><button onclick="deleteSessionLog('${log.sessionId}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">üóëÔ∏è Supprimer</button></div></div>`).join('')}</div>`}</div></div>`;
}

function updateSearchQuery(value){STATE.searchQuery=value;render();}
function clearSearch(){STATE.searchQuery='';render();}

function printSessionLog(sessionId){const log=STATE.sessionLogs.find(l=>l.sessionId===sessionId);if(!log)return;const supervisorActions=log.actions.filter(a=>a.actor==='supervisor');const traineeActions=log.actions.filter(a=>a.actor==='trainee'||!a.actor);const maxLength=Math.max(supervisorActions.length,traineeActions.length);let rowsHtml='';for(let i=0;i<maxLength;i++){const sa=supervisorActions[i];const ta=traineeActions[i];const sc=sa?'<div class="action-cell"><div class="timestamp">'+new Date(sa.timestamp).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})+'</div><div class="action-content">'+sa.action+'</div>'+(sa.details?'<div class="details">'+sa.details+'</div>':'')+'</div>':'<div class="action-cell empty"></div>';const tc=ta?'<div class="action-cell"><div class="timestamp">'+new Date(ta.timestamp).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})+'</div><div class="action-content">'+ta.action+'</div>'+(ta.details?'<div class="details">'+ta.details+'</div>':'')+'</div>':'<div class="action-cell empty"></div>';rowsHtml+='<tr><td class="scenario-col">'+sc+'</td><td class="trainee-col">'+tc+'</td></tr>';}const supName=typeof log.supervisor==='object'?((log.supervisor.prenom||'')+' '+(log.supervisor.nom||'')).trim():'Superviseur';const printWindow=window.open('','','width=1000,height=800');printWindow.document.write('<!DOCTYPE html><html><head><title>Session '+log.sessionNumber+'</title><style>body{font-family:Arial;padding:20px;font-size:12px}h1{color:#333;border-bottom:2px solid #5D5CDE;padding-bottom:10px}.meta{background:#f5f5f5;padding:15px;margin:20px 0;border-radius:5px}table{width:100%;border-collapse:collapse;margin-top:10px}th{background:#5D5CDE;color:white;padding:10px;text-align:left}td{border:1px solid #ddd;padding:8px;vertical-align:top}.scenario-col{background:#fff8e1}.trainee-col{background:#e3f2fd}.timestamp{color:#666;font-size:0.85em;font-weight:bold}.details{color:#888;font-style:italic}@media print{button{display:none}}</style></head><body><h1>üìã Journal Session SSI-SSIAP</h1><div class="meta"><div><strong>Session '+log.sessionNumber+'</strong></div><div>üìÖ '+new Date(log.startTime).toLocaleDateString('fr-FR')+'</div><div>üïê '+new Date(log.startTime).toLocaleTimeString('fr-FR')+' - '+new Date(log.endTime).toLocaleTimeString('fr-FR')+'</div><div>üë§ '+(log.trainee||'Inconnu')+'</div><div>üë®‚Äçüè´ '+supName+'</div><div>üìä '+log.actions.length+' actions</div></div><table><thead><tr><th>üé¨ SC√âNARIO</th><th>üë§ STAGIAIRE</th></tr></thead><tbody>'+rowsHtml+'</tbody></table><script>window.onload=function(){window.print();}<\/script></body></html>');printWindow.document.close();}

function deleteSessionLog(sessionId){showCustomConfirm('Supprimer ce journal?',()=>{if(firebaseInitialized){db.ref(`session_logs/${sessionId}`).remove();}STATE.sessionLogs=STATE.sessionLogs.filter(l=>l.sessionId!==sessionId);render();showCustomAlert('Journal supprim√©.');});}

function updateDetectorAddressInput(type,id,address){const detectorArray=type==='DAI'?STATE.sdi.detectors:STATE.sdi.manualAlarms;const detector=detectorArray.find(d=>d.id===id);if(detector){detector.address=address;}sendMessage('UPDATE_DETECTOR_ADDRESS',{type,id,address});}
function changeSmsiState(state){if(!checkSessionBeforeAction())return;STATE.smsi.systemState=state;sendMessage('SMSI_STATE_CHANGE',{state});}
function changeSmsBattery(state){if(!checkSessionBeforeAction())return;STATE.smsi.batteryState=state;sendMessage('SMSI_BATTERY_CHANGE',{state});}
function changeZoneState(zoneType,id,state){if(!checkSessionBeforeAction())return;setZoneState(zoneType,id,state);sendMessage('SET_ZONE_STATE',{zoneType,id,state});render();}
function updateZoneAddressInput(zoneType,id,address){updateZoneAddress(zoneType,id,address);sendMessage('UPDATE_ZONE_ADDRESS',{zoneType,id,address});}
function traineeStopAlarmSound(){stopAlarmSound();render();}

function toggleAccessLevel(type){
if(type==='sdi'){
if(STATE.accessLevel===1){STATE.workflowStep='LEVEL2_CODE';STATE.workflowData={system:'sdi'};STATE.keypadInput='';addSdiMessage('Tapez le code niveau 2 et validez');render();}
else{STATE.accessLevel=1;logAction('Retour niveau 1 SDI');render();}
}else{
if(STATE.smsiAccessLevel===1){STATE.workflowStep='LEVEL2_CODE';STATE.workflowData={system:'smsi'};STATE.keypadInput='';addSmsiMessage('Tapez le code niveau 2 et validez');render();}
else{STATE.smsiAccessLevel=1;logAction('Retour niveau 1 SMSI');render();}
}
}

function traineeResetSdiSystem(){resetSdiSystem();}
function traineeResetSmsiSystem(){resetSmsiSystem();}
let forceAlarmTimeout;
function startForceAlarm(){forceAlarmTimeout=setTimeout(()=>{forceGeneralAlarm();render();},3000);}
function cancelForceAlarm(){if(forceAlarmTimeout){clearTimeout(forceAlarmTimeout);forceAlarmTimeout=null;}}
function traineeAcquitProcess(){acquitProcess();}

function commandZone(zoneType,id){
let zone;
if(zoneType==='compartment'){zone=STATE.smsi.compartmentZones.find(z=>z.id===id);addSmsiMessage(`Commande fermeture ${zone.address}`);logAction(`Commande fermeture ${zone.address}`);}
else{zone=STATE.smsi.smokeZones.find(z=>z.id===id);addSmsiMessage(`Commande d√©marrage ${zone.address}`);logAction(`Commande d√©marrage ${zone.address}`);}
zone.commandActive=true;render();
}

function testSignalization(){
logAction('Test de signalisation');sendMessage('TEST_SIGNALIZATION',{timestamp:Date.now()});
const origZC=STATE.smsi.compartmentZones.map(z=>({ledRed:{...z.ledRed},ledOrange:{...z.ledOrange},ledGreen:{...z.ledGreen}}));
const origZF=STATE.smsi.smokeZones.map(z=>({ledRed:{...z.ledRed},ledOrange:{...z.ledOrange},ledGreen:{...z.ledGreen}}));
const origCR=STATE.smsi.relayBoxes.map(r=>({ledRed:{...r.ledRed},ledOrange:{...r.ledOrange},ledGreen:{...r.ledGreen}}));
STATE.smsi.compartmentZones.forEach(z=>{z.ledRed={on:true,blink:false};z.ledOrange={on:true,blink:false};z.ledGreen={on:true,blink:false};});
STATE.smsi.smokeZones.forEach(z=>{z.ledRed={on:true,blink:false};z.ledOrange={on:true,blink:false};z.ledGreen={on:true,blink:false};});
STATE.smsi.relayBoxes.forEach(r=>{r.ledRed={on:true,blink:false};r.ledOrange={on:true,blink:false};r.ledGreen={on:true,blink:false};});
render();
setTimeout(()=>{STATE.smsi.compartmentZones.forEach((z,i)=>{z.ledRed=origZC[i].ledRed;z.ledOrange=origZC[i].ledOrange;z.ledGreen=origZC[i].ledGreen;});STATE.smsi.smokeZones.forEach((z,i)=>{z.ledRed=origZF[i].ledRed;z.ledOrange=origZF[i].ledOrange;z.ledGreen=origZF[i].ledGreen;});STATE.smsi.relayBoxes.forEach((r,i)=>{r.ledRed=origCR[i].ledRed;r.ledOrange=origCR[i].ledOrange;r.ledGreen=origCR[i].ledGreen;});render();},2000);
}

function bilanSystem(){
logAction('Demande bilan syst√®me');let hasDefect=false;
STATE.smsi.compartmentZones.forEach(z=>{if(z.ledOrange.on||z.ledRed.on)hasDefect=true;});
STATE.smsi.smokeZones.forEach(z=>{if(z.ledOrange.on||z.ledRed.on)hasDefect=true;});
STATE.smsi.relayBoxes.forEach(r=>{if(r.ledOrange.on||r.ledRed.on)hasDefect=true;});
STATE.smsi.compartmentZones.forEach(z=>{if(!z.ledOrange.on&&!z.ledRed.on){z.ledGreen.on=true;}});
STATE.smsi.smokeZones.forEach(z=>{if(!z.ledOrange.on&&!z.ledRed.on){z.ledGreen.on=true;}});
STATE.smsi.relayBoxes.forEach(r=>{if(!r.ledOrange.on&&!r.ledRed.on){r.ledGreen.on=true;}});
if(!hasDefect){addSmsiMessage('BILAN: Aucun d√©faut - Syst√®me op√©rationnel');}else{addSmsiMessage('BILAN: D√©fauts d√©tect√©s');}
render();setTimeout(()=>{STATE.smsi.compartmentZones.forEach(z=>z.ledGreen.on=false);STATE.smsi.smokeZones.forEach(z=>z.ledGreen.on=false);STATE.smsi.relayBoxes.forEach(r=>r.ledGreen.on=false);render();},3000);
}

function stopRelay(id){const relay=STATE.smsi.relayBoxes.find(r=>r.id===id);relay.stopped=!relay.stopped;addSmsiMessage(`Coffret ${id} ${relay.stopped?'arr√™t√©':'red√©marr√©'}`);logAction(`${relay.stopped?'Arr√™t':'Red√©marrage'} pompier coffret ${id}`);render();}

render();

// Service Worker
if('serviceWorker' in navigator){window.addEventListener('load',async()=>{try{const registration=await navigator.serviceWorker.register('./sw.js');console.log('‚úì SW:',registration.scope);}catch(error){console.error('‚úó SW error:',error);}});}

let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;showInstallButton();});
function showInstallButton(){const installBtn=document.createElement('div');installBtn.id='pwa-install-btn';installBtn.innerHTML=`<button onclick="installPWA()" class="fixed bottom-4 right-4 bg-primary text-white px-4 py-3 rounded-full shadow-lg flex items-center gap-2 z-50 hover:bg-opacity-90 transition animate-bounce"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Installer</button>`;document.body.appendChild(installBtn);}
async function installPWA(){if(!deferredPrompt)return;deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;if(outcome==='accepted'){const btn=document.getElementById('pwa-install-btn');if(btn)btn.remove();}deferredPrompt=null;}
window.addEventListener('appinstalled',()=>{const btn=document.getElementById('pwa-install-btn');if(btn)btn.remove();deferredPrompt=null;});
</script></body></html>
